<!doctype html>
<html lang="ar" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° â€” Gradebook Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ iOS GLOBAL INPUT FIXES â”€â”€ */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
/* iOS: remove default button styling */
button { -webkit-appearance: none; appearance: none; font-family: var(--font-ar); }
/* iOS: prevent callout on long press */
img, button, a { -webkit-touch-callout: none; }
/* iOS: smooth momentum on all scrollable areas */
* { -webkit-overflow-scrolling: touch; }
/* iOS: fix select highlight */
select { -webkit-appearance: none; appearance: none; }

:root {
  --bg: #080e1e;
  --bg2: #0c1428;
  --panel: #101e36;
  --card: #122040;
  --border: rgba(255,255,255,.08);
  --border2: rgba(255,255,255,.14);
  --text: #e4ecff;
  --muted: #5e7aa8;
  --muted2: #8aa0c4;
  --gold: #c9a84c;
  --gold2: #e8c870;
  --accent: #3d7fff;
  --green: #22c55e;
  --red: #f43f5e;
  --amber: #f59e0b;
  --cyan: #06b6d4;
  --radius: 16px;
  --font-ar: 'IBM Plex Sans Arabic', sans-serif;
  --font-display: 'Playfair Display', serif;
  --font-mono: 'IBM Plex Mono', monospace;
  --sidebar-w: 220px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height: -webkit-fill-available;}
body{
  font-family:var(--font-ar);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  min-height: -webkit-fill-available;
  background-image: radial-gradient(ellipse at 20% 0%, rgba(61,127,255,.07) 0%, transparent 60%),
                    radial-gradient(ellipse at 80% 100%, rgba(201,168,76,.05) 0%, transparent 60%);
  /* Prevent text size adjustment on iPhone rotation */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* â”€â”€ LAYOUT â”€â”€ */
.app {
  display:flex;
  height: 100vh;
  height: -webkit-fill-available;
  height: 100dvh;
  overflow:hidden;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: transform .3s ease;
  z-index: 50;
  /* iPhone safe area */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}
.sidebar-logo {
  padding: 20px 16px 14px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo .title {
  font-family: var(--font-display);
  font-size: 15px; font-weight: 700;
  color: var(--gold2);
  line-height: 1.3;
}
.sidebar-logo .subtitle {
  font-size: 11px; color: var(--muted); margin-top: 3px;
  font-family: var(--font-ar);
}
.sidebar-nav { padding: 10px 8px; overflow-y: auto; flex:1; -webkit-overflow-scrolling: touch; }
.nav-section-label {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1.2px; color: var(--muted);
  padding: 10px 8px 6px;
}
.nav-btn {
  width: 100%; text-align: left; cursor: pointer;
  padding: 11px 12px; border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--muted2); font-family: var(--font-ar);
  font-size: 13px; font-weight: 600;
  margin: 2px 0;
  display: flex; align-items: center; gap: 9px;
  transition: all .15s;
}
.nav-btn .icon { font-size: 16px; opacity: .8; }
.nav-btn:hover { background: rgba(255,255,255,.05); color: var(--text); }
.nav-btn.active {
  background: rgba(61,127,255,.15);
  border-color: rgba(61,127,255,.35);
  color: var(--text);
}
.nav-btn .badge-count {
  margin-left: auto;
  font-size: 10px; font-weight: 700;
  background: rgba(255,255,255,.1);
  padding: 2px 6px; border-radius: 99px; color: var(--muted2);
}
.nav-btn.active .badge-count { background: rgba(61,127,255,.3); color: var(--accent); }
.nav-btn.danger-btn .badge-count { background: rgba(244,63,94,.25); color: var(--red); }

.sidebar-bottom {
  padding: 12px 8px;
  border-top: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 6px;
}
.sidebar-bottom .nav-btn { font-size: 12px; }

/* â”€â”€ MAIN â”€â”€ */
.main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  padding: 14px 20px;
  padding-top: calc(14px + env(safe-area-inset-top));
  border-bottom: 1px solid var(--border);
  background: rgba(8,14,30,.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  display: flex; align-items: center; gap: 10px;
  min-height: 62px;
  flex-shrink: 0;
  /* Prevent topbar from being clipped */
  position: relative; z-index: 10;
}
.topbar-title {
  font-family: var(--font-display);
  font-size: 17px; font-weight: 700; color: var(--gold2);
  flex: 1;
}
.topbar-meta { font-size: 12px; color: var(--muted); }
.ham-btn {
  display: none;
  width: 40px; height: 40px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05);
  border-radius: 12px; color: var(--text);
  font-size: 18px; cursor: pointer;
  align-items: center; justify-content: center;
}
.icon-btn {
  width: 40px; height: 40px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05);
  border-radius: 12px; color: var(--muted2);
  font-size: 17px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.icon-btn:hover { border-color: var(--border2); color: var(--text); background: rgba(255,255,255,.09); }
.icon-btn:active { transform: scale(.92); }
.icon-btn.lit { border-color: rgba(61,127,255,.4); background: rgba(61,127,255,.15); color: var(--accent); }

/* â”€â”€ PAGE VIEWS â”€â”€ */
.page {
  display:none; flex-direction:column;
  flex:1; overflow-y:auto; padding: 20px;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
  /* Fix: height must be constrained for scroll to work */
  height: 0;
  min-height: 0;
}
.page.active { display: flex; }

/* â”€â”€ OVERVIEW / DASHBOARD â”€â”€ */
.dash-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.dash-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  cursor: pointer;
  transition: all .2s;
  position: relative; overflow: hidden;
}
.dash-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--cyan));
  opacity: 0;
  transition: opacity .2s;
}
.dash-card:hover { border-color: var(--border2); transform: translateY(-2px); }
.dash-card:hover::before { opacity: 1; }
.dash-card .cls-name {
  font-family: var(--font-display);
  font-size: 16px; font-weight: 700; color: var(--gold2);
  margin-bottom: 8px;
}
.dash-card .cls-count { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
.dash-stat { display: flex; justify-content: space-between; font-size: 12px; margin: 4px 0; }
.dash-stat .lbl { color: var(--muted); }
.dash-stat .val { font-weight: 700; font-family: var(--font-mono); }
.dash-stat .val.good { color: var(--green); }
.dash-stat .val.mid { color: var(--amber); }
.dash-stat .val.bad { color: var(--red); }
.risk-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 8px; border-radius: 99px;
  font-size: 10px; font-weight: 700;
  margin-top: 8px;
}
.risk-pill.ok { background: rgba(34,197,94,.15); color: var(--green); }
.risk-pill.warn { background: rgba(245,158,11,.15); color: var(--amber); }
.risk-pill.danger { background: rgba(244,63,94,.15); color: var(--red); }

.section-title {
  font-family: var(--font-display);
  font-size: 18px; font-weight: 700; color: var(--gold2);
  margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
}
.section-title::after {
  content: '';
  flex: 1; height: 1px;
  background: linear-gradient(90deg, var(--border2), transparent);
}

/* â”€â”€ SETTINGS CHIPS â”€â”€ */
.settings-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px;
  margin-bottom: 20px;
}
.settings-card {
  background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px;
}
.settings-card h4 { font-size: 12px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
.weight-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 6px 0; }
.weight-row label { font-size: 13px; color: var(--muted2); font-weight: 600; flex: 1; }
.weight-inp {
  width: 72px; padding: 7px 10px;
  border-radius: 10px; border: 1px solid var(--border2);
  background: rgba(0,0,0,.3); color: var(--text);
  font-family: var(--font-mono); font-size: 16px; font-weight: 600;
  outline: none; text-align: right;
  transition: border-color .15s;
  -webkit-appearance: none; appearance: none;
}
.weight-inp:focus { border-color: rgba(61,127,255,.5); }
.weight-total {
  text-align: right; font-family: var(--font-mono);
  font-size: 13px; font-weight: 700; margin-top: 8px;
  padding-top: 8px; border-top: 1px solid var(--border);
}
.weight-total.ok { color: var(--green); }
.weight-total.bad { color: var(--red); }

/* â”€â”€ CLASS TABLE VIEW â”€â”€ */
.class-toolbar {
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  margin-bottom: 14px;
}
.search-box {
  flex: 1; min-width: 180px;
  padding: 10px 14px; border-radius: 12px;
  border: 1px solid var(--border2);
  background: rgba(0,0,0,.25); color: var(--text);
  font-family: var(--font-ar); font-size: 16px; outline: none;
  transition: border-color .15s;
  -webkit-appearance: none; appearance: none;
}
.search-box:focus { border-color: rgba(61,127,255,.5); }
.search-box::placeholder { color: var(--muted); }
.tool-btn {
  padding: 10px 14px;
  border-radius: 12px; border: 1px solid var(--border2);
  background: rgba(255,255,255,.05); color: var(--muted2);
  font-family: var(--font-ar); font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all .15s; white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.tool-btn:hover { border-color: var(--border2); color: var(--text); background: rgba(255,255,255,.09); }
.tool-btn:active { transform: scale(.96); }
.tool-btn.primary {
  background: rgba(61,127,255,.15);
  border-color: rgba(61,127,255,.35); color: var(--accent);
}
.tool-btn.danger { background: rgba(244,63,94,.1); border-color: rgba(244,63,94,.3); color: var(--red); }

/* â”€â”€ STATS ROW â”€â”€ */
.stats-row {
  display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;
}
.stat-chip {
  padding: 8px 14px; border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  font-size: 12px; font-weight: 600; color: var(--muted2);
  display: flex; align-items: center; gap: 7px;
}
.stat-chip strong { font-size: 15px; font-family: var(--font-mono); color: var(--text); }
.stat-chip.green-chip { border-color: rgba(34,197,94,.2); background: rgba(34,197,94,.06); }
.stat-chip.green-chip strong { color: var(--green); }
.stat-chip.red-chip { border-color: rgba(244,63,94,.2); background: rgba(244,63,94,.06); }
.stat-chip.red-chip strong { color: var(--red); }
.stat-chip.gold-chip { border-color: rgba(201,168,76,.2); background: rgba(201,168,76,.06); }
.stat-chip.gold-chip strong { color: var(--gold2); }

/* â”€â”€ TABLE â”€â”€ */
.tablewrap {
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
table { width: 100%; border-collapse: collapse; min-width: 900px; }
thead th {
  padding: 11px 12px;
  background: #0a1628;
  border-bottom: 2px solid rgba(61,127,255,.25);
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .9px; color: #6b82a8;
  text-align: left; white-space: nowrap;
  position: sticky; top: 0; z-index: 2;
}
thead th:first-child { width: 42px; text-align: center; }
tbody tr {
  border-bottom: 1px solid rgba(255,255,255,.06);
  transition: background .1s;
}
tbody tr:nth-child(odd) td { background: rgba(255,255,255,.025); }
tbody tr:nth-child(even) td { background: rgba(0,0,0,.15); }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover td { background: rgba(61,127,255,.1) !important; }
tbody tr.at-risk td { background: rgba(244,63,94,.06) !important; }
tbody tr.at-risk:hover td { background: rgba(244,63,94,.12) !important; }
td {
  padding: 10px 12px;
  font-size: 13px; vertical-align: middle;
  border-right: 1px solid rgba(255,255,255,.04);
}
td:last-child { border-right: none; }
/* Name column gets a stronger left border as visual anchor */
td.name-cell {
  min-width: 190px; max-width: 230px;
  border-right: 2px solid rgba(61,127,255,.15) !important;
}
td.num { text-align: center; font-family: var(--font-mono); font-size: 13px; color: var(--muted); width: 42px; }
td.name-cell { min-width: 190px; max-width: 230px; }
.name-inp {
  width: 100%; padding: 8px 10px;
  border-radius: 10px; border: 1px solid transparent;
  background: transparent; color: #ffffff;
  font-family: var(--font-ar); font-size: 16px; font-weight: 700;
  outline: none; transition: all .15s;
  direction: rtl;
  letter-spacing: 0.2px;
  -webkit-appearance: none; appearance: none;
}
.name-inp:hover { border-color: var(--border); background: rgba(255,255,255,.06); }
.name-inp:focus { border-color: rgba(61,127,255,.5); background: rgba(0,0,0,.3); }
.name-inp::placeholder { color: var(--muted); font-weight: 400; }

/* Score input */
.score-inp {
  width: 62px; padding: 8px 4px;
  border-radius: 10px; border: 1px solid rgba(255,255,255,.1);
  background: rgba(0,0,0,.35); color: #dde8ff;
  font-family: var(--font-mono); font-size: 16px; font-weight: 600;
  outline: none; text-align: center; transition: all .15s;
  -webkit-appearance: none; appearance: none;
  display: block;
}
.score-inp:focus { border-color: rgba(61,127,255,.6); background: rgba(61,127,255,.1); color: #fff; }

/* Final score â€” pill style, hard to miss */
.final-score {
  font-family: var(--font-mono); font-size: 16px; font-weight: 800;
  text-align: center; min-width: 62px;
  padding: 6px 10px; border-radius: 10px;
  display: inline-block; letter-spacing: .3px;
}
.final-score.good { color: #4ade80; background: rgba(34,197,94,.15); border: 1px solid rgba(34,197,94,.25); }
.final-score.mid  { color: #fbbf24; background: rgba(251,191,36,.12); border: 1px solid rgba(251,191,36,.25); }
.final-score.low  { color: #fb7185; background: rgba(244,63,94,.15);  border: 1px solid rgba(244,63,94,.25); }

/* â”€â”€ PARTICIPATION CELL â”€â”€ */
.part-cell {
  display: flex; align-items: center; gap: 6px;
  white-space: nowrap;
}
.part-tap {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid rgba(6,182,212,.25);
  background: rgba(6,182,212,.08);
  color: var(--cyan); font-size: 17px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .15s; user-select: none; flex-shrink: 0;
}
.part-tap:active { transform: scale(.86); background: rgba(6,182,212,.22); }
.part-minus {
  width: 30px; height: 30px; border-radius: 8px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  color: var(--muted); font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .12s; user-select: none; flex-shrink: 0;
}
.part-minus:active { transform: scale(.86); }
.part-score {
  font-family: var(--font-mono); font-size: 14px; font-weight: 800;
  color: var(--cyan); min-width: 22px; text-align: center;
}

/* â”€â”€ DISCIPLINE CELL â”€â”€ */
.disc-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 11px; border-radius: 12px;
  border: 1px solid var(--border);
  font-size: 12px; font-weight: 700; cursor: pointer;
  transition: all .15s; white-space: nowrap;
  user-select: none;
}
.disc-badge:active { transform: scale(.95); }
.disc-badge.ok { border-color: rgba(34,197,94,.3); background: rgba(34,197,94,.1); color: var(--green); }
.disc-badge.warn { border-color: rgba(245,158,11,.3); background: rgba(245,158,11,.1); color: var(--amber); }
.disc-badge.danger { border-color: rgba(244,63,94,.3); background: rgba(244,63,94,.1); color: var(--red); }

/* â”€â”€ ABSENCE CELL â”€â”€ */
.abs-cell { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
.abs-tap {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,.1);
  background: rgba(255,255,255,.05);
  color: var(--muted); font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .15s; flex-shrink: 0;
  font-weight: 700;
}
.abs-tap.marked {
  border-color: rgba(244,63,94,.5);
  background: rgba(244,63,94,.18); color: #fb7185;
}
.abs-tap:active { transform: scale(.86); }
.abs-count {
  font-family: var(--font-mono); font-size: 14px; font-weight: 800;
  cursor: pointer; min-width: 24px; text-align: center;
  color: var(--muted2);
  padding: 3px 7px; border-radius: 8px;
  transition: all .15s;
}
.abs-count:hover { background: rgba(255,255,255,.08); color: var(--text); }
.abs-count.has-abs {
  color: #fb7185;
  background: rgba(244,63,94,.12);
  border: 1px solid rgba(244,63,94,.2);
}

/* â”€â”€ ABSENCE REPORT BUTTON (on dash cards) â”€â”€ */
.abs-report-btn {
  width: 100%; margin-top: 10px;
  padding: 11px 12px; border-radius: 12px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05);
  color: var(--muted2); font-family: var(--font-ar);
  font-size: 13px; font-weight: 700;
  cursor: pointer; text-align: center;
  transition: all .15s;
  display: block;
}
.abs-report-btn:active { transform: scale(.97); }
.abs-report-btn.has-absent {
  border-color: rgba(244,63,94,.4);
  background: rgba(244,63,94,.12);
  color: #fb7185;
}
.abs-report-btn.has-absent:hover {
  background: rgba(244,63,94,.2);
}

/* â”€â”€ ABSENCE REPORT CARD (inside modal) â”€â”€ */
.abs-report-card {
  border-radius: 14px;
  border: 1px solid var(--border2);
  overflow: hidden;
  background: rgba(0,0,0,.2);
}
.abs-report-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px;
  background: linear-gradient(135deg, #1a2d5a, #0f1e42);
  color: #fff; gap: 12px;
}
.abs-count-badge {
  background: rgba(244,63,94,.85);
  color: #fff; border-radius: 12px;
  padding: 8px 14px; text-align: center;
  font-family: var(--font-mono);
  font-size: 26px; font-weight: 800; line-height: 1;
  min-width: 64px;
  flex-shrink: 0;
}
.abs-report-rows { padding: 8px 0; }
.abs-report-row {
  display: flex; align-items: center; gap: 14px;
  padding: 11px 16px;
  border-bottom: 1px solid rgba(255,255,255,.06);
  direction: rtl;
}
.abs-report-row:last-child { border-bottom: none; }
.abs-report-num {
  font-family: var(--font-mono); font-size: 13px; font-weight: 700;
  color: #fb7185;
  background: rgba(244,63,94,.12);
  border: 1px solid rgba(244,63,94,.25);
  border-radius: 8px; padding: 3px 8px;
  min-width: 36px; text-align: center;
  flex-shrink: 0;
}
.abs-report-name {
  font-size: 15px; font-weight: 700; color: #fff;
  flex: 1;
}


.risk-flag {
  display: inline-flex; align-items: center;
  width: 22px; height: 22px;
  border-radius: 6px; font-size: 12px;
  justify-content: center;
}
.risk-flag.show { background: rgba(244,63,94,.2); }

/* â”€â”€ MODALS â”€â”€ */
.overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: none; align-items: flex-end; justify-content: center;
  /* iPhone: allow touch to pass through to close button */
  touch-action: none;
  /* Safe area aware */
  padding-bottom: 0;
}
.overlay.show { display: flex; }
.overlay.center { align-items: center; }
.sheet {
  width: 100%; max-width: 680px;
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 24px 24px 0 0;
  padding: 20px 20px;
  /* Safe area for iPhone home indicator */
  padding-bottom: calc(32px + env(safe-area-inset-bottom));
  max-height: 92vh;
  max-height: 92dvh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  animation: slideUp .25s cubic-bezier(.34,1.56,.64,1);
}
.sheet.wide { max-width: 900px; }
.dialog {
  width: min(600px,96vw);
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 20px;
  max-height: 90vh;
  max-height: 90dvh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  animation: popIn .2s cubic-bezier(.34,1.56,.64,1);
  margin: 10px;
}
@keyframes slideUp { from{transform:translateY(50px);opacity:0} to{transform:translateY(0);opacity:1} }
@keyframes popIn { from{transform:scale(.92);opacity:0} to{transform:scale(1);opacity:1} }
.sheet-handle {
  width: 40px; height: 4px; border-radius: 99px;
  background: var(--border2); margin: 0 auto 16px;
}
.sheet-title {
  font-family: var(--font-display);
  font-size: 18px; font-weight: 700; color: var(--gold2);
  margin-bottom: 4px;
  direction: rtl; text-align: right;
}
.sheet-sub { font-size: 12px; color: var(--muted); margin-bottom: 16px; direction: rtl; text-align: right; }
.close-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 14px; }
.x-btn {
  width: 36px; height: 36px; border-radius: 10px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05); color: var(--muted2);
  font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.x-btn:hover { color: var(--text); border-color: var(--border2); }

/* â”€â”€ DISCIPLINE MODAL â”€â”€ */
.inc-cats {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px; margin-bottom: 14px;
}
.cat-btn {
  padding: 12px 10px; border-radius: 14px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.04); color: var(--text);
  font-family: var(--font-ar); font-size: 12px; font-weight: 700;
  cursor: pointer; text-align: center; transition: all .15s;
  display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.cat-btn .cat-icon { font-size: 22px; }
.cat-btn:active { transform: scale(.94); }
.cat-btn.low-cat:active { background: rgba(245,158,11,.2); border-color: rgba(245,158,11,.4); }
.cat-btn.high-cat:active { background: rgba(244,63,94,.2); border-color: rgba(244,63,94,.4); }
.cat-btn.low-cat { border-color: rgba(245,158,11,.2); }
.cat-btn.high-cat { border-color: rgba(244,63,94,.2); }

.inc-log { display: flex; flex-direction: column; gap: 6px; }
.inc-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 12px; border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  gap: 10px;
}
.inc-item .inc-info { flex: 1; }
.inc-item .inc-label { font-size: 13px; font-weight: 600; direction: rtl; text-align: right; }
.inc-item .inc-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
.inc-item .rm-btn {
  padding: 5px 10px; border-radius: 8px;
  border: 1px solid rgba(244,63,94,.3);
  background: rgba(244,63,94,.1); color: var(--red);
  font-size: 11px; font-weight: 700; cursor: pointer;
}

/* â”€â”€ ABSENCE CALENDAR â”€â”€ */
.cal-nav {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 12px;
}
.cal-month-label {
  font-family: var(--font-display);
  font-size: 15px; font-weight: 700; color: var(--gold2);
}
.cal-arrow {
  width: 34px; height: 34px; border-radius: 10px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05); color: var(--muted2);
  font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.cal-arrow:hover { color: var(--text); }
.cal-grid {
  display: grid; grid-template-columns: repeat(7,1fr); gap: 5px;
}
.cal-day-lbl {
  text-align: center; font-size: 10px; font-weight: 700;
  color: var(--muted); padding: 4px 0; text-transform: uppercase;
}
.cal-cell {
  aspect-ratio: 1; border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; cursor: pointer;
  transition: all .15s;
}
.cal-cell.empty { opacity: .25; cursor: default; background: transparent; border-color: transparent; }
.cal-cell.today { border-color: rgba(61,127,255,.5); color: var(--accent); }
.cal-cell.absent { background: rgba(244,63,94,.2); border-color: rgba(244,63,94,.45); color: var(--red); }
.cal-cell:not(.empty):hover { border-color: var(--border2); }

/* â”€â”€ STUDENT PROFILE â”€â”€ */
.profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
@media(max-width:500px){ .profile-grid{grid-template-columns:1fr} }
.profile-card {
  background: rgba(0,0,0,.2); border: 1px solid var(--border);
  border-radius: 14px; padding: 14px;
}
.profile-card h4 { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 10px; }
.profile-row {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 13px; padding: 5px 0;
  border-bottom: 1px solid var(--border);
}
.profile-row:last-child { border-bottom: none; }
.profile-row .lbl { color: var(--muted2); }
.profile-row .val { font-family: var(--font-mono); font-weight: 700; }
.profile-final {
  text-align: center; padding: 16px;
  background: rgba(0,0,0,.25); border: 1px solid var(--border);
  border-radius: 14px; margin-bottom: 14px;
}
.profile-final .big {
  font-family: var(--font-display);
  font-size: 42px; font-weight: 700; line-height: 1;
}
.profile-final .big.good { color: var(--green); }
.profile-final .big.mid { color: var(--amber); }
.profile-final .big.low { color: var(--red); }
.profile-final .out20 { font-size: 18px; color: var(--muted); }

/* â”€â”€ AT-RISK PAGE â”€â”€ */
.risk-list { display: flex; flex-direction: column; gap: 10px; }
.risk-card {
  background: var(--panel); border: 1px solid rgba(244,63,94,.2);
  border-radius: var(--radius); padding: 14px;
  display: flex; gap: 14px; align-items: flex-start;
  cursor: pointer; transition: all .15s;
}
.risk-card:hover { border-color: rgba(244,63,94,.4); }
.risk-card .risk-num {
  font-family: var(--font-mono); font-size: 11px; color: var(--muted);
  min-width: 24px; text-align: center; padding-top: 2px;
}
.risk-card .risk-name {
  font-size: 15px; font-weight: 700; direction: rtl;
  margin-bottom: 6px;
}
.risk-card .risk-cls { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
.risk-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.risk-tag {
  padding: 3px 8px; border-radius: 99px;
  font-size: 11px; font-weight: 700;
}
.risk-tag.abs { background: rgba(244,63,94,.15); color: var(--red); }
.risk-tag.disc { background: rgba(245,158,11,.15); color: var(--amber); }
.risk-tag.grade { background: rgba(61,127,255,.15); color: var(--accent); }

/* â”€â”€ PRINT REPORT (Arabic) â”€â”€ */
.report-preview {
  background: #fff; color: #111;
  border-radius: var(--radius); padding: 0;
  font-family: var(--font-ar);
  direction: rtl;
  border: 1px solid var(--border2);
  overflow: hidden;
}
.rpt-header {
  background: #1a2d5a; color: #fff;
  padding: 20px 24px;
  text-align: center;
}
.rpt-header h1 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.rpt-header p { font-size: 12px; opacity: .8; }
.rpt-body { padding: 20px 24px; }
.rpt-section { margin-bottom: 18px; }
.rpt-section h2 {
  font-size: 14px; font-weight: 700; color: #1a2d5a;
  border-bottom: 2px solid #c9a84c; padding-bottom: 6px; margin-bottom: 10px;
}
.rpt-row {
  display: flex; justify-content: space-between;
  padding: 7px 10px; font-size: 13px;
  border-bottom: 1px solid #f0f0f0;
}
.rpt-row:nth-child(odd) { background: #f9f9ff; }
.rpt-row .key { color: #444; font-weight: 600; }
.rpt-row .value { font-weight: 700; color: #1a2d5a; }
.rpt-row .value.red { color: #c0392b; }
.rpt-row .value.green { color: #27ae60; }
.rpt-incidents { font-size: 12px; line-height: 1.8; color: #333; }
.rpt-footer {
  padding: 14px 24px;
  background: #f5f5f5;
  display: flex; justify-content: space-between;
  font-size: 12px; color: #666;
  gap: 20px; flex-wrap: wrap;
}
.rpt-sig { display: flex; flex-direction: column; gap: 4px; min-width: 200px; }
.rpt-sig .sig-line { border-bottom: 1px solid #999; width: 200px; height: 28px; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--panel);
  border: 1px solid var(--border2);
  color: var(--text);
  padding: 11px 20px; border-radius: 14px;
  font-size: 13px; font-weight: 700;
  z-index: 500;
  transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .3s;
  white-space: nowrap;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* â”€â”€ MOBILE / iPHONE â”€â”€ */
@media(max-width:700px){
  .sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    transform: translateX(-100%);
    padding-left: env(safe-area-inset-left);
  }
  .sidebar.open { transform: translateX(0); box-shadow: 8px 0 40px rgba(0,0,0,.5); }
  .ham-btn { display: flex; }
  .overlay-sidebar {
    position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 49;
    display: none;
  }
  .overlay-sidebar.show { display: block; }

  /* Page padding accounts for safe areas */
  .page {
    padding: 12px;
    padding-bottom: calc(24px + env(safe-area-inset-bottom));
  }
  .topbar {
    padding: 10px 12px;
    padding-top: calc(10px + env(safe-area-inset-top));
    gap: 8px;
  }
  /* Save indicator compact on mobile */
  #saveIndicator span:last-child { display: none; }

  /* Larger tap targets for iPhone */
  .nav-btn { padding: 14px 12px; font-size: 14px; }
  .tool-btn { padding: 12px 14px; font-size: 13px; }
  .icon-btn { width: 44px; height: 44px; }
  .ham-btn { width: 44px; height: 44px; }
  .part-tap { width: 44px; height: 44px; border-radius: 14px; }
  .part-minus { width: 36px; height: 36px; }
  .abs-tap { width: 44px; height: 44px; border-radius: 14px; font-size: 20px; }
  .disc-badge { padding: 10px 14px; font-size: 13px; }
  .cat-btn { padding: 16px 10px; min-height: 70px; }
  .x-btn { width: 44px; height: 44px; }
  .cal-cell { font-size: 14px; border-radius: 12px; }
  .cal-arrow { width: 44px; height: 44px; }

  /* Table: switch to horizontal scroll mode */
  .tablewrap { border-radius: 12px; }
  table { min-width: 700px; }
  td { padding: 12px 10px; }
  thead th { padding: 12px 10px; }

  /* Bigger final score on mobile */
  .final-score { font-size: 16px; }

  /* Dash cards stack tighter */
  .dash-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
  .dash-card { padding: 14px 12px; }
  .dash-card .cls-name { font-size: 14px; }

  /* Settings stack */
  .settings-grid { grid-template-columns: 1fr; }
  .weight-inp { width: 90px; }

  /* Risk cards */
  .risk-card { padding: 12px; }

  /* Bottom sheet taller on iPhone */
  .sheet { max-height: 88vh; max-height: 88dvh; }
}

/* iPhone landscape */
@media(max-width:900px) and (orientation:landscape){
  .topbar { padding-top: calc(8px + env(safe-area-inset-top)); min-height: 52px; }
  .page { padding-top: 12px; }
}

/* Divider */
.divider { height: 1px; background: var(--border); margin: 16px 0; }

/* Empty state */
.empty-state {
  text-align: center; padding: 48px 20px;
  color: var(--muted);
}
.empty-state .big-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; line-height: 1.6; }
</style>
</head>
<body>

<div class="overlay-sidebar" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="title">Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
    <div class="subtitle">Gradebook Pro â€¢ 2025â€“2026</div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-section-label">Navigation</div>
    <button class="nav-btn active" onclick="showPage('overview')" id="nav-overview">
      <span class="icon">ğŸ </span> Overview
    </button>
    <button class="nav-btn" onclick="showPage('atrisk')" id="nav-atrisk">
      <span class="icon">âš ï¸</span> At-Risk Students
      <span class="badge-count danger-count" id="riskCount">0</span>
    </button>

    <div class="nav-section-label" style="margin-top:8px">Classes</div>
    <div id="classNavList"></div>

    <div class="nav-section-label" style="margin-top:8px">Tools</div>
    <button class="nav-btn" onclick="showPage('settings')" id="nav-settings">
      <span class="icon">âš™ï¸</span> Grade Weights
    </button>
    <button class="nav-btn" onclick="backupData()">
      <span class="icon">ğŸ’¾</span> Backup Data
    </button>
    <button class="nav-btn" onclick="document.getElementById('restoreFile').click()">
      <span class="icon">ğŸ“‚</span> Restore Data
    </button>
    <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreData(event)"/>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <button class="ham-btn" id="hamBtn" onclick="openSidebar()">â˜°</button>
    <button class="icon-btn" id="backBtn" onclick="showPage('overview')" title="Ø±Ø¬ÙˆØ¹" style="display:none;font-size:20px;font-weight:700">â†</button>
    <div style="flex:1;min-width:0">
      <div class="topbar-title" id="topbarTitle">Overview</div>
      <div class="topbar-meta" id="topbarMeta"></div>
    </div>
    <div id="saveIndicator" style="display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:12px;border:1px solid var(--border2);background:rgba(255,255,255,.04);font-size:11px;font-weight:700;color:var(--muted);white-space:nowrap;transition:all .4s;">
      <span id="saveIcon">ğŸ’¾</span><span id="saveText">Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¨Ø¹Ø¯</span>
    </div>
    <span id="syncDot" title="Google Sheets sync" style="font-size:18px;opacity:.3;cursor:default;transition:all .5s">â˜ï¸</span>
    <button class="icon-btn" id="manualSaveBtn" onclick="manualSave()" title="Ø­ÙØ¸ Ø§Ù„Ø¢Ù†" style="font-size:15px">ğŸ’¾</button>
    <button class="icon-btn" onclick="toggleProjector()" title="Projector mode" id="projBtn">ğŸŒ</button>
  </div>

  <!-- OVERVIEW PAGE -->
  <div class="page active" id="page-overview">
    <div class="section-title">All Classes</div>
    <div class="dash-grid" id="dashGrid"></div>
  </div>

  <!-- AT-RISK PAGE -->
  <div class="page" id="page-atrisk">
    <div class="section-title">âš ï¸ At-Risk Students</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Students with final grade &lt; 10, absences â‰¥ 5, or 3+ discipline incidents.</p>
    <div class="risk-list" id="riskList"></div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="section-title">âš™ï¸ Grade Weights</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Customize the weight of each component. Total must equal 100%.</p>

    <!-- GOOGLE SHEETS SYNC CARD -->
    <div class="settings-card" style="margin-bottom:16px;border-color:rgba(66,186,150,.25);background:rgba(66,186,150,.04)">
      <h4 style="color:#42ba96">â˜ï¸ Google Sheets Sync</h4>
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.7">
        Paste your Google Apps Script URL below. All data will sync automatically to your Google Sheet.
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input
          class="search-box"
          id="gsUrl"
          type="url"
          placeholder="https://script.google.com/macros/s/â€¦/exec"
          style="font-size:13px;flex:1;min-width:200px;font-family:var(--font-mono)"
          oninput="saveGsUrl()"
        />
        <button class="tool-btn primary" onclick="testConnection()" id="testBtn">ğŸ”— Test</button>
        <button class="tool-btn primary" onclick="pushAllToSheets()" id="pushBtn" style="background:rgba(66,186,150,.15);border-color:rgba(66,186,150,.4);color:#42ba96">â˜ï¸ Push All</button>
      </div>
      <div id="gsStatus" style="margin-top:10px;font-size:12px;font-weight:700;min-height:18px"></div>
      <div class="divider"></div>
      <div style="font-size:12px;color:var(--muted);line-height:1.7">
        <b style="color:var(--muted2)">Auto-sync:</b> Every change saves to localStorage instantly and queues a sync to Google Sheets.<br/>
        <b style="color:var(--muted2)">Push All:</b> Force-upload everything to Google Sheets at once.<br/>
        <b style="color:var(--muted2)">Pull:</b> On app load, data is fetched from Google Sheets automatically.
      </div>
    </div>

    <div class="settings-grid">
      <div class="settings-card">
        <h4>Component Weights (%)</h4>
        <div class="weight-row"><label>Homework</label><input class="weight-inp" id="w-hw" type="number" min="0" max="100" step="1" value="8" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Participation</label><input class="weight-inp" id="w-part" type="number" min="0" max="100" step="1" value="8" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Discipline</label><input class="weight-inp" id="w-disc" type="number" min="0" max="100" step="1" value="8" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Copybook</label><input class="weight-inp" id="w-copy" type="number" min="0" max="100" step="1" value="8" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Absence</label><input class="weight-inp" id="w-abs" type="number" min="0" max="100" step="1" value="8" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Test 1</label><input class="weight-inp" id="w-t1" type="number" min="0" max="100" step="1" value="15" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Test 2</label><input class="weight-inp" id="w-t2" type="number" min="0" max="100" step="1" value="15" oninput="updateWeights()"/></div>
        <div class="weight-row"><label>Global Test</label><input class="weight-inp" id="w-glob" type="number" min="0" max="100" step="1" value="30" oninput="updateWeights()"/></div>
        <div class="weight-total" id="weightTotal">Total: 100% âœ“</div>
      </div>
      <div class="settings-card">
        <h4>Participation Settings</h4>
        <div class="weight-row">
          <label>Target points for 20/20</label>
          <input class="weight-inp" id="partTarget" type="number" min="1" max="200" value="20" oninput="saveSettings()"/>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:10px;line-height:1.6">
          Score = min(20, (points Ã· target) Ã— 20)<br/>
          Tap â­ in table to add +1 point instantly.
        </div>
        <div class="divider"></div>
        <h4>Term Settings</h4>
        <div class="weight-row">
          <label>Term start date</label>
          <input class="weight-inp" id="termStart" type="date" value="2026-02-18" style="width:140px" oninput="saveSettings()"/>
        </div>
        <div class="weight-row">
          <label>Academic year</label>
          <input class="weight-inp" id="academicYear" type="text" value="2025â€“2026" style="width:120px;font-size:12px" oninput="saveSettings()"/>
        </div>
      </div>
    </div>
  </div>

  <!-- CLASS PAGE (single reusable container) -->
  <div class="page" id="page-class">
    <div class="class-toolbar">
      <input class="search-box" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨â€¦" id="classSearchBox" oninput="filterTableLive(this.value)" style="direction:rtl"/>
      <button class="tool-btn primary" onclick="openPrintAllReport(currentClass)">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ±</button>
      <button class="tool-btn" onclick="exportCSV(currentClass)">ğŸ“Š CSV</button>
    </div>
    <div class="stats-row" id="classStatsRow"></div>
    <div class="tablewrap" id="classTableWrap">
      <table id="classTable">
        <thead><tr>
          <th>#</th>
          <th style="min-width:190px;direction:rtl">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
          <th>Ø§Ù„ØºÙŠØ§Ø¨</th>
          <th>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th>
          <th>Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</th>
          <th>Ø§Ù„ÙˆØ§Ø¬Ø¨</th>
          <th>Ø§Ù„Ø¯ÙØªØ±</th>
          <th>ÙØ±Ø¶ 1</th><th>ÙØ±Ø¶ 2</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th></th>
        </tr></thead>
        <tbody id="classTableBody"></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- DISCIPLINE MODAL -->
<div class="overlay" id="discOverlay" onclick="closeIfBg(event,'discOverlay')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="close-row">
      <div>
        <div class="sheet-title" id="discModalName">â€”</div>
        <div class="sheet-sub" id="discModalMeta">â€”</div>
      </div>
      <button class="x-btn" onclick="closeDisc()">âœ•</button>
    </div>
    <div class="inc-cats" id="incCats"></div>
    <div class="divider"></div>
    <p style="font-size:11px;color:var(--muted);margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px">Logged Incidents</p>
    <div class="inc-log" id="incLog"></div>
  </div>
</div>

<!-- ABSENCE CALENDAR MODAL -->
<div class="overlay" id="absOverlay" onclick="closeIfBg(event,'absOverlay')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="close-row">
      <div>
        <div class="sheet-title" id="absModalName">â€”</div>
        <div class="sheet-sub" id="absModalMeta">â€”</div>
      </div>
      <button class="x-btn" onclick="closeAbs()">âœ•</button>
    </div>
    <div class="cal-nav">
      <button class="cal-arrow" onclick="calPrev()">â—€</button>
      <div class="cal-month-label" id="calMonthLabel">â€”</div>
      <button class="cal-arrow" onclick="calNext()">â–¶</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="divider"></div>
    <p style="font-size:12px;color:var(--muted);margin-top:4px" id="absDatesList"></p>
  </div>
</div>

<!-- STUDENT PROFILE MODAL -->
<div class="overlay center" id="profileOverlay" onclick="closeIfBg(event,'profileOverlay')">
  <div class="dialog">
    <div class="close-row">
      <div>
        <div class="sheet-title" id="profileName">â€”</div>
        <div class="sheet-sub" id="profileMeta">â€”</div>
      </div>
      <button class="x-btn" onclick="closeProfile()">âœ•</button>
    </div>
    <div id="profileBody"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px">
      <button class="tool-btn primary" onclick="printArabicReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
      <button class="tool-btn" onclick="closeProfile()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ABSENCE REPORT MODAL -->
<div class="overlay" id="absReportOverlay" onclick="closeIfBg(event,'absReportOverlay')">
  <div class="sheet" id="absReportSheet">
    <div class="sheet-handle"></div>
    <div class="close-row">
      <div>
        <div class="sheet-title" id="absReportTitle">â€”</div>
        <div class="sheet-sub" id="absReportSub">â€”</div>
      </div>
      <button class="x-btn" onclick="closeAbsReport()">âœ•</button>
    </div>
    <div id="absReportBody"></div>
    <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
      <button class="tool-btn primary" id="absReportCopyBtn" onclick="copyAbsReport()" style="flex:1;justify-content:center;font-size:14px;padding:14px">
        ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      </button>
      <button class="tool-btn" onclick="closeAbsReport()" style="font-size:14px;padding:14px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA = {"TCS-1":["Ù†ÙˆØ±Ø© Ø§Ù„ÙÙ„Ø§Ù‚ÙŠ","ÙŠØ§Ø³ÙŠÙ† Ø§Ù„Ø±ÙˆÙŠØ³ÙŠ","Ø£Ù†Ø³ Ø§Ù„ÙØªÙŠØ±ÙŠ","ÙŠØ§Ø³ÙŠÙ† Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ","Ø£Ù…ÙŠÙ† Ø§Ù„ÙˆØ­Ø¯ÙŠ","Ø³Ø¹Ø¯ Ø­Ø§Ù…Ø¯Ùˆ","ÙŠØ­ÙŠÙ‰ Ø´Ù†ÙŠÙˆØ¨","Ø¹Ù…Ø± Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠ","ÙØ§Ø±Ø³ Ø§Ù„Ø£Ø´Ù‚Ø±","Ø­Ù†Ø§Ù† Ù‡Ø±ÙˆØ§Ù„","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø´Ø§ÙƒØ±","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„ÙˆØ±Ø¯ÙŠ","Ø­Ù…Ø²Ø© Ø²Ø±Ø¯Ø¨Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø§Ù„ÙÙˆÙƒÙŠ","Ø¢Ø¯Ù… Ø§Ù„Ù‚Ø§Ø³Ù…ÙŠ","Ø¹Ù…Ø± Ø§Ù„ÙØ§Ø·Ù…ÙŠ","Ø³Ù†Ø§Ø¡ Ø§Ù„Ø­Ø§ÙÙŠ","Ù…Ø±Ø§Ø¯ Ø¨ÙˆØµÙÙŠØ­Ø©","ÙŠÙˆØ³Ù Ø§Ù„Ø³Ø¹ÙŠØ¯ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø§Ø­ÙƒÙˆØ±Ø´","ÙŠÙˆØ³Ù Ø§Ù„Ø²ÙˆÙŠÙ†","ÙŠØ§Ø³Ù…ÙŠÙ† Ø§Ù„Ù…Ø²Ø±Ø§ÙŠ","Ù…Ø¹Ø§Ø¯ ØºØ±ÙŠÙÙŠ","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ø²ÙŠØ²","Ø­Ù„ÙŠÙ…Ø© Ù‚Ø¨Ø§Ù†","Ø¢Ø¯Ù… Ù‚ÙˆÙ‚","Ù…Ø¬Ø¯ÙˆÙ„ÙŠÙ† Ù‡Ø¯Ø§Ù†","Ù„Ø¨Ù†Ù‰ Ø§Ø­ÙƒÙˆØ´","Ù†Ø§Ø¯ÙŠØ© Ø§Ø¬Ø¯Ø¹","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø­Ù†ÙŠÙ†","ÙƒÙˆØ«Ø± Ù„Ø·ÙÙŠ","Ù…Ø±ÙŠÙ… Ù„Ø¨ÙˆØ²","ØµØ¯ÙŠÙ‚Ø© Ø­Ù†ÙŠÙ†","Ù…Ø­Ù…Ø¯ Ø§Ù„ÙˆØ²Ø§Ù†ÙŠ","Ø¨Ø¯Ø± Ø¨ÙˆÙƒØ³Ø§ÙƒØ³","Ù…Ø±ÙŠÙ… Ø¬Ø¹ÙˆÙ†","Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ† Ø§Ù…Ø³ØºØ±Ùˆ","Ø¥ÙŠÙ…Ø§Ù† Ø®Ù„Ø§Ø¯ÙŠ","Ø¹ØµØ§Ù… Ø¹Ø§Ù„Ù…"],"TCS-2":["Ù…Ø±ÙˆØ© Ø±ÙˆÙ‚","Ø§Ø¨ØªØ³Ø§Ù… Ø§Ù„Ø¬Ù†ØªØ§Ù†ÙŠ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","ÙŠÙˆØ³Ù Ø§Ù„Ø¯Ø±ÙŠÙˆØ´","Ø¹Ù…Ø±Ø§Ù† Ø§Ù„Ø¹Ù…Ø±ÙŠ","Ø­Ù…Ø²Ø© Ø£ÙØ±ÙŠÙƒÙ„","Ø¹Ù…Ø§Ø¯ Ø´ÙƒØ± Ø§Ù„Ù„Ù‡","Ù‡Ø§Ø¬Ø± Ø¨ÙˆÙ…Ø¯ÙŠØ§Ù†","Ø­Ù…Ø²Ø© ÙˆØ§ØµÙ„","Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø±ÙƒÙŠÙ†Ø©","Ø£Ù…ÙŠÙ† Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø¨ÙŠÙ„Ø§Ù†","Ø±Ù…ÙŠÙ€Ø³Ø§Ø¡ Ù…Ø³Ø§Ø¹Ø¯","ÙˆØ¯ÙŠØ¹ Ø§Ù„ÙƒØ±Ø²Ù†ÙŠÙÙŠ","Ù…Ø­Ù…Ø¯ Ø³Ù†ÙˆØ³ÙŠ Ø¹Ù…ÙˆØ±ÙŠ","Ø£ÙŠÙ…Ù† Ø·Ø±ÙØ§ÙˆÙŠ","ÙŠÙˆØ³Ù Ø§Ù„Ø¨ÙˆØ±ÙŠØ²Ø¯ÙŠ","Ù…Ø­Ù…Ø¯ Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ","Ø£Ø³Ø§Ù…Ø© Ø¹Ø²ÙˆØ²ÙŠ","Ø§Ø¯Ø±ÙŠØ³ ÙˆØ§ØµÙ„","Ù…Ø­Ù…Ø¯ Ø¨Ù†Ø´Ø¹Ø¨Ø§Ù†","Ø³Ù‡ÙŠÙ„ Ù„Ø²Ø¹Ø±","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø§Ø¶ÙŠ","Ø£ÙŠÙ…Ù† Ø§Ø³Ù…ÙŠÙ€Ø¯Ø©","ÙŠØ§Ø³ÙŠÙ† Ù…Ø­ÙŠ Ø§Ù„Ø¯ÙŠÙ†","Ø¢Ø¯Ù… Ø¹ÙŠØ´ÙˆØ´","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø®Ù„ÙˆÙÙŠ","Ø³Ù…ÙŠØ± Ø§Ù„Ù‚Ø±Ù…ÙˆØ¯ÙŠ","Ø±Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ø³Ø±ÙŠ","Ø¨ÙˆØ®Ø§Ù„ Ù…Ø±ÙˆØ§Ù†","Ù…Ø±ÙˆØ§Ù† Ø­ÙˆÙ…Ø§Ù„Ùƒ","Ø­Ù…Ø²Ø© Ø­Ø³Ù†ÙŠØ© ÙÙŠÙ„Ø§Ù„ÙŠ","ØºÙØ±Ø§Ù† Ø§Ø­Ø¯ÙŠØ¯Ø§Ù†","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠ","ØµÙÙŠØ© Ø§Ø­Ø¯ÙŠØ¯Ø§Ù†","Ø³Ù†Ø§Ø¡ Ø¨Ù†Ù‚Ø§Ø¯Ø©","Ù‡Ø¯Ù‰ Ø§Ù„Ù…Ø³Ø¹ÙˆØ¯ÙŠ","ÙØ±Ø¯ÙˆØ³ Ø§Ù„Ø²ÙˆÙ†ÙŠ","Ù…Ø­Ù…Ø¯ ÙƒØªØ§Ù…ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ø²Ù…","ÙˆÙ„Ø§Ø¡ Ø§Ù„Ø¹ÙŠØ³ÙˆÙŠ","ÙØ®Ø± Ø§Ù„Ø¯ÙŠÙ† ÙØ±Ø¬","Ø£Ù…ÙŠÙ†Ø© Ø§ØºØ²Ø§Ù„"],"TCSF-1":["ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ø¨Ù† Ø§Ù„Ø´Ø±ÙŠÙ","Ø±Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ØªÙˆÙ†ÙŠ","Ø¢ÙŠØ© Ù„Ø´Ø¹Ù„","ØµÙˆÙÙŠØ§ Ø§Ù„Ù…ØµØ¯ÙˆØ±Ø©","Ø¨Ù„Ø§Ù„ Ø§Ù„Ø²ØºØ§Ø±ÙŠ","Ø±Ø¶Ù‰ Ø¨Ù† Ø¯Ø§ÙˆØ¯","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø³ÙƒØ§Ø­","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ³ÙŠ","ÙØ±Ø¯ÙˆØ³ ÙˆØ§Ù„ÙŠ Ø¹Ù„Ù…ÙŠ","Ù‡Ø¨Ø© Ø¯ÙŠØ¯ÙŠ","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚ Ø§Ù„Ù…ØºØ§Ø±ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø²Ø±ÙˆÙ‚ÙŠ","Ø£ÙŠÙ…Ù† Ø§Ù„Ø¬Ø¨Ø§Ø±ÙŠ","Ù‡Ø¯Ù‰ Ø¨ÙˆØ´Ø¨ÙƒØ©","Ø±Ø§Ù†ÙŠØ§ Ø¨Ù† Ø¯Ø­Ù…Ø§Ù†","Ø¢Ø¯Ù… Ø¨ÙŠÙ„ÙˆÙ„","Ù…Ø±ÙˆØ§Ù† Ø¹Ø§ÙŠØ¯ÙŠ","ÙØ±Ø­ Ø§Ù„Ø¯ÙŠÙˆÙŠÙ‘Ø©","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¯Ø­Ù…Ø§Ù†ÙŠ","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ","Ø¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø´ÙˆØ±Ø©","Ø­Ù…Ø²Ø© Ø³Ø­Ù„Ø§Ù…Ø§Ø³ÙŠ","Ø·Ù‡ Ø§Ù„Ø³Ù‡Ù„ÙŠ","ÙŠØ§Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø¯Ù‚","Ø§Ù„Ù…Ù‡Ø¯ÙŠ Ø§Ù„ÙƒØ±ÙŠÙ†ÙŠ","Ø­Ù„ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ÙƒÙ†ÙŠ","Ù…Ø­Ù…Ø¯ Ø­Ø³ÙŠÙ†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø¨Ù† Ø­Ø³ÙŠÙ†","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ","Ù…Ø±ÙŠÙ… Ø£Ø´Ø¹ÙˆØ¨ÙŠØ©","Ù…Ø­Ù…Ø¯ Ø­Ø§ØªÙ… Ø§Ù„Ø­Ù‚ÙˆÙ†ÙŠ","ÙØ±Ø­ Ù‡ØªÙ…ÙŠ","Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø±Ø¶ÙŠ","Ø¨Ø¯Ø± Ø§Ù„Ø¯ÙŠÙ† ÙƒØ±Ù…ÙˆÙ…","Ø´ÙŠÙ…Ø§Ø¡ Ø®Ø±Ø´Ø§Ù„","Ù„Ø·ÙŠÙØ© Ù…Ø¹ØªÙ†Ø§Ù†","Ù‡Ø§Ø¬Ø± Ø§Ù„ØµÙ…ÙˆØ¯ÙŠ","Ø£Ù…ÙŠÙ…Ø© Ø§Ù„Ø¨ÙƒÙˆØ±ÙŠ","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„ÙƒØ±Ø§ÙÙŠ","Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªÙˆÙƒÙ„","Ø´ÙŠÙ…Ø§Ø¡ Ø­Ø§Ù…Ø¯Ùˆ","ÙˆØ¦Ø§Ù… Ø¨ÙˆÙ‡Ø±ÙŠØ±"],"TCSF-2":["Ø­Ø³Ø§Ù… Ø§Ø¨Ø±ÙŠØ´","ÙˆØ¦Ø§Ù… Ø§Ù„Ø²Ø¹Ø¬Ù…","Ø£ÙŠÙ…Ù† Ø§Ù„Ù…Ù†ÙƒÙŠ","Ø£ÙŠÙˆØ¨ Ø¨ÙˆØ®ÙŠØ±Ø©","Ø²ÙƒØ±ÙŠØ§Ø¡ Ø­Ù…Ø¯ÙŠ","Ù…Ù†ÙŠØ± Ø§Ù„Ø±ÙƒÙŠØ¨ÙŠ","Ù†Ù‡ÙŠÙ„Ø© Ø§Ù„ÙˆØ²Ù†","Ø³Ù†Ø§Ø¡ ÙØ±","Ù…Ù„Ø§Ùƒ Ø§Ù„Ø­Ù…Ø§Ø±ØªÙŠ","Ø³Ù†Ø§Ø¡ Ø§Ù„Ù…ÙŠÙ…ÙˆÙ†ÙŠ","Ø¹Ø¯Ù†Ø§Ù† Ø§Ù„Ù†ØµÙˆØµ","ÙŠÙˆÙ†Ø³ Ø§Ù„Ø¨Ù‡Ø§Ù„ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø³Ù…Ù„Ø§Ù„ÙŠ","Ù…Ù„Ø§Ùƒ Ø§Ù„Ù‚Ø§Ø³Ù…ÙŠ","Ù‡Ù†Ø§Ø¡ Ø§Ø¬Ø¨ÙŠÙ„Ùˆ","Ù„Ø¹Ø·Ø§Ø´ Ø³Ù„ÙŠÙ…Ø©","ÙŠØ§Ø³ÙŠÙ† Ø§Ø¹Ø·Ùˆ","Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ù†ØªØµØ±","Ø¢ÙŠØ© Ø§Ù„Ø­Ø¬Ø§Ø¬ÙŠ","Ø¢Ø¯Ù… Ù…Ø±ÙŠØ¬","Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø¨Ø¯ÙˆÙŠ","Ø¹Ù…Ø± Ø§Ù„Ø¨ÙƒØ§Ø±","Ø­Ø§ØªÙ… Ø§Ù„Ù…Ø·Ù„Ø§Ø³ÙŠ","Ø¥Ù„ÙŠØ§Ø³ Ø¨Ù†Ø®Ø¯Ø©","Ù†Ø¹ÙŠÙ…Ø© Ø£Ù†Ø¬Ø±Ù†","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¯Ø±ÙŠÙ…Ø§Ù†ÙŠ","ØµÙÙˆØ§Ù† Ù…Ù‡Ø¯ÙŠ","Ø§Ù„Ù…Ø±Ø§Ø¨Ø· Ù‡Ø¯Ù‰","Ø·Ù‡ Ù‡Ø¯Ø§ÙÙŠ","Ø³Ù„Ù…Ù‰ Ø§Ù„Ø´Ù†ÙˆØ¹ÙŠ","Ø³ÙƒÙŠÙ†Ø© Ø´Ø·Ø§Ø·","Ù‡Ù†Ø§Ø¡ Ù„Ø´Ù‚Ø±","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø­Ù…Ø§Ù†ÙŠ","ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø§Ø¯","Ø±Ø¶ÙˆØ§Ù† Ø¨Ù† Ø¨ÙˆØ´ØªÙ‰ Ø§Ù„Ø¹Ø³Ø±ÙŠ","Ø¨Ù„Ø§Ù„ Ø§Ù„Ø­ÙŠÙˆÙ†ÙŠ","Ø²ÙŠÙ†Ø¨ Ø§Ù„Ø¹Ù†Ù‚ÙŠ","Ø²Ù‡ÙŠØ± Ø§Ù„Ø¹Ù†Ù‚ÙŠ","Ù†Ø¯Ù‰ Ù…ÙŠØ³ÙˆØ±","Ù„Ù…ÙŠØ§Ø¡ Ù‚ÙˆÙŠØ¯Ø±","Ø¢ÙŠØ© Ø§Ù„Ø­Ø¯Ø§Ø¯","Ù…Ø­Ù…Ø¯ Ø§Ù„Ù„Ø¨Ø§Ù†","ÙŠØ³Ø±Ù‰ Ø§Ù„Ø¨ÙˆØ´ÙŠØ®ÙŠ"],"TCSF-3":["Ø¹Ù…Ø± Ø§Ù„Ù‡ÙˆØ§Ø±ÙŠ","ÙØ±Ø¯ÙˆØ³ Ø¨Ù† ÙŠÙˆØ³Ù","ÙÙˆØ²ÙŠ Ø¹ÙŠÙ†ÙˆØ³","ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø±ÙŠÙÙŠ","Ø²ÙŠØ§Ø¯ Ø­ÙˆÙ…Ø§Ù„Ùƒ","ØµØ¨ÙŠØ± Ø§Ù‚Ø´ÙŠÙ‚Ø´","Ø¹Ø«Ù…Ø§Ù† Ø­ÙŠØ§Ù†ÙŠ Ø²Ø§Ù‡Ø¯","Ø¯Ø¹Ø§Ø¡ Ø´Ø¬Ø§Ø¹","Ø¬ÙˆØ¯ÙŠØ© Ø§Ø´Ù‚Ø±","Ø­ÙØµØ© Ø§Ù„ØªØ§Ù„Ø¨ÙŠ","ØµØ§Ø¨Ø± Ø´Ø§ÙƒØ±","ÙŠØ­ÙŠÙ‰ Ø®Ø§Ù„Ù‚ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„ÙÙŠÙ„Ø§Ù„ÙŠ","ÙŠØ­ÙŠÙ‰ ÙˆÙ†Ø¬Ù„ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø­Ù…Ø§Ù†ÙŠ","Ù…Ø±ÙˆØ© Ø­Ù…ÙŠØ¯Ùˆ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø²Ø§ÙˆÙŠ","Ø¹Ù…Ø± Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠ","ØµØ§Ø¨Ø±ÙŠÙ†Ø§ Ø§Ù„Ø³Ù…ÙŠØ±ÙŠ","Ø´ÙŠÙ…Ø§Ø¡ Ø§Ù„Ù‡Ø§Ø´Ù…ÙŠ","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­ÙŠÙ… Ø§Ø²Ø¹ÙŠØ·","Ø¨Ù„Ø§Ù„ Ø§Ù„Ø¹Ù…Ø§Ø±ÙŠ","Ù…ØµØ¹Ø¨ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ø±ÙŠÙ…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø·ÙŠ Ø²Ø±Ù‡ÙˆÙ†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø²Ø±ÙˆÙ‚","Ø£Ù†ÙˆØ§Ø± Ø§Ù„Ø²ÙˆØ¨Ø¹ÙŠ","Ø¢Ø³ÙŠØ© Ø£Ø­Ø³ÙŠØ³","Ø¢Ø¯Ù… Ø·Ø­Ù…Ø³","Ø£ÙŠÙˆØ¨ Ø¨Ø·Ù…ÙŠ","Ø¢ÙŠØ© Ù…ÙØªØ§Ø­","Ù…Ø±ÙˆØ© Ù…Ù„ÙˆÙƒ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù‚ÙŠ","Ù…Ø­Ù…Ø¯ Ø­Ø¬ÙˆØ¬","Ø³Ø¹ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø¹ÙŠ","Ø¢ÙŠØ© Ø§Ù„Ø­Ù…Ø¬ÙˆÙ…ÙŠ","Ù…Ù‡Ø¯ÙŠ Ø£Ù†Ù‚ÙŠØ±Ø©","Ø¢ÙŠØ© Ø¨ÙŠØ§Ø­","Ø­ÙØµØ© Ø§Ù„Ø¹Ø§Ø¯Ù„","Ø±ÙŠÙ… Ø²Ø±Ù‚Ø§Ù†","Ù„Ø¨Ù†Ù‰ Ù…Ø´ÙˆØ§Ø­ÙŠ","Ù…Ø±Ø§Ø¯ Ù„ÙƒØ³Ø§Ø³","Ù‡Ø¨Ø© Ø§Ù„Ø¹Ø¨ÙˆØ¯ÙŠ","Ù…Ù„Ø§Ùƒ Ø§Ù„ÙØ§Ø±Ø³ÙŠ","Ø¢Ø¯Ù… Ø§Ù„Ø¹ÙŠØ³ÙŠØ±ÙŠ"],"2BACSP-1":["Ø³ÙŠÙ Ø§Ù„Ø¯ÙŠÙ† Ø£ÙØ±ÙŠ","Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø±ÙØ§Ù„ÙŠ","Ø¢Ø¯Ù… Ø¨Ù† Ø¯Ø§ÙˆØ¯","Ù†Ø¬ÙˆÙ‰ Ø£ÙØ±ÙŠÙƒÙ„","Ø¥Ù„Ù‡Ø§Ù… Ù…Ù†ØµÙˆØ±","Ø¹Ù„Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯Ù„","Ø¨Ù‡ÙŠØ¬Ø© Ø§Ù„Ù‡ÙŠØ³ÙˆÙ","Ø¥Ø³Ø­Ø§Ù‚ Ø§Ù„Ù‡ÙŠÙˆØ¨","ÙŠØ³Ø±Ù‰ Ø³Ø±ØºÙŠÙ†ÙŠ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ø£ÙŠÙˆØ¨ ÙƒØ±ÙŠØ·ÙŠØ·","Ù‡Ù†Ø§Ø¡ Ø§Ù„ÙØ±Ø¹","Ø¯Ø¹Ø§Ø¡ Ø³Ù‚Ø§Ø·","Ø£Ù†Ø³ Ø§Ù„ÙƒØªÙˆÙ†ÙŠ","Ø±Ø­Ø§Ø¨ Ù…Ø²ÙˆØºÙŠ","Ø³Ù„Ù…Ù‰ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ù…Ø±ÙŠÙ… Ø¨ÙˆØµÙÙŠØ­Ø©","Ù…Ø¹Ø§Ø¯ Ø¨Ø­ØªØ±","Ø³Ù…ÙŠØ© Ù‚Ø¨ÙŠ","Ø³Ù„Ù…Ù‰ Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠ","Ø³Ù„Ù…Ù‰ Ø¨ÙƒÙˆØ´","Ø­Ù…Ø²Ø© Ø£Ø¶Ø¹ÙŠÙ","Ø£Ø³Ù…Ø§Ø¡ Ø³Ø±ØºÙŠÙ†ÙŠ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ø£Ø´Ø±Ù Ø§Ù„ÙˆÙƒÙŠÙ„ÙŠ","Ø§Ù„ØºÙˆØ§Ù„ÙŠ Ø­Ø§ØªÙ…","Ù…Ø­Ù…Ø¯ Ø¨ÙˆØ³Ù„Ø§Ù…ØªÙŠ","Ø¯Ø¹Ø§Ø¡ Ø­Ù…ÙŠÙ†","Ø£Ù…ÙŠÙ† Ù…Ø¯ÙŠØ¯Ø´","Ø´ÙŠÙ…Ø§Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠØ´ÙŠ","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§ÙˆÙŠ","Ø³Ù„ÙˆÙ‰ Ø¨Ù† Ø§Ù„Ø´ÙŠØ®","Ù†Ø¯Ù‰ Ø¢ÙŠØª Ù„ÙˆØ­ÙŠ","Ø®Ø¯ÙŠØ¬Ø© ØµÙ„Ø­ÙŠ","Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ø£Ø´Ù‡Ø¨","ÙŠÙˆØ³Ù Ø§Ù„Ø¹Ø§ØµÙ…ÙŠ","Ù†Ø§Ø¯ÙŠØ© Ø§Ù„Ø¹Ù†ØªØ±ÙŠ"],"2BACSP-2":["Ø¨Ø«ÙŠÙ†Ø© Ø§Ù„Ø´ÙŠØ®","Ø³Ù„Ù…Ù‰ Ø­Ø§Ø¬ÙŠ","ÙØ±Ø§Ø­ Ø§Ù„Ù…ØºØ§Ø±ÙŠ","Ø¢ÙŠØ© Ø§Ù„Ø²Ø¹Ø¬Ù…","Ø¯Ø¹Ø§Ø¡ Ù‚Ø±ÙÙŠ","Ø§Ø¯Ø±ÙŠØ³ Ø§Ù„Ø­Ø¶Ø±ÙŠ","Ø«Ø±ÙŠØ§ Ø§Ù„Ø´Ù…Ø®Ø§Ù†ÙŠ","Ø­Ù…ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¯Ø³ÙŠ","Ø±Ø§Ù†ÙŠØ© Ø£Ù‚Ø¯ÙŠÙ…","ÙƒÙˆØ«Ø± Ù„Ø²Ø¹Ø±","Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø¨ÙˆØ±Ù‚Ø§Ø¯ÙŠ","Ø±Ø­Ø§Ø¨ Ø§Ø¨Ù† Ø§Ù„Ø­Ø§Ø¬","ÙŠÙˆØ³Ù Ø§Ù„ÙÙ‡Ø¯ÙŠ","ØºØ²Ù„Ø§Ù† Ø²Ù‡ÙŠØ±Ø©","ÙÙŠØµÙ„ Ø§Ù„ØºØ§Ø±ÙŠ","Ø®Ø¯ÙŠØ¬Ø© Ø§Ù„Ø¹Ø²ÙˆØ²ÙŠ","ÙŠØ§Ø³ÙŠÙ† ÙƒØ¹ÙŠØ¯Ø©","ÙƒÙˆØ«Ø± Ø§Ù„Ø¯Ø±Ø§Ø¯Ø§Ø¨ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¹ÙƒØ±ÙŠ","Ø­Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ† Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø¬Ù‡Ø§Ù† Ø¨ÙˆÙƒØ±ÙŠØ¨Ø§Øª","Ø£Ø³Ø§Ù…Ø© Ù…Ø§Ù„ÙƒÙŠ","Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯","Ø­ÙØµØ© Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ Ø§Ù„Ù…ØµØ¨Ø§Ø­ÙŠ","Ø³ÙÙŠØ§Ù† Ø®Ø²Ø§Ø²ÙŠ","Ø¨Ø¯Ø± Ø¬Ù†Ø§Ù†ÙŠ Ø§Ù„Ø¯Ø±Ø³ÙŠ","Ø£Ù†Ø³ Ø§Ù„ØªÙˆÙƒØ©","Ø²ÙŠØ¯ Ø­Ù„Ø­Ø§Ù„","Ù…Ø­Ù…Ø¯ Ø·Ù‡ Ø¹Ù…Ø±Ø§Ù†ÙŠ","Ø¹Ø¯ÙŠ Ø§Ù„Ù…ÙƒÙˆØ¯ÙŠ","Ø¢ÙŠØ© Ø§Ù„Ù…Ø¯Ù‡ÙˆÙ†","Ø±Ø¶Ù‰ Ø§Ù„Ø­ÙŠÙˆØªÙŠ","Ø£Ø­Ù„Ø§Ù… Ø§Ù„Ø¯Ø±Ø§ÙˆÙŠ","Ø¹Ù„ÙŠ Ø§Ù„ÙˆÙƒÙŠÙ„ÙŠ","Ø¢Ø³ÙŠØ© Ø­Ù…Ø§Ù†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø¨Ù„Ø¯Ø§Ù†ÙŠ","Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø³ÙƒÙŠÙ†","ÙˆØ¦Ø§Ù… ÙƒØ±Ø¹Ø§Ù†"]};

const BEHAVIOURS = [
  {label:"Ø¶Ø¬ÙŠØ¬ ÙˆÙƒÙ„Ø§Ù…", icon:"ğŸ—£ï¸", code:"talking", penalty:0.5, level:"low"},
  {label:"Ø¹Ø¯Ù… Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡", icon:"ğŸ˜´", code:"distracted", penalty:0.5, level:"low"},
  {label:"ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø­ØµØ©", icon:"â°", code:"late", penalty:0.5, level:"low"},
  {label:"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ", icon:"ğŸ“±", code:"phone", penalty:1, level:"low"},
  {label:"Ø¥Ø²Ø¹Ø§Ø¬ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡", icon:"ğŸ˜¤", code:"disturbing", penalty:1, level:"low"},
  {label:"Ø±ÙØ¶ Ø§Ù„Ø¹Ù…Ù„", icon:"ğŸš«", code:"refusal", penalty:1, level:"high"},
  {label:"ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚", icon:"âš¡", code:"disrespect", penalty:2, level:"high"},
  {label:"ØºØ´ Ø£Ùˆ Ù†Ù‚Ù„", icon:"ğŸ“‹", code:"cheating", penalty:2, level:"high"},
  {label:"Ø³Ù„ÙˆÙƒ Ø®Ø·ÙŠØ±", icon:"ğŸ”´", code:"dangerous", penalty:3, level:"high"},
];

const classNames = Object.keys(DATA);
let currentPage = 'overview';
let currentClass = null;
let _rows = {};

// Modal state
let discCtx = null; // {cls, idx}
let absCtx = null;
let profileCtx = null;
let calYear, calMonth;
let profileForPrint = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = cls => 'gbpro_' + cls;
const SS = 'gbpro_settings';

function loadCls(cls){ try{ return JSON.parse(localStorage.getItem(SK(cls)))||{}; }catch(e){ return {}; } }
function saveCls(cls, st){
  try{
    localStorage.setItem(SK(cls), JSON.stringify(st));
    showSaveIndicator();
  }catch(e){ showSaveError(); }
  // Queue Google Sheets sync (non-blocking)
  if(getGsUrl()) showSyncDot('pending');
}
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SS))||{}; }catch(e){ return {}; } }
function saveSettings(){
  const s = {
    hw: +v('w-hw'), part: +v('w-part'), disc: +v('w-disc'),
    copy: +v('w-copy'), abs: +v('w-abs'), t1: +v('w-t1'),
    t2: +v('w-t2'), glob: +v('w-glob'),
    partTarget: +v('partTarget'), termStart: v('termStart'),
    academicYear: v('academicYear')
  };
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  refreshAllScores();
  updateWeights();
}

function loadSettingsUI(){
  const s = loadSettings();
  const set = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
  set('w-hw', s.hw??8); set('w-part', s.part??8); set('w-disc', s.disc??8);
  set('w-copy', s.copy??8); set('w-abs', s.abs??8); set('w-t1', s.t1??15);
  set('w-t2', s.t2??15); set('w-glob', s.glob??30);
  set('partTarget', s.partTarget??20); set('termStart', s.termStart??'2026-02-18');
  set('academicYear', s.academicYear??'2025â€“2026');
}

function getW(){
  const s = loadSettings();
  return {
    hw: (s.hw??8)/100, part: (s.part??8)/100, disc: (s.disc??8)/100,
    copy: (s.copy??8)/100, abs: (s.abs??8)/100, t1: (s.t1??15)/100,
    t2: (s.t2??15)/100, glob: (s.glob??30)/100
  };
}
function getPartTarget(){ const s=loadSettings(); return Math.max(1, s.partTarget??20); }

function updateWeights(){
  const ids = ['w-hw','w-part','w-disc','w-copy','w-abs','w-t1','w-t2','w-glob'];
  const total = ids.reduce((a,id)=>a+(+v(id)||0),0);
  const el = document.getElementById('weightTotal');
  if(el){
    el.textContent = 'Total: ' + total + '%' + (total===100?' âœ“':' âœ— (must be 100%)');
    el.className = 'weight-total ' + (total===100?'ok':'bad');
  }
}

function getStudentRecord(st, n, defaultName){
  if(!st.students) st.students = {};
  if(!st.students[n]) st.students[n] = {
    name: defaultName||'',
    scores: {hw:'',copy:'',t1:'',t2:'',glob:''},
    participationPoints: 0,
    disciplineIncidents: [],
    absenceDates: []
  };
  return st.students[n];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clamp(n,lo,hi){ return Math.max(lo,Math.min(hi,n)); }
function num(v){ const x=parseFloat(v); return isFinite(x)?x:0; }
function todayISO(){ return new Date().toISOString().slice(0,10); }
const v = id => { const el=document.getElementById(id); return el?el.value:''; };

function partScore(pts){ return clamp((pts/getPartTarget())*20,0,20); }
function discScore(incs){ return clamp(20-(incs||[]).reduce((a,x)=>a+(x.penalty||0),0),0,20); }
function absScore(dates){ return clamp(20-0.5*(dates||[]).length,0,20); }

function calcFinal(row){
  const W = getW();
  const hw = clamp(num(row.hw.value),0,20);
  const copy = clamp(num(row.copy.value),0,20);
  const t1 = clamp(num(row.t1.value),0,20);
  const t2 = clamp(num(row.t2.value),0,20);
  const glob = clamp(num(row.glob.value),0,20);
  return clamp(
    W.hw*hw + W.copy*copy + W.t1*t1 + W.t2*t2 + W.glob*glob
    + W.part*partScore(row.partPoints)
    + W.disc*discScore(row.discIncidents)
    + W.abs*absScore(row.absDates), 0, 20
  );
}
function gradeClass(v){ return v>=16?'good':v>=10?'mid':'low'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(pageId, cls){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const backBtn = document.getElementById('backBtn');
  const hamBtn  = document.getElementById('hamBtn');

  if(cls){
    currentClass = cls;
    document.getElementById('page-class').classList.add('active');
    document.getElementById('nav-cls-'+cls.replace(/[^a-zA-Z0-9]/g,'_'))?.classList.add('active');
    document.getElementById('topbarTitle').textContent = cls;
    document.getElementById('topbarMeta').textContent = DATA[cls].length + ' Ø·Ø§Ù„Ø¨Ø§Ù‹';
    if(backBtn) backBtn.style.display = 'flex';
    if(hamBtn)  hamBtn.style.display  = 'none';
    renderClassPage(cls);
  } else {
    currentClass = null;
    currentPage = pageId;
    const pg = document.getElementById('page-'+pageId);
    if(pg) pg.classList.add('active');
    document.getElementById('nav-'+pageId)?.classList.add('active');
    if(pageId==='overview'){ document.getElementById('topbarTitle').textContent='Overview'; document.getElementById('topbarMeta').textContent=''; renderOverview(); }
    if(pageId==='atrisk')  { document.getElementById('topbarTitle').textContent='At-Risk';  document.getElementById('topbarMeta').textContent=''; renderAtRisk(); }
    if(pageId==='settings'){ document.getElementById('topbarTitle').textContent='Settings'; document.getElementById('topbarMeta').textContent=''; loadGsUrlUI(); }
    if(backBtn) backBtn.style.display = 'none';
    if(hamBtn)  hamBtn.style.display  = '';
  }
  closeSidebar();
}

function openSidebar(){ document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); }
function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD SIDEBAR NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSidebarNav(){
  const list = document.getElementById('classNavList');
  list.innerHTML = '';
  classNames.forEach(cls=>{
    const safe = cls.replace(/[^a-zA-Z0-9]/g,'_');
    const btn = document.createElement('button');
    btn.className = 'nav-btn';
    btn.id = 'nav-cls-'+safe;
    btn.innerHTML = `<span class="icon">ğŸ“‹</span>${cls}<span class="badge-count">${DATA[cls].length}</span>`;
    btn.onclick = ()=>showPage(null, cls);
    list.appendChild(btn);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD CLASS PAGES (no-op â€” using single shared page now)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildClassPageContainers(){ /* single shared #page-class used instead */ }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CLASS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderClassPage(cls){
  const names = DATA[cls]||[];
  const st = loadCls(cls);
  const tbody = document.getElementById('classTableBody');
  if(!tbody) return;
  tbody.innerHTML = '';
  if(!_rows[cls]) _rows[cls] = [];
  _rows[cls] = [];

  // Reset search
  const srch = document.getElementById('classSearchBox');
  if(srch) srch.value = '';

  // Update stats
  updateStats(cls);
  _rows[cls] = [];

  names.forEach((defaultName, idx)=>{
    const n = idx+1;
    const rec = getStudentRecord(st, n, defaultName);
    const tr = document.createElement('tr');
    if(isAtRisk(rec)) tr.classList.add('at-risk');

    const rowObj = {
      n, cls,
      nameInp: null,
      hw: null, copy: null, t1: null, t2: null, glob: null,
      partPoints: rec.participationPoints||0,
      discIncidents: (rec.disciplineIncidents||[]).slice(),
      absDates: (rec.absenceDates||[]).slice(),
      final: null,
      partBtn: null, discBadge: null, absTap: null, absCount: null,
    };

    function persist(){
      markUnsaved();
      const s2 = loadCls(cls);
      const r = getStudentRecord(s2, n, defaultName);
      r.name = rowObj.nameInp.value;
      r.scores = { hw: rowObj.hw.value, copy: rowObj.copy.value, t1: rowObj.t1.value, t2: rowObj.t2.value, glob: rowObj.glob.value };
      r.participationPoints = rowObj.partPoints;
      r.disciplineIncidents = rowObj.discIncidents;
      r.absenceDates = rowObj.absDates;
      saveCls(cls, s2);
      queueSync(cls, n);
    }

    function refresh(){
      const fin = calcFinal(rowObj);
      rowObj.final.textContent = fin.toFixed(2);
      rowObj.final.className = 'final-score ' + gradeClass(fin);
      // participation
      const pPts = rowObj.partPoints;
      rowObj.partBtn.innerHTML = `â­ <b>${pPts}</b>`;
      // discipline
      const inc = rowObj.discIncidents.length;
      const ds = discScore(rowObj.discIncidents);
      rowObj.discBadge.textContent = inc===0?'ğŸŸ¢ Ø¬ÙŠØ¯': inc<=2?`ğŸŸ¡ ${inc}`:  `ğŸ”´ ${inc}`;
      rowObj.discBadge.className = 'disc-badge '+(inc===0?'ok':inc<=2?'warn':'danger');
      // absence
      const ac = rowObj.absDates.length;
      rowObj.absCount.textContent = ac>0?ac+'Øº':'â€”';
      rowObj.absCount.className = 'abs-count '+(ac>0?'has-abs':'');
      rowObj.absTap.className = 'abs-tap '+(rowObj.absDates.includes(todayISO())?'marked':'');
      // at-risk
      tr.classList.toggle('at-risk', isAtRisk({absenceDates:rowObj.absDates, disciplineIncidents:rowObj.discIncidents, _fin:fin}));
      updateStats(cls);
    }

    // #
    const tdNum = document.createElement('td'); tdNum.className='num'; tdNum.textContent=n;
    // Name
    const tdName = document.createElement('td'); tdName.className='name-cell';
    const ni = document.createElement('input');
    ni.className='name-inp'; ni.type='text'; ni.value=rec.name||''; ni.placeholder='Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨â€¦';
    ni.addEventListener('input',()=>persist());
    rowObj.nameInp = ni;
    tdName.appendChild(ni);

    // Score inputs
    function mkScore(key){ 
      const inp=document.createElement('input'); 
      inp.className='score-inp'; inp.type='number'; inp.min=0; inp.max=20; inp.step=0.25;
      inp.value=rec.scores?.[key]??'';
      inp.addEventListener('input',()=>{ persist(); refresh(); });
      rowObj[key]=inp;
      const td=document.createElement('td'); td.appendChild(inp); return td;
    }

    // Participation
    const tdPart = document.createElement('td');
    const partWrap = document.createElement('div'); partWrap.className='part-cell';
    const partBtn = document.createElement('div'); partBtn.className='part-tap';
    partBtn.title='Tap to add +1 participation point';
    partBtn.addEventListener('click',()=>{ rowObj.partPoints++; persist(); refresh(); showToast('â­ +1 Ù…Ø´Ø§Ø±ÙƒØ©'); });
    const partMinus = document.createElement('div'); partMinus.className='part-minus';
    partMinus.textContent='âˆ’';
    partMinus.addEventListener('click',()=>{ rowObj.partPoints=Math.max(0,rowObj.partPoints-1); persist(); refresh(); });
    rowObj.partBtn = partBtn;
    partWrap.append(partBtn, partMinus);
    tdPart.appendChild(partWrap);

    // Discipline
    const tdDisc = document.createElement('td');
    const discBadge = document.createElement('div'); discBadge.className='disc-badge ok';
    discBadge.addEventListener('click',()=>openDisc(cls, n));
    rowObj.discBadge = discBadge;
    tdDisc.appendChild(discBadge);

    // Absence
    const tdAbs = document.createElement('td');
    const absWrap = document.createElement('div'); absWrap.className='abs-cell';
    const absTap = document.createElement('div'); absTap.className='abs-tap'; absTap.textContent='âœ—';
    absTap.title='Mark absent today'; 
    absTap.addEventListener('click',()=>{
      const d=todayISO();
      if(rowObj.absDates.includes(d)) rowObj.absDates=rowObj.absDates.filter(x=>x!==d);
      else rowObj.absDates=[...rowObj.absDates,d].sort();
      persist(); refresh();
    });
    const absCount = document.createElement('span'); absCount.className='abs-count';
    absCount.addEventListener('click',()=>openAbs(cls,n));
    rowObj.absTap=absTap; rowObj.absCount=absCount;
    absWrap.append(absTap, absCount);
    tdAbs.appendChild(absWrap);

    // Final
    const tdFinal = document.createElement('td');
    const finalSpan = document.createElement('div'); finalSpan.className='final-score mid';
    rowObj.final = finalSpan;
    tdFinal.appendChild(finalSpan);

    // Profile btn
    const tdProf = document.createElement('td');
    const profBtn = document.createElement('button'); profBtn.className='tool-btn'; profBtn.textContent='ğŸ‘¤';
    profBtn.style.padding='7px 10px'; profBtn.style.fontSize='16px';
    profBtn.addEventListener('click',()=>openProfile(cls,n));
    tdProf.appendChild(profBtn);

    tr.append(tdNum, tdName, tdAbs, tdPart, tdDisc, mkScore('hw'), mkScore('copy'), mkScore('t1'), mkScore('t2'), mkScore('glob'), tdFinal, tdProf);
    tbody.appendChild(tr);
    refresh();
    _rows[cls].push({ tr, rowObj, n });
  });

  saveCls(cls, st);
  updateStats(cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats(cls){
  const el = document.getElementById('classStatsRow');
  if(!el || !_rows[cls]) return;
  const rows = _rows[cls];
  const vals = rows.map(r=>parseFloat(r.rowObj.final.textContent)||0);
  const avg = vals.reduce((a,b)=>a+b,0)/(vals.length||1);
  const above = vals.filter(v=>v>=10).length;
  const risky = rows.filter(r=>r.tr.classList.contains('at-risk')).length;
  el.innerHTML = `
    <div class="stat-chip gold-chip"><strong>${avg.toFixed(2)}</strong> Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØµÙ„</div>
    <div class="stat-chip green-chip"><strong>${above}</strong> ÙÙˆÙ‚ Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
    <div class="stat-chip red-chip"><strong>${vals.filter(v=>v<10).length}</strong> Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
    <div class="stat-chip"><strong>${risky}</strong> ÙÙŠ Ø®Ø·Ø±</div>
    <div class="stat-chip"><strong>${rows.length}</strong> ØªÙ„Ù…ÙŠØ°</div>`;
  updateRiskCount();
}

function isAtRisk(rec){
  const abs = (rec.absenceDates||[]).length>=5;
  const disc = (rec.disciplineIncidents||[]).length>=3;
  const fin = rec._fin!==undefined ? rec._fin<10 : false;
  return abs||disc||fin;
}

function refreshAllScores(){
  classNames.forEach(cls=>{ if(_rows[cls]&&_rows[cls].length) _rows[cls].forEach(r=>{ const fin=calcFinal(r.rowObj); r.rowObj.final.textContent=fin.toFixed(2); r.rowObj.final.className='final-score '+gradeClass(fin); }); });
  updateRiskCount();
}

function filterTable(cls, term){
  if(!_rows[cls]) return;
  term = term.trim().toLowerCase();
  _rows[cls].forEach(r=>{
    const name = r.rowObj.nameInp.value.toLowerCase();
    r.tr.style.display = (!term||name.includes(term)) ? '' : 'none';
  });
}

function filterTableLive(term){
  if(currentClass) filterTable(currentClass, term);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview(){
  const grid = document.getElementById('dashGrid');
  grid.innerHTML = '';
  const today = todayISO();
  classNames.forEach(cls=>{
    const st = loadCls(cls);
    const names = DATA[cls]||[];
    let totalFin=0, risky=0, totalAbs=0, todayAbs=0;
    names.forEach((_,idx)=>{
      const n=idx+1;
      const rec = getStudentRecord(st, n, names[idx]);
      const rowMock = {
        hw:{value:rec.scores?.hw??''}, copy:{value:rec.scores?.copy??''},
        t1:{value:rec.scores?.t1??''}, t2:{value:rec.scores?.t2??''},
        glob:{value:rec.scores?.glob??''},
        partPoints:rec.participationPoints||0,
        discIncidents:rec.disciplineIncidents||[],
        absDates:rec.absenceDates||[]
      };
      const fin=calcFinal(rowMock);
      totalFin+=fin;
      totalAbs+=(rec.absenceDates||[]).length;
      if((rec.absenceDates||[]).includes(today)) todayAbs++;
      if(isAtRisk({absenceDates:rec.absenceDates,disciplineIncidents:rec.disciplineIncidents,_fin:fin})) risky++;
    });
    const avg = totalFin/(names.length||1);
    const card = document.createElement('div');
    card.className='dash-card';
    card.style.cursor='pointer';
    card.onclick=(e)=>{
      // Don't navigate if clicking the absence report button
      if(e.target.closest('.abs-report-btn')) return;
      showPage(null, cls);
    };
    const riskClass = risky===0?'ok':risky<=3?'warn':'danger';
    const todayAbsColor = todayAbs===0?'good':todayAbs<=3?'mid':'bad';
    card.innerHTML=`
      <div class="cls-name">${cls}</div>
      <div class="cls-count">${names.length} Ø·Ø§Ù„Ø¨Ø§Ù‹</div>
      <div class="dash-stat"><span class="lbl">Ø§Ù„Ù…ØªÙˆØ³Ø·</span><span class="val ${gradeClass(avg)}">${avg.toFixed(2)}</span></div>
      <div class="dash-stat"><span class="lbl">ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</span><span class="val ${todayAbsColor}">${todayAbs}</span></div>
      <div class="dash-stat"><span class="lbl">ÙÙŠ Ø®Ø·Ø±</span><span class="val ${risky>0?'bad':'good'}">${risky}</span></div>
      <span class="risk-pill ${riskClass}" style="margin-bottom:10px">${risky===0?'âœ“ ÙˆØ¶Ø¹ Ø¬ÙŠØ¯':risky+' Ø·Ø§Ù„Ø¨ ÙÙŠ Ø®Ø·Ø±'}</span>
      <button class="abs-report-btn ${todayAbs>0?'has-absent':''}" onclick="openAbsReport('${cls}')">
        ğŸ“‹ ${todayAbs>0 ? `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Â· <b>${todayAbs}</b> ØºØ§Ø¦Ø¨` : 'Ù„Ø§ ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…'}
      </button>`;
    grid.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AT-RISK PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAtRisk(){
  const list = document.getElementById('riskList');
  list.innerHTML='';
  let count=0;
  classNames.forEach(cls=>{
    const st=loadCls(cls);
    const names=DATA[cls]||[];
    names.forEach((_,idx)=>{
      const n=idx+1;
      const rec=getStudentRecord(st,n,names[idx]);
      const rowMock={hw:{value:rec.scores?.hw??''},copy:{value:rec.scores?.copy??''},t1:{value:rec.scores?.t1??''},t2:{value:rec.scores?.t2??''},glob:{value:rec.scores?.glob??''},partPoints:rec.participationPoints||0,discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]};
      const fin=calcFinal(rowMock);
      const abs=(rec.absenceDates||[]).length;
      const disc=(rec.disciplineIncidents||[]).length;
      if(!isAtRisk({absenceDates:rec.absenceDates,disciplineIncidents:rec.disciplineIncidents,_fin:fin})) return;
      count++;
      const tags=[];
      if(fin<10) tags.push(`<span class="risk-tag grade">ğŸ“‰ ${fin.toFixed(2)}/20</span>`);
      if(abs>=5) tags.push(`<span class="risk-tag abs">ğŸ“… ${abs} ØºÙŠØ§Ø¨</span>`);
      if(disc>=3) tags.push(`<span class="risk-tag disc">âš ï¸ ${disc} Ø¥Ù†Ø°Ø§Ø±</span>`);
      const card=document.createElement('div');
      card.className='risk-card';
      card.onclick=()=>openProfile(cls,n);
      card.innerHTML=`<div class="risk-num">#${n}</div><div><div class="risk-name">${rec.name||names[idx]}</div><div class="risk-cls">${cls}</div><div class="risk-tags">${tags.join('')}</div></div>`;
      list.appendChild(card);
    });
  });
  if(!count) list.innerHTML='<div class="empty-state"><div class="big-icon">âœ…</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ ÙˆØ¶Ø¹ Ø®Ø·Ø±.<br/>Ø£Ø­Ø³Ù†Øª!</p></div>';
  updateRiskCount();
}

function updateRiskCount(){
  let count=0;
  classNames.forEach(cls=>{
    const st=loadCls(cls);
    (DATA[cls]||[]).forEach((_,idx)=>{
      const rec=getStudentRecord(st,idx+1,DATA[cls][idx]);
      const rm={hw:{value:rec.scores?.hw??''},copy:{value:rec.scores?.copy??''},t1:{value:rec.scores?.t1??''},t2:{value:rec.scores?.t2??''},glob:{value:rec.scores?.glob??''},partPoints:rec.participationPoints||0,discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]};
      if(isAtRisk({absenceDates:rec.absenceDates,disciplineIncidents:rec.disciplineIncidents,_fin:calcFinal(rm)})) count++;
    });
  });
  const el=document.getElementById('riskCount');
  if(el) el.textContent=count;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISCIPLINE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDisc(cls, n){
  discCtx={cls,n};
  const st=loadCls(cls);
  const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  document.getElementById('discModalName').textContent=rec.name||DATA[cls][n-1];
  document.getElementById('discModalMeta').textContent=`#${n} Â· ${cls}`;
  renderDiscCats(); renderIncLog(rec.disciplineIncidents||[]);
  document.getElementById('discOverlay').classList.add('show');
}
function closeDisc(){ document.getElementById('discOverlay').classList.remove('show'); discCtx=null; }

function renderDiscCats(){
  const wrap=document.getElementById('incCats');
  wrap.innerHTML='';
  BEHAVIOURS.forEach(b=>{
    const btn=document.createElement('button');
    btn.className='cat-btn '+(b.level==='high'?'high-cat':'low-cat');
    btn.innerHTML=`<span class="cat-icon">${b.icon}</span>${b.label}<br/><small style="color:var(--muted);font-size:10px">âˆ’${b.penalty} Ù†Ù‚Ø·Ø©</small>`;
    btn.onclick=()=>addInc(b);
    wrap.appendChild(btn);
  });
}

function addInc(b){
  if(!discCtx) return;
  const {cls,n}=discCtx;
  const st=loadCls(cls); const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  rec.disciplineIncidents=[...(rec.disciplineIncidents||[]),{date:todayISO(),code:b.code,label:b.label,penalty:b.penalty}];
  saveCls(cls,st);
  queueSync(cls,n);
  syncRowFromStorage(cls,n);
  renderIncLog(rec.disciplineIncidents);
  showToast('âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„: '+b.label);
}

function removeInc(idx){
  if(!discCtx) return;
  const {cls,n}=discCtx;
  const st=loadCls(cls); const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  rec.disciplineIncidents=(rec.disciplineIncidents||[]).filter((_,i)=>i!==idx);
  saveCls(cls,st);
  queueSync(cls,n);
  syncRowFromStorage(cls,n);
  renderIncLog(rec.disciplineIncidents);
}

function renderIncLog(incs){
  const wrap=document.getElementById('incLog');
  if(!incs||!incs.length){ wrap.innerHTML='<p style="color:var(--muted);font-size:13px;text-align:right">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</p>'; return; }
  wrap.innerHTML='';
  incs.forEach((x,i)=>{
    const div=document.createElement('div'); div.className='inc-item';
    div.innerHTML=`<div class="inc-info"><div class="inc-label">${x.label}</div><div class="inc-meta">${x.date} Â· âˆ’${x.penalty} Ù†Ù‚Ø·Ø©</div></div><button class="rm-btn" onclick="removeInc(${i})">Ø­Ø°Ù</button>`;
    wrap.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABSENCE CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAbs(cls,n){
  absCtx={cls,n};
  const st=loadCls(cls); const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  document.getElementById('absModalName').textContent=rec.name||DATA[cls][n-1];
  document.getElementById('absModalMeta').textContent=`#${n} Â· ${cls} Â· ${rec.absenceDates?.length||0} ÙŠÙˆÙ… ØºÙŠØ§Ø¨`;
  const now=new Date(); calYear=now.getFullYear(); calMonth=now.getMonth();
  renderCal(); document.getElementById('absOverlay').classList.add('show');
}
function closeAbs(){ document.getElementById('absOverlay').classList.remove('show'); absCtx=null; }
function calPrev(){ calMonth--; if(calMonth<0){calMonth=11;calYear--;} renderCal(); }
function calNext(){ calMonth++; if(calMonth>11){calMonth=0;calYear++;} renderCal(); }

function renderCal(){
  if(!absCtx) return;
  const {cls,n}=absCtx;
  const st=loadCls(cls); const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  const absSet=new Set(rec.absenceDates||[]);
  const months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆØ²','ØºØ´Øª','Ø´ØªÙ†Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙ†Ø¨Ø±','Ø¯Ø¬Ù†Ø¨Ø±'];
  document.getElementById('calMonthLabel').textContent=months[calMonth]+' '+calYear;
  const grid=document.getElementById('calGrid');
  grid.innerHTML='';
  const days=['Ø§Ù„Ø¥Ø«','Ø§Ù„Ø«Ù„','Ø§Ù„Ø£Ø±','Ø§Ù„Ø®Ù…','Ø§Ù„Ø¬Ù…','Ø§Ù„Ø³Ø¨','Ø§Ù„Ø£Ø­'];
  days.forEach(d=>{ const h=document.createElement('div'); h.className='cal-day-lbl'; h.textContent=d; grid.appendChild(h); });
  const first=new Date(calYear,calMonth,1);
  const startDow=(first.getDay()+6)%7;
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  for(let i=0;i<startDow;i++){ const c=document.createElement('div'); c.className='cal-cell empty'; grid.appendChild(c); }
  const today=todayISO();
  for(let d=1;d<=daysInMonth;d++){
    const iso=new Date(calYear,calMonth,d).toISOString().slice(0,10);
    const c=document.createElement('div'); c.className='cal-cell';
    c.textContent=d;
    if(absSet.has(iso)) c.classList.add('absent');
    if(iso===today) c.classList.add('today');
    c.addEventListener('click',()=>{
      const s2=loadCls(cls); const r=getStudentRecord(s2,n,DATA[cls][n-1]);
      const a=r.absenceDates||[];
      r.absenceDates=a.includes(iso)?a.filter(x=>x!==iso):[...a,iso].sort();
      saveCls(cls,s2);
      queueSync(cls,n);
      syncRowFromStorage(cls,n);
      renderCal();
      document.getElementById('absModalMeta').textContent=`#${n} Â· ${cls} Â· ${r.absenceDates.length} ÙŠÙˆÙ… ØºÙŠØ§Ø¨`;
    });
    grid.appendChild(c);
  }
  const sorted=(rec.absenceDates||[]).slice().sort();
  document.getElementById('absDatesList').textContent=sorted.length?'Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨: '+sorted.join(' â€¢ '):'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù…Ø³Ø¬Ù„.';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC ROW FROM STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncRowFromStorage(cls,n){
  const rows=_rows[cls];
  if(!rows) return;
  const entry=rows.find(r=>r.n===n);
  if(!entry) return;
  const st=loadCls(cls);
  const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  const ro=entry.rowObj;
  ro.partPoints=rec.participationPoints||0;
  ro.discIncidents=(rec.disciplineIncidents||[]).slice();
  ro.absDates=(rec.absenceDates||[]).slice();
  const fin=calcFinal(ro);
  ro.final.textContent=fin.toFixed(2);
  ro.final.className='final-score '+gradeClass(fin);
  ro.partBtn.innerHTML=`â­ <b>${ro.partPoints}</b>`;
  const inc=ro.discIncidents.length;
  ro.discBadge.textContent=inc===0?'ğŸŸ¢ Ø¬ÙŠØ¯':inc<=2?`ğŸŸ¡ ${inc}`:`ğŸ”´ ${inc}`;
  ro.discBadge.className='disc-badge '+(inc===0?'ok':inc<=2?'warn':'danger');
  const ac=ro.absDates.length;
  ro.absCount.textContent=ac>0?ac+'Øº':'â€”';
  ro.absCount.className='abs-count '+(ac>0?'has-abs':'');
  ro.absTap.className='abs-tap '+(ro.absDates.includes(todayISO())?'marked':'');
  entry.tr.classList.toggle('at-risk',isAtRisk({absenceDates:ro.absDates,disciplineIncidents:ro.discIncidents,_fin:fin}));
  updateStats(cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDENT PROFILE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProfile(cls,n){
  profileCtx={cls,n};
  const st=loadCls(cls); const rec=getStudentRecord(st,n,DATA[cls][n-1]);
  const name=rec.name||DATA[cls][n-1];
  document.getElementById('profileName').textContent=name;
  document.getElementById('profileMeta').textContent=`#${n} Â· ${cls}`;
  // compute scores
  const ro=_rows[cls]?.find(r=>r.n===n)?.rowObj;
  const hw=ro?num(ro.hw.value):num(rec.scores?.hw);
  const copy=ro?num(ro.copy.value):num(rec.scores?.copy);
  const t1=ro?num(ro.t1.value):num(rec.scores?.t1);
  const t2=ro?num(ro.t2.value):num(rec.scores?.t2);
  const glob=ro?num(ro.glob.value):num(rec.scores?.glob);
  const pPts=ro?ro.partPoints:rec.participationPoints||0;
  const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
  const absDates=ro?ro.absDates:rec.absenceDates||[];
  const pS=partScore(pPts), dS=discScore(incs), aS=absScore(absDates);
  const rowMock={hw:{value:hw},copy:{value:copy},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absDates:absDates};
  const fin=calcFinal(rowMock);
  profileForPrint={cls,n,name,hw,copy,t1,t2,glob,pPts,pS,dS,aS,incs,absDates,fin};
  const body=document.getElementById('profileBody');
  body.innerHTML=`
    <div class="profile-final">
      <div class="big ${gradeClass(fin)}">${fin.toFixed(2)}<span class="out20">/20</span></div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
    </div>
    <div class="profile-grid">
      <div class="profile-card">
        <h4>Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ…Ø±</h4>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span><span class="val">${hw||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ø¯ÙØªØ±</span><span class="val">${copy||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</span><span class="val">${pPts} Ù†Ù‚Ø·Ø© â†’ ${pS.toFixed(1)}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</span><span class="val">${dS.toFixed(1)}/20 (${incs.length} Ø­.)</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„ØºÙŠØ§Ø¨</span><span class="val">${absDates.length} ÙŠÙˆÙ… â†’ ${aS.toFixed(1)}/20</span></div>
      </div>
      <div class="profile-card">
        <h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±ÙˆØ¶</h4>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø£ÙˆÙ„</span><span class="val">${t1||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø«Ø§Ù†ÙŠ</span><span class="val">${t2||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="val">${glob||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</span><span class="val" style="color:var(--gold2)">${cls}</span></div>
      </div>
    </div>
    ${incs.length?`<div class="profile-card"><h4 style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:8px;direction:rtl">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h4><div class="rpt-incidents" style="color:var(--muted2);direction:rtl">${incs.map(x=>`${x.date}: ${x.label}`).join('<br/>')}</div></div>`:''}`;
  document.getElementById('profileOverlay').classList.add('show');
}
function closeProfile(){ document.getElementById('profileOverlay').classList.remove('show'); profileCtx=null; profileForPrint=null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARABIC REPORT PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printArabicReport(){
  if(!profileForPrint) return;
  const {cls,n,name,hw,copy,t1,t2,glob,pPts,pS,dS,aS,incs,absDates,fin} = profileForPrint;
  const s=loadSettings();
  const year=s.academicYear||'2025â€“2026';
  const today=todayISO();
  const incHTML=incs.length
    ? incs.map(x=>`<tr><td>${x.date}</td><td>${x.label}</td><td style="color:#c0392b">âˆ’${x.penalty}</td></tr>`).join('')
    : '<tr><td colspan="3" style="color:#999;text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</td></tr>';
  const absHTML=absDates.length?absDates.join(' â€¢ '):'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù…Ø³Ø¬Ù„';
  const w=getW();
  const grade=fin>=16?'Ù…Ù…ØªØ§Ø²':fin>=14?'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹':fin>=12?'Ø¬ÙŠØ¯':fin>=10?'Ù…Ù‚Ø¨ÙˆÙ„':'Ø¶Ø¹ÙŠÙ';
  const winHTML=`<!DOCTYPE html><html dir="rtl" lang="ar">
<head><meta charset="utf-8"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'IBM Plex Sans Arabic',sans-serif;background:#f4f4f4;padding:20px;direction:rtl}
  .page{max-width:780px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1)}
  .header{background:linear-gradient(135deg,#1a2d5a,#2d4a8f);color:#fff;padding:24px 30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .header h1{font-size:20px;font-weight:700;margin-bottom:4px}
  .header .sub{font-size:12px;opacity:.8}
  .header .school{text-align:left;font-size:12px;opacity:.85;line-height:1.6}
  .gold-bar{height:5px;background:linear-gradient(90deg,#c9a84c,#e8c870,#c9a84c)}
  .body{padding:24px 30px}
  .student-banner{background:linear-gradient(135deg,#f8f4e8,#fff9ef);border:2px solid #c9a84c;border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .student-name{font-size:20px;font-weight:700;color:#1a2d5a}
  .student-meta{font-size:13px;color:#666;margin-top:3px}
  .final-box{text-align:center;background:#1a2d5a;color:#fff;border-radius:10px;padding:12px 20px;min-width:120px}
  .final-num{font-size:32px;font-weight:700;line-height:1}
  .final-grade{font-size:13px;opacity:.85;margin-top:4px}
  .final-box.good{background:#27ae60}
  .final-box.mid{background:#e67e22}
  .final-box.low{background:#c0392b}
  section{margin-bottom:18px}
  section h2{font-size:14px;font-weight:700;color:#1a2d5a;border-bottom:2px solid #c9a84c;padding-bottom:6px;margin-bottom:10px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th{background:#1a2d5a;color:#fff;padding:9px 12px;text-align:right;font-weight:600;font-size:12px}
  td{padding:8px 12px;border-bottom:1px solid #eee;vertical-align:middle}
  tr:nth-child(even) td{background:#fafafe}
  .score{font-weight:700;color:#1a2d5a}
  .score.ok{color:#27ae60}
  .score.warn{color:#e67e22}
  .score.bad{color:#c0392b}
  .note-box{background:#fff9e6;border:1px solid #f0c040;border-radius:8px;padding:12px 16px;font-size:12px;color:#555;line-height:1.7}
  .sigs{display:flex;justify-content:space-between;margin-top:24px;gap:20px;flex-wrap:wrap}
  .sig{text-align:center;min-width:180px}
  .sig-title{font-size:12px;color:#666;margin-bottom:28px}
  .sig-line{border-top:1px solid #999;width:180px;margin:0 auto;padding-top:4px;font-size:11px;color:#999}
  .footer{background:#f0f0f0;padding:10px 20px;text-align:center;font-size:11px;color:#888;margin-top:4px}
  @media print{body{background:#fff;padding:0}.page{box-shadow:none;border-radius:0}}
</style>
</head>
<body><div class="page">
  <div class="header">
    <div>
      <h1>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠ Ù„Ù„ØªÙ„Ù…ÙŠØ°</h1>
      <div class="sub">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ${year} Â· ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${today}</div>
    </div>
    <div class="school">
      Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©<br/>
      Ø³Ø§ÙŠØ³ â€“ ÙØ§Ø³<br/>
      Ù…Ø§Ø¯Ø©: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    </div>
  </div>
  <div class="gold-bar"></div>
  <div class="body">
    <div class="student-banner">
      <div>
        <div class="student-name">${name}</div>
        <div class="student-meta">Ø§Ù„Ø±Ù‚Ù…: ${n} Â· Ø§Ù„Ù‚Ø³Ù…: ${cls}</div>
      </div>
      <div class="final-box ${gradeClass(fin)}">
        <div class="final-num">${fin.toFixed(2)}</div>
        <div class="final-grade">${grade}</div>
      </div>
    </div>

    <section>
      <h2>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±ÙˆØ¶ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ø¹Ù†ØµØ±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 20</th><th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th></tr></thead>
        <tbody>
          <tr><td>Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø£ÙˆÙ„</td><td class="score ${t1>=10?'ok':'bad'}">${t1||'â€”'}</td><td>${Math.round(w.t1*100)}%</td></tr>
          <tr><td>Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø«Ø§Ù†ÙŠ</td><td class="score ${t2>=10?'ok':'bad'}">${t2||'â€”'}</td><td>${Math.round(w.t2*100)}%</td></tr>
          <tr><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td class="score ${glob>=10?'ok':'bad'}">${glob||'â€”'}</td><td>${Math.round(w.glob*100)}%</td></tr>
        </tbody>
      </table>
    </section>

    <section>
      <h2>ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ…Ø±</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ø¹Ù†ØµØ±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© / Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„ØªØ­ÙˆÙŠÙ„ /20</th><th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th></tr></thead>
        <tbody>
          <tr><td>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</td><td>${hw||'â€”'}</td><td class="score ${hw>=10?'ok':'bad'}">${hw||'â€”'}</td><td>${Math.round(w.hw*100)}%</td></tr>
          <tr><td>Ø¯ÙØªØ± Ø§Ù„Ø¯Ø±ÙˆØ³</td><td>${copy||'â€”'}</td><td class="score ${copy>=10?'ok':'bad'}">${copy||'â€”'}</td><td>${Math.round(w.copy*100)}%</td></tr>
          <tr><td>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙÙŠØ©</td><td>${pPts} Ù†Ù‚Ø·Ø©</td><td class="score ${pS>=10?'ok':'bad'}">${pS.toFixed(2)}</td><td>${Math.round(w.part*100)}%</td></tr>
          <tr><td>Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ</td><td>${incs.length} Ù…Ù„Ø§Ø­Ø¸Ø©</td><td class="score ${dS>=16?'ok':dS>=10?'warn':'bad'}">${dS.toFixed(2)}</td><td>${Math.round(w.disc*100)}%</td></tr>
          <tr><td>Ø§Ù„ØºÙŠØ§Ø¨</td><td>${absDates.length} ÙŠÙˆÙ…</td><td class="score ${aS>=16?'ok':aS>=10?'warn':'bad'}">${aS.toFixed(2)}</td><td>${Math.round(w.abs*100)}%</td></tr>
        </tbody>
      </table>
    </section>

    ${incs.length?`<section>
      <h2>âš ï¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h2>
      <table>
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø§Ù„Ø®ØµÙ…</th></tr></thead>
        <tbody>${incHTML}</tbody>
      </table>
    </section>`:''}

    <section>
      <h2>ğŸ“… Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h2>
      <div class="note-box">${absHTML}</div>
    </section>

    <section>
      <h2>ğŸ’¬ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°</h2>
      <div class="note-box" style="min-height:60px">
        ${fin>=16?'Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¦Ø¹.':fin>=12?'Ù…Ø³ØªÙˆÙ‰ Ø¬ÙŠØ¯ØŒ Ø¨Ø°Ù„ Ù…Ø¬Ù‡ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„ÙØ±ÙˆØ¶ Ø³ÙŠØ­Ø³Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©.':fin>=10?'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©ØŒ Ù„ÙƒÙ† ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø©.':'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„ØŒ ÙŠÙ„Ø²Ù… ØªØ¯Ø§Ø±Ùƒ Ø§Ù„ÙˆØ¶Ø¹ Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ù….'}
      </div>
    </section>

    <div class="sigs">
      <div class="sig"><div class="sig-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø£Ø³ØªØ§Ø°</div><div class="sig-line"></div></div>
      <div class="sig"><div class="sig-title">ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div><div class="sig-line"></div></div>
      <div class="sig"><div class="sig-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div><div class="sig-line"></div></div>
    </div>
  </div>
  <div class="footer">ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ© ØµØ§Ø¯Ø±Ø© Ø¹Ù† Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ© Â· ${today}</div>
</div>
<script>window.onload=()=>window.print();<\/script>
</body></html>`;
  const w2=window.open('','_blank');
  if(w2){ w2.document.write(winHTML); w2.document.close(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASS REPORT PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPrintAllReport(cls){
  const st=loadCls(cls); const names=DATA[cls]||[];
  const s=loadSettings(); const year=s.academicYear||'2025â€“2026'; const today=todayISO();
  const rows=names.map((_,idx)=>{
    const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
    const ro=_rows[cls]?.find(r=>r.n===n)?.rowObj;
    const hw=ro?num(ro.hw.value):num(rec.scores?.hw);
    const t1=ro?num(ro.t1.value):num(rec.scores?.t1);
    const t2=ro?num(ro.t2.value):num(rec.scores?.t2);
    const glob=ro?num(ro.glob.value):num(rec.scores?.glob);
    const pPts=ro?ro.partPoints:rec.participationPoints||0;
    const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
    const abs=ro?ro.absDates:rec.absenceDates||[];
    const rowMock={hw:{value:hw},copy:{value:ro?num(ro.copy.value):num(rec.scores?.copy)},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absDates:abs};
    const fin=calcFinal(rowMock);
    return {n,name:rec.name||names[idx],t1,t2,glob,pPts,incs:incs.length,abs:abs.length,fin};
  });
  const trs=rows.map(r=>`<tr><td>${r.n}</td><td style="font-weight:600">${r.name}</td><td>${r.t1||'â€”'}</td><td>${r.t2||'â€”'}</td><td>${r.glob||'â€”'}</td><td>${r.pPts}</td><td style="color:${r.incs>2?'#c0392b':r.incs>0?'#e67e22':'#27ae60'}">${r.incs}</td><td style="color:${r.abs>=5?'#c0392b':r.abs>0?'#e67e22':'#27ae60'}">${r.abs}</td><td style="font-weight:700;color:${r.fin>=16?'#27ae60':r.fin>=10?'#e67e22':'#c0392b'}">${r.fin.toFixed(2)}</td></tr>`).join('');
  const avg=rows.reduce((a,r)=>a+r.fin,0)/(rows.length||1);
  const winHTML=`<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="utf-8"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet"/>
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</title>
<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:'IBM Plex Sans Arabic',sans-serif;background:#f4f4f4;padding:20px;direction:rtl}.page{max-width:960px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1)}.header{background:linear-gradient(135deg,#1a2d5a,#2d4a8f);color:#fff;padding:20px 28px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}.header h1{font-size:18px;font-weight:700;margin-bottom:4px}.header .sub{font-size:12px;opacity:.8}.gold-bar{height:4px;background:linear-gradient(90deg,#c9a84c,#e8c870,#c9a84c)}.body{padding:20px 28px}table{width:100%;border-collapse:collapse;font-size:12px}th{background:#1a2d5a;color:#fff;padding:9px 10px;text-align:right;font-size:11px;font-weight:600}td{padding:8px 10px;border-bottom:1px solid #eee}tr:nth-child(even) td{background:#fafafe}.footer{background:#f0f0f0;padding:10px 20px;text-align:center;font-size:11px;color:#888}.avg-box{display:inline-block;background:#1a2d5a;color:#fff;border-radius:10px;padding:8px 16px;margin-bottom:14px;font-size:14px;font-weight:700}@media print{body{background:#fff;padding:0}.page{box-shadow:none;border-radius:0}}</style>
</head><body><div class="page">
<div class="header"><div><h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù… Â· ${cls}</h1><div class="sub">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ${year} Â· ØªØ§Ø±ÙŠØ®: ${today} Â· ${rows.length} ØªÙ„Ù…ÙŠØ°Ø§Ù‹</div></div><div style="font-size:12px;opacity:.85;text-align:left">Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©<br/>Ù…Ø§Ø¯Ø©: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</div></div>
<div class="gold-bar"></div>
<div class="body">
<div class="avg-box">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø³Ù…: ${avg.toFixed(2)} / 20</div>
<table><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th>Ù1</th><th>Ù2</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th><th>Ø¥Ù†Ø°Ø§Ø±Ø§Øª</th><th>ØºÙŠØ§Ø¨</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th></tr></thead>
<tbody>${trs}</tbody></table>
<div style="margin-top:20px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:16px">
<div style="text-align:center;min-width:180px"><div style="font-size:12px;color:#666;margin-bottom:24px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø£Ø³ØªØ§Ø°</div><div style="border-top:1px solid #999;width:180px;margin:0 auto;padding-top:4px;font-size:11px;color:#999"></div></div>
<div style="text-align:center;min-width:180px"><div style="font-size:12px;color:#666;margin-bottom:24px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div><div style="border-top:1px solid #999;width:180px;margin:0 auto;padding-top:4px;font-size:11px;color:#999"></div></div>
</div></div>
<div class="footer">ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ© ØµØ§Ø¯Ø±Ø© Ø¹Ù† Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ© Â· ${today}</div>
</div><script>window.onload=()=>window.print();<\/script></body></html>`;
  const w=window.open('','_blank');
  if(w){ w.document.write(winHTML); w.document.close(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP & RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function backupData(){
  const data={};
  classNames.forEach(cls=>{ data[cls]=loadCls(cls); });
  data._settings=loadSettings();
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='gradebook_backup_'+todayISO()+'.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showToast('ğŸ’¾ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
}

function restoreData(e){
  const file=e.target.files?.[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      classNames.forEach(cls=>{ if(data[cls]) saveCls(cls,data[cls]); });
      if(data._settings) localStorage.setItem(SS,JSON.stringify(data._settings));
      loadSettingsUI(); updateWeights();
      showToast('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      renderOverview();
    }catch(err){ showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'); }
  };
  reader.readAsText(file);
  e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(cls){
  const st=loadCls(cls); const names=DATA[cls]||[];
  const headers=['Ø§Ù„Ù‚Ø³Ù…','#','Ø§Ù„Ø§Ø³Ù…','Ù1','Ù2','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø§Ù„ÙˆØ§Ø¬Ø¨','Ø§Ù„Ø¯ÙØªØ±','Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©','Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©','Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·','Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨','Ø¯Ø±Ø¬Ø© Ø§Ù„ØºÙŠØ§Ø¨','Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'];
  const lines=[headers.join(',')];
  names.forEach((_,idx)=>{
    const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
    const ro=_rows[cls]?.find(r=>r.n===n)?.rowObj;
    const hw=ro?num(ro.hw.value):num(rec.scores?.hw);
    const copy=ro?num(ro.copy.value):num(rec.scores?.copy);
    const t1=ro?num(ro.t1.value):num(rec.scores?.t1);
    const t2=ro?num(ro.t2.value):num(rec.scores?.t2);
    const glob=ro?num(ro.glob.value):num(rec.scores?.glob);
    const pPts=ro?ro.partPoints:rec.participationPoints||0;
    const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
    const abs=ro?ro.absDates:rec.absenceDates||[];
    const rm={hw:{value:hw},copy:{value:copy},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absDates:abs};
    lines.push([cls,n,`"${(rec.name||names[idx]).replace(/"/g,'""')}"`,t1,t2,glob,hw,copy,pPts,partScore(pPts).toFixed(2),discScore(incs).toFixed(2),abs.length,absScore(abs).toFixed(2),calcFinal(rm).toFixed(2)].join(','));
  });
  const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=cls+'_grades.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('ğŸ“Š ØªÙ… ØªØµØ¯ÙŠØ± '+cls);
}

function clearClass(cls){
  if(!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª '+cls+'ØŸ')) return;
  localStorage.removeItem(SK(cls));
  if(_rows[cls]) _rows[cls]=[];
  renderClassPage(cls);
  showToast('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª '+cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECTOR MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleProjector(){
  document.body.classList.toggle('proj');
  const on=document.body.classList.contains('proj');
  document.getElementById('projBtn').classList.toggle('lit',on);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeIfBg(e,id){ if(e.target.id===id) document.getElementById(id).classList.remove('show'); }

let _toastTimer=null;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  if(_toastTimer) clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

// Projector mode CSS
const projStyle=document.createElement('style');
projStyle.textContent=`
body.proj{--bg:#f8f9ff;--bg2:#f0f4ff;--panel:#fff;--card:#fff;--border:rgba(0,0,0,.1);--border2:rgba(0,0,0,.18);--text:#0d1527;--muted:#5a6a8a;--muted2:#334466;--gold:#7a5a00;--gold2:#5a4200;}
body.proj .sidebar{background:#f0f4ff;border-color:#ccd;}
body.proj .topbar{background:rgba(248,249,255,.96);}
body.proj thead th{background:#1a2d5a;color:#e8eeff;border-bottom-color:rgba(201,168,76,.5);}
body.proj tbody tr:nth-child(odd) td{background:#f9faff !important;}
body.proj tbody tr:nth-child(even) td{background:#f2f4fc !important;}
body.proj tbody tr:hover td{background:#e8eeff !important;}
body.proj tbody tr.at-risk td{background:rgba(244,63,94,.06) !important;}
body.proj .name-inp{color:#0d1527;}
body.proj .score-inp{background:#fff;color:#0d1527;border-color:#c0cce0;}
body.proj .final-score.good{color:#166534;background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.3);}
body.proj .final-score.mid{color:#92400e;background:rgba(251,191,36,.18);border-color:rgba(251,191,36,.3);}
body.proj .final-score.low{color:#9f1239;background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.25);}
body.proj td{border-right-color:rgba(0,0,0,.05);}
body.proj td.name-cell{border-right-color:rgba(61,127,255,.25) !important;}
`;
document.head.appendChild(projStyle);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY ABSENCE REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _absReportCls = null;
let _absReportText = '';

function openAbsReport(cls){
  _absReportCls = cls;
  const st = loadCls(cls);
  const names = DATA[cls]||[];
  const today = todayISO();
  const now = new Date();
  const hhmm = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const s = loadSettings();
  const year = s.academicYear||'2025â€“2026';

  // Collect absent students
  const absent = [];
  names.forEach((_,idx)=>{
    const n = idx+1;
    const rec = getStudentRecord(st, n, names[idx]);
    if((rec.absenceDates||[]).includes(today)){
      absent.push({ n, name: rec.name||names[idx] });
    }
  });

  document.getElementById('absReportTitle').textContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Â· ${cls}`;
  document.getElementById('absReportSub').textContent = `${today} Â· ${hhmm} Â· ${absent.length} ØºØ§Ø¦Ø¨`;

  const body = document.getElementById('absReportBody');

  if(absent.length === 0){
    body.innerHTML = `
      <div style="text-align:center;padding:32px 20px;direction:rtl">
        <div style="font-size:48px;margin-bottom:12px">âœ…</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:6px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
        <div style="font-size:13px;color:var(--muted)">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø§Ø¶Ø±ÙˆÙ†</div>
      </div>`;
    document.getElementById('absReportCopyBtn').style.display='none';
    _absReportText = '';
  } else {
    // Build the report card
    const rows = absent.map(a=>
      `<div class="abs-report-row">
        <span class="abs-report-num">${a.n}</span>
        <span class="abs-report-name">${a.name}</span>
      </div>`
    ).join('');

    // Build plain text for copy/share
    _absReportText =
      `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨\n` +
      `Ø§Ù„Ù‚Ø³Ù…: ${cls}\n` +
      `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}   Ø§Ù„Ø³Ø§Ø¹Ø©: ${hhmm}\n` +
      `Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: ${year}\n` +
      `Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©\n` +
      `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
      `Ø¹Ø¯Ø¯ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†: ${absent.length}\n\n` +
      absent.map(a=>`${a.n}. ${a.name}`).join('\n') +
      `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
      `Ø§Ù„Ø£Ø³ØªØ§Ø°: ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†`;

    body.innerHTML = `
      <div class="abs-report-card">
        <div class="abs-report-header">
          <div style="direction:rtl">
            <div style="font-size:11px;opacity:.8;margin-bottom:4px">Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©</div>
            <div style="font-size:15px;font-weight:700">Ø§Ù„Ù‚Ø³Ù…: ${cls}</div>
            <div style="font-size:12px;margin-top:3px;opacity:.8">${today} Â· ${hhmm}</div>
          </div>
          <div class="abs-count-badge">${absent.length}<div style="font-size:11px;font-weight:600;opacity:.85">ØºØ§Ø¦Ø¨</div></div>
        </div>
        <div class="abs-report-rows">${rows}</div>
      </div>`;
    document.getElementById('absReportCopyBtn').style.display='';
  }
  document.getElementById('absReportOverlay').classList.add('show');
  addSwipeToClose(document.getElementById('absReportSheet'), closeAbsReport);
}

function closeAbsReport(){
  document.getElementById('absReportOverlay').classList.remove('show');
  _absReportCls = null;
}

function copyAbsReport(){
  if(!_absReportText) return;
  if(navigator.share){
    navigator.share({ text: _absReportText }).catch(()=>fallbackCopy());
  } else {
    fallbackCopy();
  }
}
function fallbackCopy(){
  navigator.clipboard?.writeText(_absReportText)
    .then(()=>showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±'))
    .catch(()=>{
      // Last resort for older iOS
      const ta = document.createElement('textarea');
      ta.value = _absReportText;
      ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      try{ document.execCommand('copy'); showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±'); }
      catch(e){ showToast('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'); }
      ta.remove();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS SYNC ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GS_KEY = 'gbpro_gsurl';
const SECRET  = 'salah2026gradebook';
let _syncQueue = {};   // {cls_n: true} â€” pending syncs
let _syncTimer  = null;
let _syncing    = false;

function getGsUrl(){ return localStorage.getItem(GS_KEY)||''; }
function saveGsUrl(){
  const url = document.getElementById('gsUrl')?.value?.trim()||'';
  localStorage.setItem(GS_KEY, url);
  setGsStatus('', '');
}
function loadGsUrlUI(){
  const el = document.getElementById('gsUrl');
  if(el) el.value = getGsUrl();
}

function setGsStatus(msg, type){
  const el = document.getElementById('gsStatus');
  if(!el) return;
  const colors = { ok:'#42ba96', err:'#fb7185', warn:'#fbbf24', info:'var(--muted2)' };
  el.textContent = msg;
  el.style.color = colors[type]||colors.info;
}

// â”€â”€ CORE REQUEST â”€â”€
async function gsRequest(params){
  const url = getGsUrl();
  if(!url) return null;
  try{
    // NOTE: No Content-Type header â€” avoids CORS preflight which Google Apps Script doesn't support.
    // Sending as text/plain (default) bypasses preflight and works from any origin.
    const res = await fetch(url, {
      method: 'POST',
      body:   JSON.stringify({ key: SECRET, ...params })
    });
    return await res.json();
  }catch(e){ return null; }
}

// â”€â”€ TEST CONNECTION â”€â”€
async function testConnection(){
  const url = getGsUrl();
  if(!url){ setGsStatus('âš ï¸ No URL entered yet.','warn'); return; }
  setGsStatus('ğŸ”„ Testing connectionâ€¦','info');
  const btn = document.getElementById('testBtn');
  btn.textContent = 'â€¦'; btn.disabled = true;
  const res = await gsRequest({ action:'ping' });
  btn.textContent = 'ğŸ”— Test'; btn.disabled = false;
  if(res && res.ok){
    setGsStatus('âœ… Connected! Google Sheet is ready.','ok');
    showToast('âœ… Google Sheets connected!');
  } else if(res && res.error){
    setGsStatus('âŒ ' + res.error, 'err');
  } else {
    setGsStatus('âŒ Cannot reach the script. Check the URL and make sure you redeployed.','err');
  }
}

// â”€â”€ SYNC ONE STUDENT RECORD â”€â”€
async function syncRecord(cls, n){
  const st  = loadCls(cls);
  const rec = getStudentRecord(st, n, DATA[cls]?.[n-1]||'');
  await gsRequest({
    action: 'save', cls, n,
    name: rec.name||'',
    hw: rec.scores?.hw??'',   copy: rec.scores?.copy??'',
    t1: rec.scores?.t1??'',   t2:   rec.scores?.t2??'',
    glob: rec.scores?.glob??'',
    participationPoints: rec.participationPoints||0,
    disciplineIncidents: rec.disciplineIncidents||[],
    absenceDates:        rec.absenceDates||[]
  });
}

// â”€â”€ QUEUE DEBOUNCED SYNC (3 sec after last change) â”€â”€
function queueSync(cls, n){
  _syncQueue[cls+'_'+n] = {cls, n};
  if(_syncTimer) clearTimeout(_syncTimer);
  _syncTimer = setTimeout(flushSyncQueue, 3000);
}

async function flushSyncQueue(){
  if(!getGsUrl() || _syncing) return;
  _syncing = true;
  showSyncDot('pending');
  const items = Object.values(_syncQueue);
  _syncQueue  = {};
  for(const {cls,n} of items) await syncRecord(cls, n);
  _syncing = false;
  showSyncDot('ok');
}

function showSyncDot(state){
  const el = document.getElementById('syncDot');
  if(!el) return;
  if(state==='ok'){
    el.textContent='â˜ï¸'; el.title='Synced to Google Sheets';
    el.style.color='#42ba96'; el.style.opacity='1';
    setTimeout(()=>el.style.opacity='.35', 3000);
  } else if(state==='pending'){
    el.textContent='ğŸ”„'; el.title='Syncingâ€¦';
    el.style.color='#fbbf24'; el.style.opacity='1';
  }
}

// â”€â”€ PUSH ALL â€” force upload everything â”€â”€
async function pushAllToSheets(){
  const url = getGsUrl();
  if(!url){ setGsStatus('âš ï¸ Enter your Google Script URL first.','warn'); return; }
  const btn = document.getElementById('pushBtn');
  btn.textContent = 'â³ Pushingâ€¦'; btn.disabled = true;
  setGsStatus('ğŸ”„ Uploading all records to Google Sheetsâ€¦','info');
  showSyncDot('pending');
  let count = 0;
  for(const cls of classNames){
    for(let idx=0; idx<(DATA[cls]||[]).length; idx++){
      await syncRecord(cls, idx+1);
      count++;
    }
  }
  btn.textContent = 'â˜ï¸ Push All'; btn.disabled = false;
  setGsStatus('âœ… ' + count + ' records pushed to Google Sheets.','ok');
  showToast('â˜ï¸ All data synced to Google Sheets');
  showSyncDot('ok');
}

// â”€â”€ PULL â€” load all data from sheet on startup â”€â”€
async function pullFromSheets(){
  if(!getGsUrl()) return;
  showSyncDot('pending');
  const res = await gsRequest({ action:'loadAll' });
  if(!res || !res.ok || !Array.isArray(res.data) || !res.data.length){
    showSyncDot('ok'); return;
  }
  res.data.forEach(row=>{
    const cls = row.cls;
    const n   = parseInt(row.n);
    if(!cls || !n || !DATA[cls]) return;
    const st  = loadCls(cls);
    const rec = getStudentRecord(st, n, DATA[cls][n-1]||'');
    if(row.name) rec.name = row.name;
    rec.scores = {
      hw: row.hw??'', copy: row.copy??'',
      t1: row.t1??'', t2: row.t2??'',
      glob: row.glob??''
    };
    rec.participationPoints = parseInt(row.participationPoints)||0;
    rec.disciplineIncidents = Array.isArray(row.disciplineIncidents)?row.disciplineIncidents:[];
    rec.absenceDates        = Array.isArray(row.absenceDates)?row.absenceDates:[];
    try{ localStorage.setItem(SK(cls), JSON.stringify(st)); }catch(e){}
  });
  showToast('âœ… Data loaded from Google Sheets');
  showSyncDot('ok');
  if(currentClass) renderClassPage(currentClass);
  renderOverview();
  updateRiskCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE INDICATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastSaved = null;
let _saveTimer = null;
let _unsavedChanges = false;

function showSaveIndicator(){
  _lastSaved = new Date();
  _unsavedChanges = false;
  const icon = document.getElementById('saveIcon');
  const text = document.getElementById('saveText');
  const bar  = document.getElementById('saveIndicator');
  const btn  = document.getElementById('manualSaveBtn');
  if(!icon||!text||!bar) return;
  // Flash green
  icon.textContent = 'âœ…';
  text.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
  bar.style.borderColor = 'rgba(34,197,94,.4)';
  bar.style.background   = 'rgba(34,197,94,.1)';
  bar.style.color        = 'var(--green)';
  if(btn){ btn.style.borderColor='rgba(34,197,94,.4)'; btn.style.color='var(--green)'; }
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=>{
    const t = _lastSaved;
    const h = t.getHours().toString().padStart(2,'0');
    const m = t.getMinutes().toString().padStart(2,'0');
    icon.textContent = 'âœ…';
    text.textContent = 'Ø¢Ø®Ø± Ø­ÙØ¸ ' + h + ':' + m;
    bar.style.borderColor = 'rgba(34,197,94,.2)';
    bar.style.background   = 'rgba(34,197,94,.06)';
    bar.style.color        = 'var(--green)';
    if(btn){ btn.style.borderColor=''; btn.style.color=''; }
  }, 1800);
}

function markUnsaved(){
  _unsavedChanges = true;
  const icon = document.getElementById('saveIcon');
  const text = document.getElementById('saveText');
  const bar  = document.getElementById('saveIndicator');
  const btn  = document.getElementById('manualSaveBtn');
  if(!icon||!text||!bar) return;
  icon.textContent = 'âœï¸';
  text.textContent = 'ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©';
  bar.style.borderColor = 'rgba(245,158,11,.35)';
  bar.style.background   = 'rgba(245,158,11,.08)';
  bar.style.color        = 'var(--amber)';
  if(btn){ btn.style.borderColor='rgba(245,158,11,.4)'; btn.style.color='var(--amber)'; }
}

function showSaveError(){
  const icon = document.getElementById('saveIcon');
  const text = document.getElementById('saveText');
  const bar  = document.getElementById('saveIndicator');
  if(!icon||!text||!bar) return;
  icon.textContent = 'âŒ';
  text.textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸!';
  bar.style.borderColor = 'rgba(244,63,94,.4)';
  bar.style.background   = 'rgba(244,63,94,.1)';
  bar.style.color        = 'var(--red)';
  showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø©');
}

function manualSave(){
  // Force-save the current class if open
  if(currentClass && _rows[currentClass]){
    const st = loadCls(currentClass);
    const names = DATA[currentClass]||[];
    _rows[currentClass].forEach(({rowObj, n})=>{
      const rec = getStudentRecord(st, n, names[n-1]);
      rec.name = rowObj.nameInp.value;
      rec.scores = {
        hw: rowObj.hw.value, copy: rowObj.copy.value,
        t1: rowObj.t1.value, t2: rowObj.t2.value, glob: rowObj.glob.value
      };
      rec.participationPoints = rowObj.partPoints;
      rec.disciplineIncidents = rowObj.discIncidents;
      rec.absenceDates = rowObj.absDates;
    });
    saveCls(currentClass, st);
  }
  saveSettings();
  showToast('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

// Warn before leaving if unsaved
window.addEventListener('beforeunload', e=>{
  if(_unsavedChanges){
    e.preventDefault();
    e.returnValue = 'Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// iPHONE SWIPE-DOWN TO CLOSE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSwipeToClose(sheetEl, closeFn){
  let startY = 0, isDragging = false;
  sheetEl.addEventListener('touchstart', e=>{
    startY = e.touches[0].clientY;
    isDragging = true;
  }, {passive: true});
  sheetEl.addEventListener('touchmove', e=>{
    if(!isDragging) return;
    const dy = e.touches[0].clientY - startY;
    if(dy > 0) sheetEl.style.transform = `translateY(${dy}px)`;
  }, {passive: true});
  sheetEl.addEventListener('touchend', e=>{
    if(!isDragging) return;
    isDragging = false;
    const dy = e.changedTouches[0].clientY - startY;
    if(dy > 80){ sheetEl.style.transform=''; closeFn(); }
    else{ sheetEl.style.transition='transform .2s'; sheetEl.style.transform=''; setTimeout(()=>sheetEl.style.transition='',200); }
  }, {passive: true});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  loadSettingsUI();
  loadGsUrlUI();
  updateWeights();
  buildSidebarNav();
  buildClassPageContainers();
  renderOverview();
  updateRiskCount();
  // Pull latest data from Google Sheets on startup (if URL is set)
  if(getGsUrl()) pullFromSheets();
  // iPhone swipe-down to close all sheets
  const sheets = document.querySelectorAll('.sheet');
  sheets.forEach(s=>{
    const overlay = s.closest('.overlay');
    if(!overlay) return;
    const id = overlay.id;
    const closers = { discOverlay: closeDisc, absOverlay: closeAbs };
    if(closers[id]) addSwipeToClose(s, closers[id]);
  });
});
</script>
</body>
</html>
