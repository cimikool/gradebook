<!doctype html>
<html lang="ar" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° â€” Gradebook Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ iOS GLOBAL INPUT FIXES â”€â”€ */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
/* iOS: remove default button styling */
button { -webkit-appearance: none; appearance: none; font-family: var(--font-ar); }
/* iOS: prevent callout on long press */
img, button, a { -webkit-touch-callout: none; }
/* iOS: smooth momentum on all scrollable areas */
* { -webkit-overflow-scrolling: touch; }
/* iOS: fix select highlight */
select { -webkit-appearance: none; appearance: none; }

:root {
  --bg: #080e1e;
  --bg2: #0c1428;
  --panel: #101e36;
  --card: #122040;
  --border: rgba(255,255,255,.08);
  --border2: rgba(255,255,255,.14);
  --text: #e4ecff;
  --muted: #5e7aa8;
  --muted2: #8aa0c4;
  --gold: #c9a84c;
  --gold2: #e8c870;
  --accent: #3d7fff;
  --green: #22c55e;
  --red: #f43f5e;
  --amber: #f59e0b;
  --cyan: #06b6d4;
  --radius: 16px;
  --font-ar: 'IBM Plex Sans Arabic', sans-serif;
  --font-display: 'Playfair Display', serif;
  --font-mono: 'IBM Plex Mono', monospace;
  --sidebar-w: 220px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height: -webkit-fill-available;}
body{
  font-family:var(--font-ar);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  min-height: -webkit-fill-available;
  background-image: radial-gradient(ellipse at 20% 0%, rgba(61,127,255,.07) 0%, transparent 60%),
                    radial-gradient(ellipse at 80% 100%, rgba(201,168,76,.05) 0%, transparent 60%);
  /* Prevent text size adjustment on iPhone rotation */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* â”€â”€ LAYOUT â”€â”€ */
.app {
  display:flex;
  height: 100vh;
  height: -webkit-fill-available;
  height: 100dvh;
  overflow:hidden;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: transform .3s ease;
  z-index: 50;
  /* iPhone safe area */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}
.sidebar-logo {
  padding: 20px 16px 14px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo .title {
  font-family: var(--font-display);
  font-size: 15px; font-weight: 700;
  color: var(--gold2);
  line-height: 1.3;
}
.sidebar-logo .subtitle {
  font-size: 11px; color: var(--muted); margin-top: 3px;
  font-family: var(--font-ar);
}
.sidebar-nav { padding: 10px 8px; overflow-y: auto; flex:1; -webkit-overflow-scrolling: touch; }
.nav-section-label {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1.2px; color: var(--muted);
  padding: 10px 8px 6px;
}
.nav-btn {
  width: 100%; text-align: left; cursor: pointer;
  padding: 11px 12px; border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--muted2); font-family: var(--font-ar);
  font-size: 13px; font-weight: 600;
  margin: 2px 0;
  display: flex; align-items: center; gap: 9px;
  transition: all .15s;
}
.nav-btn .icon { font-size: 16px; opacity: .8; }
.nav-btn:hover { background: rgba(255,255,255,.05); color: var(--text); }
.nav-btn.active {
  background: rgba(61,127,255,.15);
  border-color: rgba(61,127,255,.35);
  color: var(--text);
}
.nav-btn .badge-count {
  margin-left: auto;
  font-size: 10px; font-weight: 700;
  background: rgba(255,255,255,.1);
  padding: 2px 6px; border-radius: 99px; color: var(--muted2);
}
.nav-btn.active .badge-count { background: rgba(61,127,255,.3); color: var(--accent); }
.nav-btn.danger-btn .badge-count { background: rgba(244,63,94,.25); color: var(--red); }

.sidebar-bottom {
  padding: 12px 8px;
  border-top: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 6px;
}
.sidebar-bottom .nav-btn { font-size: 12px; }

/* â”€â”€ MAIN â”€â”€ */
.main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  padding: 14px 20px;
  padding-top: calc(14px + env(safe-area-inset-top));
  border-bottom: 1px solid var(--border);
  background: rgba(8,14,30,.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  display: flex; align-items: center; gap: 10px;
  min-height: 62px;
  flex-shrink: 0;
  /* Prevent topbar from being clipped */
  position: relative; z-index: 10;
}
.topbar-title {
  font-family: var(--font-display);
  font-size: 17px; font-weight: 700; color: var(--gold2);
  flex: 1;
}
.topbar-meta { font-size: 12px; color: var(--muted); }
.ham-btn {
  display: none;
  width: 40px; height: 40px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05);
  border-radius: 12px; color: var(--text);
  font-size: 18px; cursor: pointer;
  align-items: center; justify-content: center;
}
.icon-btn {
  width: 40px; height: 40px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05);
  border-radius: 12px; color: var(--muted2);
  font-size: 17px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.icon-btn:hover { border-color: var(--border2); color: var(--text); background: rgba(255,255,255,.09); }
.icon-btn:active { transform: scale(.92); }
.icon-btn.lit { border-color: rgba(61,127,255,.4); background: rgba(61,127,255,.15); color: var(--accent); }

/* â”€â”€ PAGE VIEWS â”€â”€ */
.page {
  display:none; flex-direction:column;
  flex:1; overflow-y:auto; padding: 20px;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
  /* Fix: height must be constrained for scroll to work */
  height: 0;
  min-height: 0;
}
.page.active { display: flex; }

/* â”€â”€ OVERVIEW / DASHBOARD â”€â”€ */
.dash-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.dash-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  cursor: pointer;
  transition: all .2s;
  position: relative; overflow: hidden;
}
.dash-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--cyan));
  opacity: 0;
  transition: opacity .2s;
}
.dash-card:hover { border-color: var(--border2); transform: translateY(-2px); }
.dash-card:hover::before { opacity: 1; }
.dash-card .cls-name {
  font-family: var(--font-display);
  font-size: 20px; font-weight: 700; color: var(--gold2);
  margin-bottom: 4px;
}
.dash-card .cls-count { font-size: 13px; color: var(--muted); margin-bottom: 16px; }
.dash-abs-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-radius: 12px;
  background: rgba(255,255,255,.04); border: 1px solid var(--border);
  margin-bottom: 12px;
}
.dash-abs-lbl { font-size: 13px; color: var(--muted2); font-weight: 600; }
.dash-abs-val {
  font-family: var(--font-mono); font-size: 22px; font-weight: 800;
}
.dash-abs-val.good { color: var(--green); }
.dash-abs-val.mid  { color: var(--amber); }
.dash-abs-val.bad  { color: var(--red); }

.section-title {
  font-family: var(--font-display);
  font-size: 18px; font-weight: 700; color: var(--gold2);
  margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
}
.section-title::after {
  content: '';
  flex: 1; height: 1px;
  background: linear-gradient(90deg, var(--border2), transparent);
}

/* â”€â”€ SETTINGS CHIPS â”€â”€ */
.settings-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px;
  margin-bottom: 20px;
}
.settings-card {
  background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px;
}
.settings-card h4 { font-size: 12px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
.weight-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 6px 0; }
.weight-row label { font-size: 13px; color: var(--muted2); font-weight: 600; flex: 1; }
.weight-inp {
  width: 72px; padding: 7px 10px;
  border-radius: 10px; border: 1px solid var(--border2);
  background: rgba(0,0,0,.3); color: var(--text);
  font-family: var(--font-mono); font-size: 16px; font-weight: 600;
  outline: none; text-align: right;
  transition: border-color .15s;
  -webkit-appearance: none; appearance: none;
}
.weight-inp:focus { border-color: rgba(61,127,255,.5); }
.weight-total {
  text-align: right; font-family: var(--font-mono);
  font-size: 13px; font-weight: 700; margin-top: 8px;
  padding-top: 8px; border-top: 1px solid var(--border);
}
.weight-total.ok { color: var(--green); }
.weight-total.bad { color: var(--red); }

/* â”€â”€ CLASS TABLE VIEW â”€â”€ */
.class-toolbar {
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  margin-bottom: 14px;
}
.search-box {
  flex: 1; min-width: 180px;
  padding: 10px 14px; border-radius: 12px;
  border: 1px solid var(--border2);
  background: rgba(0,0,0,.25); color: var(--text);
  font-family: var(--font-ar); font-size: 16px; outline: none;
  transition: border-color .15s;
  -webkit-appearance: none; appearance: none;
}
.search-box:focus { border-color: rgba(61,127,255,.5); }
.search-box::placeholder { color: var(--muted); }
.tool-btn {
  padding: 10px 14px;
  border-radius: 12px; border: 1px solid var(--border2);
  background: rgba(255,255,255,.05); color: var(--muted2);
  font-family: var(--font-ar); font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all .15s; white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.tool-btn:hover { border-color: var(--border2); color: var(--text); background: rgba(255,255,255,.09); }
.tool-btn:active { transform: scale(.96); }
.tool-btn.primary {
  background: rgba(61,127,255,.15);
  border-color: rgba(61,127,255,.35); color: var(--accent);
}
.tool-btn.danger { background: rgba(244,63,94,.1); border-color: rgba(244,63,94,.3); color: var(--red); }

/* â”€â”€ STATS ROW â”€â”€ */
.stats-row {
  display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;
}
.stat-chip {
  padding: 8px 14px; border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  font-size: 12px; font-weight: 600; color: var(--muted2);
  display: flex; align-items: center; gap: 7px;
}
.stat-chip strong { font-size: 15px; font-family: var(--font-mono); color: var(--text); }
.stat-chip.green-chip { border-color: rgba(34,197,94,.2); background: rgba(34,197,94,.06); }
.stat-chip.green-chip strong { color: var(--green); }
.stat-chip.red-chip { border-color: rgba(244,63,94,.2); background: rgba(244,63,94,.06); }
.stat-chip.red-chip strong { color: var(--red); }
.stat-chip.gold-chip { border-color: rgba(201,168,76,.2); background: rgba(201,168,76,.06); }
.stat-chip.gold-chip strong { color: var(--gold2); }

/* â”€â”€ TABLE â”€â”€ */
.tablewrap {
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
table { width: 100%; border-collapse: collapse; min-width: 900px; }
thead th {
  padding: 11px 12px;
  background: #0a1628;
  border-bottom: 2px solid rgba(61,127,255,.25);
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .9px; color: #6b82a8;
  text-align: left; white-space: nowrap;
  position: sticky; top: 0; z-index: 2;
}
thead th:first-child { width: 42px; text-align: center; }
tbody tr {
  border-bottom: 1px solid rgba(255,255,255,.06);
  transition: background .1s;
}
tbody tr:nth-child(odd) td { background: rgba(255,255,255,.025); }
tbody tr:nth-child(even) td { background: rgba(0,0,0,.15); }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover td { background: rgba(61,127,255,.1) !important; }
tbody tr.at-risk td { background: rgba(244,63,94,.06) !important; }
tbody tr.at-risk:hover td { background: rgba(244,63,94,.12) !important; }
td {
  padding: 10px 12px;
  font-size: 13px; vertical-align: middle;
  border-right: 1px solid rgba(255,255,255,.04);
}
td:last-child { border-right: none; }
/* Name column gets a stronger left border as visual anchor */
td.name-cell {
  min-width: 190px; max-width: 230px;
  border-right: 2px solid rgba(61,127,255,.15) !important;
}
td.num { text-align: center; font-family: var(--font-mono); font-size: 13px; color: var(--muted); width: 42px; }
td.name-cell { min-width: 190px; max-width: 230px; }
.name-inp {
  width: 100%; padding: 8px 10px;
  border-radius: 10px; border: 1px solid transparent;
  background: transparent; color: #ffffff;
  font-family: var(--font-ar); font-size: 16px; font-weight: 700;
  outline: none; transition: all .15s;
  direction: rtl;
  letter-spacing: 0.2px;
  -webkit-appearance: none; appearance: none;
}
.name-inp:hover { border-color: var(--border); background: rgba(255,255,255,.06); }
.name-inp:focus { border-color: rgba(61,127,255,.5); background: rgba(0,0,0,.3); }
.name-inp::placeholder { color: var(--muted); font-weight: 400; }

/* Score input */
.score-inp {
  width: 62px; padding: 8px 4px;
  border-radius: 10px; border: 1px solid rgba(255,255,255,.1);
  background: rgba(0,0,0,.35); color: #dde8ff;
  font-family: var(--font-mono); font-size: 16px; font-weight: 600;
  outline: none; text-align: center; transition: all .15s;
  -webkit-appearance: none; appearance: none;
  display: block;
}
.score-inp:focus { border-color: rgba(61,127,255,.6); background: rgba(61,127,255,.1); color: #fff; }

/* Final score â€” pill style, hard to miss */
.final-score {
  font-family: var(--font-mono); font-size: 16px; font-weight: 800;
  text-align: center; min-width: 62px;
  padding: 6px 10px; border-radius: 10px;
  display: inline-block; letter-spacing: .3px;
}
.final-score.good { color: #4ade80; background: rgba(34,197,94,.15); border: 1px solid rgba(34,197,94,.25); }
.final-score.mid  { color: #fbbf24; background: rgba(251,191,36,.12); border: 1px solid rgba(251,191,36,.25); }
.final-score.low  { color: #fb7185; background: rgba(244,63,94,.15);  border: 1px solid rgba(244,63,94,.25); }

/* â”€â”€ PARTICIPATION CELL â”€â”€ */
.part-cell {
  display: flex; align-items: center; gap: 6px;
  white-space: nowrap;
}
.part-tap {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid rgba(6,182,212,.25);
  background: rgba(6,182,212,.08);
  color: var(--cyan); font-size: 17px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .15s; user-select: none; flex-shrink: 0;
}
.part-tap:active { transform: scale(.86); background: rgba(6,182,212,.22); }
.part-minus {
  width: 30px; height: 30px; border-radius: 8px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  color: var(--muted); font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .12s; user-select: none; flex-shrink: 0;
}
.part-minus:active { transform: scale(.86); }
.part-score {
  font-family: var(--font-mono); font-size: 14px; font-weight: 800;
  color: var(--cyan); min-width: 22px; text-align: center;
}

/* â”€â”€ DISCIPLINE CELL â”€â”€ */
.disc-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 11px; border-radius: 12px;
  border: 1px solid var(--border);
  font-size: 12px; font-weight: 700; cursor: pointer;
  transition: all .15s; white-space: nowrap;
  user-select: none;
}
.disc-badge:active { transform: scale(.95); }
.disc-badge.ok { border-color: rgba(34,197,94,.3); background: rgba(34,197,94,.1); color: var(--green); }
.disc-badge.warn { border-color: rgba(245,158,11,.3); background: rgba(245,158,11,.1); color: var(--amber); }
.disc-badge.danger { border-color: rgba(244,63,94,.3); background: rgba(244,63,94,.1); color: var(--red); }

/* â”€â”€ ABSENCE CELL â”€â”€ */
.abs-cell { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
.abs-tap {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,.1);
  background: rgba(255,255,255,.05);
  color: var(--muted); font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .15s; flex-shrink: 0;
  font-weight: 700;
}
.abs-tap.marked {
  border-color: rgba(244,63,94,.5);
  background: rgba(244,63,94,.18); color: #fb7185;
}
.abs-tap:active { transform: scale(.86); }
.abs-count {
  font-family: var(--font-mono); font-size: 14px; font-weight: 800;
  cursor: pointer; min-width: 24px; text-align: center;
  color: var(--muted2);
  padding: 3px 7px; border-radius: 8px;
  transition: all .15s;
}
.abs-count:hover { background: rgba(255,255,255,.08); color: var(--text); }
.abs-count.has-abs {
  color: #fb7185;
  background: rgba(244,63,94,.12);
  border: 1px solid rgba(244,63,94,.2);
}

/* â”€â”€ ABSENCE REPORT BUTTON (on dash cards) â”€â”€ */
.abs-report-btn {
  width: 100%; margin-top: 10px;
  padding: 11px 12px; border-radius: 12px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05);
  color: var(--muted2); font-family: var(--font-ar);
  font-size: 13px; font-weight: 700;
  cursor: pointer; text-align: center;
  transition: all .15s;
  display: block;
}
.abs-report-btn:active { transform: scale(.97); }
.abs-report-btn.has-absent {
  border-color: rgba(244,63,94,.4);
  background: rgba(244,63,94,.12);
  color: #fb7185;
}
.abs-report-btn.has-absent:hover {
  background: rgba(244,63,94,.2);
}

/* â”€â”€ ABSENCE REPORT CARD (inside modal) â”€â”€ */
.abs-report-card {
  border-radius: 14px;
  border: 1px solid var(--border2);
  overflow: hidden;
  background: rgba(0,0,0,.2);
}
.abs-report-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px;
  background: linear-gradient(135deg, #1a2d5a, #0f1e42);
  color: #fff; gap: 12px;
}
.abs-count-badge {
  background: rgba(244,63,94,.85);
  color: #fff; border-radius: 12px;
  padding: 8px 14px; text-align: center;
  font-family: var(--font-mono);
  font-size: 26px; font-weight: 800; line-height: 1;
  min-width: 64px;
  flex-shrink: 0;
}
.abs-report-rows { padding: 8px 0; }
.abs-report-row {
  display: flex; align-items: center; gap: 14px;
  padding: 11px 16px;
  border-bottom: 1px solid rgba(255,255,255,.06);
  direction: rtl;
}
.abs-report-row:last-child { border-bottom: none; }
.abs-report-num {
  font-family: var(--font-mono); font-size: 13px; font-weight: 700;
  color: #fb7185;
  background: rgba(244,63,94,.12);
  border: 1px solid rgba(244,63,94,.25);
  border-radius: 8px; padding: 3px 8px;
  min-width: 36px; text-align: center;
  flex-shrink: 0;
}
.abs-report-name {
  font-size: 15px; font-weight: 700; color: #fff;
  flex: 1;
}


.risk-flag {
  display: inline-flex; align-items: center;
  width: 22px; height: 22px;
  border-radius: 6px; font-size: 12px;
  justify-content: center;
}
.risk-flag.show { background: rgba(244,63,94,.2); }

/* â”€â”€ MODALS â”€â”€ */
.overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: none; align-items: flex-end; justify-content: center;
  /* iPhone: allow touch to pass through to close button */
  touch-action: none;
  /* Safe area aware */
  padding-bottom: 0;
}
.overlay.show { display: flex; }
.overlay.center { align-items: center; }
.sheet {
  width: 100%; max-width: 680px;
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 24px 24px 0 0;
  padding: 20px 20px;
  /* Safe area for iPhone home indicator */
  padding-bottom: calc(32px + env(safe-area-inset-bottom));
  max-height: 92vh;
  max-height: 92dvh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  animation: slideUp .25s cubic-bezier(.34,1.56,.64,1);
}
.sheet.wide { max-width: 900px; }
.dialog {
  width: min(600px,96vw);
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 20px;
  max-height: 90vh;
  max-height: 90dvh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  animation: popIn .2s cubic-bezier(.34,1.56,.64,1);
  margin: 10px;
}
@keyframes slideUp { from{transform:translateY(50px);opacity:0} to{transform:translateY(0);opacity:1} }
@keyframes popIn { from{transform:scale(.92);opacity:0} to{transform:scale(1);opacity:1} }
.sheet-handle {
  width: 40px; height: 4px; border-radius: 99px;
  background: var(--border2); margin: 0 auto 16px;
}
.sheet-title {
  font-family: var(--font-display);
  font-size: 18px; font-weight: 700; color: var(--gold2);
  margin-bottom: 4px;
  direction: rtl; text-align: right;
}
.sheet-sub { font-size: 12px; color: var(--muted); margin-bottom: 16px; direction: rtl; text-align: right; }
.close-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 14px; }
.x-btn {
  width: 36px; height: 36px; border-radius: 10px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05); color: var(--muted2);
  font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.x-btn:hover { color: var(--text); border-color: var(--border2); }

/* â”€â”€ DISCIPLINE MODAL â”€â”€ */
.inc-cats {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px; margin-bottom: 14px;
}
.cat-btn {
  padding: 12px 10px; border-radius: 14px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.04); color: var(--text);
  font-family: var(--font-ar); font-size: 12px; font-weight: 700;
  cursor: pointer; text-align: center; transition: all .15s;
  display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.cat-btn .cat-icon { font-size: 22px; }
.cat-btn:active { transform: scale(.94); }
.cat-btn.low-cat:active { background: rgba(245,158,11,.2); border-color: rgba(245,158,11,.4); }
.cat-btn.high-cat:active { background: rgba(244,63,94,.2); border-color: rgba(244,63,94,.4); }
.cat-btn.low-cat { border-color: rgba(245,158,11,.2); }
.cat-btn.high-cat { border-color: rgba(244,63,94,.2); }

.inc-log { display: flex; flex-direction: column; gap: 6px; }
.inc-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 12px; border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  gap: 10px;
}
.inc-item .inc-info { flex: 1; }
.inc-item .inc-label { font-size: 13px; font-weight: 600; direction: rtl; text-align: right; }
.inc-item .inc-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
.inc-item .rm-btn {
  padding: 5px 10px; border-radius: 8px;
  border: 1px solid rgba(244,63,94,.3);
  background: rgba(244,63,94,.1); color: var(--red);
  font-size: 11px; font-weight: 700; cursor: pointer;
}

/* â”€â”€ ABSENCE CALENDAR â”€â”€ */
.cal-nav {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 12px;
}
.cal-month-label {
  font-family: var(--font-display);
  font-size: 15px; font-weight: 700; color: var(--gold2);
}
.cal-arrow {
  width: 34px; height: 34px; border-radius: 10px;
  border: 1px solid var(--border2);
  background: rgba(255,255,255,.05); color: var(--muted2);
  font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.cal-arrow:hover { color: var(--text); }
.cal-grid {
  display: grid; grid-template-columns: repeat(7,1fr); gap: 5px;
}
.cal-day-lbl {
  text-align: center; font-size: 10px; font-weight: 700;
  color: var(--muted); padding: 4px 0; text-transform: uppercase;
}
.cal-cell {
  aspect-ratio: 1; border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; cursor: pointer;
  transition: all .15s;
}
.cal-cell.empty { opacity: .25; cursor: default; background: transparent; border-color: transparent; }
.cal-cell.today { border-color: rgba(61,127,255,.5); color: var(--accent); }
.cal-cell.absent { background: rgba(244,63,94,.2); border-color: rgba(244,63,94,.45); color: var(--red); }
.cal-cell:not(.empty):hover { border-color: var(--border2); }

/* â”€â”€ STUDENT PROFILE â”€â”€ */
.profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
@media(max-width:500px){ .profile-grid{grid-template-columns:1fr} }
.profile-card {
  background: rgba(0,0,0,.2); border: 1px solid var(--border);
  border-radius: 14px; padding: 14px;
}
.profile-card h4 { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 10px; }
.profile-row {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 13px; padding: 5px 0;
  border-bottom: 1px solid var(--border);
}
.profile-row:last-child { border-bottom: none; }
.profile-row .lbl { color: var(--muted2); }
.profile-row .val { font-family: var(--font-mono); font-weight: 700; }
.profile-final {
  text-align: center; padding: 16px;
  background: rgba(0,0,0,.25); border: 1px solid var(--border);
  border-radius: 14px; margin-bottom: 14px;
}
.profile-final .big {
  font-family: var(--font-display);
  font-size: 42px; font-weight: 700; line-height: 1;
}
.profile-final .big.good { color: var(--green); }
.profile-final .big.mid { color: var(--amber); }
.profile-final .big.low { color: var(--red); }
.profile-final .out20 { font-size: 18px; color: var(--muted); }

/* â”€â”€ AT-RISK PAGE â”€â”€ */
.risk-list { display: flex; flex-direction: column; gap: 10px; }
.risk-card {
  background: var(--panel); border: 1px solid rgba(244,63,94,.2);
  border-radius: var(--radius); padding: 14px;
  display: flex; gap: 14px; align-items: flex-start;
  cursor: pointer; transition: all .15s;
}
.risk-card:hover { border-color: rgba(244,63,94,.4); }
.risk-card .risk-num {
  font-family: var(--font-mono); font-size: 11px; color: var(--muted);
  min-width: 24px; text-align: center; padding-top: 2px;
}
.risk-card .risk-name {
  font-size: 15px; font-weight: 700; direction: rtl;
  margin-bottom: 6px;
}
.risk-card .risk-cls { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
.risk-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.risk-tag {
  padding: 3px 8px; border-radius: 99px;
  font-size: 11px; font-weight: 700;
}
.risk-tag.abs { background: rgba(244,63,94,.15); color: var(--red); }
.risk-tag.disc { background: rgba(245,158,11,.15); color: var(--amber); }
.risk-tag.grade { background: rgba(61,127,255,.15); color: var(--accent); }

/* â”€â”€ PRINT REPORT (Arabic) â”€â”€ */
.report-preview {
  background: #fff; color: #111;
  border-radius: var(--radius); padding: 0;
  font-family: var(--font-ar);
  direction: rtl;
  border: 1px solid var(--border2);
  overflow: hidden;
}
.rpt-header {
  background: #1a2d5a; color: #fff;
  padding: 20px 24px;
  text-align: center;
}
.rpt-header h1 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.rpt-header p { font-size: 12px; opacity: .8; }
.rpt-body { padding: 20px 24px; }
.rpt-section { margin-bottom: 18px; }
.rpt-section h2 {
  font-size: 14px; font-weight: 700; color: #1a2d5a;
  border-bottom: 2px solid #c9a84c; padding-bottom: 6px; margin-bottom: 10px;
}
.rpt-row {
  display: flex; justify-content: space-between;
  padding: 7px 10px; font-size: 13px;
  border-bottom: 1px solid #f0f0f0;
}
.rpt-row:nth-child(odd) { background: #f9f9ff; }
.rpt-row .key { color: #444; font-weight: 600; }
.rpt-row .value { font-weight: 700; color: #1a2d5a; }
.rpt-row .value.red { color: #c0392b; }
.rpt-row .value.green { color: #27ae60; }
.rpt-incidents { font-size: 12px; line-height: 1.8; color: #333; }
.rpt-footer {
  padding: 14px 24px;
  background: #f5f5f5;
  display: flex; justify-content: space-between;
  font-size: 12px; color: #666;
  gap: 20px; flex-wrap: wrap;
}
.rpt-sig { display: flex; flex-direction: column; gap: 4px; min-width: 200px; }
.rpt-sig .sig-line { border-bottom: 1px solid #999; width: 200px; height: 28px; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--panel);
  border: 1px solid var(--border2);
  color: var(--text);
  padding: 11px 20px; border-radius: 14px;
  font-size: 13px; font-weight: 700;
  z-index: 500;
  transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .3s;
  white-space: nowrap;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* â”€â”€ MOBILE / iPHONE â”€â”€ */
@media(max-width:700px){
  .sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    transform: translateX(-100%);
    padding-left: env(safe-area-inset-left);
  }
  .sidebar.open { transform: translateX(0); box-shadow: 8px 0 40px rgba(0,0,0,.5); }
  .ham-btn { display: flex; }
  .overlay-sidebar {
    position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 49;
    display: none;
  }
  .overlay-sidebar.show { display: block; }

  /* Page padding accounts for safe areas */
  .page {
    padding: 12px;
    padding-bottom: calc(24px + env(safe-area-inset-bottom));
  }
  .topbar {
    padding: 10px 12px;
    padding-top: calc(10px + env(safe-area-inset-top));
    gap: 8px;
  }
  /* Save indicator compact on mobile */
  #saveIndicator span:last-child { display: none; }

  /* Larger tap targets for iPhone */
  .nav-btn { padding: 14px 12px; font-size: 14px; }
  .tool-btn { padding: 12px 14px; font-size: 13px; }
  .icon-btn { width: 44px; height: 44px; }
  .ham-btn { width: 44px; height: 44px; }
  .part-tap { width: 44px; height: 44px; border-radius: 14px; }
  .part-minus { width: 36px; height: 36px; }
  .abs-tap { width: 44px; height: 44px; border-radius: 14px; font-size: 20px; }
  .disc-badge { padding: 10px 14px; font-size: 13px; }
  .cat-btn { padding: 16px 10px; min-height: 70px; }
  .x-btn { width: 44px; height: 44px; }
  .cal-cell { font-size: 14px; border-radius: 12px; }
  .cal-arrow { width: 44px; height: 44px; }

  /* Table: switch to horizontal scroll mode */
  .tablewrap { border-radius: 12px; }
  table { min-width: 700px; }
  td { padding: 12px 10px; }
  thead th { padding: 12px 10px; }

  /* Bigger final score on mobile */
  .final-score { font-size: 16px; }

  /* Dash cards stack tighter */
  .dash-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
  .dash-card { padding: 14px 12px; }
  .dash-card .cls-name { font-size: 14px; }

  /* Settings stack */
  .settings-grid { grid-template-columns: 1fr; }
  .weight-inp { width: 90px; }

  /* Risk cards */
  .risk-card { padding: 12px; }

  /* Bottom sheet taller on iPhone */
  .sheet { max-height: 88vh; max-height: 88dvh; }
}

/* iPhone landscape */
@media(max-width:900px) and (orientation:landscape){
  .topbar { padding-top: calc(8px + env(safe-area-inset-top)); min-height: 52px; }
  .page { padding-top: 12px; }
}

/* Divider */
.divider { height: 1px; background: var(--border); margin: 16px 0; }

/* Empty state */
.empty-state {
  text-align: center; padding: 48px 20px;
  color: var(--muted);
}
.empty-state .big-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; line-height: 1.6; }
</style>
</head>
<body>

<!-- SKELETON LOADER -->
<div class="skeleton-overlay" id="skeletonOverlay">
  <div class="skeleton-logo">ğŸ“š</div>
  <div class="skeleton-bars">
    <div class="skeleton-bar" style="width:80%"></div>
    <div class="skeleton-bar" style="width:60%"></div>
    <div class="skeleton-bar" style="width:75%"></div>
    <div class="skeleton-bar" style="width:50%"></div>
  </div>
</div>

<!-- ONBOARDING -->
<div class="onboard-overlay hidden" id="onboardOverlay">
  <div class="onboard-sheet">
    <div class="onboard-dots" id="onboardDots"></div>
    <div class="onboard-step active" id="onboard-0">
      <div class="onboard-icon">ğŸ“š</div>
      <div class="onboard-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
      <div class="onboard-body">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ØºØ±Ø¨. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</div>
    </div>
    <div class="onboard-step" id="onboard-1">
      <div class="onboard-icon">ğŸ“‹</div>
      <div class="onboard-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      <div class="onboard-body">Ø§ÙØªØ­ Ø£ÙŠ Ù‚Ø³Ù… Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± <b>Ø­Ø¶ÙˆØ±</b> Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø³Ø±ÙŠØ¹. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¨Ø±Ø± ÙˆØºÙŠØ± Ø§Ù„Ù…Ø¨Ø±Ø±.</div>
    </div>
    <div class="onboard-step" id="onboard-2">
      <div class="onboard-icon">â­</div>
      <div class="onboard-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</div>
      <div class="onboard-body">Ø£Ø¯Ø®Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙØ±ÙˆØ¶ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†Ø¬Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©ØŒ ÙˆÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
    </div>
    <div class="onboard-step" id="onboard-3">
      <div class="onboard-icon">â˜ï¸</div>
      <div class="onboard-title">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Google Sheets</div>
      <div class="onboard-body">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Google Apps Script Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².</div>
    </div>
    <button class="onboard-next" id="onboardNext" onclick="onboardNext()">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
    <span class="onboard-skip" onclick="onboardDone()">ØªØ®Ø·Ù‰</span>
  </div>
</div>

<!-- CONFLICT BANNER -->
<div class="conflict-banner" id="conflictBanner"></div>


<!-- BACKUP REMINDER BANNER -->
<div class="backup-reminder" id="backupReminderBanner">
  <span>ğŸ’¾ Ù„Ù… ÙŠØªÙ… Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† â€” Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‚Ø¯ ØªØ¶ÙŠØ¹!</span>
  <button onclick="backupData()" style="background:#fff;color:#92400e;border:none;border-radius:8px;padding:6px 14px;font-weight:700;cursor:pointer;font-family:var(--font-ar)">Ù†Ø³Ø® Ø§Ù„Ø¢Ù†</button>
  <button onclick="document.getElementById('backupReminderBanner').classList.remove('show')" style="background:transparent;color:#fff;border:none;font-size:18px;cursor:pointer;padding:0 6px">Ã—</button>
</div>

<div class="overlay-sidebar" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="title">Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
    <div class="subtitle">Gradebook Pro â€¢ 2025â€“2026</div>
  </div>
  <div class="global-search-wrap">
    <span class="global-search-icon">ğŸ”</span>
    <input class="global-search-inp" id="globalSearchInp" type="search" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨â€¦" oninput="globalSearch(this.value)" onfocus="showGlobalResults()" autocomplete="off"/>
    <div class="global-search-results" id="globalSearchResults"></div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-section-label">Ø§Ù„ØªÙ†Ù‚Ù„</div>
    <button class="nav-btn active" onclick="showPage('overview')" id="nav-overview">
      <span class="icon">ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </button>
    <button class="nav-btn" onclick="showPage('atrisk')" id="nav-atrisk">
      <span class="icon">âš ï¸</span> Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø®Ø·Ø±
      <span class="badge-count danger-count" id="riskCount">0</span>
    </button>
    <button class="nav-btn" onclick="showPage('dailyabs')" id="nav-dailyabs">
      <span class="icon">ğŸ“…</span> Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ
      <span class="badge-count" id="todayAbsCount" style="background:rgba(245,158,11,.2);color:var(--amber)">0</span>
    </button>

    <div class="nav-section-label" style="margin-top:8px">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
    <div id="classNavList"></div>

    <button class="nav-btn" onclick="showPage('compare')" id="nav-compare">
      <span class="icon">ğŸ“Š</span> Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    </button>

    <div class="nav-section-label" style="margin-top:8px">Ø£Ø¯ÙˆØ§Øª</div>
    <button class="nav-btn" onclick="showPage('settings')" id="nav-settings">
      <span class="icon">âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    </button>
    <button class="nav-btn" onclick="toggleTheme()">
      <span class="icon" id="themeIcon">â˜€ï¸</span> <span id="themeLabel">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</span>
    </button>

    <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreData(event)"/>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <button class="ham-btn" id="hamBtn" onclick="openSidebar()">â˜°</button>
    <button class="icon-btn" id="backBtn" onclick="goBack()" title="Ø±Ø¬ÙˆØ¹" style="display:none;font-size:20px;font-weight:700">â†</button>
    <div style="flex:1;min-width:0">
      <div class="topbar-title" id="topbarTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <div class="topbar-meta" id="topbarMeta"></div>
    </div>
    <div id="saveIndicator" style="display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:12px;border:1px solid var(--border2);background:rgba(255,255,255,.04);font-size:11px;font-weight:700;color:var(--muted);white-space:nowrap;transition:all .4s;">
      <span id="saveIcon">ğŸ’¾</span><span id="saveText">Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¨Ø¹Ø¯</span>
    </div>
    <span id="syncDot" title="Google Sheets sync" style="font-size:18px;opacity:.3;cursor:default;transition:all .5s">â˜ï¸</span>
    <button class="icon-btn" id="manualSaveBtn" onclick="manualSave()" title="Ø­ÙØ¸ Ø§Ù„Ø¢Ù†" style="font-size:15px">ğŸ’¾</button>
    <button class="theme-toggle-btn" onclick="toggleTheme()" id="themeTopBtn" title="Toggle theme">â˜€ï¸</button>
    <button class="icon-btn" onclick="toggleProjector()" title="Projector mode" id="projBtn">ğŸŒ</button>
  </div>

  <!-- OVERVIEW PAGE -->
  <div class="page active" id="page-overview">
    <div class="dash-grid" id="dashGrid"></div>
  </div>

  <!-- DAILY ABSENCES PAGE -->
  <div class="page" id="page-dailyabs">
    <!-- Date navigator -->
    <div class="abs-date-nav">
      <button class="abs-nav-arrow" onclick="shiftDailyAbs(-1)" title="Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚">â€¹</button>
      <div class="abs-date-center">
        <div class="abs-date-label" id="absDateLabel">â€”</div>
        <input type="date" class="abs-date-hidden" id="dailyAbsDate" onchange="renderDailyAbs();updateAbsDateLabel()"/>
      </div>
      <button class="abs-nav-arrow" onclick="shiftDailyAbs(1)" title="Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ">â€º</button>
    </div>
    <div class="abs-date-actions">
      <button class="abs-action-btn today" onclick="setDailyAbsToday()">ğŸ“ Ø§Ù„ÙŠÙˆÙ…</button>
      <button class="abs-action-btn copy" onclick="copyDailyAbsReport()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>
    <div class="abs-day-summary" id="dailyAbsSummary"></div>
    <div class="abs-class-bars" id="dailyAbsBars"></div>
    <div class="abs-day-students" id="dailyAbsStudents"></div>
  </div>

  <!-- COMPARISON PAGE -->
  <div class="page" id="page-compare">
    <div class="section-title">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
    <div class="comp-metric-tabs" id="compTabs">
      <button class="comp-tab active" onclick="setCompMetric('avg',this)">Ø§Ù„Ù…Ø¹Ø¯Ù„</button>
      <button class="comp-tab" onclick="setCompMetric('above',this)">ÙÙˆÙ‚ 10</button>
      <button class="comp-tab" onclick="setCompMetric('risk',this)">ÙÙŠ Ø®Ø·Ø±</button>
      <button class="comp-tab" onclick="setCompMetric('abs',this)">Ø§Ù„ØºÙŠØ§Ø¨</button>
    </div>
    <div class="comp-kpi-grid" id="compKpis"></div>
    <div class="comparison-chart-wrap">
      <div class="comp-bars" id="compBars"></div>
    </div>
    <div class="dist-section">
      <div class="dist-section-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <div id="compDistChart"></div>
    </div>
  </div>

  <!-- AT-RISK PAGE -->
  <div class="page" id="page-atrisk">
    <div class="risk-filter-bar">
      <button class="risk-filter-btn active" data-filter="all" onclick="filterRisk('all',this)">Ø§Ù„ÙƒÙ„ <span class="risk-filter-count" id="rfc-all">0</span></button>
      <button class="risk-filter-btn" data-filter="grade" onclick="filterRisk('grade',this)">ğŸ“‰ Ø§Ù„Ù…Ø¹Ø¯Ù„ <span class="risk-filter-count" id="rfc-grade">0</span></button>
      <button class="risk-filter-btn" data-filter="abs" onclick="filterRisk('abs',this)">ğŸ“… Ø§Ù„ØºÙŠØ§Ø¨ <span class="risk-filter-count" id="rfc-abs">0</span></button>
      <button class="risk-filter-btn" data-filter="disc" onclick="filterRisk('disc',this)">âš ï¸ Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· <span class="risk-filter-count" id="rfc-disc">0</span></button>
    </div>
    <div class="risk-sort-row">
      <span class="risk-sort-label">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</span>
      <button class="risk-sort-btn active" onclick="sortRisk('severity',this)">Ø§Ù„Ø£Ø´Ø¯ Ø®Ø·ÙˆØ±Ø©</button>
      <button class="risk-sort-btn" onclick="sortRisk('grade',this)">Ø§Ù„Ù…Ø¹Ø¯Ù„</button>
      <button class="risk-sort-btn" onclick="sortRisk('abs',this)">Ø§Ù„ØºÙŠØ§Ø¨</button>
      <button class="risk-sort-btn" onclick="sortRisk('class',this)">Ø§Ù„Ù‚Ø³Ù…</button>
    </div>
    <div class="risk-list" id="riskList"></div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="section-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>

    <!-- SUBJECT PROFILE CARD -->
    <div class="subj-profile-card">
      <div class="subj-profile-header">
        <div class="subj-icon-wrap" id="subjIconWrap">ğŸ“š</div>
        <div style="flex:1">
          <div class="subj-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</div>
          <input class="subj-name-inp" id="subjectDisplayName" placeholder="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" oninput="saveSettings()" dir="rtl"/>
        </div>
        <div style="text-align:center">
          <div class="subj-label">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</div>
          <div class="coeff-stepper">
            <button class="coeff-btn" onclick="changeCoeff(-1)">âˆ’</button>
            <div class="coeff-val" id="coeffVal">2</div>
            <button class="coeff-btn" onclick="changeCoeff(1)">+</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TEST CONFIGURATION -->
    <div class="subj-section-label">ğŸ“ Ø§Ù„ÙØ±ÙˆØ¶ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
    <div class="test-config-row" id="testConfigRow">
      <!-- built by JS -->
    </div>
    <div class="test-add-row">
      <button class="test-add-btn" onclick="addTest()" id="addTestBtn">ï¼‹ Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¶</button>
      <span class="test-count-hint" id="testCountHint">Ø§Ù„ÙØ±ÙˆØ¶: 2</span>
    </div>

    <!-- VISUAL WEIGHT BUILDER -->
    <div class="subj-section-label">âš–ï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙˆØ²Ø§Ù†</div>
    <div class="weight-builder" id="weightBuilder">
      <!-- built by JS -->
    </div>
    <div class="weight-bar-wrap">
      <div class="weight-bar" id="weightBar"><!-- filled by JS --></div>
    </div>
    <div class="weight-total-row" id="weightTotalRow">
      <span id="weightTotal" class="weight-total ok">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 100% âœ“</span>
      <button class="weight-auto-btn" onclick="autoBalance()">âš–ï¸ ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
    </div>

    <!-- GOOGLE SHEETS SYNC CARD -->
    <div class="stg-section-label" style="margin-top:24px">â˜ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Google Sheets</div>
    <div class="stg-card" style="border-color:rgba(66,186,150,.25)">
      <div class="stg-card-header">
        <span class="stg-card-icon">â˜ï¸</span>
        <span class="stg-card-title" style="color:#42ba96">Google Sheets Sync</span>
        <div id="syncStatusDot" style="width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„"></div>
      </div>
      <div class="stg-field">
        <label class="stg-label">Ø±Ø§Ø¨Ø· Google Apps Script</label>
        <input class="stg-input" id="gsUrl" type="url"
          placeholder="https://script.google.com/macros/s/â€¦/exec"
          style="font-family:var(--font-mono);font-size:11px;direction:ltr"
          oninput="saveGsUrl()"/>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="stg-sync-btn test" onclick="testConnection()" id="testBtn">ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
        <button class="stg-sync-btn push" onclick="pushAllToSheets()" id="pushBtn">â˜ï¸ Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
      <div id="gsStatus" style="margin-top:10px;font-size:12px;font-weight:700;min-height:18px;direction:rtl;color:var(--muted)"></div>
      <div class="stg-sync-info">
        <div class="stg-sync-info-item"><span class="stg-sync-dot"></span><span>ÙƒÙ„ ØªØºÙŠÙŠØ± ÙŠÙØ­ÙØ¸ ÙÙˆØ±Ù‹Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙŠÙØ±Ø³Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span></div>
        <div class="stg-sync-info-item"><span class="stg-sync-dot"></span><span>Ø²Ø± Ø§Ù„Ø±ÙØ¹ ÙŠØ±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</span></div>
      </div>
    </div>



    <!-- DATA + SECURITY -->
    <div class="stg-section-label" style="margin-top:24px">ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø£Ù…Ø§Ù†</div>
    <div class="stg-data-security-grid">

      <!-- Backup -->
      <div class="stg-action-card" onclick="backupData()">
        <div class="stg-action-card-icon">ğŸ’¾</div>
        <div class="stg-action-card-label">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div>
        <div class="stg-action-card-desc">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„Ù</div>
      </div>

      <!-- Restore -->
      <div class="stg-action-card" onclick="document.getElementById('restoreFile').click()">
        <div class="stg-action-card-icon">ğŸ“‚</div>
        <div class="stg-action-card-label">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</div>
        <div class="stg-action-card-desc">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</div>
      </div>

      <!-- Export CSV -->
      <div class="stg-action-card" onclick="exportAllCSV()">
        <div class="stg-action-card-icon">ğŸ“¤</div>
        <div class="stg-action-card-label">ØªØµØ¯ÙŠØ± CSV</div>
        <div class="stg-action-card-desc">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      </div>

      <!-- PIN -->
      <div class="stg-action-card" onclick="openPinModal()">
        <div class="stg-action-card-icon">ğŸ”</div>
        <div class="stg-action-card-label">Ø±Ù…Ø² PIN</div>
        <div class="stg-action-card-desc">Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
      </div>

    </div>

    <!-- DANGER ZONE -->
    <div class="stg-section-label" style="margin-top:24px;color:var(--red)">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</div>
    <div class="stg-danger-zone">
      <div class="stg-danger-warning">
        <span class="stg-danger-warning-icon">âš ï¸</span>
        <span>Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.</span>
      </div>
      <div class="stg-danger-row">
        <select id="dangerClassSel" class="stg-input" style="flex:1;min-width:130px;direction:rtl">
          <option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹...</option>
        </select>
        <button class="stg-danger-action amber" onclick="resetAbsencesOnly(document.getElementById('dangerClassSel').value)">
          ğŸ—“ï¸ Ù…Ø³Ø­ Ø§Ù„ØºÙŠØ§Ø¨
        </button>
        <button class="stg-danger-action red" onclick="resetClass(document.getElementById('dangerClassSel').value)">
          ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…
        </button>
      </div>
      <button class="stg-danger-nuke" onclick="resetAllData()">
        ğŸ’¥ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
      </button>
    </div>

    <div style="height:48px"></div>
  </div>

  <!-- CLASS PAGE (single reusable container) -->
  <div class="page" id="page-class">
    <div class="class-toolbar">
      <input class="search-box" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨â€¦" id="classSearchBox" oninput="filterTableLive(this.value)" style="direction:rtl"/>
      <button class="tool-btn" style="background:linear-gradient(135deg,rgba(34,197,94,.2),rgba(34,197,94,.1));border-color:rgba(34,197,94,.3);color:var(--green)" onclick="openRollCall(currentClass)">ğŸ“‹ Ø­Ø¶ÙˆØ±</button>
      <button class="tool-btn" onclick="openRosterManager(currentClass)" title="Add/remove students">ğŸ‘¥ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button class="tool-btn" onclick="toggleCompactMode()" id="compactBtn" title="Compact mode">ğŸ“± Ø¥Ø®ÙØ§Ø¡</button>
      <!-- More menu -->
      <div class="more-menu-wrap" id="moreMenuWrap">
        <button class="tool-btn" onclick="toggleMoreMenu()" id="moreMenuBtn" title="More options">â‹¯</button>
        <div class="more-menu" id="moreMenu">
          <button class="more-menu-item" onclick="openPrintAllReport(currentClass);closeMoreMenu()">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØµÙ„</button>
          <button class="more-menu-item" onclick="exportCSV(currentClass);closeMoreMenu()">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>
          <button class="more-menu-item" onclick="window.print();closeMoreMenu()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>
    </div>
    <div class="stats-row" id="classStatsRow"></div>
    <div id="classDistChart" style="padding:0 2px 8px"></div>
    <div class="tablewrap" id="classTableWrap">
      <table id="classTable">
        <thead id="classTableHead"><tr>
          <th class="sortable-header" onclick="sortTable('n')" data-col="n"># <span class="sort-icon" id="sort-n">â†•</span></th>
          <th style="min-width:160px;direction:rtl" data-col="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
          <th data-col="abs">Ø§Ù„ØºÙŠØ§Ø¨</th>
          <th data-col="part">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th>
          <th data-col="disc">Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</th>
          <th class="sortable-header" onclick="sortTable('hw')" data-col="hw">Ø§Ù„ÙˆØ§Ø¬Ø¨ <span class="sort-icon" id="sort-hw">â†•</span></th>
          <th class="sortable-header" onclick="sortTable('copy')" data-col="copy">Ø§Ù„Ø¯ÙØªØ± <span class="sort-icon" id="sort-copy">â†•</span></th>
          <!-- test columns injected by JS -->
          <th class="sortable-header" onclick="sortTable('final')" data-col="final">Ø§Ù„Ù†ØªÙŠØ¬Ø© <span class="sort-icon" id="sort-final">â†•</span></th>
          <th data-col="actions"></th>
        </tr></thead>
        <tbody id="classTableBody"></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- DISCIPLINE MODAL -->
<div class="overlay" id="discOverlay" onclick="closeIfBg(event,'discOverlay')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="close-row">
      <div>
        <div class="sheet-title" id="discModalName">â€”</div>
        <div class="sheet-sub" id="discModalMeta">â€”</div>
      </div>
      <button class="x-btn" onclick="closeDisc()">âœ•</button>
    </div>
    <div class="inc-cats" id="incCats"></div>
    <div class="divider"></div>
    <p style="font-size:11px;color:var(--muted);margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px">Ø³Ø¬Ù„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</p>
    <div class="inc-log" id="incLog"></div>
  </div>
</div>

<!-- ABSENCE CALENDAR MODAL -->
<div class="overlay" id="absOverlay" onclick="closeIfBg(event,'absOverlay')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="close-row">
      <div>
        <div class="sheet-title" id="absModalName">â€”</div>
        <div class="sheet-sub" id="absModalMeta">â€”</div>
      </div>
      <button class="x-btn" onclick="closeAbs()">âœ•</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
      <span style="font-size:12px;color:var(--muted);flex:1">Tap date to mark. Long-press to justify.</span>
      <div style="display:flex;gap:6px;font-size:11px;">
        <span><span class="abs-type-dot" style="background:var(--red)"></span>ØºÙŠØ± Ù…Ø¨Ø±Ø±</span>
        <span><span class="abs-type-dot" style="background:var(--amber)"></span>Ù…Ø¨Ø±Ø±</span>
      </div>
    </div>
    <div id="absWarning4"></div>
    <div class="cal-nav">
      <button class="cal-arrow" onclick="calPrev()">â—€</button>
      <div class="cal-month-label" id="calMonthLabel">â€”</div>
      <button class="cal-arrow" onclick="calNext()">â–¶</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="divider"></div>
    <p style="font-size:12px;color:var(--muted);margin-top:4px" id="absDatesList"></p>
  </div>
</div>

<!-- STUDENT PROFILE MODAL -->
<div class="overlay center" id="profileOverlay" onclick="closeIfBg(event,'profileOverlay')">
  <div class="dialog">
    <div class="close-row">
      <div>
        <div class="sheet-title" id="profileName">â€”</div>
        <div class="sheet-sub" id="profileMeta">â€”</div>
      </div>
      <button class="x-btn" onclick="closeProfile()">âœ•</button>
    </div>
    <div id="profileBody"></div>
    <div style="margin-top:12px">
      <div style="font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;direction:rtl">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
      <textarea class="student-notes-inp" id="profileNotesArea" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© Ø­ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨â€¦" rows="3"></textarea>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px">
      <button class="tool-btn primary" onclick="printArabicReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
      <button class="tool-btn" onclick="closeProfile()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ABSENCE REPORT MODAL -->
<div class="overlay" id="absReportOverlay" onclick="closeIfBg(event,'absReportOverlay')">
  <div class="sheet" id="absReportSheet">
    <div class="sheet-handle"></div>
    <div class="close-row">
      <div>
        <div class="sheet-title" id="absReportTitle">â€”</div>
        <div class="sheet-sub" id="absReportSub">â€”</div>
      </div>
      <button class="x-btn" onclick="closeAbsReport()">âœ•</button>
    </div>
    <div id="absReportBody"></div>
    <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
      <button class="tool-btn primary" id="absReportCopyBtn" onclick="copyAbsReport()" style="flex:1;justify-content:center;font-size:14px;padding:14px">
        ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      </button>
      <button class="tool-btn" onclick="closeAbsReport()" style="font-size:14px;padding:14px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- UNDO TOAST -->
<div class="undo-toast" id="undoToast">
  <span id="undoMsg">ØªÙ…</span>
  <button class="undo-btn" onclick="doUndo()">â†© Undo</button>
</div>

<!-- PIN MODAL (create/verify) -->
<div class="pin-modal-overlay" id="pinModalOverlay" onclick="closePinModalIfBg(event)">
  <div class="pin-modal-sheet" id="pinModalSheet">
    <div class="pin-modal-title" id="pinModalTitle">ğŸ” Create PIN</div>
    <div class="pin-modal-sub" id="pinModalSub">Choose a 4-digit PIN to protect your gradebook</div>
    <div class="pin-dots" id="pinModalDots">
      <div class="pin-dot" id="pmd0"></div><div class="pin-dot" id="pmd1"></div>
      <div class="pin-dot" id="pmd2"></div><div class="pin-dot" id="pmd3"></div>
    </div>
    <div class="pin-pad">
      <button class="pin-btn" onclick="pinModalPress('1')">1</button>
      <button class="pin-btn" onclick="pinModalPress('2')">2<div class="pin-sub-letters">ABC</div></button>
      <button class="pin-btn" onclick="pinModalPress('3')">3<div class="pin-sub-letters">DEF</div></button>
      <button class="pin-btn" onclick="pinModalPress('4')">4<div class="pin-sub-letters">GHI</div></button>
      <button class="pin-btn" onclick="pinModalPress('5')">5<div class="pin-sub-letters">JKL</div></button>
      <button class="pin-btn" onclick="pinModalPress('6')">6<div class="pin-sub-letters">MNO</div></button>
      <button class="pin-btn" onclick="pinModalPress('7')">7<div class="pin-sub-letters">PQRS</div></button>
      <button class="pin-btn" onclick="pinModalPress('8')">8<div class="pin-sub-letters">TUV</div></button>
      <button class="pin-btn" onclick="pinModalPress('9')">9<div class="pin-sub-letters">WXYZ</div></button>
      <button class="pin-btn" onclick="pinModalDel()">âŒ«</button>
      <button class="pin-btn" onclick="pinModalPress('0')">0</button>
      <div></div>
    </div>
    <div class="pin-error-msg" id="pinModalError"></div>
    <button class="tool-btn" onclick="closePinModal()" style="margin-top:16px;width:100%;justify-content:center">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- PIN LOCK SCREEN -->
<div class="pin-lock-screen hidden" id="pinLockScreen">
  <div class="pin-lock-logo">ğŸ”</div>
  <div class="pin-lock-title">Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
  <div class="pin-lock-sub">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² PIN Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div>
  <div class="pin-dots" id="pinLockDots">
    <div class="pin-dot" id="pld0"></div><div class="pin-dot" id="pld1"></div>
    <div class="pin-dot" id="pld2"></div><div class="pin-dot" id="pld3"></div>
  </div>
  <div class="pin-pad" style="max-width:240px">
    <button class="pin-btn" onclick="pinLockPress('1')">1</button>
    <button class="pin-btn" onclick="pinLockPress('2')">2<div class="pin-sub-letters">ABC</div></button>
    <button class="pin-btn" onclick="pinLockPress('3')">3<div class="pin-sub-letters">DEF</div></button>
    <button class="pin-btn" onclick="pinLockPress('4')">4<div class="pin-sub-letters">GHI</div></button>
    <button class="pin-btn" onclick="pinLockPress('5')">5<div class="pin-sub-letters">JKL</div></button>
    <button class="pin-btn" onclick="pinLockPress('6')">6<div class="pin-sub-letters">MNO</div></button>
    <button class="pin-btn" onclick="pinLockPress('7')">7<div class="pin-sub-letters">PQRS</div></button>
    <button class="pin-btn" onclick="pinLockPress('8')">8<div class="pin-sub-letters">TUV</div></button>
    <button class="pin-btn" onclick="pinLockPress('9')">9<div class="pin-sub-letters">WXYZ</div></button>
    <button class="pin-btn" onclick="pinLockDel()">âŒ«</button>
    <button class="pin-btn" onclick="pinLockPress('0')">0</button>
    <div></div>
  </div>
  <div class="pin-error-msg" id="pinLockError"></div>
  <div style="margin-top:20px;font-size:12px;color:var(--muted);cursor:pointer;text-decoration:underline" onclick="pinLockDisable()">Ø­Ø°Ù Ø±Ù…Ø² PIN</div>
</div>

<!-- ROSTER MANAGER MODAL -->
<div class="overlay roster-overlay" id="rosterOverlay" onclick="closeIfBg(event,'rosterOverlay')">
  <div class="sheet roster-sheet">
    <div class="sheet-handle"></div>
    <div class="close-row" style="padding:16px 20px 8px">
      <div>
        <div class="sheet-title" id="rosterTitle">â€”</div>
        <div class="sheet-sub" id="rosterSub">â€”</div>
      </div>
      <button class="x-btn" onclick="closeRosterManager()">âœ•</button>
    </div>
    <div class="roster-stats" id="rosterStats"></div>
    <div class="roster-list" id="rosterList"></div>
    <div class="roster-add-row">
      <input class="roster-add-inp" id="rosterAddInp" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯â€¦" dir="rtl"
        onkeydown="if(event.key==='Enter') confirmAddStudent()"/>
      <button class="roster-add-btn" onclick="confirmAddStudent()">+ Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </div>
</div>

<!-- ROLL CALL MODAL -->
<div class="overlay" id="rollCallOverlay" onclick="closeIfBg(event,'rollCallOverlay')">
  <div class="sheet roll-call-sheet" id="rollCallSheet">
    <div class="sheet-handle"></div>
    <div class="roll-call-header">
      <div class="close-row">
        <div>
          <div class="sheet-title" id="rcTitle">â€”</div>
          <div class="sheet-sub" id="rcMeta">â€”</div>
        </div>
        <button class="x-btn" onclick="closeRollCall()">âœ•</button>
      </div>
      <div class="roll-call-progress"><div class="roll-call-progress-fill" id="rcProgress" style="width:0%"></div></div>
      <div class="roll-call-summary" id="rcSummary"></div>
    </div>
    <div id="rcStudentList"></div>
    <div style="padding:16px 20px;display:flex;gap:8px;">
      <button class="tool-btn" onclick="markAllRollCall('present')" style="color:var(--green);border-color:rgba(34,197,94,.4)">âœ“ Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±</button>
      <button class="tool-btn" onclick="markAllRollCall('absent-u')" style="color:var(--red);border-color:rgba(244,63,94,.4)">âœ— Ø§Ù„ÙƒÙ„ ØºØ§Ø¦Ø¨</button>
      <button class="tool-btn primary" onclick="saveRollCall()" style="flex:1;justify-content:center;font-size:14px;padding:14px">âœ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      <button class="tool-btn" onclick="closeRollCall()" style="font-size:14px;padding:14px">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
window.onerror = function(msg, src, line, col, err) {
  console.error('APP ERROR at line '+line+': '+msg, err);
  return false;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_DATA = {"TCS-1":["Ù†ÙˆØ±Ø© Ø§Ù„ÙÙ„Ø§Ù‚ÙŠ","ÙŠØ§Ø³ÙŠÙ† Ø§Ù„Ø±ÙˆÙŠØ³ÙŠ","Ø£Ù†Ø³ Ø§Ù„ÙØªÙŠØ±ÙŠ","ÙŠØ§Ø³ÙŠÙ† Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ","Ø£Ù…ÙŠÙ† Ø§Ù„ÙˆØ­Ø¯ÙŠ","Ø³Ø¹Ø¯ Ø­Ø§Ù…Ø¯Ùˆ","ÙŠØ­ÙŠÙ‰ Ø´Ù†ÙŠÙˆØ¨","Ø¹Ù…Ø± Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠ","ÙØ§Ø±Ø³ Ø§Ù„Ø£Ø´Ù‚Ø±","Ø­Ù†Ø§Ù† Ù‡Ø±ÙˆØ§Ù„","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø´Ø§ÙƒØ±","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„ÙˆØ±Ø¯ÙŠ","Ø­Ù…Ø²Ø© Ø²Ø±Ø¯Ø¨Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø§Ù„ÙÙˆÙƒÙŠ","Ø¢Ø¯Ù… Ø§Ù„Ù‚Ø§Ø³Ù…ÙŠ","Ø¹Ù…Ø± Ø§Ù„ÙØ§Ø·Ù…ÙŠ","Ø³Ù†Ø§Ø¡ Ø§Ù„Ø­Ø§ÙÙŠ","Ù…Ø±Ø§Ø¯ Ø¨ÙˆØµÙÙŠØ­Ø©","ÙŠÙˆØ³Ù Ø§Ù„Ø³Ø¹ÙŠØ¯ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø§Ø­ÙƒÙˆØ±Ø´","ÙŠÙˆØ³Ù Ø§Ù„Ø²ÙˆÙŠÙ†","ÙŠØ§Ø³Ù…ÙŠÙ† Ø§Ù„Ù…Ø²Ø±Ø§ÙŠ","Ù…Ø¹Ø§Ø¯ ØºØ±ÙŠÙÙŠ","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ø²ÙŠØ²","Ø­Ù„ÙŠÙ…Ø© Ù‚Ø¨Ø§Ù†","Ø¢Ø¯Ù… Ù‚ÙˆÙ‚","Ù…Ø¬Ø¯ÙˆÙ„ÙŠÙ† Ù‡Ø¯Ø§Ù†","Ù„Ø¨Ù†Ù‰ Ø§Ø­ÙƒÙˆØ´","Ù†Ø§Ø¯ÙŠØ© Ø§Ø¬Ø¯Ø¹","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø­Ù†ÙŠÙ†","ÙƒÙˆØ«Ø± Ù„Ø·ÙÙŠ","Ù…Ø±ÙŠÙ… Ù„Ø¨ÙˆØ²","ØµØ¯ÙŠÙ‚Ø© Ø­Ù†ÙŠÙ†","Ù…Ø­Ù…Ø¯ Ø§Ù„ÙˆØ²Ø§Ù†ÙŠ","Ø¨Ø¯Ø± Ø¨ÙˆÙƒØ³Ø§ÙƒØ³","Ù…Ø±ÙŠÙ… Ø¬Ø¹ÙˆÙ†","Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ† Ø§Ù…Ø³ØºØ±Ùˆ","Ø¥ÙŠÙ…Ø§Ù† Ø®Ù„Ø§Ø¯ÙŠ","Ø¹ØµØ§Ù… Ø¹Ø§Ù„Ù…"],"TCS-2":["Ù…Ø±ÙˆØ© Ø±ÙˆÙ‚","Ø§Ø¨ØªØ³Ø§Ù… Ø§Ù„Ø¬Ù†ØªØ§Ù†ÙŠ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","ÙŠÙˆØ³Ù Ø§Ù„Ø¯Ø±ÙŠÙˆØ´","Ø¹Ù…Ø±Ø§Ù† Ø§Ù„Ø¹Ù…Ø±ÙŠ","Ø­Ù…Ø²Ø© Ø£ÙØ±ÙŠÙƒÙ„","Ø¹Ù…Ø§Ø¯ Ø´ÙƒØ± Ø§Ù„Ù„Ù‡","Ù‡Ø§Ø¬Ø± Ø¨ÙˆÙ…Ø¯ÙŠØ§Ù†","Ø­Ù…Ø²Ø© ÙˆØ§ØµÙ„","Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø±ÙƒÙŠÙ†Ø©","Ø£Ù…ÙŠÙ† Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø¨ÙŠÙ„Ø§Ù†","Ø±Ù…ÙŠÙ€Ø³Ø§Ø¡ Ù…Ø³Ø§Ø¹Ø¯","ÙˆØ¯ÙŠØ¹ Ø§Ù„ÙƒØ±Ø²Ù†ÙŠÙÙŠ","Ù…Ø­Ù…Ø¯ Ø³Ù†ÙˆØ³ÙŠ Ø¹Ù…ÙˆØ±ÙŠ","Ø£ÙŠÙ…Ù† Ø·Ø±ÙØ§ÙˆÙŠ","ÙŠÙˆØ³Ù Ø§Ù„Ø¨ÙˆØ±ÙŠØ²Ø¯ÙŠ","Ù…Ø­Ù…Ø¯ Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ","Ø£Ø³Ø§Ù…Ø© Ø¹Ø²ÙˆØ²ÙŠ","Ø§Ø¯Ø±ÙŠØ³ ÙˆØ§ØµÙ„","Ù…Ø­Ù…Ø¯ Ø¨Ù†Ø´Ø¹Ø¨Ø§Ù†","Ø³Ù‡ÙŠÙ„ Ù„Ø²Ø¹Ø±","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø§Ø¶ÙŠ","Ø£ÙŠÙ…Ù† Ø§Ø³Ù…ÙŠÙ€Ø¯Ø©","ÙŠØ§Ø³ÙŠÙ† Ù…Ø­ÙŠ Ø§Ù„Ø¯ÙŠÙ†","Ø¢Ø¯Ù… Ø¹ÙŠØ´ÙˆØ´","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø®Ù„ÙˆÙÙŠ","Ø³Ù…ÙŠØ± Ø§Ù„Ù‚Ø±Ù…ÙˆØ¯ÙŠ","Ø±Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ø³Ø±ÙŠ","Ø¨ÙˆØ®Ø§Ù„ Ù…Ø±ÙˆØ§Ù†","Ù…Ø±ÙˆØ§Ù† Ø­ÙˆÙ…Ø§Ù„Ùƒ","Ø­Ù…Ø²Ø© Ø­Ø³Ù†ÙŠØ© ÙÙŠÙ„Ø§Ù„ÙŠ","ØºÙØ±Ø§Ù† Ø§Ø­Ø¯ÙŠØ¯Ø§Ù†","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠ","ØµÙÙŠØ© Ø§Ø­Ø¯ÙŠØ¯Ø§Ù†","Ø³Ù†Ø§Ø¡ Ø¨Ù†Ù‚Ø§Ø¯Ø©","Ù‡Ø¯Ù‰ Ø§Ù„Ù…Ø³Ø¹ÙˆØ¯ÙŠ","ÙØ±Ø¯ÙˆØ³ Ø§Ù„Ø²ÙˆÙ†ÙŠ","Ù…Ø­Ù…Ø¯ ÙƒØªØ§Ù…ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ø²Ù…","ÙˆÙ„Ø§Ø¡ Ø§Ù„Ø¹ÙŠØ³ÙˆÙŠ","ÙØ®Ø± Ø§Ù„Ø¯ÙŠÙ† ÙØ±Ø¬","Ø£Ù…ÙŠÙ†Ø© Ø§ØºØ²Ø§Ù„"],"TCSF-1":["ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ø¨Ù† Ø§Ù„Ø´Ø±ÙŠÙ","Ø±Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ØªÙˆÙ†ÙŠ","Ø¢ÙŠØ© Ù„Ø´Ø¹Ù„","ØµÙˆÙÙŠØ§ Ø§Ù„Ù…ØµØ¯ÙˆØ±Ø©","Ø¨Ù„Ø§Ù„ Ø§Ù„Ø²ØºØ§Ø±ÙŠ","Ø±Ø¶Ù‰ Ø¨Ù† Ø¯Ø§ÙˆØ¯","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø³ÙƒØ§Ø­","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ³ÙŠ","ÙØ±Ø¯ÙˆØ³ ÙˆØ§Ù„ÙŠ Ø¹Ù„Ù…ÙŠ","Ù‡Ø¨Ø© Ø¯ÙŠØ¯ÙŠ","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚ Ø§Ù„Ù…ØºØ§Ø±ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø²Ø±ÙˆÙ‚ÙŠ","Ø£ÙŠÙ…Ù† Ø§Ù„Ø¬Ø¨Ø§Ø±ÙŠ","Ù‡Ø¯Ù‰ Ø¨ÙˆØ´Ø¨ÙƒØ©","Ø±Ø§Ù†ÙŠØ§ Ø¨Ù† Ø¯Ø­Ù…Ø§Ù†","Ø¢Ø¯Ù… Ø¨ÙŠÙ„ÙˆÙ„","Ù…Ø±ÙˆØ§Ù† Ø¹Ø§ÙŠØ¯ÙŠ","ÙØ±Ø­ Ø§Ù„Ø¯ÙŠÙˆÙŠÙ‘Ø©","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¯Ø­Ù…Ø§Ù†ÙŠ","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ","Ø¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø´ÙˆØ±Ø©","Ø­Ù…Ø²Ø© Ø³Ø­Ù„Ø§Ù…Ø§Ø³ÙŠ","Ø·Ù‡ Ø§Ù„Ø³Ù‡Ù„ÙŠ","ÙŠØ§Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø¯Ù‚","Ø§Ù„Ù…Ù‡Ø¯ÙŠ Ø§Ù„ÙƒØ±ÙŠÙ†ÙŠ","Ø­Ù„ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ÙƒÙ†ÙŠ","Ù…Ø­Ù…Ø¯ Ø­Ø³ÙŠÙ†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø¨Ù† Ø­Ø³ÙŠÙ†","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ","Ù…Ø±ÙŠÙ… Ø£Ø´Ø¹ÙˆØ¨ÙŠØ©","Ù…Ø­Ù…Ø¯ Ø­Ø§ØªÙ… Ø§Ù„Ø­Ù‚ÙˆÙ†ÙŠ","ÙØ±Ø­ Ù‡ØªÙ…ÙŠ","Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø±Ø¶ÙŠ","Ø¨Ø¯Ø± Ø§Ù„Ø¯ÙŠÙ† ÙƒØ±Ù…ÙˆÙ…","Ø´ÙŠÙ…Ø§Ø¡ Ø®Ø±Ø´Ø§Ù„","Ù„Ø·ÙŠÙØ© Ù…Ø¹ØªÙ†Ø§Ù†","Ù‡Ø§Ø¬Ø± Ø§Ù„ØµÙ…ÙˆØ¯ÙŠ","Ø£Ù…ÙŠÙ…Ø© Ø§Ù„Ø¨ÙƒÙˆØ±ÙŠ","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„ÙƒØ±Ø§ÙÙŠ","Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªÙˆÙƒÙ„","Ø´ÙŠÙ…Ø§Ø¡ Ø­Ø§Ù…Ø¯Ùˆ","ÙˆØ¦Ø§Ù… Ø¨ÙˆÙ‡Ø±ÙŠØ±"],"TCSF-2":["Ø­Ø³Ø§Ù… Ø§Ø¨Ø±ÙŠØ´","ÙˆØ¦Ø§Ù… Ø§Ù„Ø²Ø¹Ø¬Ù…","Ø£ÙŠÙ…Ù† Ø§Ù„Ù…Ù†ÙƒÙŠ","Ø£ÙŠÙˆØ¨ Ø¨ÙˆØ®ÙŠØ±Ø©","Ø²ÙƒØ±ÙŠØ§Ø¡ Ø­Ù…Ø¯ÙŠ","Ù…Ù†ÙŠØ± Ø§Ù„Ø±ÙƒÙŠØ¨ÙŠ","Ù†Ù‡ÙŠÙ„Ø© Ø§Ù„ÙˆØ²Ù†","Ø³Ù†Ø§Ø¡ ÙØ±","Ù…Ù„Ø§Ùƒ Ø§Ù„Ø­Ù…Ø§Ø±ØªÙŠ","Ø³Ù†Ø§Ø¡ Ø§Ù„Ù…ÙŠÙ…ÙˆÙ†ÙŠ","Ø¹Ø¯Ù†Ø§Ù† Ø§Ù„Ù†ØµÙˆØµ","ÙŠÙˆÙ†Ø³ Ø§Ù„Ø¨Ù‡Ø§Ù„ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø³Ù…Ù„Ø§Ù„ÙŠ","Ù…Ù„Ø§Ùƒ Ø§Ù„Ù‚Ø§Ø³Ù…ÙŠ","Ù‡Ù†Ø§Ø¡ Ø§Ø¬Ø¨ÙŠÙ„Ùˆ","Ù„Ø¹Ø·Ø§Ø´ Ø³Ù„ÙŠÙ…Ø©","ÙŠØ§Ø³ÙŠÙ† Ø§Ø¹Ø·Ùˆ","Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ù†ØªØµØ±","Ø¢ÙŠØ© Ø§Ù„Ø­Ø¬Ø§Ø¬ÙŠ","Ø¢Ø¯Ù… Ù…Ø±ÙŠØ¬","Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø¨Ø¯ÙˆÙŠ","Ø¹Ù…Ø± Ø§Ù„Ø¨ÙƒØ§Ø±","Ø­Ø§ØªÙ… Ø§Ù„Ù…Ø·Ù„Ø§Ø³ÙŠ","Ø¥Ù„ÙŠØ§Ø³ Ø¨Ù†Ø®Ø¯Ø©","Ù†Ø¹ÙŠÙ…Ø© Ø£Ù†Ø¬Ø±Ù†","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¯Ø±ÙŠÙ…Ø§Ù†ÙŠ","ØµÙÙˆØ§Ù† Ù…Ù‡Ø¯ÙŠ","Ø§Ù„Ù…Ø±Ø§Ø¨Ø· Ù‡Ø¯Ù‰","Ø·Ù‡ Ù‡Ø¯Ø§ÙÙŠ","Ø³Ù„Ù…Ù‰ Ø§Ù„Ø´Ù†ÙˆØ¹ÙŠ","Ø³ÙƒÙŠÙ†Ø© Ø´Ø·Ø§Ø·","Ù‡Ù†Ø§Ø¡ Ù„Ø´Ù‚Ø±","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø­Ù…Ø§Ù†ÙŠ","ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø§Ø¯","Ø±Ø¶ÙˆØ§Ù† Ø¨Ù† Ø¨ÙˆØ´ØªÙ‰ Ø§Ù„Ø¹Ø³Ø±ÙŠ","Ø¨Ù„Ø§Ù„ Ø§Ù„Ø­ÙŠÙˆÙ†ÙŠ","Ø²ÙŠÙ†Ø¨ Ø§Ù„Ø¹Ù†Ù‚ÙŠ","Ø²Ù‡ÙŠØ± Ø§Ù„Ø¹Ù†Ù‚ÙŠ","Ù†Ø¯Ù‰ Ù…ÙŠØ³ÙˆØ±","Ù„Ù…ÙŠØ§Ø¡ Ù‚ÙˆÙŠØ¯Ø±","Ø¢ÙŠØ© Ø§Ù„Ø­Ø¯Ø§Ø¯","Ù…Ø­Ù…Ø¯ Ø§Ù„Ù„Ø¨Ø§Ù†","ÙŠØ³Ø±Ù‰ Ø§Ù„Ø¨ÙˆØ´ÙŠØ®ÙŠ"],"TCSF-3":["Ø¹Ù…Ø± Ø§Ù„Ù‡ÙˆØ§Ø±ÙŠ","ÙØ±Ø¯ÙˆØ³ Ø¨Ù† ÙŠÙˆØ³Ù","ÙÙˆØ²ÙŠ Ø¹ÙŠÙ†ÙˆØ³","ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø±ÙŠÙÙŠ","Ø²ÙŠØ§Ø¯ Ø­ÙˆÙ…Ø§Ù„Ùƒ","ØµØ¨ÙŠØ± Ø§Ù‚Ø´ÙŠÙ‚Ø´","Ø¹Ø«Ù…Ø§Ù† Ø­ÙŠØ§Ù†ÙŠ Ø²Ø§Ù‡Ø¯","Ø¯Ø¹Ø§Ø¡ Ø´Ø¬Ø§Ø¹","Ø¬ÙˆØ¯ÙŠØ© Ø§Ø´Ù‚Ø±","Ø­ÙØµØ© Ø§Ù„ØªØ§Ù„Ø¨ÙŠ","ØµØ§Ø¨Ø± Ø´Ø§ÙƒØ±","ÙŠØ­ÙŠÙ‰ Ø®Ø§Ù„Ù‚ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„ÙÙŠÙ„Ø§Ù„ÙŠ","ÙŠØ­ÙŠÙ‰ ÙˆÙ†Ø¬Ù„ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø­Ù…Ø§Ù†ÙŠ","Ù…Ø±ÙˆØ© Ø­Ù…ÙŠØ¯Ùˆ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø²Ø§ÙˆÙŠ","Ø¹Ù…Ø± Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠ","ØµØ§Ø¨Ø±ÙŠÙ†Ø§ Ø§Ù„Ø³Ù…ÙŠØ±ÙŠ","Ø´ÙŠÙ…Ø§Ø¡ Ø§Ù„Ù‡Ø§Ø´Ù…ÙŠ","Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­ÙŠÙ… Ø§Ø²Ø¹ÙŠØ·","Ø¨Ù„Ø§Ù„ Ø§Ù„Ø¹Ù…Ø§Ø±ÙŠ","Ù…ØµØ¹Ø¨ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ø±ÙŠÙ…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø·ÙŠ Ø²Ø±Ù‡ÙˆÙ†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø²Ø±ÙˆÙ‚","Ø£Ù†ÙˆØ§Ø± Ø§Ù„Ø²ÙˆØ¨Ø¹ÙŠ","Ø¢Ø³ÙŠØ© Ø£Ø­Ø³ÙŠØ³","Ø¢Ø¯Ù… Ø·Ø­Ù…Ø³","Ø£ÙŠÙˆØ¨ Ø¨Ø·Ù…ÙŠ","Ø¢ÙŠØ© Ù…ÙØªØ§Ø­","Ù…Ø±ÙˆØ© Ù…Ù„ÙˆÙƒ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù‚ÙŠ","Ù…Ø­Ù…Ø¯ Ø­Ø¬ÙˆØ¬","Ø³Ø¹ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø¹ÙŠ","Ø¢ÙŠØ© Ø§Ù„Ø­Ù…Ø¬ÙˆÙ…ÙŠ","Ù…Ù‡Ø¯ÙŠ Ø£Ù†Ù‚ÙŠØ±Ø©","Ø¢ÙŠØ© Ø¨ÙŠØ§Ø­","Ø­ÙØµØ© Ø§Ù„Ø¹Ø§Ø¯Ù„","Ø±ÙŠÙ… Ø²Ø±Ù‚Ø§Ù†","Ù„Ø¨Ù†Ù‰ Ù…Ø´ÙˆØ§Ø­ÙŠ","Ù…Ø±Ø§Ø¯ Ù„ÙƒØ³Ø§Ø³","Ù‡Ø¨Ø© Ø§Ù„Ø¹Ø¨ÙˆØ¯ÙŠ","Ù…Ù„Ø§Ùƒ Ø§Ù„ÙØ§Ø±Ø³ÙŠ","Ø¢Ø¯Ù… Ø§Ù„Ø¹ÙŠØ³ÙŠØ±ÙŠ"],"2BACSP-1":["Ø³ÙŠÙ Ø§Ù„Ø¯ÙŠÙ† Ø£ÙØ±ÙŠ","Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø±ÙØ§Ù„ÙŠ","Ø¢Ø¯Ù… Ø¨Ù† Ø¯Ø§ÙˆØ¯","Ù†Ø¬ÙˆÙ‰ Ø£ÙØ±ÙŠÙƒÙ„","Ø¥Ù„Ù‡Ø§Ù… Ù…Ù†ØµÙˆØ±","Ø¹Ù„Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯Ù„","Ø¨Ù‡ÙŠØ¬Ø© Ø§Ù„Ù‡ÙŠØ³ÙˆÙ","Ø¥Ø³Ø­Ø§Ù‚ Ø§Ù„Ù‡ÙŠÙˆØ¨","ÙŠØ³Ø±Ù‰ Ø³Ø±ØºÙŠÙ†ÙŠ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ø£ÙŠÙˆØ¨ ÙƒØ±ÙŠØ·ÙŠØ·","Ù‡Ù†Ø§Ø¡ Ø§Ù„ÙØ±Ø¹","Ø¯Ø¹Ø§Ø¡ Ø³Ù‚Ø§Ø·","Ø£Ù†Ø³ Ø§Ù„ÙƒØªÙˆÙ†ÙŠ","Ø±Ø­Ø§Ø¨ Ù…Ø²ÙˆØºÙŠ","Ø³Ù„Ù…Ù‰ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ù…Ø±ÙŠÙ… Ø¨ÙˆØµÙÙŠØ­Ø©","Ù…Ø¹Ø§Ø¯ Ø¨Ø­ØªØ±","Ø³Ù…ÙŠØ© Ù‚Ø¨ÙŠ","Ø³Ù„Ù…Ù‰ Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠ","Ø³Ù„Ù…Ù‰ Ø¨ÙƒÙˆØ´","Ø­Ù…Ø²Ø© Ø£Ø¶Ø¹ÙŠÙ","Ø£Ø³Ù…Ø§Ø¡ Ø³Ø±ØºÙŠÙ†ÙŠ Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ","Ø£Ø´Ø±Ù Ø§Ù„ÙˆÙƒÙŠÙ„ÙŠ","Ø§Ù„ØºÙˆØ§Ù„ÙŠ Ø­Ø§ØªÙ…","Ù…Ø­Ù…Ø¯ Ø¨ÙˆØ³Ù„Ø§Ù…ØªÙŠ","Ø¯Ø¹Ø§Ø¡ Ø­Ù…ÙŠÙ†","Ø£Ù…ÙŠÙ† Ù…Ø¯ÙŠØ¯Ø´","Ø´ÙŠÙ…Ø§Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠØ´ÙŠ","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§ÙˆÙŠ","Ø³Ù„ÙˆÙ‰ Ø¨Ù† Ø§Ù„Ø´ÙŠØ®","Ù†Ø¯Ù‰ Ø¢ÙŠØª Ù„ÙˆØ­ÙŠ","Ø®Ø¯ÙŠØ¬Ø© ØµÙ„Ø­ÙŠ","Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ø£Ø´Ù‡Ø¨","ÙŠÙˆØ³Ù Ø§Ù„Ø¹Ø§ØµÙ…ÙŠ","Ù†Ø§Ø¯ÙŠØ© Ø§Ù„Ø¹Ù†ØªØ±ÙŠ"],"2BACSP-2":["Ø¨Ø«ÙŠÙ†Ø© Ø§Ù„Ø´ÙŠØ®","Ø³Ù„Ù…Ù‰ Ø­Ø§Ø¬ÙŠ","ÙØ±Ø§Ø­ Ø§Ù„Ù…ØºØ§Ø±ÙŠ","Ø¢ÙŠØ© Ø§Ù„Ø²Ø¹Ø¬Ù…","Ø¯Ø¹Ø§Ø¡ Ù‚Ø±ÙÙŠ","Ø§Ø¯Ø±ÙŠØ³ Ø§Ù„Ø­Ø¶Ø±ÙŠ","Ø«Ø±ÙŠØ§ Ø§Ù„Ø´Ù…Ø®Ø§Ù†ÙŠ","Ø­Ù…ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¯Ø³ÙŠ","Ø±Ø§Ù†ÙŠØ© Ø£Ù‚Ø¯ÙŠÙ…","ÙƒÙˆØ«Ø± Ù„Ø²Ø¹Ø±","Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø¨ÙˆØ±Ù‚Ø§Ø¯ÙŠ","Ø±Ø­Ø§Ø¨ Ø§Ø¨Ù† Ø§Ù„Ø­Ø§Ø¬","ÙŠÙˆØ³Ù Ø§Ù„ÙÙ‡Ø¯ÙŠ","ØºØ²Ù„Ø§Ù† Ø²Ù‡ÙŠØ±Ø©","ÙÙŠØµÙ„ Ø§Ù„ØºØ§Ø±ÙŠ","Ø®Ø¯ÙŠØ¬Ø© Ø§Ù„Ø¹Ø²ÙˆØ²ÙŠ","ÙŠØ§Ø³ÙŠÙ† ÙƒØ¹ÙŠØ¯Ø©","ÙƒÙˆØ«Ø± Ø§Ù„Ø¯Ø±Ø§Ø¯Ø§Ø¨ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø§Ù„Ø¹ÙƒØ±ÙŠ","Ø­Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ† Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø¬Ù‡Ø§Ù† Ø¨ÙˆÙƒØ±ÙŠØ¨Ø§Øª","Ø£Ø³Ø§Ù…Ø© Ù…Ø§Ù„ÙƒÙŠ","Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯","Ø­ÙØµØ© Ø§Ù„Ø¥Ø¯Ø±ÙŠØ³ÙŠ Ø§Ù„Ù…ØµØ¨Ø§Ø­ÙŠ","Ø³ÙÙŠØ§Ù† Ø®Ø²Ø§Ø²ÙŠ","Ø¨Ø¯Ø± Ø¬Ù†Ø§Ù†ÙŠ Ø§Ù„Ø¯Ø±Ø³ÙŠ","Ø£Ù†Ø³ Ø§Ù„ØªÙˆÙƒØ©","Ø²ÙŠØ¯ Ø­Ù„Ø­Ø§Ù„","Ù…Ø­Ù…Ø¯ Ø·Ù‡ Ø¹Ù…Ø±Ø§Ù†ÙŠ","Ø¹Ø¯ÙŠ Ø§Ù„Ù…ÙƒÙˆØ¯ÙŠ","Ø¢ÙŠØ© Ø§Ù„Ù…Ø¯Ù‡ÙˆÙ†","Ø±Ø¶Ù‰ Ø§Ù„Ø­ÙŠÙˆØªÙŠ","Ø£Ø­Ù„Ø§Ù… Ø§Ù„Ø¯Ø±Ø§ÙˆÙŠ","Ø¹Ù„ÙŠ Ø§Ù„ÙˆÙƒÙŠÙ„ÙŠ","Ø¢Ø³ÙŠØ© Ø­Ù…Ø§Ù†ÙŠ","ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ Ø¨Ù„Ø¯Ø§Ù†ÙŠ","Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø³ÙƒÙŠÙ†","ÙˆØ¦Ø§Ù… ÙƒØ±Ø¹Ø§Ù†"]};

const BEHAVIOURS = [
  {label:"Ø¶Ø¬ÙŠØ¬ ÙˆÙƒÙ„Ø§Ù…", icon:"ğŸ—£ï¸", code:"talking", penalty:0.5, level:"low"},
  {label:"Ø¹Ø¯Ù… Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡", icon:"ğŸ˜´", code:"distracted", penalty:0.5, level:"low"},
  {label:"ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø­ØµØ©", icon:"â°", code:"late", penalty:0.5, level:"low"},
  {label:"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ", icon:"ğŸ“±", code:"phone", penalty:1, level:"low"},
  {label:"Ø¥Ø²Ø¹Ø§Ø¬ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡", icon:"ğŸ˜¤", code:"disturbing", penalty:1, level:"low"},
  {label:"Ø±ÙØ¶ Ø§Ù„Ø¹Ù…Ù„", icon:"ğŸš«", code:"refusal", penalty:1, level:"high"},
  {label:"ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚", icon:"âš¡", code:"disrespect", penalty:2, level:"high"},
  {label:"ØºØ´ Ø£Ùˆ Ù†Ù‚Ù„", icon:"ğŸ“‹", code:"cheating", penalty:2, level:"high"},
  {label:"Ø³Ù„ÙˆÙƒ Ø®Ø·ÙŠØ±", icon:"ğŸ”´", code:"dangerous", penalty:3, level:"high"},
];

const classNames = Object.keys(DEFAULT_DATA);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITABLE ROSTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ROSTER_KEY = cls => 'gbpro_roster_' + cls;

function getRoster(cls){
  try {
    const stored = localStorage.getItem(ROSTER_KEY(cls));
    if(stored){
      const arr = JSON.parse(stored);
      if(Array.isArray(arr) && arr.length) return arr;
    }
  } catch(e){}
  return (DEFAULT_DATA[cls]||[]).slice(); // fallback to hardcoded
}

function saveRoster(cls, arr){
  localStorage.setItem(ROSTER_KEY(cls), JSON.stringify(arr));
}

function addStudent(cls, name){
  const roster = getRoster(cls);
  roster.push(name.trim());
  saveRoster(cls, roster);
  return roster.length; // new student number (1-based)
}

function removeStudent(cls, n){
  // n is 1-based. We don't delete the record â€” we blank the name so data stays.
  // Physically remove from roster (shifts numbers for new entries)
  // Strategy: mark as removed in roster with null, keep data intact.
  const roster = getRoster(cls);
  roster[n-1] = null; // null = removed slot (preserves numbering)
  saveRoster(cls, roster);
}

function renameStudent(cls, n, newName){
  const roster = getRoster(cls);
  roster[n-1] = newName.trim();
  saveRoster(cls, roster);
  // Also update the student record name
  const st = loadCls(cls);
  const rec = getStudentRecord(st, n, newName);
  rec.name = newName.trim();
  saveCls(cls, st);
}

function getActiveRoster(cls){
  // Returns [{n, name}] for non-null entries only
  return getRoster(cls)
    .map((name, idx) => ({n: idx+1, name}))
    .filter(s => s.name !== null && s.name !== undefined && s.name !== '');
}


let currentPage = 'overview';
let currentClass = null;
let _rows = {};

// Modal state
let discCtx = null; // {cls, idx}
let absCtx = null;
let profileCtx = null;
let calYear, calMonth;
let profileForPrint = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = cls => 'gbpro_' + cls;
const SS = 'gbpro_settings';

function loadCls(cls){ try{ return JSON.parse(localStorage.getItem(SK(cls)))||{}; }catch(e){ return {}; } }
// Session ID for conflict detection
const SESSION_ID = 'sess_'+Math.random().toString(36).slice(2,8);
const TS_KEY = function(cls){ return 'gbpro_ts_'+cls; };
const TS_SESS = function(cls){ return 'gbpro_sess_'+cls; };

function saveCls(cls, st){
  try{
    // Conflict check: did another session write after us?
    const lastSess=localStorage.getItem(TS_SESS(cls));
    const lastTs=parseInt(localStorage.getItem(TS_KEY(cls))||'0');
    const now=Date.now();
    if(lastSess && lastSess!==SESSION_ID && now-lastTs<30000){
      // Another session wrote within last 30 seconds
      showConflictWarning(cls);
    }
    localStorage.setItem(SK(cls), JSON.stringify(st));
    localStorage.setItem(TS_KEY(cls), now.toString());
    localStorage.setItem(TS_SESS(cls), SESSION_ID);
    showSaveIndicator();
  }catch(e){ showSaveError(); }
  if(getGsUrl()) showSyncDot('pending');
}

var _conflictShown={};
function showConflictWarning(cls){
  if(_conflictShown[cls]) return;
  _conflictShown[cls]=true;
  showConflictBanner(cls);
}
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SS))||{}; }catch(e){ return {}; } }
function saveSettings(){
  const chk = function(id){ var el=document.getElementById(id); return el?el.checked:false; };
  const s = {
    hw: +v('w-hw'), part: +v('w-part'), disc: +v('w-disc'),
    copy: +v('w-copy'), abs: +v('w-abs'), t1: +v('w-t1'),
    t2: +v('w-t2'), glob: +v('w-glob'),
    partTarget: +v('partTarget'), termStart: v('termStart'),
    academicYear: v('academicYear'),
    lockT1: chk('lockT1'), lockT2: chk('lockT2'),
    teacherName: v('teacherName'), schoolName: v('schoolName'), subjectName: v('subjectName'),
    // Preserve tests and coefficient (managed separately)
    tests: (loadSettings().tests || DEFAULT_TESTS.slice()),
    coefficient: loadSettings().coefficient || 2
  };
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  refreshAllScores();
  updateWeights();
  applyGradeLocks();
}

function applyGradeLocks(){
  var s = loadSettings();
  var tbody = document.getElementById('classTableBody');
  if(!tbody) return;
  var rows = tbody.querySelectorAll('tr');
  for(var i=0;i<rows.length;i++){
    var tds = rows[i].querySelectorAll('td');
    // col index: 0=#, 1=name, 2=abs, 3=part, 4=disc, 5=hw, 6=copy, 7=t1, 8=t2, 9=glob, 10=final
    for(var c=0;c<tds.length;c++){
      var col = tds[c].getAttribute('data-col');
      if(col==='t1'){
        var inp = tds[c].querySelector('input');
        if(inp){ inp.disabled=!!s.lockT1; inp.style.opacity=s.lockT1?'.45':'1'; inp.title=s.lockT1?'ğŸ”’ ÙØ±Ø¶ 1 Ù…Ù‚ÙÙ„':''; }
      }
      if(col==='t2'){
        var inp2 = tds[c].querySelector('input');
        if(inp2){ inp2.disabled=!!s.lockT2; inp2.style.opacity=s.lockT2?'.45':'1'; inp2.title=s.lockT2?'ğŸ”’ ÙØ±Ø¶ 2 Ù…Ù‚ÙÙ„':''; }
      }
    }
  }
}

function loadSettingsUI(){
  const s = loadSettings();
  // Teacher info
  const tn=document.getElementById('teacherName'); if(tn) tn.value=s.teacherName||'ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†';
  const sn=document.getElementById('schoolName'); if(sn) sn.value=s.schoolName||'Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©';
  const sub=document.getElementById('subjectName'); if(sub) sub.value=s.subjectName||'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©';
  const set = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
  set('w-hw', s.hw||8); set('w-part', s.part||8); set('w-disc', s.disc||8);
  set('w-copy', s.copy||8); set('w-abs', s.abs||8); set('w-t1', s.t1||15);
  set('w-t2', s.t2||15); set('w-glob', s.glob||30);
  set('partTarget', s.partTarget||20); set('termStart', s.termStart||'2026-02-18');
  set('academicYear', s.academicYear||'2025â€“2026');
  // Lock checkboxes
  var lt1=document.getElementById('lockT1'); if(lt1) lt1.checked=!!s.lockT1;
  var lt2=document.getElementById('lockT2'); if(lt2) lt2.checked=!!s.lockT2;
  // Teacher info refresh (ensure fields populated)
  var tn2=document.getElementById('teacherName'); if(tn2) tn2.value=s.teacherName||'ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†';
  var sn2=document.getElementById('schoolName'); if(sn2) sn2.value=s.schoolName||'Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©';
  var sub2=document.getElementById('subjectName'); if(sub2) sub2.value=s.subjectName||'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©';
  // Subject profile
  var sdn=document.getElementById('subjectDisplayName'); if(sdn) sdn.value=s.subjectName||'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©';
  var cv=document.getElementById('coeffVal'); if(cv) cv.textContent=s.coefficient||2;
  // Test config & weight builder
  renderTestConfig();
  renderWeightBuilder();
}

function getW(){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  var W = {
    hw: (s.hw||8)/100, part: (s.part||8)/100, disc: (s.disc||8)/100,
    copy: (s.copy||8)/100, abs: (s.abs||8)/100
  };
  tests.forEach(function(t){ W[t.key] = t.weight/100; });
  return W;
}
function getPartTarget(){ const s=loadSettings(); return Math.max(1, s.partTarget||20); }

function updateWeights(){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  var fixed = (s.hw||8)+(s.copy||8)+(s.part||8)+(s.disc||8)+(s.abs||8);
  var testSum = tests.reduce(function(a,t){return a+t.weight;},0);
  var total = fixed + testSum;
  var el = document.getElementById('weightTotal');
  if(el){
    el.textContent = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + total + '%' + (total===100?' âœ“':' â† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 100%');
    el.className = 'weight-total ' + (total===100?'ok':'bad');
  }
  // Update weight bar
  var s2 = loadSettings();
  var comps = [
    {key:'hw',label:'Ø§Ù„ÙˆØ§Ø¬Ø¨',color:'#60a5fa',val:s2.hw||8},
    {key:'copy',label:'Ø§Ù„Ø¯ÙØªØ±',color:'#a78bfa',val:s2.copy||8},
    {key:'part',label:'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©',color:'#34d399',val:s2.part||8},
    {key:'disc',label:'Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·',color:'#f59e0b',val:s2.disc||8},
    {key:'abs',label:'Ø§Ù„ØºÙŠØ§Ø¨',color:'#f87171',val:s2.abs||8}
  ];
  tests.forEach(function(t,i){ comps.push({key:t.key,label:t.label,color:TEST_COLORS[i%4],val:t.weight}); });
  renderWeightBar(comps);
}

function getStudentRecord(st, n, defaultName){
  if(!st.students) st.students = {};
  if(!st.students[n]) st.students[n] = {
    name: defaultName||'',
    scores: {hw:'',copy:'',t1:'',t2:'',glob:''},
    participationPoints: 0,
    disciplineIncidents: [],
    absenceDates: [],
    absenceRecords: [], // [{date, justified}]
    notes: ''
  };
  // Migrate old absenceDates to absenceRecords if needed
  const rec = st.students[n];
  if(rec.absenceDates && rec.absenceDates.length && !(rec.absenceRecords&&rec.absenceRecords.length)){
    rec.absenceRecords = rec.absenceDates.map(d => ({date:d, justified:false}));
  }
  if(!rec.absenceRecords) rec.absenceRecords = [];
  if(!rec.notes) rec.notes = '';
  return rec;
}

// Helpers for absence records
function absGetDates(rec){ return (rec.absenceRecords||[]).map(a=>a.date); }
function absGetUnjust(rec){ return (rec.absenceRecords||[]).filter(a=>!a.justified).map(a=>a.date); }
function absGetJust(rec){ return (rec.absenceRecords||[]).filter(a=>a.justified).map(a=>a.date); }
function absHasDate(rec, iso){ return (rec.absenceRecords||[]).some(a=>a.date===iso); }
function absIsJust(rec, iso){ const r=(rec.absenceRecords||[]).find(a=>a.date===iso); return r?r.justified:false; }
function absAddDate(rec, iso, justified=false){
  if(!rec.absenceRecords) rec.absenceRecords=[];
  if(!absHasDate(rec,iso)) rec.absenceRecords.push({date:iso,justified});
  rec.absenceRecords.sort((a,b)=>a.date.localeCompare(b.date));
  rec.absenceDates = rec.absenceRecords.map(a=>a.date); // keep legacy sync
}
function absRemoveDate(rec, iso){
  rec.absenceRecords = (rec.absenceRecords||[]).filter(a=>a.date!==iso);
  rec.absenceDates = rec.absenceRecords.map(a=>a.date);
}
function absToggleJustified(rec, iso){
  const r=(rec.absenceRecords||[]).find(a=>a.date===iso);
  if(r) r.justified=!r.justified;
  rec.absenceDates = rec.absenceRecords.map(a=>a.date);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clamp(n,lo,hi){ return Math.max(lo,Math.min(hi,n)); }
function num(v){ const x=parseFloat(v); return isFinite(x)?x:0; }
function todayISO(){ return new Date().toISOString().slice(0,10); }
const v = id => { const el=document.getElementById(id); return el?el.value:''; };

function partScore(pts){ return clamp((pts/getPartTarget())*20,0,20); }
function discScore(incs){ return clamp(20-(incs||[]).reduce((a,x)=>a+(x.penalty||0),0),0,20); }
function absScore(rec_or_dates){
  // Accept either a record object (new) or a dates array (legacy)
  let unjustCount;
  if(Array.isArray(rec_or_dates)){
    unjustCount = rec_or_dates.length; // legacy: all count
  } else {
    unjustCount = absGetUnjust(rec_or_dates).length;
  }
  return clamp(20-0.5*unjustCount,0,20);
}

function calcFinal(row){
  var W = getW();
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  var hw = clamp(num(row.hw?row.hw.value:0),0,20);
  var copy = clamp(num(row.copy?row.copy.value:0),0,20);
  var absArg = row.absRec || row.absDates || [];
  var score = W.hw*hw + W.copy*copy
    + W.part*partScore(row.partPoints)
    + W.disc*discScore(row.discIncidents)
    + W.abs*absScore(absArg);
  tests.forEach(function(t){
    var inp = row[t.key];
    var val = inp ? clamp(num(inp.value),0,20) : clamp(num(row[t.key+'_val']||0),0,20);
    score += (W[t.key]||0) * val;
  });
  return clamp(score, 0, 20);
}
function gradeClass(v){ return v>=16?'good':v>=10?'mid':'low'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Navigation history stack â”€â”€
var _navHistory = [];
var _navTitles = {
  overview: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', atrisk: 'Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø®Ø·Ø±',
  settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', dailyabs: 'Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ', compare: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…'
};

function goBack(){
  if(_navHistory.length === 0){ showPage('overview'); return; }
  var prev = _navHistory.pop();
  if(prev.cls){
    _showPageInternal(null, prev.cls, false);
  } else {
    _showPageInternal(prev.pageId, null, false);
  }
}

function showPage(pageId, cls){
  // Push current state to history before navigating
  var wasPage = currentPage;
  var wasCls  = currentClass;
  if(wasPage && wasPage !== 'overview'){
    _navHistory.push({pageId: wasPage, cls: wasCls});
  } else if(wasCls){
    _navHistory.push({pageId: null, cls: wasCls});
  }
  // Cap history at 10
  if(_navHistory.length > 10) _navHistory.shift();
  _showPageInternal(pageId, cls, true);
  closeSidebar();
}

function _showPageInternal(pageId, cls, pushable){
  document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('active'); });
  document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('active'); });
  var backBtn = document.getElementById('backBtn');
  var hamBtn  = document.getElementById('hamBtn');

  if(cls){
    currentClass = cls;
    currentPage  = null;
    document.getElementById('page-class').classList.add('active');
    var _ncb=document.getElementById('nav-cls-'+cls); if(_ncb)_ncb.classList.add('active');
    document.getElementById('topbarTitle').textContent = cls;
    document.getElementById('topbarMeta').textContent  = getRoster(cls).filter(function(n){return !!n;}).length + ' Ø·Ø§Ù„Ø¨Ø§Ù‹';
    try{ renderClassPage(cls); tagTableCols(); applyGradeLocks(); if(_compactMode){ var t=document.getElementById('classTable'); if(t)t.classList.add('compact-mode'); } }catch(e){ console.error('renderClassPage error:',e); }
  } else {
    currentClass = null;
    currentPage  = pageId;
    var pg = document.getElementById('page-'+pageId);
    if(pg) pg.classList.add('active');
    var _npb=document.getElementById('nav-'+pageId); if(_npb)_npb.classList.add('active');
    var tt=document.getElementById('topbarTitle');
    var tm=document.getElementById('topbarMeta');
    if(pageId==='overview'){ if(tt)tt.textContent='Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'; if(tm)tm.textContent=''; renderOverview(); renderWeekStrip(); updateTodayAbsBadge(); _navHistory=[]; }
    if(pageId==='atrisk')  { if(tt)tt.textContent='Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø®Ø·Ø±'; if(tm)tm.textContent=''; renderAtRisk(); }
    if(pageId==='settings'){ if(tt)tt.textContent='Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'; if(tm)tm.textContent=''; loadSettingsUI(); loadGsUrlUI(); }
    if(pageId==='dailyabs'){ if(tt)tt.textContent='Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ'; if(tm)tm.textContent=''; initDailyAbs(); updateAbsDateLabel(); }
    if(pageId==='compare') { if(tt)tt.textContent='Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…'; if(tm)tm.textContent=''; renderComparison(); }
  }

  // Show back button if there's history OR we're not on overview
  var hasHistory = _navHistory.length > 0;
  var isOverview = (pageId === 'overview' && !cls);
  if(backBtn) backBtn.style.display = (!isOverview) ? 'flex' : 'none';
  if(hamBtn)  hamBtn.style.display  = (!isOverview) ? 'none' : '';
}

function openSidebar(){ document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); }
function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD SIDEBAR NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSidebarNav(){
  const list = document.getElementById('classNavList');
  list.innerHTML = '';
  classNames.forEach(cls=>{
    const btn = document.createElement('button');
    btn.className = 'nav-btn';
    btn.id = 'nav-cls-'+cls; // use cls directly for updateBadgeCounts
    const activeCount = getRoster(cls).filter(n=>n).length;
    btn.innerHTML = `<span class="icon">ğŸ“‹</span>${cls}<span class="badge-count">${activeCount}</span>`;
    btn.onclick = ()=>showPage(null, cls);
    list.appendChild(btn);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD CLASS PAGES (no-op â€” using single shared page now)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildClassPageContainers(){ /* single shared #page-class used instead */ }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CLASS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderClassPage(cls){
  rebuildClassTableHead();
  const names = getRoster(cls);
  const st = loadCls(cls);
  const tbody = document.getElementById('classTableBody');
  if(!tbody) return;
  tbody.innerHTML = '';
  if(!_rows[cls]) _rows[cls] = [];
  _rows[cls] = [];

  // Reset search
  const srch = document.getElementById('classSearchBox');
  if(srch) srch.value = '';

  // Update stats
  updateStats(cls);
  _rows[cls] = [];

  names.forEach((defaultName, idx)=>{
    if(!defaultName) return; // removed student slot
    const n = idx+1;
    const rec = getStudentRecord(st, n, defaultName);
    const tr = document.createElement('tr');
    if(isAtRisk(rec)) tr.classList.add('at-risk');

    const rowObj = {
      n, cls,
      nameInp: null,
      hw: null, copy: null, t1: null, t2: null, glob: null,
      partPoints: rec.participationPoints||0,
      discIncidents: (rec.disciplineIncidents||[]).slice(),
      absDates: (rec.absenceDates||[]).slice(),
      absRec: rec, // full record for justified absence support
      final: null,
      partBtn: null, discBadge: null, absTap: null, absCount: null,
    };

    function persist(){
      markUnsaved();
      const s2 = loadCls(cls);
      const r = getStudentRecord(s2, n, defaultName);
      r.name = rowObj.nameInp.value;
      r.scores = { hw: rowObj.hw.value, copy: rowObj.copy.value, t1: rowObj.t1.value, t2: rowObj.t2.value, glob: rowObj.glob.value };
      r.participationPoints = rowObj.partPoints;
      r.disciplineIncidents = rowObj.discIncidents;
      r.absenceDates = rowObj.absDates;
      r.absenceRecords = (rowObj.absRec&&rowObj.absRec.absenceRecords) || rowObj.absDates.map(d=>({date:d,justified:false}));
      r.notes = (rowObj.notesInp&&rowObj.notesInp.value) || r.notes || '';
      rowObj.absRec = r; // keep reference fresh
      saveCls(cls, s2);
      queueSync(cls, n);
    }

    function refresh(){
      const fin = calcFinal(rowObj);
      rowObj.final.textContent = fin.toFixed(2);
      rowObj.final.className = 'final-score ' + gradeClass(fin);
      var lbl=document.getElementById('letter-'+cls+'-'+n);
      if(lbl){ lbl.textContent=letterGrade(fin); lbl.style.color=fin>=10?'var(--muted)':'var(--red)'; }
      // participation
      const pPts = rowObj.partPoints;
      rowObj.partBtn.innerHTML = `â­ <b>${pPts}</b>`;
      // discipline
      const inc = rowObj.discIncidents.length;
      rowObj.discBadge.textContent = inc===0?'ğŸŸ¢ Ø¬ÙŠØ¯': inc<=2?('ğŸŸ¡ '+inc):('ğŸ”´ '+inc);
      rowObj.discBadge.className = 'disc-badge '+(inc===0?'ok':inc<=2?'warn':'danger');
      // absence - show justified/unjustified split
      const absRec = rowObj.absRec;
      const totalAbs = absRec ? (absRec.absenceRecords||[]).length : rowObj.absDates.length;
      const unjustAbs = absRec ? absGetUnjust(absRec).length : totalAbs;
      const justAbs = totalAbs - unjustAbs;
      let absLabel = 'â€”';
      if(totalAbs>0){
        absLabel = unjustAbs>0 ? (unjustAbs+'Øº') : '';
        if(justAbs>0) absLabel += (absLabel?'+':'')+(justAbs+'Ù…');
      }
      rowObj.absCount.textContent = totalAbs>0?absLabel:'â€”';
      rowObj.absCount.className = 'abs-count '+(totalAbs>0?'has-abs':'');
      // Unjustified 4+ warning badge on count
      if(unjustAbs>=4) rowObj.absCount.style.background='rgba(244,63,94,.25)';
      else rowObj.absCount.style.background='';
      rowObj.absTap.className = 'abs-tap '+((absRec?absHasDate(absRec,todayISO()):rowObj.absDates.includes(todayISO()))?'marked':'');
      // at-risk (uses unjustified count)
      tr.classList.toggle('at-risk', isAtRisk({absenceDates:rowObj.absDates, disciplineIncidents:rowObj.discIncidents, _fin:fin, unjustAbs}));
      updateStats(cls);
    }

    // #
    const tdNum = document.createElement('td'); tdNum.className='num'; tdNum.textContent=n;
    // Name
    const tdName = document.createElement('td'); tdName.className='name-cell';
    const ni = document.createElement('input');
    ni.className='name-inp'; ni.type='text'; ni.value=rec.name||''; ni.placeholder='Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨â€¦';
    ni.addEventListener('input',()=>persist());
    rowObj.nameInp = ni;
    tdName.appendChild(ni);

    // Score inputs with validation
    function mkScore(key){ 
      const inp=document.createElement('input'); 
      inp.className='score-inp'; inp.type='number'; inp.min=0; inp.max=20; inp.step=0.25;
      inp.value=(rec.scores&&rec.scores[key])||'';
      inp.addEventListener('input',()=>{
        const v=parseFloat(inp.value);
        if(inp.value!=='' && (v<0||v>20)){
          inp.classList.add('invalid');
          inp.value=Math.max(0,Math.min(20,v)).toString();
          setTimeout(()=>inp.classList.remove('invalid'),500);
        } else { inp.classList.remove('invalid'); }
        persist(); refresh();
      });
      rowObj[key]=inp;
      const td=document.createElement('td');
      td.setAttribute('data-col',key);
      td.appendChild(inp);
      // Apply grade lock immediately on row creation
      var _s=loadSettings();
      if((key==='t1'&&_s.lockT1)||(key==='t2'&&_s.lockT2)){
        inp.disabled=true; inp.style.opacity='.45'; inp.title='ğŸ”’ Ù…Ù‚ÙÙ„';
      }
      return td;
    }

    // Participation
    const tdPart = document.createElement('td');
    const partWrap = document.createElement('div'); partWrap.className='part-cell';
    const partBtn = document.createElement('div'); partBtn.className='part-tap';
    partBtn.title='Tap to add +1 participation point';
    partBtn.addEventListener('click',()=>{ rowObj.partPoints++; persist(); refresh(); showToast('â­ +1 Ù…Ø´Ø§Ø±ÙƒØ©'); });
    const partMinus = document.createElement('div'); partMinus.className='part-minus';
    partMinus.textContent='âˆ’';
    partMinus.addEventListener('click',()=>{ rowObj.partPoints=Math.max(0,rowObj.partPoints-1); persist(); refresh(); });
    rowObj.partBtn = partBtn;
    partWrap.append(partBtn, partMinus);
    tdPart.appendChild(partWrap);

    // Discipline
    const tdDisc = document.createElement('td');
    const discBadge = document.createElement('div'); discBadge.className='disc-badge ok';
    discBadge.addEventListener('click',()=>openDisc(cls, n));
    rowObj.discBadge = discBadge;
    tdDisc.appendChild(discBadge);

    // Absence
    const tdAbs = document.createElement('td');
    const absWrap = document.createElement('div'); absWrap.className='abs-cell';
    const absTap = document.createElement('div'); absTap.className='abs-tap'; absTap.textContent='âœ—';
    absTap.title='Mark absent today'; 
    absTap.addEventListener('click',()=>{
      const d=todayISO();
      // Snapshot for undo
      const st0=loadCls(cls); const recSnap=getStudentRecord(st0,n,defaultName);
      pushUndo(cls,n,recSnap,'Absence marked for '+rec.name||defaultName);
      if(rowObj.absDates.includes(d)) rowObj.absDates=rowObj.absDates.filter(x=>x!==d);
      else rowObj.absDates=rowObj.absDates.concat([d]).sort();
      if(rowObj.absRec){ if(absHasDate(rowObj.absRec,d)) absRemoveDate(rowObj.absRec,d); else absAddDate(rowObj.absRec,d,false); }
      persist(); refresh();
    });
    const absCount = document.createElement('span'); absCount.className='abs-count';
    absCount.addEventListener('click',()=>openAbs(cls,n));
    rowObj.absTap=absTap; rowObj.absCount=absCount;
    absWrap.append(absTap, absCount);
    tdAbs.appendChild(absWrap);

    // Final
    const tdFinal = document.createElement('td'); tdFinal.setAttribute('data-col','final');
    const finalSpan = document.createElement('div'); finalSpan.className='final-score mid';
    rowObj.final = finalSpan;
    const letterSpan = document.createElement('div');
    letterSpan.className='letter-grade-lbl';
    letterSpan.id='letter-'+cls+'-'+n;
    tdFinal.appendChild(finalSpan);
    tdFinal.appendChild(letterSpan);

    // Profile btn
    const tdProf = document.createElement('td');
    const profBtn = document.createElement('button'); profBtn.className='tool-btn';
    profBtn.style.padding='7px 10px'; profBtn.style.fontSize='14px';
    var hasNote = !!(rec.notes&&rec.notes.trim());
    profBtn.innerHTML = hasNote ? 'ğŸ‘¤<span style="color:var(--accent);font-size:9px;vertical-align:top">â—</span>' : 'ğŸ‘¤';
    profBtn.title = hasNote ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù â€” ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù';
    profBtn.setAttribute('id','profBtn-'+cls+'-'+n);
    profBtn.addEventListener('click',function(){ openProfile(cls,n); });
    tdProf.appendChild(profBtn);

    // Tag tds with data-col for compact mode
    tdNum.setAttribute('data-col','n');
    tdName.setAttribute('data-col','name');
    tdAbs.setAttribute('data-col','abs');
    tdPart.setAttribute('data-col','part');
    tdDisc.setAttribute('data-col','disc');
    tdProf.setAttribute('data-col','actions');

    // Build dynamic test score cells
    var _s_cfg = loadSettings();
    var _tests_cfg = (_s_cfg.tests && _s_cfg.tests.length) ? _s_cfg.tests : DEFAULT_TESTS.slice();
    var testTds = _tests_cfg.map(function(t){ return mkScore(t.key); });
    var appendArgs = [tdNum, tdName, tdAbs, tdPart, tdDisc, mkScore('hw'), mkScore('copy')];
    testTds.forEach(function(td){ appendArgs.push(td); });
    appendArgs.push(tdFinal, tdProf);
    tr.append.apply(tr, appendArgs);
    tbody.appendChild(tr);
    refresh();
    _rows[cls].push({ tr, rowObj, n });
  });

  saveCls(cls, st);
  updateStats(cls);
  addRankBadges(cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats(cls){
  const el = document.getElementById('classStatsRow');
  if(!el || !_rows[cls]) return;
  const rows = _rows[cls];
  const vals = rows.map(r=>parseFloat(r.rowObj.final.textContent)||0);
  const avg = vals.reduce((a,b)=>a+b,0)/(vals.length||1);
  const above = vals.filter(v=>v>=10).length;
  const risky = rows.filter(r=>r.tr.classList.contains('at-risk')).length;
  el.innerHTML = `
    <div class="stat-chip gold-chip"><strong>${avg.toFixed(2)}</strong> Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØµÙ„</div>
    <div class="stat-chip green-chip"><strong>${above}</strong> ÙÙˆÙ‚ Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
    <div class="stat-chip red-chip"><strong>${vals.filter(v=>v<10).length}</strong> Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
    <div class="stat-chip"><strong>${risky}</strong> ÙÙŠ Ø®Ø·Ø±</div>
    <div class="stat-chip"><strong>${rows.length}</strong> ØªÙ„Ù…ÙŠØ°</div>`;
  updateRiskCount();
  // Render dist chart under stats
  const dc = document.getElementById('classDistChart');
  if(dc && cls){
    const st=loadCls(cls); const names=getRoster(cls);
    dc.innerHTML='<div class="dist-section-title" style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-bottom:4px">Grade Distribution</div>'+buildFullDistChart(vals);
  }
}

function isAtRisk(rec){
  const unjust = rec.unjustAbs !== undefined ? rec.unjustAbs : (rec.absenceDates||[]).length;
  const abs = unjust >= 4; // 4 unjustified = official Moroccan threshold
  const disc = (rec.disciplineIncidents||[]).length>=3;
  const fin = rec._fin!==undefined ? rec._fin<10 : false;
  return abs||disc||fin;
}

function refreshAllScores(){
  classNames.forEach(cls=>{ if(_rows[cls]&&_rows[cls].length) _rows[cls].forEach(r=>{ const fin=calcFinal(r.rowObj); r.rowObj.final.textContent=fin.toFixed(2); r.rowObj.final.className='final-score '+gradeClass(fin); }); });
  updateRiskCount();
}

function filterTable(cls, term){
  if(!_rows[cls]) return;
  term = term.trim().toLowerCase();
  _rows[cls].forEach(r=>{
    const name = r.rowObj.nameInp.value.toLowerCase();
    r.tr.style.display = (!term||name.includes(term)) ? '' : 'none';
  });
}

function filterTableLive(term){
  if(currentClass) filterTable(currentClass, term);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview(){
  var grid = document.getElementById('dashGrid');
  grid.innerHTML = '';
  var today = todayISO();
  classNames.forEach(function(cls){
    var st = loadCls(cls);
    var names = getRoster(cls);
    var todayAbs=0, totalFin=0, finCount=0, above=0, risky=0;
    var gradeDistrib=[0,0,0,0,0]; // <8, 8-10, 10-12, 12-15, 15+
    names.forEach(function(_,idx){
      if(!names[idx]) return;
      var n=idx+1;
      var rec = getStudentRecord(st, n, names[idx]);
      var rm={hw:{value:(rec.scores&&rec.scores.hw)||''},copy:{value:(rec.scores&&rec.scores.copy)||''},
        t1:{value:(rec.scores&&rec.scores.t1)||''},t2:{value:(rec.scores&&rec.scores.t2)||''},
        glob:{value:(rec.scores&&rec.scores.glob)||''},partPoints:rec.participationPoints||0,
        discIncidents:rec.disciplineIncidents||[],absRec:rec.absenceRecords||rec.absenceDates||[]};
      var fin = calcFinal(rm);
      totalFin+=fin; finCount++;
      if(fin>=10) above++; else risky++;
      if(fin<8) gradeDistrib[0]++;
      else if(fin<10) gradeDistrib[1]++;
      else if(fin<12) gradeDistrib[2]++;
      else if(fin<15) gradeDistrib[3]++;
      else gradeDistrib[4]++;
      if(absHasDate(rec, today)) todayAbs++;
    });
    var studentCount = names.filter(function(n){return !!n;}).length;
    var avg = finCount>0?(totalFin/finCount):0;
    var absColor = todayAbs===0?'var(--green)':todayAbs<=3?'var(--amber)':'var(--red)';
    var absClass = todayAbs===0?'good':todayAbs<=3?'mid':'bad';

    // Mini grade distribution bars
    var maxDistrib = Math.max(1, Math.max.apply(null, gradeDistrib));
    var barColors = ['#f43f5e','#f59e0b','#06b6d4','#22c55e','#c9a84c'];
    var barLabels = ['<8','8-10','10-12','12-15','15+'];
    var barsHtml = gradeDistrib.map(function(v,i){
      var h = Math.round((v/maxDistrib)*32);
      return '<div class="dash-mini-bar-wrap" title="'+barLabels[i]+': '+v+' Ø·Ø§Ù„Ø¨">'
        +'<div class="dash-mini-bar" style="height:'+h+'px;background:'+barColors[i]+'"></div>'
        +'<div class="dash-mini-bar-lbl">'+barLabels[i]+'</div>'
        +'</div>';
    }).join('');

    var card = document.createElement('div');
    card.className = 'dash-card';
    card.onclick = function(){ showPage(null, cls); };
    card.innerHTML =
      '<div class="dash-card-top">'
        +'<div>'
          +'<div class="cls-name">'+cls+'</div>'
          +'<div class="cls-count">'+studentCount+' Ø·Ø§Ù„Ø¨Ø§Ù‹</div>'
        +'</div>'
        +'<div class="dash-avg-pill" title="Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…">'
          +'<span class="dash-avg-val '+(avg>=10?'good':'bad')+'">'+(avg>0?avg.toFixed(1):'â€”')+'</span>'
          +'<span class="dash-avg-suffix">/20</span>'
        +'</div>'
      +'</div>'
      +'<div class="dash-abs-row">'
        +'<span class="dash-abs-lbl">ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</span>'
        +'<span class="dash-abs-val '+absClass+'">'+todayAbs+'</span>'
      +'</div>'
      +'<div class="dash-grade-bars">'
        +barsHtml
      +'</div>'
      +'<div class="dash-card-footer">'
        +'<span class="dash-footer-stat good">âœ“ '+above+' ÙÙˆÙ‚ 10</span>'
        +'<span class="dash-footer-stat bad">âœ— '+risky+' Ø¯ÙˆÙ† 10</span>'
        +'<button class="dash-report-btn" id="drb-'+cls+'">ğŸ“Š ØªÙ‚Ø±ÙŠØ±</button>'
      +'</div>';
    grid.appendChild(card);
    // Wire report button safely
    var rb = document.getElementById('drb-'+cls);
    if(rb){ rb.onclick = (function(c){ return function(e){ e.stopPropagation(); openAbsReport(c); }; })(cls); }
  });
  if(!classNames.length){
    grid.innerHTML='<div class="empty-state"><div class="big-icon">ğŸ“š</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¹Ø¯.<br/>Ø£Ø¶Ù Ù‚Ø³Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</p></div>';
  }
}
function renderAtRisk(){
  var list = document.getElementById('riskList');
  list.innerHTML='';
  var _riskData = [];
  var counts = {all:0, grade:0, abs:0, disc:0};
  classNames.forEach(function(cls){
    var st=loadCls(cls); var names=getRoster(cls);
    names.forEach(function(_,idx){
      var n=idx+1; var name=names[idx]; if(!name) return;
      var rec=getStudentRecord(st,n,name);
      var rm={hw:{value:(rec.scores&&rec.scores.hw)||''},copy:{value:(rec.scores&&rec.scores.copy)||''},
        t1:{value:(rec.scores&&rec.scores.t1)||''},t2:{value:(rec.scores&&rec.scores.t2)||''},
        glob:{value:(rec.scores&&rec.scores.glob)||''},partPoints:rec.participationPoints||0,
        discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]};
      var fin=calcFinal(rm);
      var abs=(rec.absenceDates||[]).length;
      var disc=(rec.disciplineIncidents||[]).length;
      if(!isAtRisk({absenceDates:rec.absenceDates,disciplineIncidents:rec.disciplineIncidents,_fin:fin})) return;
      var flags=[];
      var severity=0;
      if(fin<10){ flags.push('grade'); severity+=(10-fin)*3; }
      if(abs>=5){ flags.push('abs'); severity+=abs*2; }
      if(disc>=3){ flags.push('disc'); severity+=disc*4; }
      counts.all++;
      flags.forEach(function(f){ counts[f]++; });
      _riskData.push({cls,n,name:rec.name||name,fin,abs,disc,flags,severity});
    });
  });
  // Update filter counts
  Object.keys(counts).forEach(function(k){
    var el=document.getElementById('rfc-'+k); if(el) el.textContent=counts[k];
  });
  // Store globally for filter/sort
  window._riskAll = _riskData;
  _renderRiskList(_riskData);
  updateRiskCount();
}

var _riskFilter='all', _riskSort='severity';

function _renderRiskList(data){
  var list = document.getElementById('riskList');
  list.innerHTML='';
  if(!data||!data.length){
    list.innerHTML='<div class="empty-state"><div class="big-icon">âœ…</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ ÙˆØ¶Ø¹ Ø®Ø·Ø±.<br/>Ø£Ø­Ø³Ù†Øª!</p></div>';
    return;
  }
  // Sort
  var sorted = data.slice().sort(function(a,b){
    if(_riskSort==='severity') return b.severity-a.severity;
    if(_riskSort==='grade')    return a.fin-b.fin;
    if(_riskSort==='abs')      return b.abs-a.abs;
    if(_riskSort==='class')    return a.cls.localeCompare(b.cls);
    return 0;
  });
  // Filter
  var filtered = _riskFilter==='all' ? sorted : sorted.filter(function(r){ return r.flags.includes(_riskFilter); });
  if(!filtered.length){
    list.innerHTML='<div class="empty-state"><div class="big-icon">ğŸ”</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.</p></div>';
    return;
  }
  filtered.forEach(function(r){
    var sev = r.severity>40?'critical':r.severity>20?'high':'medium';
    var tags='';
    if(r.flags.includes('grade')) tags+=`<span class="risk-tag grade">ğŸ“‰ ${r.fin.toFixed(1)}/20</span>`;
    if(r.flags.includes('abs'))   tags+=`<span class="risk-tag abs">ğŸ“… ${r.abs} ØºÙŠØ§Ø¨</span>`;
    if(r.flags.includes('disc'))  tags+=`<span class="risk-tag disc">âš ï¸ ${r.disc} Ø¥Ù†Ø°Ø§Ø±</span>`;
    var card=document.createElement('div');
    card.className='risk-card risk-sev-'+sev;
    card.onclick=function(){ openProfile(r.cls,r.n); };
    card.innerHTML=`
      <div class="risk-sev-bar"></div>
      <div class="risk-card-body">
        <div class="risk-card-left">
          <div class="risk-name">${r.name}</div>
          <div class="risk-cls">${r.cls}</div>
          <div class="risk-tags">${tags}</div>
        </div>
        <div class="risk-card-score risk-${r.flags.includes('grade')?'bad':'ok'}">${r.fin.toFixed(1)}</div>
      </div>`;
    list.appendChild(card);
  });
}

function filterRisk(filter, btn){
  _riskFilter=filter;
  document.querySelectorAll('.risk-filter-btn').forEach(function(b){ b.classList.remove('active'); });
  if(btn) btn.classList.add('active');
  if(window._riskAll) _renderRiskList(window._riskAll);
}

function sortRisk(sort, btn){
  _riskSort=sort;
  document.querySelectorAll('.risk-sort-btn').forEach(function(b){ b.classList.remove('active'); });
  if(btn) btn.classList.add('active');
  if(window._riskAll) _renderRiskList(window._riskAll);
}
function updateRiskCount(){
  let count=0;
  classNames.forEach(cls=>{
    const st=loadCls(cls);
    (getRoster(cls)).forEach((_,idx)=>{
      const rec=getStudentRecord(st,idx+1,getRoster(cls)[idx]);
      const rm={hw:{value:(rec.scores&&rec.scores.hw)||''},copy:{value:(rec.scores&&rec.scores.copy)||''},t1:{value:(rec.scores&&rec.scores.t1)||''},t2:{value:(rec.scores&&rec.scores.t2)||''},glob:{value:(rec.scores&&rec.scores.glob)||''},partPoints:rec.participationPoints||0,discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]};
      if(isAtRisk({absenceDates:rec.absenceDates,disciplineIncidents:rec.disciplineIncidents,_fin:calcFinal(rm)})) count++;
    });
  });
  const el=document.getElementById('riskCount');
  if(el) el.textContent=count;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISCIPLINE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDisc(cls, n){
  discCtx={cls,n};
  const st=loadCls(cls);
  const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  document.getElementById('discModalName').textContent=rec.name||getRoster(cls)[n-1];
  document.getElementById('discModalMeta').textContent=`#${n} Â· ${cls}`;
  renderDiscCats(); renderIncLog(rec.disciplineIncidents||[]);
  document.getElementById('discOverlay').classList.add('show');
}
function closeDisc(){ document.getElementById('discOverlay').classList.remove('show'); discCtx=null; }

function renderDiscCats(){
  const wrap=document.getElementById('incCats');
  wrap.innerHTML='';
  BEHAVIOURS.forEach(b=>{
    const btn=document.createElement('button');
    btn.className='cat-btn '+(b.level==='high'?'high-cat':'low-cat');
    btn.innerHTML=`<span class="cat-icon">${b.icon}</span>${b.label}<br/><small style="color:var(--muted);font-size:10px">âˆ’${b.penalty} Ù†Ù‚Ø·Ø©</small>`;
    btn.onclick=()=>addInc(b);
    wrap.appendChild(btn);
  });
}

function addInc(b){
  if(!discCtx) return;
  const {cls,n}=discCtx;
  // Snapshot for undo
  const st0=loadCls(cls); const recSnap=getStudentRecord(st0,n,getRoster(cls)[n-1]);
  pushUndo(cls,n,recSnap,'Discipline: '+b.label);
  const st=loadCls(cls); const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  rec.disciplineIncidents=(rec.disciplineIncidents||[]).concat([{date:todayISO(),code:b.code,label:b.label,penalty:b.penalty}]);
  saveCls(cls,st);
  queueSync(cls,n);
  syncRowFromStorage(cls,n);
  renderIncLog(rec.disciplineIncidents);
  showToast('âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„: '+b.label);
}

function removeInc(idx){
  if(!discCtx) return;
  const {cls,n}=discCtx;
  const st=loadCls(cls); const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  rec.disciplineIncidents=(rec.disciplineIncidents||[]).filter((_,i)=>i!==idx);
  saveCls(cls,st);
  queueSync(cls,n);
  syncRowFromStorage(cls,n);
  renderIncLog(rec.disciplineIncidents);
}

function renderIncLog(incs){
  const wrap=document.getElementById('incLog');
  if(!incs||!incs.length){ wrap.innerHTML='<p style="color:var(--muted);font-size:13px;text-align:right">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</p>'; return; }
  wrap.innerHTML='';
  incs.forEach(function(x,i){
    const div=document.createElement('div'); div.className='inc-item';
    // Label - tappable to edit
    const info=document.createElement('div'); info.className='inc-info';
    const lbl=document.createElement('div'); lbl.className='inc-label';
    lbl.textContent=x.label;
    const meta=document.createElement('div'); meta.className='inc-meta';
    // Date editable
    const dateInp=document.createElement('input');
    dateInp.type='date'; dateInp.value=x.date;
    dateInp.className='inc-date-inp';
    dateInp.onchange=function(){ updateInc(i,'date',dateInp.value); };
    // Penalty editable
    const penSpan=document.createElement('span');
    penSpan.textContent=' Â· âˆ’';
    const penInp=document.createElement('input');
    penInp.type='number'; penInp.value=x.penalty; penInp.min=0; penInp.max=5; penInp.step=0.5;
    penInp.className='inc-pen-inp';
    penInp.onchange=function(){ updateInc(i,'penalty',parseFloat(penInp.value)||0); };
    const penLbl=document.createElement('span'); penLbl.textContent=' Ù†Ù‚Ø·Ø©';
    meta.append(dateInp, penSpan, penInp, penLbl);
    info.append(lbl, meta);
    const btns=document.createElement('div'); btns.style.cssText='display:flex;gap:6px;align-items:center';
    const rmBtn=document.createElement('button'); rmBtn.className='rm-btn'; rmBtn.textContent='Ø­Ø°Ù';
    rmBtn.onclick=function(){ removeInc(i); };
    btns.appendChild(rmBtn);
    div.append(info, btns);
    wrap.appendChild(div);
  });
}

function updateInc(idx, field, val){
  if(!discCtx) return;
  const {cls,n}=discCtx;
  const st=loadCls(cls); const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  const incs=rec.disciplineIncidents||[];
  if(!incs[idx]) return;
  incs[idx][field]=val;
  rec.disciplineIncidents=incs;
  saveCls(cls,st); queueSync(cls,n); syncRowFromStorage(cls,n);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABSENCE CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAbs(cls,n){
  absCtx={cls,n};
  const st=loadCls(cls); const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  document.getElementById('absModalName').textContent=rec.name||getRoster(cls)[n-1];
  document.getElementById('absModalMeta').textContent=`#${n} Â· ${cls} Â· ${(rec.absenceDates&&rec.absenceDates.length)||0} ÙŠÙˆÙ… ØºÙŠØ§Ø¨`;
  const now=new Date(); calYear=now.getFullYear(); calMonth=now.getMonth();
  renderCal(); document.getElementById('absOverlay').classList.add('show');
}
function closeAbs(){ document.getElementById('absOverlay').classList.remove('show'); absCtx=null; }
function calPrev(){ calMonth--; if(calMonth<0){calMonth=11;calYear--;} renderCal(); }
function calNext(){ calMonth++; if(calMonth>11){calMonth=0;calYear++;} renderCal(); }

function renderCal(){
  if(!absCtx) return;
  const {cls,n}=absCtx;
  const st=loadCls(cls); const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  const months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆØ²','ØºØ´Øª','Ø´ØªÙ†Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙ†Ø¨Ø±','Ø¯Ø¬Ù†Ø¨Ø±'];
  document.getElementById('calMonthLabel').textContent=months[calMonth]+' '+calYear;
  const grid=document.getElementById('calGrid');
  grid.innerHTML='';
  const days=['Ø§Ù„Ø¥Ø«','Ø§Ù„Ø«Ù„','Ø§Ù„Ø£Ø±','Ø§Ù„Ø®Ù…','Ø§Ù„Ø¬Ù…','Ø§Ù„Ø³Ø¨','Ø§Ù„Ø£Ø­'];
  days.forEach(d=>{ const h=document.createElement('div'); h.className='cal-day-lbl'; h.textContent=d; grid.appendChild(h); });
  const first=new Date(calYear,calMonth,1);
  const startDow=(first.getDay()+6)%7;
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  for(let i=0;i<startDow;i++){ const c=document.createElement('div'); c.className='cal-cell empty'; grid.appendChild(c); }
  const today=todayISO();
  for(let d=1;d<=daysInMonth;d++){
    const iso=new Date(calYear,calMonth,d).toISOString().slice(0,10);
    const c=document.createElement('div'); c.className='cal-cell';
    c.textContent=d;
    const hasAbs=absHasDate(rec,iso);
    const isJust=absIsJust(rec,iso);
    if(hasAbs) c.classList.add(isJust?'absent-just':'absent');
    if(iso===today) c.classList.add('today');
    // Tap = toggle absence (unjustified by default)
    c.addEventListener('click',()=>{
      const s2=loadCls(cls); const r=getStudentRecord(s2,n,getRoster(cls)[n-1]);
      if(absHasDate(r,iso)) absRemoveDate(r,iso);
      else absAddDate(r,iso,false);
      saveCls(cls,s2); queueSync(cls,n); syncRowFromStorage(cls,n); renderCal();
      document.getElementById('absModalMeta').textContent=`#${n} Â· ${cls} Â· ${(r.absenceRecords||[]).length} ÙŠÙˆÙ… ØºÙŠØ§Ø¨`;
    });
    // Long press = toggle justified
    let longPressTimer;
    c.addEventListener('touchstart',()=>{ longPressTimer=setTimeout(()=>{
      if(!absHasDate(rec,iso)) return;
      const s2=loadCls(cls); const r=getStudentRecord(s2,n,getRoster(cls)[n-1]);
      absToggleJustified(r,iso);
      saveCls(cls,s2); queueSync(cls,n); syncRowFromStorage(cls,n); renderCal();
      showToast(absIsJust(r,iso)?'âœ… Ù…Ø¨Ø±Ø±Ø©':'âŒ ØºÙŠØ± Ù…Ø¨Ø±Ø±Ø©');
    },600); },{passive:true});
    c.addEventListener('touchend',()=>clearTimeout(longPressTimer),{passive:true});
    c.addEventListener('contextmenu',(e)=>{
      e.preventDefault();
      if(!absHasDate(rec,iso)) return;
      const s2=loadCls(cls); const r=getStudentRecord(s2,n,getRoster(cls)[n-1]);
      absToggleJustified(r,iso);
      saveCls(cls,s2); queueSync(cls,n); syncRowFromStorage(cls,n); renderCal();
      showToast(absIsJust(r,iso)?'âœ… ØºÙŠØ§Ø¨ Ù…Ø¨Ø±Ø±':'âŒ ØºÙŠØ§Ø¨ ØºÙŠØ± Ù…Ø¨Ø±Ø±');
    });
    grid.appendChild(c);
  }
  const unjust=absGetUnjust(rec); const just=absGetJust(rec);
  const total=(rec.absenceRecords||[]).length;
  let listText='Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù…Ø³Ø¬Ù„.';
  if(total>0) listText=`Ø§Ù„ØºÙŠØ§Ø¨: ${total} ÙŠÙˆÙ… (${unjust.length} ØºÙŠØ± Ù…Ø¨Ø±Ø±ØŒ ${just.length} Ù…Ø¨Ø±Ø±)`;
  document.getElementById('absDatesList').textContent=listText;
  // Show official warning if 4+ unjustified
  const warn=document.getElementById('absWarning4');
  if(warn){
    if(unjust.length>=4) warn.innerHTML=`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø±Ø³Ù…ÙŠ: ${unjust.length} ØºÙŠØ§Ø¨ ØºÙŠØ± Ù…Ø¨Ø±Ø± â€” ÙŠØ³ØªÙˆØ¬Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø³Ø·Ø±ÙŠ`;
    else warn.innerHTML='';
    warn.className=unjust.length>=4?'abs-warning-4':'';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC ROW FROM STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncRowFromStorage(cls,n){
  const rows=_rows[cls];
  if(!rows) return;
  const entry=rows.find(r=>r.n===n);
  if(!entry) return;
  const st=loadCls(cls);
  const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  const ro=entry.rowObj;
  ro.partPoints=rec.participationPoints||0;
  ro.discIncidents=(rec.disciplineIncidents||[]).slice();
  ro.absDates=(rec.absenceDates||[]).slice();
  ro.absRec=rec; // keep fresh reference for justified absences
  const fin=calcFinal(ro);
  ro.final.textContent=fin.toFixed(2);
  ro.final.className='final-score '+gradeClass(fin);
  ro.partBtn.innerHTML=`â­ <b>${ro.partPoints}</b>`;
  const inc=ro.discIncidents.length;
  ro.discBadge.textContent=inc===0?'ğŸŸ¢ Ø¬ÙŠØ¯':inc<=2?('ğŸŸ¡ '+inc):('ğŸ”´ '+inc);
  ro.discBadge.className='disc-badge '+(inc===0?'ok':inc<=2?'warn':'danger');
  const ac=ro.absDates.length;
  ro.absCount.textContent=ac>0?ac+'Øº':'â€”';
  ro.absCount.className='abs-count '+(ac>0?'has-abs':'');
  ro.absTap.className='abs-tap '+(ro.absDates.includes(todayISO())?'marked':'');
  entry.tr.classList.toggle('at-risk',isAtRisk({absenceDates:ro.absDates,disciplineIncidents:ro.discIncidents,_fin:fin}));
  updateStats(cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDENT PROFILE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProfile(cls,n){
  profileCtx={cls,n};
  const st=loadCls(cls); const rec=getStudentRecord(st,n,getRoster(cls)[n-1]);
  const name=rec.name||getRoster(cls)[n-1];
  document.getElementById('profileName').textContent=name;
  document.getElementById('profileMeta').textContent=`#${n} Â· ${cls}`;
  // compute scores
  var _rf0=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;var ro=_rf0?_rf0.rowObj:null;
  const hw=ro?num(ro.hw.value):num((rec.scores&&rec.scores.hw));
  const copy=ro?num(ro.copy.value):num((rec.scores&&rec.scores.copy));
  const t1=ro?num(ro.t1.value):num((rec.scores&&rec.scores.t1));
  const t2=ro?num(ro.t2.value):num((rec.scores&&rec.scores.t2));
  const glob=ro?num(ro.glob.value):num((rec.scores&&rec.scores.glob));
  const pPts=ro?ro.partPoints:rec.participationPoints||0;
  const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
  const absDates=ro?ro.absDates:rec.absenceDates||[];
  const pS=partScore(pPts), dS=discScore(incs), aS=absScore(absDates);
  const rowMock={hw:{value:hw},copy:{value:copy},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absDates:absDates};
  const fin=calcFinal(rowMock);
  profileForPrint={cls,n,name,hw,copy,t1,t2,glob,pPts,pS,dS,aS,incs,absDates,fin};
  const body=document.getElementById('profileBody');
  body.innerHTML=`
    <div class="profile-final">
      <div class="big ${gradeClass(fin)}">${fin.toFixed(2)}<span class="out20">/20</span></div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
    </div>
    <div class="profile-grid">
      <div class="profile-card">
        <h4>Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ…Ø±</h4>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span><span class="val">${hw||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ø¯ÙØªØ±</span><span class="val">${copy||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</span><span class="val">${pPts} Ù†Ù‚Ø·Ø© â†’ ${pS.toFixed(1)}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</span><span class="val">${dS.toFixed(1)}/20 (${incs.length} Ø­.)</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„ØºÙŠØ§Ø¨</span><span class="val">${absDates.length} ÙŠÙˆÙ… â†’ ${aS.toFixed(1)}/20</span></div>
      </div>
      <div class="profile-card">
        <h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±ÙˆØ¶</h4>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø£ÙˆÙ„</span><span class="val">${t1||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø«Ø§Ù†ÙŠ</span><span class="val">${t2||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="val">${glob||'â€”'}/20</span></div>
        <div class="profile-row"><span class="lbl">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</span><span class="val" style="color:var(--gold2)">${cls}</span></div>
      </div>
    </div>
    ${incs.length?'<div class="profile-card"><h4 style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:8px;direction:rtl">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h4><div class="rpt-incidents" style="color:var(--muted2);direction:rtl">'+incs.map(x=>x.date+': '+x.label).join('<br/>')+'</div></div>':''}` ;
  // Notes field
  const notesArea = document.getElementById('profileNotesArea');
  if(notesArea){
    notesArea.value = rec.notes || '';
    notesArea.oninput = ()=>{
      const s2=loadCls(cls); const r=getStudentRecord(s2,n,getRoster(cls)[n-1]);
      r.notes = notesArea.value;
      saveCls(cls,s2);
      // update rowObj if available
      var row=_rows[cls]?_rows[cls].find(function(r2){return r2.n===n;}):null;
      if(row && row.rowObj.notesInp) row.rowObj.notesInp.value = notesArea.value;
      refreshNoteIndicator(cls, n, !!(notesArea.value&&notesArea.value.trim()));
    };
  }
  document.getElementById('profileOverlay').classList.add('show');
}
function closeProfile(){ document.getElementById('profileOverlay').classList.remove('show'); profileCtx=null; profileForPrint=null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARABIC REPORT PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printArabicReport(){
  if(!profileForPrint) return;
  const {cls,n,name,hw,copy,t1,t2,glob,pPts,pS,dS,aS,incs,absDates,fin} = profileForPrint;
  const s=loadSettings();
  const year=s.academicYear||'2025â€“2026';
  const today=todayISO();
  const incHTML=incs.length
    ? incs.map(x=>`<tr><td>${x.date}</td><td>${x.label}</td><td style="color:#c0392b">âˆ’${x.penalty}</td></tr>`).join('')
    : '<tr><td colspan="3" style="color:#999;text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</td></tr>';
  const absHTML=absDates.length?absDates.join(' â€¢ '):'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù…Ø³Ø¬Ù„';
  const w=getW();
  const grade=fin>=16?'Ù…Ù…ØªØ§Ø²':fin>=14?'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹':fin>=12?'Ø¬ÙŠØ¯':fin>=10?'Ù…Ù‚Ø¨ÙˆÙ„':'Ø¶Ø¹ÙŠÙ';
  const winHTML=`<!DOCTYPE html><html dir="rtl" lang="ar">
<head><meta charset="utf-8"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'IBM Plex Sans Arabic',sans-serif;background:#f4f4f4;padding:20px;direction:rtl}
  .page{max-width:780px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1)}
  .header{background:linear-gradient(135deg,#1a2d5a,#2d4a8f);color:#fff;padding:24px 30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .header h1{font-size:20px;font-weight:700;margin-bottom:4px}
  .header .sub{font-size:12px;opacity:.8}
  .header .school{text-align:left;font-size:12px;opacity:.85;line-height:1.6}
  .gold-bar{height:5px;background:linear-gradient(90deg,#c9a84c,#e8c870,#c9a84c)}
  .body{padding:24px 30px}
  .student-banner{background:linear-gradient(135deg,#f8f4e8,#fff9ef);border:2px solid #c9a84c;border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .student-name{font-size:20px;font-weight:700;color:#1a2d5a}
  .student-meta{font-size:13px;color:#666;margin-top:3px}
  .final-box{text-align:center;background:#1a2d5a;color:#fff;border-radius:10px;padding:12px 20px;min-width:120px}
  .final-num{font-size:32px;font-weight:700;line-height:1}
  .final-grade{font-size:13px;opacity:.85;margin-top:4px}
  .final-box.good{background:#27ae60}
  .final-box.mid{background:#e67e22}
  .final-box.low{background:#c0392b}
  section{margin-bottom:18px}
  section h2{font-size:14px;font-weight:700;color:#1a2d5a;border-bottom:2px solid #c9a84c;padding-bottom:6px;margin-bottom:10px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th{background:#1a2d5a;color:#fff;padding:9px 12px;text-align:right;font-weight:600;font-size:12px}
  td{padding:8px 12px;border-bottom:1px solid #eee;vertical-align:middle}
  tr:nth-child(even) td{background:#fafafe}
  .score{font-weight:700;color:#1a2d5a}
  .score.ok{color:#27ae60}
  .score.warn{color:#e67e22}
  .score.bad{color:#c0392b}
  .note-box{background:#fff9e6;border:1px solid #f0c040;border-radius:8px;padding:12px 16px;font-size:12px;color:#555;line-height:1.7}
  .sigs{display:flex;justify-content:space-between;margin-top:24px;gap:20px;flex-wrap:wrap}
  .sig{text-align:center;min-width:180px}
  .sig-title{font-size:12px;color:#666;margin-bottom:28px}
  .sig-line{border-top:1px solid #999;width:180px;margin:0 auto;padding-top:4px;font-size:11px;color:#999}
  .footer{background:#f0f0f0;padding:10px 20px;text-align:center;font-size:11px;color:#888;margin-top:4px}
  @media print{body{background:#fff;padding:0}.page{box-shadow:none;border-radius:0}}
</style>
</head>
<body><div class="page">
  <div class="header">
    <div>
      <h1>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠ Ù„Ù„ØªÙ„Ù…ÙŠØ°</h1>
      <div class="sub">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ${year} Â· ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${today}</div>
    </div>
    <div class="school">
      Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©<br/>
      Ø³Ø§ÙŠØ³ â€“ ÙØ§Ø³<br/>
      Ù…Ø§Ø¯Ø©: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    </div>
  </div>
  <div class="gold-bar"></div>
  <div class="body">
    <div class="student-banner">
      <div>
        <div class="student-name">${name}</div>
        <div class="student-meta">Ø§Ù„Ø±Ù‚Ù…: ${n} Â· Ø§Ù„Ù‚Ø³Ù…: ${cls}</div>
      </div>
      <div class="final-box ${gradeClass(fin)}">
        <div class="final-num">${fin.toFixed(2)}</div>
        <div class="final-grade">${grade}</div>
      </div>
    </div>

    <section>
      <h2>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±ÙˆØ¶ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ø¹Ù†ØµØ±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 20</th><th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th></tr></thead>
        <tbody>
          <tr><td>Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø£ÙˆÙ„</td><td class="score ${t1>=10?'ok':'bad'}">${t1||'â€”'}</td><td>${Math.round(w.t1*100)}%</td></tr>
          <tr><td>Ø§Ù„ÙØ±Ø¶ Ø§Ù„Ø«Ø§Ù†ÙŠ</td><td class="score ${t2>=10?'ok':'bad'}">${t2||'â€”'}</td><td>${Math.round(w.t2*100)}%</td></tr>
          <tr><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td class="score ${glob>=10?'ok':'bad'}">${glob||'â€”'}</td><td>${Math.round(w.glob*100)}%</td></tr>
        </tbody>
      </table>
    </section>

    <section>
      <h2>ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ…Ø±</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ø¹Ù†ØµØ±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© / Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„ØªØ­ÙˆÙŠÙ„ /20</th><th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th></tr></thead>
        <tbody>
          <tr><td>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</td><td>${hw||'â€”'}</td><td class="score ${hw>=10?'ok':'bad'}">${hw||'â€”'}</td><td>${Math.round(w.hw*100)}%</td></tr>
          <tr><td>Ø¯ÙØªØ± Ø§Ù„Ø¯Ø±ÙˆØ³</td><td>${copy||'â€”'}</td><td class="score ${copy>=10?'ok':'bad'}">${copy||'â€”'}</td><td>${Math.round(w.copy*100)}%</td></tr>
          <tr><td>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙÙŠØ©</td><td>${pPts} Ù†Ù‚Ø·Ø©</td><td class="score ${pS>=10?'ok':'bad'}">${pS.toFixed(2)}</td><td>${Math.round(w.part*100)}%</td></tr>
          <tr><td>Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ</td><td>${incs.length} Ù…Ù„Ø§Ø­Ø¸Ø©</td><td class="score ${dS>=16?'ok':dS>=10?'warn':'bad'}">${dS.toFixed(2)}</td><td>${Math.round(w.disc*100)}%</td></tr>
          <tr><td>Ø§Ù„ØºÙŠØ§Ø¨</td><td>${absDates.length} ÙŠÙˆÙ…</td><td class="score ${aS>=16?'ok':aS>=10?'warn':'bad'}">${aS.toFixed(2)}</td><td>${Math.round(w.abs*100)}%</td></tr>
        </tbody>
      </table>
    </section>

    ${incs.length?`<section>
      <h2>âš ï¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h2>
      <table>
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø§Ù„Ø®ØµÙ…</th></tr></thead>
        <tbody>${incHTML}</tbody>
      </table>
    </section>`:''}

    <section>
      <h2>ğŸ“… Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h2>
      <div class="note-box">${absHTML}</div>
    </section>

    <section>
      <h2>ğŸ’¬ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°</h2>
      <div class="note-box" style="min-height:60px">
        ${fin>=16?'Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¦Ø¹.':fin>=12?'Ù…Ø³ØªÙˆÙ‰ Ø¬ÙŠØ¯ØŒ Ø¨Ø°Ù„ Ù…Ø¬Ù‡ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„ÙØ±ÙˆØ¶ Ø³ÙŠØ­Ø³Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©.':fin>=10?'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©ØŒ Ù„ÙƒÙ† ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø©.':'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„ØŒ ÙŠÙ„Ø²Ù… ØªØ¯Ø§Ø±Ùƒ Ø§Ù„ÙˆØ¶Ø¹ Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ù….'}
      </div>
    </section>

    <div class="sigs">
      <div class="sig"><div class="sig-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø£Ø³ØªØ§Ø°</div><div class="sig-line"></div></div>
      <div class="sig"><div class="sig-title">ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div><div class="sig-line"></div></div>
      <div class="sig"><div class="sig-title">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div><div class="sig-line"></div></div>
    </div>
  </div>
  <div class="footer">ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ© ØµØ§Ø¯Ø±Ø© Ø¹Ù† Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ© Â· ${today}</div>
</div>
<script>window.onload=()=>window.print();<\/script>
</body></html>`;
  const w2=window.open('','_blank');
  if(w2){ w2.document.write(winHTML); w2.document.close(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASS REPORT PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPrintAllReport(cls){
  const st=loadCls(cls); const names=getRoster(cls);
  const s=loadSettings(); const year=s.academicYear||'2025â€“2026'; const today=todayISO();
  const rows=names.map((_,idx)=>{
    const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
    var _rf0=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;var ro=_rf0?_rf0.rowObj:null;
    const hw=ro?num(ro.hw.value):num((rec.scores&&rec.scores.hw));
    const t1=ro?num(ro.t1.value):num((rec.scores&&rec.scores.t1));
    const t2=ro?num(ro.t2.value):num((rec.scores&&rec.scores.t2));
    const glob=ro?num(ro.glob.value):num((rec.scores&&rec.scores.glob));
    const pPts=ro?ro.partPoints:rec.participationPoints||0;
    const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
    const abs=ro?ro.absDates:rec.absenceDates||[];
    const rowMock={hw:{value:hw},copy:{value:ro?num(ro.copy.value):num((rec.scores&&rec.scores.copy))},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absDates:abs};
    const fin=calcFinal(rowMock);
    return {n,name:rec.name||names[idx],t1,t2,glob,pPts,incs:incs.length,abs:abs.length,fin};
  });
  const trs=rows.map(r=>`<tr><td>${r.n}</td><td style="font-weight:600">${r.name}</td><td>${r.t1||'â€”'}</td><td>${r.t2||'â€”'}</td><td>${r.glob||'â€”'}</td><td>${r.pPts}</td><td style="color:${r.incs>2?'#c0392b':r.incs>0?'#e67e22':'#27ae60'}">${r.incs}</td><td style="color:${r.abs>=5?'#c0392b':r.abs>0?'#e67e22':'#27ae60'}">${r.abs}</td><td style="font-weight:700;color:${r.fin>=16?'#27ae60':r.fin>=10?'#e67e22':'#c0392b'}">${r.fin.toFixed(2)}</td></tr>`).join('');
  const avg=rows.reduce((a,r)=>a+r.fin,0)/(rows.length||1);
  const winHTML=`<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="utf-8"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet"/>
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</title>
<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:'IBM Plex Sans Arabic',sans-serif;background:#f4f4f4;padding:20px;direction:rtl}.page{max-width:960px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1)}.header{background:linear-gradient(135deg,#1a2d5a,#2d4a8f);color:#fff;padding:20px 28px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}.header h1{font-size:18px;font-weight:700;margin-bottom:4px}.header .sub{font-size:12px;opacity:.8}.gold-bar{height:4px;background:linear-gradient(90deg,#c9a84c,#e8c870,#c9a84c)}.body{padding:20px 28px}table{width:100%;border-collapse:collapse;font-size:12px}th{background:#1a2d5a;color:#fff;padding:9px 10px;text-align:right;font-size:11px;font-weight:600}td{padding:8px 10px;border-bottom:1px solid #eee}tr:nth-child(even) td{background:#fafafe}.footer{background:#f0f0f0;padding:10px 20px;text-align:center;font-size:11px;color:#888}.avg-box{display:inline-block;background:#1a2d5a;color:#fff;border-radius:10px;padding:8px 16px;margin-bottom:14px;font-size:14px;font-weight:700}@media print{body{background:#fff;padding:0}.page{box-shadow:none;border-radius:0}}</style>
</head><body><div class="page">
<div class="header"><div><h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù… Â· ${cls}</h1><div class="sub">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ${year} Â· ØªØ§Ø±ÙŠØ®: ${today} Â· ${rows.length} ØªÙ„Ù…ÙŠØ°Ø§Ù‹</div></div><div style="font-size:12px;opacity:.85;text-align:left">Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©<br/>Ù…Ø§Ø¯Ø©: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</div></div>
<div class="gold-bar"></div>
<div class="body">
<div class="avg-box">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø³Ù…: ${avg.toFixed(2)} / 20</div>
<table><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th>Ù1</th><th>Ù2</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th><th>Ø¥Ù†Ø°Ø§Ø±Ø§Øª</th><th>ØºÙŠØ§Ø¨</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th></tr></thead>
<tbody>${trs}</tbody></table>
<div style="margin-top:20px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:16px">
<div style="text-align:center;min-width:180px"><div style="font-size:12px;color:#666;margin-bottom:24px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø£Ø³ØªØ§Ø°</div><div style="border-top:1px solid #999;width:180px;margin:0 auto;padding-top:4px;font-size:11px;color:#999">${s.teacherName||'ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†'}</div></div>
<div style="text-align:center;min-width:180px"><div style="font-size:12px;color:#666;margin-bottom:24px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div><div style="border-top:1px solid #999;width:180px;margin:0 auto;padding-top:4px;font-size:11px;color:#999"></div></div>
<div style="text-align:center;min-width:160px"><div style="font-size:12px;color:#666;margin-bottom:8px">Ø®ØªÙ… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</div><div style="width:120px;height:120px;border:2px dashed #bbb;border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:10px;color:#bbb;text-align:center">Ø®Ø§ØªÙ…<br/>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</div></div>
</div></div>
<div class="footer">ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ© ØµØ§Ø¯Ø±Ø© Ø¹Ù† Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ© Â· ${today}</div>
</div><script>window.onload=()=>window.print();<\/script></body></html>`;
  const w=window.open('','_blank');
  if(w){ w.document.write(winHTML); w.document.close(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP & RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function backupData(){
  const data={};
  classNames.forEach(cls=>{ data[cls]=loadCls(cls); });
  data._settings=loadSettings();
  data._rosters={};
  classNames.forEach(cls=>{ data._rosters[cls]=getRoster(cls); });
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='gradebook_backup_'+todayISO()+'.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  // Record backup date
  localStorage.setItem('gbpro_last_backup', Date.now().toString());
  showToast('ğŸ’¾ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
  var rb = document.getElementById('backupReminderBanner');
  if(rb) rb.classList.remove('show');
}

function checkBackupReminder(){
  var last = parseInt(localStorage.getItem('gbpro_last_backup')||'0');
  var days = (Date.now()-last)/(1000*60*60*24);
  var rb = document.getElementById('backupReminderBanner');
  if(!rb) return;
  if(!last || days >= 14){
    rb.classList.add('show');
  }
}

function restoreData(e){
  const file=e.target.files&&files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      classNames.forEach(cls=>{ if(data[cls]) saveCls(cls,data[cls]); });
      if(data._settings) localStorage.setItem(SS,JSON.stringify(data._settings));
      loadSettingsUI(); updateWeights();
      showToast('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      renderOverview();
    }catch(err){ showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'); }
  };
  reader.readAsText(file);
  e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(cls){
  const st=loadCls(cls); const names=getRoster(cls);
  const headers=['Ø§Ù„Ù‚Ø³Ù…','#','Ø§Ù„Ø§Ø³Ù…','Ù1','Ù2','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø§Ù„ÙˆØ§Ø¬Ø¨','Ø§Ù„Ø¯ÙØªØ±','Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©','Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©','Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·','Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨','Ø¯Ø±Ø¬Ø© Ø§Ù„ØºÙŠØ§Ø¨','Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'];
  const lines=[headers.join(',')];
  names.forEach(function(_,idx){
    if(!names[idx]) return;
    const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
    var _rf0=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;var ro=_rf0?_rf0.rowObj:null;
    const hw=ro?num(ro.hw.value):num((rec.scores&&rec.scores.hw));
    const copy=ro?num(ro.copy.value):num((rec.scores&&rec.scores.copy));
    const t1=ro?num(ro.t1.value):num((rec.scores&&rec.scores.t1));
    const t2=ro?num(ro.t2.value):num((rec.scores&&rec.scores.t2));
    const glob=ro?num(ro.glob.value):num((rec.scores&&rec.scores.glob));
    const pPts=ro?ro.partPoints:rec.participationPoints||0;
    const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
    const abs=ro?ro.absDates:rec.absenceDates||[];
    const rm={hw:{value:hw},copy:{value:copy},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absDates:abs};
    lines.push([cls,n,`"${(rec.name||names[idx]).replace(/"/g,'""')}"`,t1,t2,glob,hw,copy,pPts,partScore(pPts).toFixed(2),discScore(incs).toFixed(2),abs.length,absScore(abs).toFixed(2),calcFinal(rm).toFixed(2)].join(','));
  });
  const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=cls+'_grades.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('ğŸ“Š ØªÙ… ØªØµØ¯ÙŠØ± '+cls);
}

function clearClass(cls){
  if(!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª '+cls+'ØŸ')) return;
  localStorage.removeItem(SK(cls));
  if(_rows[cls]) _rows[cls]=[];
  renderClassPage(cls);
  showToast('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª '+cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECTOR MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleProjector(){
  document.body.classList.toggle('proj');
  const on=document.body.classList.contains('proj');
  document.getElementById('projBtn').classList.toggle('lit',on);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeIfBg(e,id){ if(e.target.id===id) document.getElementById(id).classList.remove('show'); }

let _toastTimer=null;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  if(_toastTimer) clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

// Projector mode CSS
const projStyle=document.createElement('style');
projStyle.textContent=`
body.proj{--bg:#f8f9ff;--bg2:#f0f4ff;--panel:#fff;--card:#fff;--border:rgba(0,0,0,.1);--border2:rgba(0,0,0,.18);--text:#0d1527;--muted:#5a6a8a;--muted2:#334466;--gold:#7a5a00;--gold2:#5a4200;}
/* â”€â”€ DAILY ABSENCES PAGE â”€â”€ */
.daily-abs-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}
.daily-abs-datepicker {
  background: var(--card);
  border: 1.5px solid var(--border2);
  color: var(--text);
  font-family: var(--font-ar);
  font-size: 15px;
  padding: 10px 14px;
  border-radius: 10px;
  flex: 1;
  min-width: 140px;
}
.daily-abs-datepicker:focus { outline: none; border-color: var(--accent); }
.today-btn {
  background: linear-gradient(135deg, var(--accent), #5b9aff);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}
/* summary strip */
.abs-day-summary {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.abs-day-kpi {
  flex: 1;
  min-width: 80px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 10px;
  text-align: center;
}
.abs-day-kpi .kpi-val { font-size: 24px; font-weight: 800; font-family: var(--font-mono); }
.abs-day-kpi .kpi-lbl { font-size: 11px; color: var(--muted); margin-top: 4px; }
.abs-day-kpi.kpi-total .kpi-val { color: var(--amber); }
.abs-day-kpi.kpi-classes .kpi-val { color: var(--cyan); }
.abs-day-kpi.kpi-zero .kpi-val { color: var(--green); }
/* per-class bar */
.abs-class-bars { display: flex; flex-direction: column; gap: 8px; margin-bottom: 18px; }
.abs-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  cursor: pointer;
  transition: border-color .2s;
}
.abs-bar-row:hover { border-color: var(--border2); }
.abs-bar-row.has-absent { border-color: rgba(244,63,94,.3); }
.abs-bar-cls { font-size: 13px; font-weight: 600; min-width: 70px; }
.abs-bar-track { flex: 1; height: 8px; background: var(--bg2); border-radius: 4px; overflow: hidden; }
.abs-bar-fill { height: 100%; border-radius: 4px; background: var(--red); transition: width .4s ease; }
.abs-bar-fill.zero { background: var(--green); }
.abs-bar-count { font-size: 13px; font-weight: 700; font-family: var(--font-mono); min-width: 28px; text-align: right; }
.abs-bar-count.zero { color: var(--green); }
.abs-bar-count.warn { color: var(--amber); }
.abs-bar-count.danger { color: var(--red); }
/* absent students list for selected day */
.abs-day-students { margin-top: 4px; }
.abs-day-cls-block { margin-bottom: 14px; }
.abs-day-cls-title {
  font-size: 12px; font-weight: 700; color: var(--muted2);
  text-transform: uppercase; letter-spacing: .06em;
  margin-bottom: 6px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--border);
}
.abs-day-student-row {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 0; border-bottom: 1px solid var(--border);
  font-size: 14px;
}
.abs-day-student-row:last-child { border-bottom: none; }
.abs-day-num { font-family: var(--font-mono); font-size: 12px; color: var(--muted); min-width: 28px; }
.abs-day-name { flex: 1; }
.abs-day-total { font-size: 11px; color: var(--muted); background: var(--panel); padding: 2px 7px; border-radius: 20px; }
.no-absent-day { text-align: center; padding: 40px 20px; }
.no-absent-day .big-icon { font-size: 48px; margin-bottom: 12px; }
.no-absent-day .msg { font-size: 15px; font-weight: 700; color: var(--green); }
.no-absent-day .sub { font-size: 13px; color: var(--muted); margin-top: 6px; }
/* copy report btn */
.abs-day-copy-btn {
  width: 100%;
  background: linear-gradient(135deg, #1a3a6a, #1e4a8a);
  border: 1px solid rgba(61,127,255,.3);
  color: var(--text);
  border-radius: 10px;
  padding: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 14px;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.abs-day-copy-btn:active { opacity: .8; }
/* â”€â”€ WEEK STRIP on Overview â”€â”€ */
.week-strip {
  display: flex; gap: 6px;
  margin-bottom: 16px;
  overflow-x: auto;
  padding-bottom: 4px;
}
.week-strip::-webkit-scrollbar { display: none; }
.week-day-chip {
  flex-shrink: 0;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 10px;
  text-align: center;
  min-width: 56px;
  cursor: pointer;
  transition: border-color .2s;
}
.week-day-chip:hover { border-color: var(--border2); }
.week-day-chip.today-chip { border-color: var(--accent); background: rgba(61,127,255,.08); }
.week-day-chip .wd-name { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }
.week-day-chip .wd-date { font-size: 12px; font-weight: 700; font-family: var(--font-mono); margin: 3px 0; }
.week-day-chip .wd-abs { font-size: 11px; font-weight: 700; }
.week-day-chip .wd-abs.zero { color: var(--green); }
.week-day-chip .wd-abs.low  { color: var(--amber); }
.week-day-chip .wd-abs.high { color: var(--red); }


/* â”€â”€ INPUT VALIDATION â”€â”€ */
.score-inp.invalid { border-color: var(--red) !important; background: rgba(244,63,94,.1); animation: shake .3s ease; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
.score-inp:focus { outline: none; border-color: var(--accent) !important; box-shadow: 0 0 0 3px rgba(61,127,255,.15); }

/* â”€â”€ GRADE TRENDS â”€â”€ */
.trend-arrow { font-size:11px; font-weight:700; margin-left:4px; }
.trend-up { color: var(--green); }
.trend-down { color: var(--red); }
.trend-same { color: var(--muted); }
.rank-badge { font-size:10px; font-weight:800; font-family:var(--font-mono); background:rgba(201,168,76,.15); color:var(--gold2); border:1px solid rgba(201,168,76,.3); border-radius:6px; padding:2px 6px; margin-left:4px; }
.rank-badge.rank-top { background:rgba(34,197,94,.15); color:var(--green); border-color:rgba(34,197,94,.3); }
.rank-badge.rank-bot { background:rgba(244,63,94,.1); color:var(--red); border-color:rgba(244,63,94,.2); }


/* â”€â”€ ROLL CALL MODE â”€â”€ */
#rollCallOverlay { z-index: 300; }
.roll-call-sheet { max-height: 92vh; overflow-y: auto; }
.roll-call-header { padding: 16px 20px 0; }
.roll-call-progress { height: 5px; background: var(--bg2); border-radius: 3px; margin: 12px 0; }
.roll-call-progress-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--green)); transition: width .3s ease; }
.roll-call-student { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); gap: 12px; }
.roll-call-student.present { background: rgba(34,197,94,.05); }
.roll-call-student.absent-unjust { background: rgba(244,63,94,.06); }
.roll-call-student.absent-just { background: rgba(245,158,11,.05); }
.roll-call-num { font-family: var(--font-mono); font-size: 13px; color: var(--muted); min-width: 28px; }
.roll-call-name { flex: 1; font-size: 15px; font-weight: 500; direction: rtl; }
.roll-call-btns { display: flex; gap: 6px; }
.rc-btn { border: none; border-radius: 10px; padding: 8px 12px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all .15s; white-space: nowrap; }
.rc-btn:active { transform: scale(.93); }
.rc-btn.present { background: rgba(34,197,94,.2); color: var(--green); border: 1px solid rgba(34,197,94,.3); }
.rc-btn.present.active { background: var(--green); color: #fff; }
.rc-btn.absent-u { background: rgba(244,63,94,.15); color: var(--red); border: 1px solid rgba(244,63,94,.3); }
.rc-btn.absent-u.active { background: var(--red); color: #fff; }
.rc-btn.absent-j { background: rgba(245,158,11,.15); color: var(--amber); border: 1px solid rgba(245,158,11,.3); }
.rc-btn.absent-j.active { background: var(--amber); color: #fff; }
.roll-call-summary { padding: 16px 20px; display: flex; gap: 10px; flex-wrap: wrap; }
.rc-sum-chip { flex:1; min-width:70px; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; text-align:center; }
.rc-sum-chip .v { font-size: 22px; font-weight: 800; font-family: var(--font-mono); }
.rc-sum-chip .l { font-size: 11px; color: var(--muted); margin-top: 3px; }

/* â”€â”€ JUSTIFIED VS UNJUSTIFIED â”€â”€ */
.cal-cell.absent-just { background: rgba(245,158,11,.25); color: var(--amber); border-color: rgba(245,158,11,.4); }
.cal-cell.absent-just::after { content:'J'; position:absolute; bottom:1px; right:2px; font-size:7px; color:var(--amber); font-weight:800; }
.cal-cell { position: relative; }
.abs-type-legend { display:flex; gap:10px; margin-top:10px; font-size:11px; color:var(--muted); }
.abs-type-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:4px; vertical-align:middle; }
.abs-warning-4 { background:rgba(244,63,94,.12); border:1px solid rgba(244,63,94,.3); border-radius:8px; padding:8px 12px; font-size:12px; color:var(--red); font-weight:600; margin-top:8px; direction:rtl; }

/* â”€â”€ STUDENT NOTES â”€â”€ */
.student-notes-inp { width:100%; background:var(--bg2); border:1px solid var(--border); color:var(--text); font-family:var(--font-ar); font-size:13px; padding:10px 12px; border-radius:10px; resize:none; margin-top:10px; min-height:60px; direction:rtl; }
.student-notes-inp:focus { outline:none; border-color:var(--accent); }

/* â”€â”€ TABLE SORT â”€â”€ */
.sortable-header { cursor: pointer; user-select: none; white-space: nowrap; }
.sortable-header:hover { color: var(--accent); }
.sort-icon { font-size: 10px; margin-left: 3px; opacity: .5; }
.sort-icon.active { opacity: 1; color: var(--gold2); }


/* â”€â”€ LIGHT MODE â”€â”€ */
body.light {
  --bg: #f0f4f8; --bg2: #e2e8f0; --panel: #ffffff; --card: #f8fafc;
  --border: rgba(0,0,0,.08); --border2: rgba(0,0,0,.14);
  --text: #1e293b; --muted: #64748b; --muted2: #475569;
  --gold: #b45309; --gold2: #92400e;
  --accent: #2563eb; --green: #16a34a; --red: #dc2626; --amber: #d97706; --cyan: #0891b2;
}
body.light .topbar { background: #fff; border-color: rgba(0,0,0,.1); }
body.light .sidebar { background: #f8fafc; border-color: rgba(0,0,0,.1); }
body.light .dash-card { background: #fff; border-color: rgba(0,0,0,.1); }
body.light input, body.light .search-box { background: #fff; color: #1e293b; border-color: rgba(0,0,0,.15); }
body.light .tool-btn { background: #e2e8f0; color: #1e293b; border-color: rgba(0,0,0,.12); }
body.light .nav-btn { color: #475569; }
body.light .nav-btn:hover, body.light .nav-btn.active { background: rgba(37,99,235,.1); color: var(--accent); }
body.light .sheet { background: #fff; }
body.light .dialog { background: #fff; }
body.light .overlay { background: rgba(0,0,0,.4); }
body.light .cal-cell { background: #f1f5f9; color: #334155; }
body.light .cal-cell.absent { background: rgba(220,38,38,.15); }
body.light .cal-cell.today { border-color: var(--accent); }
body.light .disc-badge { background: #e2e8f0; }
body.light .abs-count { color: #475569; }
body.light table th { background: #e2e8f0; color: #475569; }
body.light table td { border-color: rgba(0,0,0,.06); }
body.light .stat-chip { background: #e2e8f0; color: #475569; }
body.light .roll-call-student { border-color: rgba(0,0,0,.08); }
body.light .week-day-chip { background: #fff; border-color: rgba(0,0,0,.1); }
body.light .abs-bar-row { background: #fff; border-color: rgba(0,0,0,.08); }
body.light .abs-bar-track { background: #e2e8f0; }
body.light .settings-card { background: #fff; border-color: rgba(0,0,0,.1); }
.theme-toggle-btn { font-size: 18px; cursor: pointer; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border2); background: var(--card); transition: all .2s; }
.theme-toggle-btn:active { transform: scale(.9); }

/* â”€â”€ GLOBAL SEARCH â”€â”€ */
.global-search-wrap {
  padding: 8px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.global-search-inp {
  width: 100%;
  background: var(--bg2);
  border: 1.5px solid var(--border2);
  color: var(--text);
  font-family: var(--font-ar);
  font-size: 13px;
  padding: 9px 14px 9px 36px;
  border-radius: 10px;
  direction: rtl;
}
.global-search-inp:focus { outline: none; border-color: var(--accent); }
.global-search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 14px; pointer-events: none; }
.global-search-results {
  position: absolute;
  top: 100%; left: 8px; right: 8px;
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 12px;
  z-index: 200;
  max-height: 260px;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0,0,0,.3);
  display: none;
}
.global-search-results.show { display: block; }
.gs-result-item {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background .15s;
}
.gs-result-item:last-child { border-bottom: none; }
.gs-result-item:hover { background: var(--card); }
.gs-result-name { flex: 1; font-size: 13px; direction: rtl; }
.gs-result-cls { font-size: 11px; color: var(--muted); background: var(--card); padding: 2px 8px; border-radius: 20px; }
.gs-result-grade { font-size: 12px; font-weight: 700; font-family: var(--font-mono); }
.gs-no-results { padding: 20px; text-align: center; color: var(--muted); font-size: 13px; }

/* â”€â”€ UNDO TOAST â”€â”€ */
.undo-toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(120px);
  background: #1e3a5f;
  border: 1px solid rgba(61,127,255,.4);
  color: var(--text);
  padding: 11px 8px 11px 16px;
  border-radius: 14px;
  font-size: 13px; font-weight: 600;
  z-index: 600;
  transition: transform .35s cubic-bezier(.34,1.56,.64,1);
  white-space: nowrap;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
  display: flex; align-items: center; gap: 10px;
}
.undo-toast.show { transform: translateX(-50%) translateY(0); }
.undo-btn { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; }

/* â”€â”€ GRADE DISTRIBUTION â”€â”€ */
.dist-chart {
  display: flex;
  align-items: flex-end;
  gap: 3px;
  height: 36px;
  margin-top: 8px;
  padding: 0 2px;
}
.dist-bar {
  flex: 1;
  border-radius: 3px 3px 0 0;
  min-height: 3px;
  transition: height .3s ease;
  cursor: default;
  position: relative;
}
.dist-bar:hover::after {
  content: attr(data-tip);
  position: absolute;
  bottom: 100%; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.85);
  color: #fff;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
  pointer-events: none;
}
.dist-labels {
  display: flex;
  justify-content: space-between;
  font-size: 9px;
  color: var(--muted);
  margin-top: 2px;
  padding: 0 2px;
}
.dist-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
.dist-section-title { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; font-weight: 700; margin-bottom: 6px; }

/* â”€â”€ COMPARISON PAGE â”€â”€ */
.comparison-chart-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 16px; }
.comp-bars { display: flex; flex-direction: column; gap: 10px; }
.comp-bar-row { display: flex; align-items: center; gap: 10px; }
.comp-bar-cls { font-size: 12px; font-weight: 600; min-width: 80px; }
.comp-bar-track { flex: 1; height: 22px; background: var(--bg2); border-radius: 6px; overflow: hidden; position: relative; }
.comp-bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; padding-left: 8px; font-size: 11px; font-weight: 700; color: rgba(255,255,255,.9); transition: width .5s ease; }
.comp-bar-val { font-size: 12px; font-weight: 700; font-family: var(--font-mono); min-width: 36px; text-align: right; }
.comp-metric-tabs { display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap; }
.comp-tab { background: var(--card); border: 1px solid var(--border2); color: var(--muted); border-radius: 8px; padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer; }
.comp-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.comp-kpi-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }
.comp-kpi { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px 10px; text-align: center; }
.comp-kpi .v { font-size: 20px; font-weight: 800; font-family: var(--font-mono); }
.comp-kpi .l { font-size: 10px; color: var(--muted); margin-top: 3px; }

/* â”€â”€ PIN MODAL â”€â”€ */
.pin-modal-overlay {
  position: fixed; inset: 0; z-index: 400;
  background: rgba(0,0,0,.6);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.pin-modal-overlay.show { opacity: 1; pointer-events: all; }
.pin-modal-sheet {
  background: var(--panel);
  border-radius: 24px 24px 0 0;
  padding: 24px 24px 40px;
  width: 100%; max-width: 400px;
  text-align: center;
  transform: translateY(100%);
  transition: transform .3s cubic-bezier(.34,1.2,.64,1);
}
.pin-modal-overlay.show .pin-modal-sheet { transform: translateY(0); }
.pin-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.pin-modal-sub { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
.pin-dots { display: flex; gap: 14px; justify-content: center; margin-bottom: 24px; }
.pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border2); background: transparent; transition: all .2s; }
.pin-dot.filled { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 10px rgba(61,127,255,.5); }
.pin-dot.error { background: var(--red); border-color: var(--red); animation: shake .3s ease; }
.pin-pad { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; max-width: 280px; margin: 0 auto; }
.pin-btn { background: var(--card); border: 1px solid var(--border2); border-radius: 14px; color: var(--text); font-size: 22px; font-weight: 700; font-family: var(--font-mono); padding: 16px 10px; cursor: pointer; transition: all .15s; display: flex; flex-direction: column; align-items: center; gap: 1px; }
.pin-btn:active { transform: scale(.92); background: var(--bg2); }
.pin-sub-letters { font-size: 9px; color: var(--muted); font-family: var(--font-ar); font-weight: 400; }
.pin-error-msg { color: var(--red); font-size: 13px; font-weight: 700; min-height: 18px; margin-top: 12px; }
.pin-lock-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 40px 24px;
  background-image: radial-gradient(ellipse at 50% 0%, rgba(61,127,255,.1) 0%, transparent 60%);
}
.pin-lock-screen.hidden { display: none; }
.pin-lock-logo { font-size: 52px; margin-bottom: 8px; }
.pin-lock-title { font-family: var(--font-display); font-size: 26px; font-weight: 700; color: var(--gold2); margin-bottom: 4px; }
.pin-lock-sub { font-size: 13px; color: var(--muted); margin-bottom: 32px; }

/* â”€â”€ EXPORT ALL â”€â”€ */
.export-all-btn { width: 100%; justify-content: center; margin-top: 8px; }

/* â”€â”€ PRINT STYLES â”€â”€ */
@media print {
  .sidebar, .topbar, .class-toolbar, .tool-btn, .ham-btn, .icon-btn,
  .week-strip, .stats-row, .toast, .undo-toast, .overlay,
  .abs-tap, .part-minus, .disc-badge, .rank-badge, .trend-arrow { display: none !important; }
  body { background: #fff !important; color: #000 !important; }
  .app { display: block !important; }
  .main { overflow: visible !important; }
  .page { display: block !important; height: auto !important; overflow: visible !important; }
  .tablewrap { overflow: visible !important; }
  table { font-size: 11px; border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc !important; padding: 4px 6px !important; color: #000 !important; background: #fff !important; }
  th { background: #f0f0f0 !important; font-weight: 700; }
  .final-score { color: #000 !important; }
  .at-risk td { background: #fff8f8 !important; }
  @page { margin: 1.5cm; size: A4 landscape; }
}

/* â”€â”€ KEYBOARD NAV â”€â”€ */
.score-inp:focus, .name-inp:focus { background: rgba(61,127,255,.08) !important; border-color: var(--accent) !important; }


/* â”€â”€ BACKUP REMINDER BANNER â”€â”€ */
.backup-reminder {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 998;
  background: linear-gradient(135deg, #92400e, #b45309);
  color: #fff; padding: 12px 16px;
  display: none; align-items: center; gap: 10px;
  font-size: 13px; font-family: var(--font-ar); direction: rtl;
  flex-wrap: wrap; justify-content: space-between;
}
.backup-reminder.show { display: flex; }

/* â”€â”€ LETTER GRADE LABEL â”€â”€ */
.letter-grade-lbl {
  font-size: 10px; color: var(--muted); text-align: center;
  margin-top: 2px; font-family: var(--font-ar); white-space: nowrap;
}

/* â”€â”€ GRADE LOCK INDICATOR â”€â”€ */
.score-inp:disabled {
  background: rgba(244,63,94,.06) !important;
  cursor: not-allowed;
  border-color: rgba(244,63,94,.2) !important;
}

/* â”€â”€ DANGER ZONE â”€â”€ */
.danger-zone { background: rgba(244,63,94,.04) !important; }

/* â”€â”€ SETTINGS CARD SHARED â”€â”€ */
.settings-card h4 {
  font-size: 14px; font-weight: 700; margin-bottom: 10px;
  color: var(--text); direction: rtl;
}


/* â”€â”€ GRADE LOCK â”€â”€ */
.score-inp:disabled { cursor: not-allowed; background: repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(244,63,94,.06) 4px,rgba(244,63,94,.06) 8px); }

/* â”€â”€ SETTINGS CARD â”€â”€ */
.settings-card { background: var(--panel); border: 1px solid var(--border2); border-radius: 16px; padding: 20px; }

/* â”€â”€ DANGER ZONE â”€â”€ */
.danger-zone-card { border-color: rgba(244,63,94,.3) !important; background: rgba(244,63,94,.04) !important; }

/* â”€â”€ BACKUP REMINDER BANNER â”€â”€ */
#backupReminderBanner { background: #7c3aed; cursor: pointer; transition: transform .3s; }
#backupReminderBanner:hover { opacity: .9; }

/* â”€â”€ BULK ATTENDANCE BUTTONS â”€â”€ */
.rc-bulk-row { display: flex; gap: 8px; padding: 10px 20px 0; }


/* â”€â”€ MORE MENU DROPDOWN â”€â”€ */
.more-menu-wrap { position: relative; }
.more-menu {
  position: absolute; top: calc(100% + 8px); left: 0;
  background: var(--panel); border: 1px solid var(--border2);
  border-radius: 14px; padding: 6px; min-width: 180px;
  box-shadow: 0 8px 32px rgba(0,0,0,.3); z-index: 200;
  display: none; flex-direction: column; gap: 2px;
  direction: rtl;
}
.more-menu.open { display: flex; }
.more-menu-item {
  padding: 10px 14px; border-radius: 10px; border: none;
  background: transparent; color: var(--text);
  font-family: var(--font-ar); font-size: 13px; font-weight: 600;
  cursor: pointer; text-align: right; transition: background .12s;
}
.more-menu-item:hover { background: rgba(255,255,255,.07); }
.more-menu-item:active { background: rgba(255,255,255,.12); }


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECT SETTINGS UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.subj-profile-card {
  background: linear-gradient(135deg, rgba(61,127,255,.12), rgba(6,182,212,.08));
  border: 1px solid rgba(61,127,255,.25);
  border-radius: 18px; padding: 20px; margin-bottom: 20px;
}
.subj-profile-header { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.subj-icon-wrap {
  font-size: 36px; width: 64px; height: 64px;
  background: rgba(255,255,255,.06); border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--border2); flex-shrink: 0;
}
.subj-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 6px; }
.subj-name-inp {
  background: transparent; border: none; border-bottom: 2px solid rgba(61,127,255,.4);
  color: var(--text); font-size: 20px; font-weight: 700;
  font-family: var(--font-ar); width: 100%; outline: none; padding: 4px 0;
  transition: border-color .2s;
}
.subj-name-inp:focus { border-color: var(--accent); }
.coeff-stepper {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,255,255,.06); border: 1px solid var(--border2);
  border-radius: 14px; padding: 6px 10px;
}
.coeff-btn {
  width: 32px; height: 32px; border-radius: 10px; border: none;
  background: rgba(255,255,255,.08); color: var(--text); font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .15s; font-weight: 700;
}
.coeff-btn:hover { background: rgba(61,127,255,.2); color: var(--accent); }
.coeff-btn:active { transform: scale(.9); }
.coeff-val { font-size: 26px; font-weight: 800; font-family: var(--font-mono); color: var(--gold2); min-width: 28px; text-align: center; }

/* â”€â”€ SECTION LABEL â”€â”€ */
.subj-section-label {
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px;
  color: var(--muted); margin: 20px 0 10px; display: flex; align-items: center; gap: 8px;
}
.subj-section-label::after { content:''; flex:1; height:1px; background:var(--border); }

/* â”€â”€ TEST CONFIG â”€â”€ */
.test-config-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
.test-config-chip {
  background: var(--panel); border: 1px solid var(--border2); border-radius: 14px;
  padding: 12px 14px; display: flex; align-items: center; gap: 10px;
  position: relative; min-width: 160px; flex: 1;
  transition: border-color .2s;
}
.test-config-chip:focus-within { border-color: rgba(61,127,255,.5); }
.test-chip-icon { font-size: 20px; flex-shrink: 0; }
.test-chip-fields { display: flex; flex-direction: column; gap: 4px; flex: 1; }
.test-chip-name {
  background: transparent; border: none; border-bottom: 1px solid var(--border);
  color: var(--text); font-size: 13px; font-weight: 600; font-family: var(--font-ar);
  outline: none; width: 100%; padding: 2px 0; direction: rtl;
  transition: border-color .15s;
}
.test-chip-name:focus { border-color: var(--accent); }
.test-chip-weight-row { display: flex; align-items: center; gap: 6px; }
.test-chip-weight-lbl { font-size: 10px; color: var(--muted); }
.test-chip-weight {
  width: 46px; background: rgba(0,0,0,.3); border: 1px solid var(--border2);
  border-radius: 8px; color: var(--text); font-family: var(--font-mono); font-size: 13px;
  font-weight: 700; text-align: center; padding: 3px 4px; outline: none;
  -webkit-appearance: none; appearance: none;
  transition: border-color .15s;
}
.test-chip-weight:focus { border-color: var(--accent); }
.test-chip-pct { font-size: 10px; color: var(--muted); }
.test-rm-btn {
  position: absolute; top: 6px; right: 6px;
  width: 20px; height: 20px; border-radius: 6px; border: none;
  background: rgba(244,63,94,.12); color: var(--red); font-size: 12px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  opacity: 0; transition: opacity .15s;
}
.test-config-chip:hover .test-rm-btn { opacity: 1; }
.test-add-row { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
.test-add-btn {
  padding: 8px 16px; border-radius: 10px; border: 1px dashed rgba(61,127,255,.4);
  background: rgba(61,127,255,.06); color: var(--accent);
  font-size: 13px; font-weight: 700; cursor: pointer; transition: all .15s;
}
.test-add-btn:hover { background: rgba(61,127,255,.12); border-style: solid; }
.test-add-btn:disabled { opacity: .4; cursor: not-allowed; }
.test-count-hint { font-size: 12px; color: var(--muted); }

/* â”€â”€ VISUAL WEIGHT BUILDER â”€â”€ */
.weight-builder { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.wb-row { display: flex; align-items: center; gap: 10px; }
.wb-label {
  width: 90px; font-size: 12px; font-weight: 600; color: var(--muted2);
  text-align: right; flex-shrink: 0; font-family: var(--font-ar); direction: rtl;
}
.wb-slider-wrap { flex: 1; position: relative; height: 28px; display: flex; align-items: center; }
.wb-track {
  position: absolute; left: 0; right: 0; height: 6px;
  background: rgba(255,255,255,.06); border-radius: 99px; overflow: hidden;
}
.wb-fill { height: 100%; border-radius: 99px; transition: width .2s; }
.wb-slider {
  position: relative; z-index: 1; width: 100%;
  -webkit-appearance: none; appearance: none;
  background: transparent; outline: none; cursor: pointer; height: 28px;
}
.wb-slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 18px; height: 18px;
  border-radius: 50%; border: 2px solid var(--bg);
  box-shadow: 0 0 0 1px rgba(255,255,255,.2);
  cursor: pointer; transition: transform .1s;
}
.wb-slider:active::-webkit-slider-thumb { transform: scale(1.3); }
.wb-value {
  width: 44px; text-align: center; font-family: var(--font-mono);
  font-size: 13px; font-weight: 700; flex-shrink: 0;
  padding: 4px 6px; border-radius: 8px; border: 1px solid var(--border2);
  background: rgba(0,0,0,.25); color: var(--text); outline: none;
  -webkit-appearance: none; appearance: none;
}

/* â”€â”€ WEIGHT BAR â”€â”€ */
.weight-bar-wrap {
  height: 28px; border-radius: 12px; overflow: hidden;
  border: 1px solid var(--border); margin-bottom: 10px;
  display: flex;
}
.weight-bar { display: flex; width: 100%; height: 100%; }
.wb-seg { height: 100%; transition: width .3s; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.wb-seg-lbl { font-size: 9px; font-weight: 700; color: rgba(255,255,255,.8); white-space: nowrap; overflow: hidden; }

/* â”€â”€ WEIGHT TOTAL ROW â”€â”€ */
.weight-total-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.weight-total { font-size: 13px; font-weight: 700; font-family: var(--font-mono); }
.weight-total.ok { color: var(--green); }
.weight-total.bad { color: var(--red); }
.weight-auto-btn {
  padding: 7px 14px; border-radius: 10px; border: 1px solid var(--border2);
  background: rgba(255,255,255,.04); color: var(--muted2);
  font-size: 12px; font-weight: 600; cursor: pointer; transition: all .15s;
}
.weight-auto-btn:hover { background: rgba(255,255,255,.08); color: var(--text); }


/* â”€â”€ SYNC SECTION â”€â”€ */
.stg-sync-btn {
  padding: 10px 18px; border-radius: 12px; border: 1px solid;
  font-family: var(--font-ar); font-size: 13px; font-weight: 700;
  cursor: pointer; transition: all .15s; white-space: nowrap;
}
.stg-sync-btn.test {
  background: rgba(61,127,255,.12); border-color: rgba(61,127,255,.35); color: var(--accent);
}
.stg-sync-btn.test:hover { background: rgba(61,127,255,.22); }
.stg-sync-btn.push {
  background: rgba(66,186,150,.12); border-color: rgba(66,186,150,.35); color: #42ba96;
}
.stg-sync-btn.push:hover { background: rgba(66,186,150,.22); }
.stg-sync-btn:active { transform: scale(.96); }
.stg-sync-info {
  margin-top: 14px; padding-top: 14px;
  border-top: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 6px;
}
.stg-sync-info-item {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; color: var(--muted); direction: rtl;
}
.stg-sync-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: rgba(66,186,150,.6); flex-shrink: 0;
}

/* â”€â”€ DATA & SECURITY GRID â”€â”€ */
.stg-data-security-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
@media (max-width: 480px) {
  .stg-data-security-grid { grid-template-columns: repeat(2, 1fr); }
}
.stg-action-card {
  background: var(--panel); border: 1px solid var(--border2);
  border-radius: 16px; padding: 18px 12px;
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  cursor: pointer; transition: all .18s; text-align: center; user-select: none;
}
.stg-action-card:hover {
  border-color: rgba(61,127,255,.4);
  background: rgba(61,127,255,.06);
  transform: translateY(-2px);
}
.stg-action-card:active { transform: scale(.96); }
.stg-action-card-icon { font-size: 26px; }
.stg-action-card-label {
  font-size: 13px; font-weight: 700; color: var(--text);
  font-family: var(--font-ar);
}
.stg-action-card-desc {
  font-size: 10px; color: var(--muted); font-family: var(--font-ar);
}

/* â”€â”€ DANGER ZONE â”€â”€ */
.stg-danger-zone {
  background: rgba(244,63,94,.04); border: 1px solid rgba(244,63,94,.2);
  border-radius: 18px; padding: 18px; display: flex; flex-direction: column; gap: 12px;
}
.stg-danger-warning {
  display: flex; align-items: flex-start; gap: 10px;
  font-size: 12px; color: var(--muted); direction: rtl; line-height: 1.6;
}
.stg-danger-warning-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.stg-danger-row {
  display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
}
.stg-danger-action {
  padding: 9px 14px; border-radius: 11px; font-family: var(--font-ar);
  font-size: 12px; font-weight: 700; cursor: pointer; transition: all .15s;
  border: 1px solid; white-space: nowrap;
}
.stg-danger-action.amber {
  background: rgba(245,158,11,.08); border-color: rgba(245,158,11,.35); color: #f59e0b;
}
.stg-danger-action.amber:hover { background: rgba(245,158,11,.15); }
.stg-danger-action.red {
  background: rgba(244,63,94,.08); border-color: rgba(244,63,94,.35); color: var(--red);
}
.stg-danger-action.red:hover { background: rgba(244,63,94,.15); }
.stg-danger-nuke {
  width: 100%; padding: 13px;
  background: rgba(244,63,94,.08); border: 1px solid rgba(244,63,94,.4);
  border-radius: 13px; color: var(--red);
  font-family: var(--font-ar); font-size: 14px; font-weight: 800;
  cursor: pointer; transition: all .15s;
}
.stg-danger-nuke:hover { background: rgba(244,63,94,.18); }
.stg-danger-nuke:active { transform: scale(.98); }

/* â”€â”€ BACK BUTTON POLISH â”€â”€ */
.icon-btn {
  width: 38px; height: 38px; border-radius: 12px;
  border: 1px solid var(--border2); background: rgba(255,255,255,.06);
  color: var(--text); cursor: pointer; transition: all .15s;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700;
}
.icon-btn:hover { background: rgba(255,255,255,.12); border-color: rgba(61,127,255,.4); }
.icon-btn:active { transform: scale(.92); }


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD CARD UPGRADES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-card {
  cursor: pointer;
  transition: transform .18s, border-color .18s, box-shadow .18s;
  animation: cardIn .3s ease both;
}
.dash-card:nth-child(1){animation-delay:.04s}
.dash-card:nth-child(2){animation-delay:.08s}
.dash-card:nth-child(3){animation-delay:.12s}
.dash-card:nth-child(4){animation-delay:.16s}
.dash-card:nth-child(5){animation-delay:.20s}
.dash-card:nth-child(6){animation-delay:.24s}
@keyframes cardIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.dash-card:hover { transform:translateY(-3px); border-color:rgba(61,127,255,.4); box-shadow:0 8px 32px rgba(61,127,255,.1); }

.dash-card-top {
  display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:14px;
}
.dash-avg-pill {
  display:flex; align-items:baseline; gap:2px;
  background:rgba(255,255,255,.05); border:1px solid var(--border2);
  border-radius:10px; padding:4px 10px;
}
.dash-avg-val { font-family:var(--font-mono); font-size:17px; font-weight:900; }
.dash-avg-val.good { color:var(--green); }
.dash-avg-val.bad  { color:var(--red); }
.dash-avg-suffix { font-size:10px; color:var(--muted); font-family:var(--font-mono); }

/* Mini grade distribution bars */
.dash-grade-bars {
  display:flex; align-items:flex-end; gap:3px; height:46px;
  margin:10px 0; padding:0 2px;
}
.dash-mini-bar-wrap {
  flex:1; display:flex; flex-direction:column; align-items:center; gap:2px;
  justify-content:flex-end; height:100%;
}
.dash-mini-bar {
  width:100%; border-radius:4px 4px 0 0; min-height:3px;
  transition:height .4s cubic-bezier(.4,0,.2,1);
  opacity:.8;
}
.dash-mini-bar-lbl { font-size:8px; color:var(--muted); font-family:var(--font-mono); }

.dash-card-footer {
  display:flex; align-items:center; gap:6px; padding-top:10px;
  border-top:1px solid var(--border); margin-top:6px;
}
.dash-footer-stat {
  font-size:11px; font-weight:700; font-family:var(--font-ar); flex:1;
}
.dash-footer-stat.good { color:var(--green); }
.dash-footer-stat.bad  { color:var(--red); }
.dash-report-btn {
  padding:5px 10px; border-radius:8px; border:1px solid var(--border2);
  background:rgba(255,255,255,.05); color:var(--muted2);
  font-size:11px; font-weight:700; font-family:var(--font-ar);
  cursor:pointer; transition:all .15s; white-space:nowrap;
}
.dash-report-btn:hover { background:rgba(61,127,255,.15); color:var(--accent); border-color:rgba(61,127,255,.4); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DAILY ABSENCES â€” DATE NAVIGATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.abs-date-nav {
  display:flex; align-items:center; gap:0;
  background:var(--panel); border:1px solid var(--border2);
  border-radius:18px; overflow:hidden; margin-bottom:12px;
}
.abs-nav-arrow {
  width:48px; height:60px; border:none; background:none;
  color:var(--muted2); font-size:22px; font-weight:700;
  cursor:pointer; transition:all .15s; flex-shrink:0;
}
.abs-nav-arrow:hover { background:rgba(255,255,255,.06); color:var(--text); }
.abs-nav-arrow:active { transform:scale(.9); }
.abs-date-center {
  flex:1; text-align:center; padding:10px; cursor:pointer; position:relative;
}
.abs-date-center:hover { background:rgba(255,255,255,.04); }
.abs-date-label {
  font-family:var(--font-ar); direction:rtl;
  display:flex; flex-direction:column; align-items:center; gap:2px;
}
.abs-date-day { font-size:15px; font-weight:800; color:var(--text); }
.abs-date-full { font-size:12px; color:var(--muted); }
.abs-date-hidden {
  position:absolute; inset:0; opacity:0; cursor:pointer;
  width:100%; height:100%; border:none; background:none;
}
.abs-date-actions {
  display:flex; gap:8px; margin-bottom:16px;
}
.abs-action-btn {
  flex:1; padding:10px; border-radius:12px; border:1px solid var(--border2);
  font-family:var(--font-ar); font-size:13px; font-weight:700; cursor:pointer;
  transition:all .15s;
}
.abs-action-btn.today {
  background:rgba(61,127,255,.1); color:var(--accent); border-color:rgba(61,127,255,.3);
}
.abs-action-btn.today:hover { background:rgba(61,127,255,.2); }
.abs-action-btn.copy {
  background:rgba(34,197,94,.08); color:var(--green); border-color:rgba(34,197,94,.25);
}
.abs-action-btn.copy:hover { background:rgba(34,197,94,.16); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AT-RISK PAGE REDESIGN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.risk-filter-bar {
  display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px;
}
.risk-filter-btn {
  padding:8px 14px; border-radius:99px; border:1px solid var(--border2);
  background:rgba(255,255,255,.04); color:var(--muted2);
  font-family:var(--font-ar); font-size:12px; font-weight:700;
  cursor:pointer; transition:all .15s; display:flex; align-items:center; gap:6px;
}
.risk-filter-btn:hover { border-color:rgba(244,63,94,.4); color:var(--red); }
.risk-filter-btn.active {
  background:rgba(244,63,94,.12); border-color:rgba(244,63,94,.4);
  color:var(--red);
}
.risk-filter-count {
  background:rgba(244,63,94,.2); color:var(--red);
  border-radius:99px; padding:1px 7px; font-size:11px; font-weight:800;
}
.risk-sort-row {
  display:flex; align-items:center; gap:6px; margin-bottom:16px; flex-wrap:wrap;
}
.risk-sort-label {
  font-size:11px; color:var(--muted); font-family:var(--font-ar); white-space:nowrap;
}
.risk-sort-btn {
  padding:5px 12px; border-radius:8px; border:1px solid var(--border);
  background:transparent; color:var(--muted);
  font-size:11px; font-weight:700; font-family:var(--font-ar); cursor:pointer;
  transition:all .12s;
}
.risk-sort-btn.active { background:var(--panel); border-color:var(--border2); color:var(--text); }
.risk-sort-btn:hover { color:var(--text); }

/* Risk card redesign */
.risk-card {
  display:flex; position:relative; overflow:hidden;
  border-radius:16px; border:1px solid var(--border2);
  background:var(--panel); margin-bottom:10px; cursor:pointer;
  transition:transform .15s, border-color .15s; animation:cardIn .25s ease both;
}
.risk-card:hover { transform:translateX(-3px); }
.risk-sev-bar {
  width:4px; flex-shrink:0; border-radius:0;
}
.risk-sev-critical .risk-sev-bar { background:var(--red); }
.risk-sev-high .risk-sev-bar { background:var(--amber); }
.risk-sev-medium .risk-sev-bar { background:var(--cyan); }
.risk-sev-critical { border-color:rgba(244,63,94,.3); }
.risk-sev-high { border-color:rgba(245,158,11,.25); }
.risk-card-body {
  display:flex; align-items:center; padding:14px 16px; flex:1; gap:12px;
}
.risk-card-left { flex:1; }
.risk-card-score {
  font-family:var(--font-mono); font-size:22px; font-weight:900;
  flex-shrink:0;
}
.risk-card-score.risk-bad { color:var(--red); }
.risk-card-score.risk-ok  { color:var(--amber); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MICRO-ANIMATIONS & POLISH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page { animation: pageIn .25s ease both; }
@keyframes pageIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* Topbar back button pulse when first appearing */
#backBtn { transition: all .2s cubic-bezier(.4,0,.2,1); }

/* Sidebar nav active state glow */
.nav-btn.active {
  box-shadow: inset 3px 0 0 var(--accent);
}

/* Stats row chips */
.stat-chip {
  padding:6px 12px; border-radius:10px; font-size:12px; font-weight:700;
  border:1px solid; display:inline-flex; align-items:center; gap:4px;
}
.gold-chip { background:rgba(201,168,76,.1); border-color:rgba(201,168,76,.25); color:var(--gold2); }
.green-chip { background:rgba(34,197,94,.1); border-color:rgba(34,197,94,.2); color:var(--green); }
.red-chip { background:rgba(244,63,94,.1); border-color:rgba(244,63,94,.2); color:var(--red); }
.blue-chip { background:rgba(61,127,255,.1); border-color:rgba(61,127,255,.2); color:var(--accent); }

/* Improve table row hover */
#classTable tbody tr {
  transition: background .12s;
}
#classTable tbody tr:hover {
  background: rgba(61,127,255,.06);
}
/* â”€â”€ COMPACT MODE â”€â”€ */
.compact-mode th[data-col="hw"],
.compact-mode th[data-col="copy"],
.compact-mode th[data-col="glob"],
.compact-mode th[data-col="actions"],
.compact-mode td[data-col="hw"],
.compact-mode td[data-col="copy"],
.compact-mode td[data-col="glob"],
.compact-mode td[data-col="actions"] { display: none; }
.compact-mode #compactBtn { background: rgba(61,127,255,.2); border-color: rgba(61,127,255,.5); color: var(--accent); }
.compact-mode th[data-col="name"] { min-width: 120px !important; }

/* â”€â”€ LOADING SKELETON â”€â”€ */
.skeleton-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: var(--bg); display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 20px;
  transition: opacity .4s;
}
.skeleton-overlay.hidden { opacity: 0; pointer-events: none; }
.skeleton-logo { font-size: 48px; animation: skPulse 1.2s infinite; }
.skeleton-bar { height: 8px; border-radius: 99px; background: var(--border2); animation: skShimmer 1.4s infinite; }
@keyframes skPulse { 0%,100%{opacity:.4} 50%{opacity:1} }
@keyframes skShimmer { 0%{opacity:.3} 50%{opacity:.8} 100%{opacity:.3} }
.skeleton-bars { display: flex; flex-direction: column; gap: 10px; width: 200px; }

/* â”€â”€ ONBOARDING â”€â”€ */
.onboard-overlay {
  position: fixed; inset: 0; z-index: 600; background: rgba(0,0,0,.7);
  display: flex; align-items: flex-end; justify-content: center;
}
.onboard-overlay.hidden { display: none; }
.onboard-sheet {
  background: var(--panel); border-radius: 24px 24px 0 0;
  padding: 28px 24px 40px; width: 100%; max-width: 500px;
  direction: rtl;
}
.onboard-step { display: none; }
.onboard-step.active { display: block; }
.onboard-icon { font-size: 48px; text-align: center; margin-bottom: 12px; }
.onboard-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 8px; color: var(--text); }
.onboard-body { font-size: 14px; color: var(--muted2); text-align: center; line-height: 1.7; margin-bottom: 24px; }
.onboard-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 20px; }
.onboard-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border2); transition: background .2s; }
.onboard-dot.active { background: var(--accent); width: 20px; border-radius: 99px; }
.onboard-next { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; font-family: var(--font-ar); cursor: pointer; }
.onboard-skip { display: block; text-align: center; margin-top: 12px; color: var(--muted); font-size: 13px; cursor: pointer; }

/* â”€â”€ INCIDENT EDIT INPUTS â”€â”€ */
.inc-date-inp {
  background: transparent; border: none; border-bottom: 1px solid var(--border2);
  color: var(--muted2); font-size: 11px; font-family: var(--font-ar);
  padding: 2px 4px; border-radius: 0; width: 110px;
}
.inc-pen-inp {
  background: transparent; border: none; border-bottom: 1px solid var(--border2);
  color: var(--muted2); font-size: 11px; width: 36px; text-align: center;
}
.inc-date-inp:focus, .inc-pen-inp:focus { outline: none; border-color: var(--accent); }

/* â”€â”€ CONFLICT WARNING â”€â”€ */
.conflict-banner {
  position: fixed; top: 0; left: 0; right: 0; z-index: 999;
  background: #d97706; color: #fff; text-align: center;
  padding: 10px 16px; font-size: 13px; font-family: var(--font-ar);
  direction: rtl; transform: translateY(-100%); transition: transform .3s;
}
.conflict-banner.show { transform: translateY(0); }

/* â”€â”€ ROSTER MANAGER â”€â”€ */
/* â”€â”€ ROSTER MANAGER â”€â”€ */
.roster-overlay { z-index: 350; }
.roster-sheet { max-height: 90vh; display: flex; flex-direction: column; }
.roster-list { flex: 1; overflow-y: auto; }
.roster-student-row {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 20px; border-bottom: 1px solid var(--border);
  transition: background .15s;
}
.roster-student-row:hover { background: var(--card); }
.roster-num { font-family: var(--font-mono); font-size: 12px; color: var(--muted); min-width: 26px; }
.roster-name-inp {
  flex: 1; background: transparent; border: none; color: var(--text);
  font-family: var(--font-ar); font-size: 14px; direction: rtl;
  padding: 4px 6px; border-radius: 6px;
}
.roster-name-inp:focus { outline: none; background: var(--bg2); }
.roster-name-inp.removed { text-decoration: line-through; color: var(--muted); opacity: .5; }
.roster-del-btn { background: rgba(244,63,94,.15); border: none; color: var(--red); border-radius: 8px; padding: 5px 9px; cursor: pointer; font-size: 14px; }
.roster-del-btn:hover { background: rgba(244,63,94,.3); }
.roster-restore-btn { background: rgba(34,197,94,.15); border: none; color: var(--green); border-radius: 8px; padding: 5px 9px; cursor: pointer; font-size: 12px; }
.roster-add-row {
  display: flex; gap: 8px; padding: 12px 20px;
  border-top: 1px solid var(--border2); background: var(--panel);
  position: sticky; bottom: 0;
}
.roster-add-inp {
  flex: 1; background: var(--bg2); border: 1.5px solid var(--border2);
  color: var(--text); font-family: var(--font-ar); font-size: 14px;
  padding: 10px 14px; border-radius: 10px; direction: rtl;
}
.roster-add-inp:focus { outline: none; border-color: var(--accent); }
.roster-add-btn { background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 10px 16px; font-weight: 700; cursor: pointer; font-size: 14px; white-space: nowrap; }
.roster-add-btn:active { transform: scale(.95); }
.roster-stats { display: flex; gap: 8px; padding: 10px 20px; font-size: 12px; color: var(--muted); border-bottom: 1px solid var(--border); }
.roster-stat { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 4px 10px; }
body.proj .sidebar{background:#f0f4ff;border-color:#ccd;}
body.proj .topbar{background:rgba(248,249,255,.96);}
body.proj thead th{background:#1a2d5a;color:#e8eeff;border-bottom-color:rgba(201,168,76,.5);}
body.proj tbody tr:nth-child(odd) td{background:#f9faff !important;}
body.proj tbody tr:nth-child(even) td{background:#f2f4fc !important;}
body.proj tbody tr:hover td{background:#e8eeff !important;}
body.proj tbody tr.at-risk td{background:rgba(244,63,94,.06) !important;}
body.proj .name-inp{color:#0d1527;}
body.proj .score-inp{background:#fff;color:#0d1527;border-color:#c0cce0;}
body.proj .final-score.good{color:#166534;background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.3);}
body.proj .final-score.mid{color:#92400e;background:rgba(251,191,36,.18);border-color:rgba(251,191,36,.3);}
body.proj .final-score.low{color:#9f1239;background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.25);}
body.proj td{border-right-color:rgba(0,0,0,.05);}
body.proj td.name-cell{border-right-color:rgba(61,127,255,.25) !important;}
`;
document.head.appendChild(projStyle);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY ABSENCE REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _absReportCls = null;
let _absReportText = '';

function openAbsReport(cls){
  _absReportCls = cls;
  const st = loadCls(cls);
  const names = getRoster(cls);
  const today = todayISO();
  const now = new Date();
  const hhmm = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const s = loadSettings();
  const year = s.academicYear||'2025â€“2026';

  // Collect absent students
  const absent = [];
  names.forEach((_,idx)=>{
    const n = idx+1;
    const rec = getStudentRecord(st, n, names[idx]);
    if((rec.absenceDates||[]).includes(today)){
      absent.push({ n, name: rec.name||names[idx] });
    }
  });

  document.getElementById('absReportTitle').textContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Â· ${cls}`;
  document.getElementById('absReportSub').textContent = `${today} Â· ${hhmm} Â· ${absent.length} ØºØ§Ø¦Ø¨`;

  const body = document.getElementById('absReportBody');

  if(absent.length === 0){
    body.innerHTML = `
      <div style="text-align:center;padding:32px 20px;direction:rtl">
        <div style="font-size:48px;margin-bottom:12px">âœ…</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:6px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
        <div style="font-size:13px;color:var(--muted)">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø§Ø¶Ø±ÙˆÙ†</div>
      </div>`;
    document.getElementById('absReportCopyBtn').style.display='none';
    _absReportText = '';
  } else {
    // Build the report card
    const rows = absent.map(a=>
      `<div class="abs-report-row">
        <span class="abs-report-num">${a.n}</span>
        <span class="abs-report-name">${a.name}</span>
      </div>`
    ).join('');

    // Build plain text for copy/share
    _absReportText =
      `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨\n` +
      `Ø§Ù„Ù‚Ø³Ù…: ${cls}\n` +
      `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}   Ø§Ù„Ø³Ø§Ø¹Ø©: ${hhmm}\n` +
      `Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: ${year}\n` +
      `Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©\n` +
      `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
      `Ø¹Ø¯Ø¯ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†: ${absent.length}\n\n` +
      absent.map(a=>`${a.n}. ${a.name}`).join('\n') +
      `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
      `Ø§Ù„Ø£Ø³ØªØ§Ø°: ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†`;

    body.innerHTML = `
      <div class="abs-report-card">
        <div class="abs-report-header">
          <div style="direction:rtl">
            <div style="font-size:11px;opacity:.8;margin-bottom:4px">Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©</div>
            <div style="font-size:15px;font-weight:700">Ø§Ù„Ù‚Ø³Ù…: ${cls}</div>
            <div style="font-size:12px;margin-top:3px;opacity:.8">${today} Â· ${hhmm}</div>
          </div>
          <div class="abs-count-badge">${absent.length}<div style="font-size:11px;font-weight:600;opacity:.85">ØºØ§Ø¦Ø¨</div></div>
        </div>
        <div class="abs-report-rows">${rows}</div>
      </div>`;
    document.getElementById('absReportCopyBtn').style.display='';
  }
  document.getElementById('absReportOverlay').classList.add('show');
  addSwipeToClose(document.getElementById('absReportSheet'), closeAbsReport);
}

function closeAbsReport(){
  document.getElementById('absReportOverlay').classList.remove('show');
  _absReportCls = null;
}

function copyAbsReport(){
  if(!_absReportText) return;
  if(navigator.share){
    navigator.share({ text: _absReportText }).catch(()=>fallbackCopy());
  } else {
    fallbackCopy();
  }
}
function fallbackCopy(){
  (navigator.clipboard&&navigator.clipboard.writeText)(_absReportText)
    .then(()=>showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±'))
    .catch(()=>{
      // Last resort for older iOS
      const ta = document.createElement('textarea');
      ta.value = _absReportText;
      ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      try{ document.execCommand('copy'); showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±'); }
      catch(e){ showToast('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'); }
      ta.remove();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS SYNC ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GS_KEY = 'gbpro_gsurl';
const SECRET  = 'salah2026gradebook';
let _syncQueue = {};   // {cls_n: true} â€” pending syncs
let _syncTimer  = null;
let _syncing    = false;

function getGsUrl(){ return localStorage.getItem(GS_KEY)||''; }
function saveGsUrl(){
  var _gu=document.getElementById('gsUrl');var url=(_gu&&_gu.value)?_gu.value.trim():'';
  localStorage.setItem(GS_KEY, url);
  setGsStatus('', '');
}
function loadGsUrlUI(){
  const el = document.getElementById('gsUrl');
  if(el) el.value = getGsUrl();
}

function setGsStatus(msg, type){
  const el = document.getElementById('gsStatus');
  if(!el) return;
  const colors = { ok:'#42ba96', err:'#fb7185', warn:'#fbbf24', info:'var(--muted2)' };
  el.textContent = msg;
  el.style.color = colors[type]||colors.info;
}

// â”€â”€ CORE REQUEST â”€â”€
async function gsRequest(params){
  const url = getGsUrl();
  if(!url) return null;
  try{
    // NOTE: No Content-Type header â€” avoids CORS preflight which Google Apps Script doesn't support.
    // Sending as text/plain (default) bypasses preflight and works from any origin.
    const res = await fetch(url, {
      method: 'POST',
      body:   JSON.stringify(Object.assign({ key: SECRET }, params))
    });
    return await res.json();
  }catch(e){ return null; }
}

// â”€â”€ TEST CONNECTION â”€â”€
async function testConnection(){
  const url = getGsUrl();
  if(!url){ setGsStatus('âš ï¸ No URL entered yet.','warn'); return; }
  setGsStatus('ğŸ”„ Testing connectionâ€¦','info');
  const btn = document.getElementById('testBtn');
  btn.textContent = 'â€¦'; btn.disabled = true;
  const res = await gsRequest({ action:'ping' });
  btn.textContent = 'ğŸ”— Test'; btn.disabled = false;
  if(res && res.ok){
    setGsStatus('âœ… Connected! Google Sheet is ready.','ok');
    showToast('âœ… Google Sheets connected!');
  } else if(res && res.error){
    setGsStatus('âŒ ' + res.error, 'err');
  } else {
    setGsStatus('âŒ Cannot reach the script. Check the URL and make sure you redeployed.','err');
  }
}

// â”€â”€ SYNC ONE STUDENT RECORD â”€â”€
async function syncRecord(cls, n){
  const st  = loadCls(cls);
  const rec = getStudentRecord(st, n, getRoster(cls)[n-1]||'');
  await gsRequest({
    action: 'save', cls, n,
    name: rec.name||'',
    hw: (rec.scores&&rec.scores.hw)||'',   copy: (rec.scores&&rec.scores.copy)||'',
    t1: (rec.scores&&rec.scores.t1)||'',   t2:   (rec.scores&&rec.scores.t2)||'',
    glob: (rec.scores&&rec.scores.glob)||'',
    participationPoints: rec.participationPoints||0,
    disciplineIncidents: rec.disciplineIncidents||[],
    absenceDates:        rec.absenceDates||[]
  });
}

// â”€â”€ QUEUE DEBOUNCED SYNC (3 sec after last change) â”€â”€
function queueSync(cls, n){
  _syncQueue[cls+'_'+n] = {cls, n};
  if(_syncTimer) clearTimeout(_syncTimer);
  _syncTimer = setTimeout(flushSyncQueue, 3000);
}

async function flushSyncQueue(){
  if(!getGsUrl() || _syncing) return;
  _syncing = true;
  showSyncDot('pending');
  const items = Object.values(_syncQueue);
  _syncQueue  = {};
  for(const {cls,n} of items) await syncRecord(cls, n);
  _syncing = false;
  showSyncDot('ok');
}

function showSyncDot(state){
  const el = document.getElementById('syncDot');
  if(!el) return;
  if(state==='ok'){
    el.textContent='â˜ï¸'; el.title='Synced to Google Sheets';
    el.style.color='#42ba96'; el.style.opacity='1';
    setTimeout(()=>el.style.opacity='.35', 3000);
  } else if(state==='pending'){
    el.textContent='ğŸ”„'; el.title='Syncingâ€¦';
    el.style.color='#fbbf24'; el.style.opacity='1';
  }
}

// â”€â”€ PUSH ALL â€” force upload everything â”€â”€
async function pushAllToSheets(){
  const url = getGsUrl();
  if(!url){ setGsStatus('âš ï¸ Enter your Google Script URL first.','warn'); return; }
  const btn = document.getElementById('pushBtn');
  btn.textContent = 'â³ Pushingâ€¦'; btn.disabled = true;
  setGsStatus('ğŸ”„ Uploading all records to Google Sheetsâ€¦','info');
  showSyncDot('pending');
  let count = 0;
  for(const cls of classNames){
    for(let idx=0; idx<(getRoster(cls)).length; idx++){
      await syncRecord(cls, idx+1);
      count++;
    }
  }
  btn.textContent = 'â˜ï¸ Push All'; btn.disabled = false;
  setGsStatus('âœ… ' + count + ' records pushed to Google Sheets.','ok');
  showToast('â˜ï¸ All data synced to Google Sheets');
  showSyncDot('ok');
}

// â”€â”€ PULL â€” load all data from sheet on startup â”€â”€
async function pullFromSheets(){
  if(!getGsUrl()) return;
  showSyncDot('pending');
  const res = await gsRequest({ action:'loadAll' });
  if(!res || !res.ok || !Array.isArray(res.data) || !res.data.length){
    showSyncDot('ok'); return;
  }
  res.data.forEach(row=>{
    const cls = row.cls;
    const n   = parseInt(row.n);
    if(!cls || !n || !getRoster(cls)) return;
    const st  = loadCls(cls);
    const rec = getStudentRecord(st, n, getRoster(cls)[n-1]||'');
    if(row.name) rec.name = row.name;
    rec.scores = {
      hw: row.hw||'', copy: row.copy||'',
      t1: row.t1||'', t2: row.t2||'',
      glob: row.glob||''
    };
    rec.participationPoints = parseInt(row.participationPoints)||0;
    rec.disciplineIncidents = Array.isArray(row.disciplineIncidents)?row.disciplineIncidents:[];
    rec.absenceDates        = Array.isArray(row.absenceDates)?row.absenceDates:[];
    try{ localStorage.setItem(SK(cls), JSON.stringify(st)); }catch(e){}
  });
  showToast('âœ… Data loaded from Google Sheets');
  showSyncDot('ok');
  if(currentClass) renderClassPage(currentClass);
  renderOverview();
  updateRiskCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE INDICATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastSaved = null;
let _saveTimer = null;
let _unsavedChanges = false;

function showSaveIndicator(){
  _lastSaved = new Date();
  _unsavedChanges = false;
  const icon = document.getElementById('saveIcon');
  const text = document.getElementById('saveText');
  const bar  = document.getElementById('saveIndicator');
  const btn  = document.getElementById('manualSaveBtn');
  if(!icon||!text||!bar) return;
  // Flash green
  icon.textContent = 'âœ…';
  text.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
  bar.style.borderColor = 'rgba(34,197,94,.4)';
  bar.style.background   = 'rgba(34,197,94,.1)';
  bar.style.color        = 'var(--green)';
  if(btn){ btn.style.borderColor='rgba(34,197,94,.4)'; btn.style.color='var(--green)'; }
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=>{
    const t = _lastSaved;
    const h = t.getHours().toString().padStart(2,'0');
    const m = t.getMinutes().toString().padStart(2,'0');
    icon.textContent = 'âœ…';
    text.textContent = 'Ø¢Ø®Ø± Ø­ÙØ¸ ' + h + ':' + m;
    bar.style.borderColor = 'rgba(34,197,94,.2)';
    bar.style.background   = 'rgba(34,197,94,.06)';
    bar.style.color        = 'var(--green)';
    if(btn){ btn.style.borderColor=''; btn.style.color=''; }
  }, 1800);
}

function markUnsaved(){
  _unsavedChanges = true;
  const icon = document.getElementById('saveIcon');
  const text = document.getElementById('saveText');
  const bar  = document.getElementById('saveIndicator');
  const btn  = document.getElementById('manualSaveBtn');
  if(!icon||!text||!bar) return;
  icon.textContent = 'âœï¸';
  text.textContent = 'ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©';
  bar.style.borderColor = 'rgba(245,158,11,.35)';
  bar.style.background   = 'rgba(245,158,11,.08)';
  bar.style.color        = 'var(--amber)';
  if(btn){ btn.style.borderColor='rgba(245,158,11,.4)'; btn.style.color='var(--amber)'; }
}

function showSaveError(){
  const icon = document.getElementById('saveIcon');
  const text = document.getElementById('saveText');
  const bar  = document.getElementById('saveIndicator');
  if(!icon||!text||!bar) return;
  icon.textContent = 'âŒ';
  text.textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸!';
  bar.style.borderColor = 'rgba(244,63,94,.4)';
  bar.style.background   = 'rgba(244,63,94,.1)';
  bar.style.color        = 'var(--red)';
  showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø©');
}

function manualSave(){
  // Force-save the current class if open
  if(currentClass && _rows[currentClass]){
    const st = loadCls(currentClass);
    const names = currentClass ? getRoster(currentClass) : [];
    _rows[currentClass].forEach(({rowObj, n})=>{
      const rec = getStudentRecord(st, n, names[n-1]);
      rec.name = rowObj.nameInp.value;
      rec.scores = {
        hw: rowObj.hw.value, copy: rowObj.copy.value,
        t1: rowObj.t1.value, t2: rowObj.t2.value, glob: rowObj.glob.value
      };
      rec.participationPoints = rowObj.partPoints;
      rec.disciplineIncidents = rowObj.discIncidents;
      rec.absenceDates = rowObj.absDates;
    });
    saveCls(currentClass, st);
  }
  saveSettings();
  showToast('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

// Warn before leaving if unsaved
window.addEventListener('beforeunload', e=>{
  if(_unsavedChanges){
    e.preventDefault();
    e.returnValue = 'Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// iPHONE SWIPE-DOWN TO CLOSE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSwipeToClose(sheetEl, closeFn){
  let startY = 0, isDragging = false;
  sheetEl.addEventListener('touchstart', e=>{
    startY = e.touches[0].clientY;
    isDragging = true;
  }, {passive: true});
  sheetEl.addEventListener('touchmove', e=>{
    if(!isDragging) return;
    const dy = e.touches[0].clientY - startY;
    if(dy > 0) sheetEl.style.transform = `translateY(${dy}px)`;
  }, {passive: true});
  sheetEl.addEventListener('touchend', e=>{
    if(!isDragging) return;
    isDragging = false;
    const dy = e.changedTouches[0].clientY - startY;
    if(dy > 80){ sheetEl.style.transform=''; closeFn(); }
    else{ sheetEl.style.transition='transform .2s'; sheetEl.style.transform=''; setTimeout(()=>sheetEl.style.transition='',200); }
  }, {passive: true});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEEK STRIP (Overview)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWeekStrip(){
  const strip = document.getElementById('weekStrip');
  if(!strip) return;
  const today = todayISO();
  const days = [];
  // Past 6 days + today = 7 chips
  for(let i=6; i>=0; i--){
    const d = new Date();
    d.setDate(d.getDate()-i);
    days.push(d);
  }
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  strip.innerHTML = days.map(d=>{
    const iso = d.toISOString().slice(0,10);
    const isToday = iso===today;
    // Count absences across all classes for this date
    let total=0;
    classNames.forEach(cls=>{
      const st=loadCls(cls);
      const names=getRoster(cls);
      names.forEach((_,idx)=>{
        const rec=getStudentRecord(st,idx+1,names[idx]);
        if((rec.absenceDates||[]).includes(iso)) total++;
      });
    });
    const absClass = total===0?'zero':total<=5?'low':'high';
    return `<div class="week-day-chip${isToday?' today-chip':''}" onclick="jumpToDailyAbs('${iso}')">
      <div class="wd-name">${dayNames[d.getDay()]}</div>
      <div class="wd-date">${d.getDate()}</div>
      <div class="wd-abs ${absClass}">${total>0?total:'âœ“'}</div>
    </div>`;
  }).join('');
}

function jumpToDailyAbs(iso){
  showPage('dailyabs');
  setTimeout(()=>{
    document.getElementById('dailyAbsDate').value = iso;
    renderDailyAbs();
  },50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TODAY ABSENCE BADGE IN NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTodayAbsBadge(){
  const today = todayISO();
  let total=0;
  classNames.forEach(cls=>{
    const st=loadCls(cls);
    const names=getRoster(cls);
    names.forEach((_,idx)=>{
      const rec=getStudentRecord(st,idx+1,names[idx]);
      if((rec.absenceDates||[]).includes(today)) total++;
    });
  });
  const badge = document.getElementById('todayAbsCount');
  if(badge){ badge.textContent=total; badge.style.display=total>0?'':'none'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY ABSENCES PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDailyAbs(){
  const inp = document.getElementById('dailyAbsDate');
  if(!inp.value) inp.value = todayISO();
  renderDailyAbs();
}

function setDailyAbsToday(){
  document.getElementById('dailyAbsDate').value = todayISO();
  renderDailyAbs();
}

function renderDailyAbs(){
  const date = document.getElementById('dailyAbsDate').value;
  if(!date) return;
  const classes = classNames;
  let totalAbs=0, classesWithAbs=0, allPresent=0;
  const perClass = []; // {cls, count, students[]}

  classes.forEach(cls=>{
    const st=loadCls(cls);
    const names=getRoster(cls);
    const absent=[];
    names.forEach((_,idx)=>{
      const n=idx+1;
      const rec=getStudentRecord(st,n,names[idx]);
      if(absHasDate(rec,date)){
        absent.push({n, name:rec.name||names[idx], totalAbs:(rec.absenceRecords||rec.absenceDates||[]).length, justified:absIsJust(rec,date)});
      }
    });
    perClass.push({cls, count:absent.length, students:absent, total:names.length});
    totalAbs+=absent.length;
    if(absent.length>0) classesWithAbs++;
  });

  const totalStudents = classes.reduce((a,c)=>a+getRoster(c).length,0);
  allPresent = classes.filter(c=>((function(){var _pf=perClass.find(function(p){return p.cls===c;});return _pf?_pf.count:undefined;})()=== 0)).length;

  // KPI strip
  const summary = document.getElementById('dailyAbsSummary');
  const dateLabel = new Date(date+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
  summary.innerHTML=`
    <div class="abs-day-kpi kpi-total"><div class="kpi-val">${totalAbs}</div><div class="kpi-lbl">Total Absent</div></div>
    <div class="abs-day-kpi kpi-classes"><div class="kpi-val">${classesWithAbs}/${classes.length}</div><div class="kpi-lbl">Classes Affected</div></div>
    <div class="abs-day-kpi kpi-zero"><div class="kpi-val">${allPresent}</div><div class="kpi-lbl">Full Classes</div></div>
  `;

  // Bar chart per class
  var maxCount = Math.max.apply(null, perClass.map(function(p){return p.count;}).concat([1]));
  const bars = document.getElementById('dailyAbsBars');
  bars.innerHTML = perClass.map(p=>{
    const pct = Math.round((p.count/maxCount)*100);
    const countClass = p.count===0?'zero':p.count<=3?'warn':'danger';
    return `<div class="abs-bar-row ${p.count>0?'has-absent':''}" onclick="scrollToClass('${p.cls}')">
      <span class="abs-bar-cls">${p.cls}</span>
      <div class="abs-bar-track"><div class="abs-bar-fill ${p.count===0?'zero':''}" style="width:${p.count===0?100:pct}%;background:${p.count===0?'var(--green)':'var(--red)'}"></div></div>
      <span class="abs-bar-count ${countClass}">${p.count===0?'âœ“':p.count}</span>
    </div>`;
  }).join('');

  // Student list
  const studentsDiv = document.getElementById('dailyAbsStudents');
  const withAbs = perClass.filter(p=>p.count>0);
  if(withAbs.length===0){
    studentsDiv.innerHTML=`<div class="no-absent-day"><div class="big-icon">ğŸ‰</div><div class="msg">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø§Ø¶Ø±ÙˆÙ†</div><div class="sub">No absences recorded on ${dateLabel}</div></div>`;
  } else {
    studentsDiv.innerHTML = withAbs.map(p=>`
      <div class="abs-day-cls-block" id="abs-cls-${p.cls.replace(/[^a-zA-Z0-9]/g,'_')}">
        <div class="abs-day-cls-title">${p.cls} â€” ${p.count} absent</div>
        ${p.students.map(s=>`<div class="abs-day-student-row">
          <span class="abs-day-num">${s.n}</span>
          <span class="abs-day-name">${s.name}</span>
          ${s.justified?'<span style="font-size:10px;background:rgba(245,158,11,.2);color:var(--amber);padding:2px 7px;border-radius:20px;border:1px solid rgba(245,158,11,.3)">Ù…Ø¨Ø±Ø±</span>':'<span style="font-size:10px;background:rgba(244,63,94,.15);color:var(--red);padding:2px 7px;border-radius:20px;border:1px solid rgba(244,63,94,.3)">Øº.Ù…</span>'}
          <span class="abs-day-total" title="Total absences this year">${s.totalAbs} abs</span>
        </div>`).join('')}
      </div>`).join('');
  }
  // update topbar meta
  document.getElementById('topbarMeta').textContent = `${totalAbs} absent Â· ${dateLabel}`;
}

function scrollToClass(cls){
  const id = 'abs-cls-'+cls.replace(/[^a-zA-Z0-9]/g,'_');
  var _sid=document.getElementById(id);if(_sid)_sid.scrollIntoView({behavior:'smooth',block:'start'});
}

function copyDailyAbsReport(){
  const date = document.getElementById('dailyAbsDate').value;
  if(!date){ showToast('Please select a date first'); return; }
  const classes = classNames;
  const perClass=[];
  classes.forEach(cls=>{
    const st=loadCls(cls);
    const names=getRoster(cls);
    const absent=[];
    names.forEach((_,idx)=>{
      const n=idx+1;
      const rec=getStudentRecord(st,n,names[idx]);
      if((rec.absenceDates||[]).includes(date)){
        absent.push({n, name:rec.name||names[idx]});
      }
    });
    if(absent.length>0) perClass.push({cls,students:absent});
  });
  const totalAbs = perClass.reduce((a,p)=>a+p.students.length,0);
  const s = loadSettings();
  const now=new Date(); const hhmm=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  let text = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ\nØ«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ ÙƒÙ†ÙˆÙ† Ø§Ù„ØªØ£Ù‡ÙŠÙ„ÙŠØ©\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}   Ø§Ù„Ø³Ø§Ø¹Ø©: ${hhmm}\nØ§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: ${s.academicYear||'2025â€“2026'}\n${'â”€'.repeat(30)}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†: ${totalAbs}\n\n`;
  if(perClass.length===0){ text+='âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø§Ø¶Ø±ÙˆÙ†\n'; }
  else { perClass.forEach(p=>{ text+='Ø§Ù„Ù‚Ø³Ù…: '+p.cls+' ('+p.students.length+' ØºØ§Ø¦Ø¨)\n'; p.students.forEach(s=>text+='  '+s.n+'. '+s.name+'\n'); text+='\n'; }); }
  text+=`${'â”€'.repeat(30)}\nØ§Ù„Ø£Ø³ØªØ§Ø°: ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†`;
  navigator.clipboard.writeText(text).then(()=>showToast('âœ… Report copied!')).catch(()=>{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('âœ… Report copied!'); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME TOGGLE (Light / Dark)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme(){
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('gbpro_theme', isLight?'light':'dark');
  document.getElementById('themeIcon').textContent = isLight?'ğŸŒ™':'â˜€ï¸';
  document.getElementById('themeLabel').textContent = isLight?'Dark Mode':'Light Mode';
  const tb = document.getElementById('themeTopBtn');
  if(tb) tb.textContent = isLight?'ğŸŒ™':'â˜€ï¸';
}
function loadTheme(){
  const t = localStorage.getItem('gbpro_theme');
  if(t==='light'){ document.body.classList.add('light'); const i=document.getElementById('themeIcon'); if(i){i.textContent='ğŸŒ™'; document.getElementById('themeLabel').textContent='Dark Mode';} const tb=document.getElementById('themeTopBtn'); if(tb) tb.textContent='ğŸŒ™'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL SEARCH (all classes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _gsTimer = null;
function globalSearch(term){
  clearTimeout(_gsTimer);
  term = term.trim();
  const res = document.getElementById('globalSearchResults');
  if(!term){ res.classList.remove('show'); return; }
  _gsTimer = setTimeout(()=>{
    const matches = [];
    classNames.forEach(cls=>{
      const st=loadCls(cls); const names=getRoster(cls);
      names.forEach((defName,idx)=>{
        const n=idx+1;
        const rec=getStudentRecord(st,n,defName);
        const name=(rec.name||defName).toLowerCase();
        if(name.includes(term.toLowerCase())){
          var _rf0=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;var ro=_rf0?_rf0.rowObj:null;
          const fin=ro?parseFloat(ro.final.textContent)||0:0;
          matches.push({cls,n,name:rec.name||defName,fin});
        }
      });
    });
    if(matches.length===0){
      res.innerHTML='<div class="gs-no-results">No results for "'+term+'"</div>';
    } else {
      res.innerHTML = matches.slice(0,12).map(m=>`
        <div class="gs-result-item" onclick="jumpToStudent('${m.cls}',${m.n})">
          <span class="gs-result-name">${m.name}</span>
          <span class="gs-result-cls">${m.cls}</span>
          <span class="gs-result-grade ${gradeClass(m.fin)}">${m.fin>0?m.fin.toFixed(1):'â€”'}</span>
        </div>`).join('');
    }
    res.classList.add('show');
  }, 200);
}
function showGlobalResults(){
  const inp=document.getElementById('globalSearchInp');
  if(inp&&inp.value.trim()) globalSearch(inp.value);
}
function jumpToStudent(cls,n){
  document.getElementById('globalSearchInp').value='';
  document.getElementById('globalSearchResults').classList.remove('show');
  closeSidebar();
  showPage(null,cls);
  setTimeout(()=>{
    var row=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;
    if(row){ row.tr.scrollIntoView({behavior:'smooth',block:'center'}); row.tr.style.outline='2px solid var(--accent)'; setTimeout(()=>row.tr.style.outline='',1500); }
  },300);
}
// Close global search on outside click
document.addEventListener('click',(e)=>{ if(!e.target.closest('.global-search-wrap')){var _gsr=document.getElementById('globalSearchResults');if(_gsr)_gsr.classList.remove('show');} });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNDO SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _undoStack = null; // {cls, n, rec_snapshot, description}
let _undoTimer = null;

function pushUndo(cls, n, snapshot, description){
  _undoStack = {cls, n, snapshot: JSON.parse(JSON.stringify(snapshot)), description};
  const msg = document.getElementById('undoMsg');
  if(msg) msg.textContent = description;
  const toast = document.getElementById('undoToast');
  if(toast){ toast.classList.add('show'); clearTimeout(_undoTimer); _undoTimer=setTimeout(()=>{ toast.classList.remove('show'); _undoStack=null; },5000); }
}

function doUndo(){
  if(!_undoStack) return;
  const {cls,n,snapshot}=_undoStack;
  const st=loadCls(cls);
  st.students = st.students||{};
  st.students[n] = JSON.parse(JSON.stringify(snapshot));
  saveCls(cls,st);
  syncRowFromStorage(cls,n);
  queueSync(cls,n);
  document.getElementById('undoToast').classList.remove('show');
  _undoStack=null;
  showToast('â†© Undone');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRADE DISTRIBUTION CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getGradeBuckets(vals){
  // Buckets: 0-4, 5-7, 8-9, 10-11, 12-13, 14-15, 16-17, 18-20
  const buckets=[0,0,0,0,0,0,0,0];
  vals.forEach(v=>{
    if(v<5) buckets[0]++;
    else if(v<8) buckets[1]++;
    else if(v<10) buckets[2]++;
    else if(v<12) buckets[3]++;
    else if(v<14) buckets[4]++;
    else if(v<16) buckets[5]++;
    else if(v<18) buckets[6]++;
    else buckets[7]++;
  });
  return buckets;
}

function buildMiniDistChart(cls, st, names){
  const vals=[];
  names.forEach(function(_,idx){
    if(!names[idx]) return;
    const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
    const rm={hw:{value:(rec.scores&&rec.scores.hw)||''},copy:{value:(rec.scores&&rec.scores.copy)||''},t1:{value:(rec.scores&&rec.scores.t1)||''},t2:{value:(rec.scores&&rec.scores.t2)||''},glob:{value:(rec.scores&&rec.scores.glob)||''},partPoints:rec.participationPoints||0,discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]};
    vals.push(calcFinal(rm));
  });
  const b=getGradeBuckets(vals);
  const max=Math.max.apply(null, b.concat([1]));
  const colors=['#f43f5e','#f43f5e','#f59e0b','#22c55e','#22c55e','#3d7fff','#3d7fff','#c9a84c'];
  return b.map((count,i)=>`<div class="dist-bar" style="height:${Math.round((count/max)*100)}%;background:${colors[i]};opacity:.8" data-tip="${['0-4','5-7','8-9','10-11','12-13','14-15','16-17','18-20'][i]}: ${count}"></div>`).join('');
}

function buildFullDistChart(vals){
  const b=getGradeBuckets(vals);
  const max=Math.max.apply(null, b.concat([1]));
  const labels=['0â€“4','5â€“7','8â€“9','10â€“11','12â€“13','14â€“15','16â€“17','18â€“20'];
  const colors=['#f43f5e','#f43f5e','#f59e0b','#22c55e','#22c55e','#3d7fff','#3d7fff','#c9a84c'];
  const bars=b.map((count,i)=>`<div class="dist-bar" style="height:${Math.max(3,Math.round((count/max)*60))}px;background:${colors[i]}" data-tip="${labels[i]}: ${count} students"></div>`).join('');
  const lbls=labels.map(l=>`<span>${l}</span>`).join('');
  return `<div class="dist-chart" style="height:60px">${bars}</div><div class="dist-labels">${lbls}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASS COMPARISON PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _compMetric = 'avg';

function setCompMetric(metric, btn){
  _compMetric = metric;
  document.querySelectorAll('.comp-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderComparison();
}

function renderComparison(){
  const allData = classNames.map(cls=>{
    const st=loadCls(cls); const names=getRoster(cls);
    let totalFin=0,above=0,risk=0,totalAbs=0;
    names.forEach((_,idx)=>{
      const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
      const rm={hw:{value:(rec.scores&&rec.scores.hw)||''},copy:{value:(rec.scores&&rec.scores.copy)||''},t1:{value:(rec.scores&&rec.scores.t1)||''},t2:{value:(rec.scores&&rec.scores.t2)||''},glob:{value:(rec.scores&&rec.scores.glob)||''},partPoints:rec.participationPoints||0,discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]};
      const fin=calcFinal(rm);
      totalFin+=fin;
      if(fin>=10) above++;
      if(isAtRisk({absenceDates:rec.absenceDates,disciplineIncidents:rec.disciplineIncidents,_fin:fin})) risk++;
      totalAbs+=(rec.absenceRecords||rec.absenceDates||[]).length;
    });
    const count=names.length||1;
    return {cls, avg:totalFin/count, above, abovePct:Math.round(above/count*100), risk, riskPct:Math.round(risk/count*100), totalAbs, absPer:+(totalAbs/count).toFixed(1), count};
  });

  // KPIs
  const totalStudents=allData.reduce((a,d)=>a+d.count,0);
  const overallAvg=(allData.reduce((a,d)=>a+d.avg*d.count,0)/totalStudents).toFixed(2);
  const totalRisk=allData.reduce((a,d)=>a+d.risk,0);
  const totalAbsAll=allData.reduce((a,d)=>a+d.totalAbs,0);
  const bestCls=allData.reduce((a,b)=>a.avg>b.avg?a:b);
  document.getElementById('compKpis').innerHTML=`
    <div class="comp-kpi"><div class="v" style="color:var(--gold2)">${overallAvg}</div><div class="l">Overall Average</div></div>
    <div class="comp-kpi"><div class="v" style="color:var(--red)">${totalRisk}</div><div class="l">At-Risk Students</div></div>
    <div class="comp-kpi"><div class="v" style="color:var(--amber)">${totalAbsAll}</div><div class="l">Total Absences</div></div>`;

  // Bars
  const metric = _compMetric;
  const getVal = d => metric==='avg'?d.avg:metric==='above'?d.abovePct:metric==='risk'?d.riskPct:d.absPer;
  const getLabel = d => metric==='avg'?d.avg.toFixed(2):metric==='above'?d.abovePct+'%':metric==='risk'?d.riskPct+'%':d.absPer;
  const getColor = d => metric==='avg'?(d.avg>=14?'#22c55e':d.avg>=10?'#3d7fff':'#f43f5e'):metric==='above'?'#22c55e':metric==='risk'?'#f43f5e':'#f59e0b';
  var maxVal=Math.max.apply(null,allData.map(getVal).concat([1]));
  var sorted=allData.slice().sort(function(a,b){return getVal(b)-getVal(a);});
  document.getElementById('compBars').innerHTML=sorted.map(d=>`
    <div class="comp-bar-row">
      <span class="comp-bar-cls">${d.cls}</span>
      <div class="comp-bar-track">
        <div class="comp-bar-fill" style="width:${Math.round(getVal(d)/maxVal*100)}%;background:${getColor(d)}">${getLabel(d)}</div>
      </div>
      <span class="comp-bar-val ${gradeClass(d.avg)}">${metric==='avg'?d.avg.toFixed(1):getLabel(d)}</span>
    </div>`).join('');

  // Distribution chart
  const allVals=[];
  classNames.forEach(cls=>{ const st=loadCls(cls); const names=getRoster(cls); names.forEach((_,idx)=>{ const n=idx+1; const rec=getStudentRecord(st,n,names[idx]); const rm={hw:{value:(rec.scores&&rec.scores.hw)||''},copy:{value:(rec.scores&&rec.scores.copy)||''},t1:{value:(rec.scores&&rec.scores.t1)||''},t2:{value:(rec.scores&&rec.scores.t2)||''},glob:{value:(rec.scores&&rec.scores.glob)||''},partPoints:rec.participationPoints||0,discIncidents:rec.disciplineIncidents||[],absDates:rec.absenceDates||[]}; allVals.push(calcFinal(rm)); }); });
  document.getElementById('compDistChart').innerHTML=buildFullDistChart(allVals);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT ALL CLASSES CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportAllCSV(){
  const headers=['Ø§Ù„Ù‚Ø³Ù…','#','Ø§Ù„Ø§Ø³Ù…','Ù1','Ù2','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø§Ù„ÙˆØ§Ø¬Ø¨','Ø§Ù„Ø¯ÙØªØ±','Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©','Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©','Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·','Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨ (ØºÙŠØ± Ù…Ø¨Ø±Ø±)','Ø¯Ø±Ø¬Ø© Ø§Ù„ØºÙŠØ§Ø¨','Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©'];
  const lines=[headers.join(',')];
  classNames.forEach(cls=>{
    const st=loadCls(cls); const names=getRoster(cls);
    names.forEach((_,idx)=>{
      const n=idx+1; const rec=getStudentRecord(st,n,names[idx]);
      var _rf0=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;var ro=_rf0?_rf0.rowObj:null;
      const hw=ro?num(ro.hw.value):num((rec.scores&&rec.scores.hw));
      const copy=ro?num(ro.copy.value):num((rec.scores&&rec.scores.copy));
      const t1=ro?num(ro.t1.value):num((rec.scores&&rec.scores.t1));
      const t2=ro?num(ro.t2.value):num((rec.scores&&rec.scores.t2));
      const glob=ro?num(ro.glob.value):num((rec.scores&&rec.scores.glob));
      const pPts=ro?ro.partPoints:rec.participationPoints||0;
      const incs=ro?ro.discIncidents:rec.disciplineIncidents||[];
      const unjust=absGetUnjust(rec).length;
      const rm={hw:{value:hw},copy:{value:copy},t1:{value:t1},t2:{value:t2},glob:{value:glob},partPoints:pPts,discIncidents:incs,absRec:rec};
      lines.push([cls,n,`"${(rec.name||names[idx]).replace(/"/g,'""')}"`,t1,t2,glob,hw,copy,pPts,partScore(pPts).toFixed(2),discScore(incs).toFixed(2),unjust,absScore(rec).toFixed(2),calcFinal(rm).toFixed(2)].join(','));
    });
    lines.push(''); // blank row between classes
  });
  const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='gradebook_all_classes.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('ğŸ“¤ All classes exported!');
  closeSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN (Create / Lock)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PIN_KEY='gbpro_pin';
let _pinModalBuf='', _pinModalStep=1, _pinModalFirst='';
let _pinLockBuf='';
let _pinLockTimer=null;
const PIN_TIMEOUT=5*60*1000;

function hashPin(p){ let h=0; for(let c of p){h=((h<<5)-h)+c.charCodeAt(0);h|=0;} return h.toString(36); }
function getStoredPin(){ return localStorage.getItem(PIN_KEY)||''; }

// â”€â”€ Setup modal â”€â”€
function openPinModal(){
  closeSidebar();
  _pinModalBuf=''; _pinModalStep=1; _pinModalFirst='';
  document.getElementById('pinModalTitle').textContent=getStoredPin()?'ğŸ” Change PIN':'ğŸ” Create PIN';
  document.getElementById('pinModalSub').textContent='Choose a 4-digit PIN';
  document.getElementById('pinModalError').textContent='';
  updatePinModalDots();
  document.getElementById('pinModalOverlay').classList.add('show');
}
function closePinModal(){ document.getElementById('pinModalOverlay').classList.remove('show'); }
function closePinModalIfBg(e){ if(e.target===document.getElementById('pinModalOverlay')) closePinModal(); }

function pinModalPress(d){
  if(_pinModalBuf.length>=4) return;
  _pinModalBuf+=d; updatePinModalDots();
  if(_pinModalBuf.length===4) setTimeout(submitPinModal,200);
}
function pinModalDel(){ _pinModalBuf=_pinModalBuf.slice(0,-1); updatePinModalDots(); }
function updatePinModalDots(){
  for(let i=0;i<4;i++){ const dot=document.getElementById('pmd'+i); if(dot) dot.classList.toggle('filled',i<_pinModalBuf.length); }
}
function submitPinModal(){
  if(_pinModalStep===1){
    _pinModalFirst=_pinModalBuf; _pinModalBuf='';
    document.getElementById('pinModalSub').textContent='Confirm your PIN';
    document.getElementById('pinModalError').textContent='';
    _pinModalStep=2; updatePinModalDots();
  } else {
    if(_pinModalBuf===_pinModalFirst){
      localStorage.setItem(PIN_KEY,hashPin(_pinModalBuf));
      closePinModal(); showToast('ğŸ” PIN saved! App will lock after 5 min.');
      startPinInactivityTimer();
    } else {
      document.getElementById('pinModalError').textContent='PINs do not match. Try again.';
      for(let i=0;i<4;i++){ const d=document.getElementById('pmd'+i); if(d){d.classList.add('error'); setTimeout(()=>d.classList.remove('error'),500);} }
      setTimeout(()=>{ _pinModalBuf=''; _pinModalFirst=''; _pinModalStep=1; document.getElementById('pinModalSub').textContent='Choose a 4-digit PIN'; document.getElementById('pinModalError').textContent=''; updatePinModalDots(); },700);
    }
  }
}

// â”€â”€ Lock screen â”€â”€
function showPinLock(){
  _pinLockBuf='';
  updatePinLockDots();
  document.getElementById('pinLockError').textContent='';
  document.getElementById('pinLockScreen').classList.remove('hidden');
}
function hidePinLock(){ document.getElementById('pinLockScreen').classList.add('hidden'); }

function pinLockPress(d){
  if(_pinLockBuf.length>=4) return;
  _pinLockBuf+=d; updatePinLockDots();
  if(_pinLockBuf.length===4) setTimeout(checkPinLock,200);
}
function pinLockDel(){ _pinLockBuf=_pinLockBuf.slice(0,-1); updatePinLockDots(); }
function updatePinLockDots(){
  for(let i=0;i<4;i++){ const d=document.getElementById('pld'+i); if(d) d.classList.toggle('filled',i<_pinLockBuf.length); }
}
function checkPinLock(){
  if(hashPin(_pinLockBuf)===getStoredPin()){
    hidePinLock(); startPinInactivityTimer();
  } else {
    document.getElementById('pinLockError').textContent='Incorrect PIN';
    for(let i=0;i<4;i++){ const d=document.getElementById('pld'+i); if(d){d.classList.add('error'); setTimeout(()=>d.classList.remove('error'),500);} }
    setTimeout(()=>{ _pinLockBuf=''; updatePinLockDots(); document.getElementById('pinLockError').textContent=''; },700);
  }
}
function pinLockDisable(){
  if(confirm('Remove PIN protection?')){ localStorage.removeItem(PIN_KEY); hidePinLock(); showToast('ğŸ”“ PIN removed'); clearTimeout(_pinLockTimer); }
}

function startPinInactivityTimer(){
  clearTimeout(_pinLockTimer);
  if(!getStoredPin()) return;
  _pinLockTimer=setTimeout(()=>{ if(getStoredPin()) showPinLock(); }, PIN_TIMEOUT);
}
// Reset timer on interaction
document.addEventListener('touchstart',function(){ try{ if(getStoredPin()) startPinInactivityTimer(); }catch(e){} },{passive:true});
document.addEventListener('click',function(){ try{ if(getStoredPin()) startPinInactivityTimer(); }catch(e){} });

function checkPinOnLoad(){
  if(getStoredPin()) showPinLock();
  else startPinInactivityTimer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD NAVIGATION IN TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initKeyboardNav(){
  document.addEventListener('keydown',(e)=>{
    const active=document.activeElement;
    if(!active) return;
    const isScore=active.classList.contains('score-inp');
    const isName=active.classList.contains('name-inp');
    if(!isScore&&!isName) return;
    const tr=active.closest('tr');
    if(!tr) return;
    var allInputs=Array.prototype.slice.call(document.querySelectorAll('#classTableBody .score-inp, #classTableBody .name-inp'));
    const idx=allInputs.indexOf(active);
    if(e.key==='Tab'||e.key==='ArrowRight'){
      e.preventDefault();
      const next=allInputs[idx+(e.shiftKey?-1:1)];
      if(next){ next.focus(); next.select(); }
    } else if(e.key==='ArrowDown'){
      e.preventDefault();
      // Find same column in next row
      var tds=Array.prototype.slice.call(tr.querySelectorAll('td'));
      const tdIdx=tds.indexOf(active.closest('td'));
      const nextTr=tr.nextElementSibling;
      if(nextTr){ const inp=nextTr.querySelectorAll('input')[tdIdx-1]; if(inp){inp.focus();inp.select();} }
    } else if(e.key==='ArrowUp'){
      e.preventDefault();
      var tds=Array.prototype.slice.call(tr.querySelectorAll('td'));
      const tdIdx=tds.indexOf(active.closest('td'));
      const prevTr=tr.previousElementSibling;
      if(prevTr){ const inp=prevTr.querySelectorAll('input')[tdIdx-1]; if(inp){inp.focus();inp.select();} }
    } else if(e.key==='Enter'){
      e.preventDefault();
      const next=allInputs[idx+1];
      if(next){ next.focus(); next.select(); }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROSTER MANAGER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _rosterCls = null;

function openRosterManager(cls){
  if(!cls) return;
  _rosterCls = cls;
  document.getElementById('rosterTitle').textContent = `ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© ${cls}`;
  renderRosterManager();
  document.getElementById('rosterOverlay').classList.add('show');
  addSwipeToClose(document.querySelector('#rosterOverlay .sheet'), closeRosterManager);
}

function closeRosterManager(){
  document.getElementById('rosterOverlay').classList.remove('show');
  _rosterCls = null;
}

function renderRosterManager(){
  const cls = _rosterCls;
  const roster = getRoster(cls);
  const active = roster.filter(n => n).length;
  const removed = roster.filter(n => !n).length;

  document.getElementById('rosterSub').textContent = `${active} Ø·Ø§Ù„Ø¨ Ù†Ø´Ø·${removed ? ' Â· ' + removed + ' Ù…Ø­Ø°ÙˆÙ' : ''}`;
  document.getElementById('rosterStats').innerHTML = `
    <span class="roster-stat">âœ… ${active} Ù†Ø´Ø·</span>
    ${removed ? '<span class="roster-stat" style="color:var(--red)">ğŸ—‘ '+removed+' Ù…Ø­Ø°ÙˆÙ</span>' : ''}
    <span class="roster-stat">ğŸ“‹ ${roster.length} Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>`;

  const list = document.getElementById('rosterList');
  list.innerHTML = '';

  roster.forEach((name, idx) => {
    const n = idx + 1;
    const isRemoved = !name;
    const row = document.createElement('div');
    row.className = 'roster-student-row';
    row.style.opacity = isRemoved ? '.5' : '1';

    const numSpan = document.createElement('span');
    numSpan.className = 'roster-num';
    numSpan.textContent = n;

    const nameInp = document.createElement('input');
    nameInp.className = 'roster-name-inp' + (isRemoved ? ' removed' : '');
    nameInp.type = 'text';
    nameInp.value = name || '(Ù…Ø­Ø°ÙˆÙ)';
    nameInp.disabled = isRemoved;
    nameInp.dir = 'rtl';

    // Save on blur
    nameInp.addEventListener('blur', () => {
      const newName = nameInp.value.trim();
      if(newName && newName !== name){
        renameStudent(cls, n, newName);
        // Update in-table name input if class is open
        var row=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;
        if(row) row.rowObj.nameInp.value = newName;
        updateBadgeCounts();
        showToast('âœï¸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
      }
    });
    nameInp.addEventListener('keydown', e => { if(e.key==='Enter') nameInp.blur(); });

    const actionBtn = document.createElement('button');
    if(isRemoved){
      actionBtn.className = 'roster-restore-btn';
      actionBtn.textContent = 'â†© Ø§Ø³ØªØ¹Ø§Ø¯Ø©';
      actionBtn.onclick = () => {
        const r = getRoster(cls);
        r[idx] = (DEFAULT_DATA[cls]&&DEFAULT_DATA[cls][idx]) || 'Ø·Ø§Ù„Ø¨ ' + n;
        saveRoster(cls, r);
        renderRosterManager();
        renderClassPage(cls);
        updateBadgeCounts();
        showToast('â†© ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©');
      };
    } else {
      actionBtn.className = 'roster-del-btn';
      actionBtn.textContent = 'ğŸ—‘';
      actionBtn.title = 'Remove student (data preserved)';
      actionBtn.onclick = () => {
        if(!confirm(`Ø­Ø°Ù ${name} Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ Ø³ØªØ¨Ù‚Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù…Ø­ÙÙˆØ¸Ø©.`)) return;
        removeStudent(cls, n);
        renderRosterManager();
        renderClassPage(cls);
        updateBadgeCounts();
        showToast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù â€” ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©');
      };
    }

    row.append(numSpan, nameInp, actionBtn);
    list.appendChild(row);
  });

  // Clear add input
  const addInp = document.getElementById('rosterAddInp');
  if(addInp) addInp.value = '';
}

function confirmAddStudent(){
  const cls = _rosterCls;
  const inp = document.getElementById('rosterAddInp');
  var name=(inp&&inp.value)?inp.value.trim():'';
  if(!name){ showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'); return; }
  const n = addStudent(cls, name);
  inp.value = '';
  renderRosterManager();
  renderClassPage(cls);
  updateBadgeCounts();
  showToast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${name} (Ø±Ù‚Ù… ${n})`);
  // Scroll to new student in table
  setTimeout(()=>{
    var row=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;
    if(row) row.tr.scrollIntoView({behavior:'smooth', block:'center'});
  }, 200);
}

function updateBadgeCounts(){
  // Refresh sidebar badges showing student count
  classNames.forEach(cls=>{
    const btn = document.getElementById('nav-cls-'+cls);
    if(btn){
      const badge = btn.querySelector('.badge-count');
      if(badge) badge.textContent = getRoster(cls).filter(n=>n).length;
    }
  });
  renderOverview();
}




// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MORE MENU (class toolbar)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMoreMenu(){
  var m = document.getElementById('moreMenu');
  if(m) m.classList.toggle('open');
}
function closeMoreMenu(){
  var m = document.getElementById('moreMenu');
  if(m) m.classList.remove('open');
}
// Close more menu when clicking outside
document.addEventListener('click', function(e){
  var wrap = document.getElementById('moreMenuWrap');
  if(wrap && !wrap.contains(e.target)) closeMoreMenu();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK ATTENDANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function markAllRollCall(state){
  var names = getRoster(_rcCls);
  names.forEach(function(name, idx){
    if(!name) return;
    _rcState[idx+1] = state;
  });
  renderRollCall();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRADE LOCKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLockLabels(){
  var s = loadSettings();

}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DANGER ZONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dangerResetClass(){
  var cls = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù„Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ (Ù…Ø«Ø§Ù„: 2BAC-A):');
  if(!cls) return;
  if(classNames.indexOf(cls) < 0){ showToast('âŒ Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: '+cls); return; }
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… '+cls+'ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')){ return; }
  localStorage.removeItem('gbpro_'+cls);
  showToast('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª '+cls);
  if(currentClass===cls) showPage('overview');
}

function dangerResetAbsences(){
  var cls = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù„Ù…Ø³Ø­ Ø³Ø¬Ù„ ØºÙŠØ§Ø¨Ù‡ (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„):');
  var targets = cls ? [cls] : classNames;
  if(!confirm('Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù€: '+targets.join(', ')+'ØŸ')) return;
  targets.forEach(function(c){
    var st = loadCls(c);
    Object.keys(st).forEach(function(key){
      if(st[key]){
        st[key].absenceDates = [];
        st[key].absenceRecords = [];
      }
    });
    localStorage.setItem('gbpro_'+c, JSON.stringify(st));
  });
  showToast('ğŸ“… ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨');
  if(currentClass) renderClassPage(currentClass);
}

function dangerResetAll(){
  if(!confirm('âš ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù‡Ø°Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ')) return;
  classNames.forEach(function(cls){ localStorage.removeItem('gbpro_'+cls); });
  localStorage.removeItem('gbpro_settings');
  localStorage.removeItem('gbpro_onboarded');
  localStorage.removeItem('gbpro_last_backup');
  showToast('ğŸ’¥ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LETTER GRADE LABEL (Moroccan system)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function letterGrade(score){
  if(score >= 18) return 'Ù…Ù…ØªØ§Ø²';
  if(score >= 16) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
  if(score >= 14) return 'Ø¬ÙŠØ¯';
  if(score >= 12) return 'Ø­Ø³Ù†';
  if(score >= 10) return 'Ù…Ù‚Ø¨ÙˆÙ„';
  return 'Ø¶Ø¹ÙŠÙ';
}

function letterGradeFr(score){
  if(score >= 18) return 'Excellent';
  if(score >= 16) return 'T. Bien';
  if(score >= 14) return 'Bien';
  if(score >= 12) return 'A. Bien';
  if(score >= 10) return 'Passable';
  return 'Insuffisant';
}

// Update profile button note indicator after saving notes
function refreshNoteIndicator(cls, n){
  var st = loadCls(cls);
  var rec = getStudentRecord(st, n, getRoster(cls)[n-1]);
  var btn = document.getElementById('profBtn-'+cls+'-'+n);
  if(!btn) return;
  var hasNote = !!(rec.notes&&rec.notes.trim());
  btn.innerHTML = hasNote ? 'ğŸ‘¤<span style="color:var(--accent);font-size:9px;vertical-align:top">â—</span>' : 'ğŸ‘¤';
  btn.title = hasNote ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù â€” ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBJECT CONFIG (tests, weights, coefficient)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Default subject config â€” editable in Settings
var DEFAULT_TESTS = [
  { key: 't1', label: 'ÙØ±Ø¶ 1', weight: 15 },
  { key: 't2', label: 'ÙØ±Ø¶ 2', weight: 15 },
  { key: 'glob', label: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', weight: 30 }
];

var FIXED_COMPONENTS = [
  { key: 'hw',   label: 'Ø§Ù„ÙˆØ§Ø¬Ø¨',    color: '#60a5fa' },
  { key: 'copy', label: 'Ø§Ù„Ø¯ÙØªØ±',    color: '#a78bfa' },
  { key: 'part', label: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©',  color: '#34d399' },
  { key: 'disc', label: 'Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·',  color: '#f59e0b' },
  { key: 'abs',  label: 'Ø§Ù„ØºÙŠØ§Ø¨',    color: '#f87171' }
];

var TEST_COLORS = ['#3b82f6','#06b6d4','#8b5cf6','#ec4899'];

function getSubjectConfig(){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  var coeff = s.coefficient || 2;
  var fixedWeights = {
    hw:   s.hw   !== undefined ? s.hw   : 8,
    copy: s.copy !== undefined ? s.copy : 8,
    part: s.part !== undefined ? s.part : 8,
    disc: s.disc !== undefined ? s.disc : 8,
    abs:  s.abs  !== undefined ? s.abs  : 8
  };
  return { tests: tests, coeff: coeff, fixedWeights: fixedWeights };
}

function changeCoeff(delta){
  var s = loadSettings();
  var c = Math.max(1, Math.min(10, (s.coefficient||2) + delta));
  s.coefficient = c;
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  var el = document.getElementById('coeffVal');
  if(el) el.textContent = c;
}

// â”€â”€ TEST MANAGEMENT â”€â”€
function addTest(){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  if(tests.length >= 4){ showToast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4 ÙØ±ÙˆØ¶'); return; }
  var idx = tests.length + 1;
  tests.push({ key: 'tx'+idx, label: 'ÙØ±Ø¶ '+idx, weight: 0 });
  s.tests = tests;
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  renderTestConfig();
  renderWeightBuilder();
}

function removeTest(idx){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  if(tests.length <= 1){ showToast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ÙØ±Ø¶ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
  tests.splice(idx, 1);
  s.tests = tests;
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  renderTestConfig();
  renderWeightBuilder();
  if(currentClass) renderClassPage(currentClass);
}

function updateTestLabel(idx, val){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  if(tests[idx]) tests[idx].label = val;
  s.tests = tests;
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  renderWeightBuilder();
  // Update table header live
  var th = document.querySelector('th[data-col="'+tests[idx].key+'"]');
  if(th) th.childNodes[0].textContent = val + ' ';
}

function updateTestWeight(idx, val){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  if(tests[idx]) tests[idx].weight = parseFloat(val)||0;
  s.tests = tests;
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  updateWeights();
  if(currentClass) refreshAllScores();
}

// â”€â”€ RENDER TEST CONFIG CHIPS â”€â”€
function renderTestConfig(){
  var wrap = document.getElementById('testConfigRow');
  if(!wrap) return;
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  wrap.innerHTML = '';
  tests.forEach(function(t, i){
    var chip = document.createElement('div');
    chip.className = 'test-config-chip';
    chip.innerHTML =
      '<div class="test-chip-icon" style="color:'+TEST_COLORS[i%4]+'">ğŸ“</div>'+
      '<div class="test-chip-fields">'+
        '<input class="test-chip-name" value="'+t.label+'" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¶" '+
          'onchange="updateTestLabel('+i+',this.value)" oninput="updateTestLabel('+i+',this.value)"/>'+
        '<div class="test-chip-weight-row">'+
          '<span class="test-chip-weight-lbl">Ø§Ù„ÙˆØ²Ù†:</span>'+
          '<input class="test-chip-weight" type="number" value="'+t.weight+'" min="0" max="100" '+
            'onchange="updateTestWeight('+i+',this.value)"/>'+
          '<span class="test-chip-pct">%</span>'+
        '</div>'+
      '</div>'+
      (tests.length > 1 ? '<button class="test-rm-btn" onclick="removeTest('+i+')" title="Ø­Ø°Ù">âœ•</button>' : '');
    wrap.appendChild(chip);
  });
  var hint = document.getElementById('testCountHint');
  if(hint) hint.textContent = 'Ø§Ù„ÙØ±ÙˆØ¶: '+tests.length;
  var addBtn = document.getElementById('addTestBtn');
  if(addBtn) addBtn.disabled = tests.length >= 4;
}

// â”€â”€ VISUAL WEIGHT BUILDER â”€â”€
var WB_COLORS = { hw:'#60a5fa', copy:'#a78bfa', part:'#34d399', disc:'#f59e0b', abs:'#f87171' };

function renderWeightBuilder(){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();

  // All components to show
  var components = [
    { key:'hw',   label:'Ø§Ù„ÙˆØ§Ø¬Ø¨',   color:'#60a5fa', val: s.hw!==undefined?s.hw:8 },
    { key:'copy', label:'Ø§Ù„Ø¯ÙØªØ±',   color:'#a78bfa', val: s.copy!==undefined?s.copy:8 },
    { key:'part', label:'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', color:'#34d399', val: s.part!==undefined?s.part:8 },
    { key:'disc', label:'Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·', color:'#f59e0b', val: s.disc!==undefined?s.disc:8 },
    { key:'abs',  label:'Ø§Ù„ØºÙŠØ§Ø¨',   color:'#f87171', val: s.abs!==undefined?s.abs:8 }
  ];
  tests.forEach(function(t, i){
    components.push({ key: t.key, label: t.label, color: TEST_COLORS[i%4], val: t.weight, isTest: true, testIdx: i });
  });

  var wrap = document.getElementById('weightBuilder');
  if(!wrap) return;
  wrap.innerHTML = '';

  components.forEach(function(c){
    var row = document.createElement('div');
    row.className = 'wb-row';
    var maxVal = Math.max(1, components.reduce(function(a,x){return a+x.val;},0));

    row.innerHTML =
      '<div class="wb-label">'+c.label+'</div>'+
      '<div class="wb-slider-wrap">'+
        '<div class="wb-track"><div class="wb-fill" id="wbf-'+c.key+'" style="width:'+c.val+'%;background:'+c.color+'"></div></div>'+
        '<input class="wb-slider" type="range" min="0" max="60" step="1" value="'+c.val+'" '+
          'id="wbs-'+c.key+'" oninput="onWbSlider(this)" data-key="'+c.key+'" data-tidx="'+(c.isTest?c.testIdx:-1)+'" '+
          'style="accent-color:'+c.color+'"/>'+
      '</div>'+
      '<input class="wb-value" type="number" min="0" max="60" value="'+c.val+'" '+
        'id="wbv-'+c.key+'" oninput="onWbVal(this)" data-key="'+c.key+'" data-tidx="'+(c.isTest?c.testIdx:-1)+'" '+
        'style="color:'+c.color+'"/>';
    wrap.appendChild(row);
  });

  renderWeightBar(components);
}

function onWbSlider(el){
  var key = el.getAttribute('data-key');
  var testIdx = parseInt(el.getAttribute('data-tidx'))||0;
  if(el.getAttribute('data-tidx')==='-1') testIdx=-1;
  var val = parseInt(el.value)||0;
  var vi = document.getElementById('wbv-'+key); if(vi) vi.value = val;
  var fi = document.getElementById('wbf-'+key); if(fi) fi.style.width = val+'%';
  persistWeightChange(key, val, testIdx);
}

function onWbVal(el){
  var key = el.getAttribute('data-key');
  var testIdx = parseInt(el.getAttribute('data-tidx'))||0;
  if(el.getAttribute('data-tidx')==='-1') testIdx=-1;
  var val = parseInt(el.value)||0;
  var si = document.getElementById('wbs-'+key); if(si) si.value = val;
  var fi = document.getElementById('wbf-'+key); if(fi) fi.style.width = val+'%';
  persistWeightChange(key, val, testIdx);
}

function persistWeightChange(key, val, testIdx){
  var s = loadSettings();
  if(testIdx >= 0){
    var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
    if(tests[testIdx]) tests[testIdx].weight = val;
    s.tests = tests;
    // also update test chip
    var tc = document.querySelector('#testConfigRow .test-config-chip:nth-child('+(testIdx+1)+') .test-chip-weight');
    if(tc) tc.value = val;
  } else {
    s[key] = val;
  }
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  updateWeights();
  refreshAllScores();
}

function renderWeightBar(components){
  var bar = document.getElementById('weightBar');
  if(!bar) return;
  var total = components.reduce(function(a,c){return a+c.val;},0)||1;
  bar.innerHTML = '';
  components.forEach(function(c){
    if(!c.val) return;
    var seg = document.createElement('div');
    seg.className = 'wb-seg';
    seg.style.width = (c.val/total*100).toFixed(1)+'%';
    seg.style.background = c.color;
    seg.innerHTML = c.val>=8 ? '<span class="wb-seg-lbl">'+c.label+'</span>' : '';
    bar.appendChild(seg);
  });
}

function autoBalance(){
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  var nTests = tests.length;
  // Fixed: hw8, copy8, part8, disc8, abs8 = 40%. Tests get 60% split equally
  var each = Math.floor(60/nTests);
  var rem = 60 - each*nTests;
  s.hw=8; s.copy=8; s.part=8; s.disc=8; s.abs=8;
  tests.forEach(function(t,i){ t.weight = each + (i===nTests-1?rem:0); });
  s.tests = tests;
  try{ localStorage.setItem(SS, JSON.stringify(s)); }catch(e){}
  renderWeightBuilder();
  renderTestConfig();
  updateWeights();
  refreshAllScores();
  showToast('âœ… ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REBUILD TABLE HEADER WITH DYNAMIC TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rebuildClassTableHead(){
  var head = document.getElementById('classTableHead');
  if(!head) return;
  var s = loadSettings();
  var tests = (s.tests && s.tests.length) ? s.tests : DEFAULT_TESTS.slice();
  var tr = head.querySelector('tr');
  if(!tr) return;
  // Clear and rebuild
  var h = '';
  h += '<th class="sortable-header" onclick="sortTable(&quot;n&quot;)" data-col="n"># <span class="sort-icon" id="sort-n">â†•</span></th>';
  h += '<th style="min-width:160px;direction:rtl" data-col="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>';
  h += '<th data-col="abs">Ø§Ù„ØºÙŠØ§Ø¨</th>';
  h += '<th data-col="part">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th>';
  h += '<th data-col="disc">Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</th>';
  h += '<th class="sortable-header" onclick="sortTable(&quot;hw&quot;)" data-col="hw">Ø§Ù„ÙˆØ§Ø¬Ø¨ <span class="sort-icon" id="sort-hw">â†•</span></th>';
  h += '<th class="sortable-header" onclick="sortTable(&quot;copy&quot;)" data-col="copy">Ø§Ù„Ø¯ÙØªØ± <span class="sort-icon" id="sort-copy">â†•</span></th>';
  tests.forEach(function(t, i){
    h += '<th class="sortable-header" onclick="sortTable(&quot;'+t.key+'&quot;)" data-col="'+t.key+'" style="color:'+TEST_COLORS[i%4]+'">'+
      t.label+' <span class="sort-icon" id="sort-'+t.key+'">â†•</span></th>';
  });
  h += '<th class="sortable-header" onclick="sortTable(&quot;final&quot;)" data-col="final">Ø§Ù„Ù†ØªÙŠØ¬Ø© <span class="sort-icon" id="sort-final">â†•</span></th>';
  h += '<th data-col="actions"></th>';
  tr.innerHTML = h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPACT MODE (Feature 4)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _compactMode = false;

function toggleCompactMode(){
  _compactMode = !_compactMode;
  var table = document.getElementById('classTable');
  if(table) table.classList.toggle('compact-mode', _compactMode);
  // Also tag all td's with data-col based on position
  tagTableCols();
  var btn = document.getElementById('compactBtn');
  if(btn) btn.textContent = _compactMode ? 'ğŸ“± Ø¹Ø§Ø¯ÙŠ' : 'ğŸ“± Ø¥Ø®ÙØ§Ø¡';
  localStorage.setItem('gbpro_compact', _compactMode?'1':'0');
}

function tagTableCols(){
  // Add data-col to each td in tbody based on th data-col
  var ths = document.querySelectorAll('#classTable thead th');
  var cols = [];
  for(var i=0;i<ths.length;i++) cols.push(ths[i].getAttribute('data-col')||i);
  var rows = document.querySelectorAll('#classTable tbody tr');
  for(var r=0;r<rows.length;r++){
    var tds = rows[r].querySelectorAll('td');
    for(var c=0;c<tds.length&&c<cols.length;c++){
      tds[c].setAttribute('data-col', cols[c]);
    }
  }
}

function loadCompactMode(){
  _compactMode = localStorage.getItem('gbpro_compact')==='1';
  if(_compactMode){
    var table = document.getElementById('classTable');
    if(table) table.classList.add('compact-mode');
    var btn = document.getElementById('compactBtn');
    if(btn) btn.textContent = 'ğŸ“± Ø¹Ø§Ø¯ÙŠ';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKELETON LOADER (Feature 5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hideSkeleton(){
  var sk = document.getElementById('skeletonOverlay');
  if(sk){ sk.classList.add('hidden'); setTimeout(function(){ sk.style.display='none'; },400); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONBOARDING (Feature 6)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _onboardStep = 0;
var _onboardSteps = 4;

function checkOnboarding(){
  if(localStorage.getItem('gbpro_onboarded')) return;
  var overlay = document.getElementById('onboardOverlay');
  if(overlay){
    overlay.classList.remove('hidden');
    buildOnboardDots();
    _onboardStep = 0;
    showOnboardStep(0);
  }
}

function buildOnboardDots(){
  var dots = document.getElementById('onboardDots');
  if(!dots) return;
  dots.innerHTML = '';
  for(var i=0;i<_onboardSteps;i++){
    var d = document.createElement('div');
    d.className = 'onboard-dot'+(i===0?' active':'');
    d.id = 'od'+i;
    dots.appendChild(d);
  }
}

function showOnboardStep(n){
  for(var i=0;i<_onboardSteps;i++){
    var s = document.getElementById('onboard-'+i);
    var d = document.getElementById('od'+i);
    if(s) s.className = 'onboard-step'+(i===n?' active':'');
    if(d) d.className = 'onboard-dot'+(i===n?' active':'');
  }
  var btn = document.getElementById('onboardNext');
  if(btn) btn.textContent = n===_onboardSteps-1 ? 'âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' : 'Ø§Ù„ØªØ§Ù„ÙŠ â†’';
}

function onboardNext(){
  if(_onboardStep < _onboardSteps-1){
    _onboardStep++;
    showOnboardStep(_onboardStep);
  } else {
    onboardDone();
  }
}

function onboardDone(){
  localStorage.setItem('gbpro_onboarded','1');
  var overlay = document.getElementById('onboardOverlay');
  if(overlay) overlay.classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFLICT BANNER (Feature 2 UI)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showConflictBanner(cls){
  var b = document.getElementById('conflictBanner');
  if(!b) return;
  b.textContent = 'âš ï¸ ØªØ­Ø°ÙŠØ±: ØªÙ… ØªØ¹Ø¯ÙŠÙ„ '+cls+' Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± Ù…Ø¤Ø®Ø±Ø§Ù‹ â€” Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ØªØ¹Ø§Ø±Ø¶Ø§Øª ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  b.classList.add('show');
  setTimeout(function(){ b.classList.remove('show'); }, 6000);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK ATTENDANCE (Feature 3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function markAllRollCall(state){
  var names = getRoster(_rcCls);
  names.forEach(function(_,idx){
    if(!names[idx]) return;
    var n = idx+1;
    _rcState[n] = state;
  });
  renderRollCall();
  showToast(state==='present' ? 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø­Ø§Ø¶Ø±ÙŠÙ†' : 'âŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ ØºØ§Ø¦Ø¨ÙŠÙ†');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTE INDICATOR REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshNoteIndicator(cls, n, hasNote){
  var btn = document.getElementById('profBtn-'+cls+'-'+n);
  if(!btn) return;
  btn.innerHTML = hasNote ? 'ğŸ‘¤<span style="color:var(--accent);font-size:9px;vertical-align:top">â—</span>' : 'ğŸ‘¤';
  btn.title = hasNote ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù â€” ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DANGER ZONE - RESET FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetClass(cls){
  if(!cls){ showToast('âš ï¸ Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª '+cls+'ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')){ return; }
  localStorage.removeItem(SK(cls));
  localStorage.removeItem('gbpro_roster_'+cls);
  showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª '+cls);
  if(currentClass===cls) showPage('overview');
}

function resetAllData(){
  if(!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ')){ return; }
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„ØºÙŠØ§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')){ return; }
  classNames.forEach(function(cls){
    localStorage.removeItem(SK(cls));
    localStorage.removeItem('gbpro_roster_'+cls);
  });
  localStorage.removeItem(SS);
  localStorage.removeItem('gbpro_onboarded');
  localStorage.removeItem('gbpro_last_backup');
  showToast('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  setTimeout(function(){ location.reload(); }, 1200);
}

function resetAbsencesOnly(cls){
  if(!cls){ showToast('âš ï¸ Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  if(!confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ ÙÙ‚Ø· Ù„Ù€ '+cls+'ØŸ')){ return; }
  var st = loadCls(cls);
  Object.keys(st).forEach(function(k){
    if(st[k]){
      st[k].absenceDates = [];
      st[k].absenceRecords = [];
    }
  });
  saveCls(cls, st);
  showToast('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù€ '+cls);
  if(currentClass===cls) renderClassPage(cls);
}


// â”€â”€ Daily Abs date navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shiftDailyAbs(delta){
  var inp = document.getElementById('dailyAbsDate');
  if(!inp||!inp.value) return;
  var d = new Date(inp.value+'T12:00:00');
  d.setDate(d.getDate()+delta);
  inp.value = d.toISOString().slice(0,10);
  renderDailyAbs();
  updateAbsDateLabel();
}

function updateAbsDateLabel(){
  var inp = document.getElementById('dailyAbsDate');
  var lbl = document.getElementById('absDateLabel');
  if(!inp||!lbl) return;
  if(!inp.value){ lbl.textContent='Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ø§Ù‹'; return; }
  var d = new Date(inp.value+'T12:00:00');
  var today = new Date(); today.setHours(12,0,0,0);
  var yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
  var tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
  var days=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
  var months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
  var dayName = d.getTime()===today.getTime()?'Ø§Ù„ÙŠÙˆÙ…':d.getTime()===yesterday.getTime()?'Ø£Ù…Ø³':d.getTime()===tomorrow.getTime()?'ØºØ¯Ø§Ù‹':days[d.getDay()];
  lbl.innerHTML = `<span class="abs-date-day">${dayName}</span> <span class="abs-date-full">${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}</span>`;
}

// Patch setDailyAbsToday to also update label
var _origSetDailyAbsToday = setDailyAbsToday;
function setDailyAbsToday(){
  _origSetDailyAbsToday();
  updateAbsDateLabel();
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE SORT & RANK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _sortKey = null;
let _sortDir = 1; // 1=asc, -1=desc

function sortTable(key){
  if(!currentClass) return;
  if(_sortKey===key) _sortDir*=-1;
  else { _sortKey=key; _sortDir=-1; } // default desc
  // Update sort icons
  document.querySelectorAll('.sort-icon').forEach(el=>{ el.textContent='â†•'; el.classList.remove('active'); });
  const icon=document.getElementById('sort-'+key);
  if(icon){ icon.textContent=_sortDir===1?'â†‘':'â†“'; icon.classList.add('active'); }
  const tbody=document.getElementById('classTableBody');
  var rows=(_rows[currentClass]||[]).slice();
  rows.sort((a,b)=>{
    let va,vb;
    if(key==='n'){ va=a.n; vb=b.n; }
    else if(key==='final'){ va=parseFloat(a.rowObj.final.textContent)||0; vb=parseFloat(b.rowObj.final.textContent)||0; }
    else { va=num(a.rowObj[key]?a.rowObj[key].value:''); vb=num(b.rowObj[key]?b.rowObj[key].value:''); }
    return (va-vb)*_sortDir;
  });
  rows.forEach((r,i)=>{ tbody.appendChild(r.tr); });
  // Show rank badges
  addRankBadges(currentClass);
}

function addRankBadges(cls){
  var rows=(_rows[cls]||[]).slice();
  var sorted=rows.slice().sort(function(a,b){return (parseFloat(b.rowObj.final.textContent)||0)-(parseFloat(a.rowObj.final.textContent)||0);});
  rows.forEach(r=>{
    const rank=sorted.indexOf(r)+1;
    const total=sorted.length;
    let badge=r.tr.querySelector('.rank-badge');
    if(!badge){ badge=document.createElement('span'); badge.className='rank-badge'; r.tr.querySelector('td.num').appendChild(badge); }
    badge.textContent='#'+rank;
    badge.className='rank-badge'+(rank<=3?' rank-top':rank>=total-2?' rank-bot':'');
    // T1 vs T2 trend arrow
    var t1=num(r.rowObj&&r.rowObj.t1?r.rowObj.t1.value:''); var t2=num(r.rowObj&&r.rowObj.t2?r.rowObj.t2.value:'');
    if(t1>0&&t2>0){
      let arrow=r.tr.querySelector('.trend-arrow');
      if(!arrow){ arrow=document.createElement('span'); arrow.className='trend-arrow'; r.tr.querySelector('td.num').appendChild(arrow); }
      if(t2>t1+0.5){ arrow.textContent='â†‘'; arrow.className='trend-arrow trend-up'; arrow.title=`T1:${t1} â†’ T2:${t2}`; }
      else if(t2<t1-0.5){ arrow.textContent='â†“'; arrow.className='trend-arrow trend-down'; arrow.title=`T1:${t1} â†’ T2:${t2}`; }
      else { arrow.textContent='â†’'; arrow.className='trend-arrow trend-same'; arrow.title='Stable'; }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK ROLL CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _rcCls = null;
let _rcDate = null;
let _rcState = {}; // {n: 'present'|'absent-u'|'absent-j'}

function openRollCall(cls){
  if(!cls) return;
  _rcCls = cls;
  _rcDate = todayISO();
  _rcState = {};
  const names = getRoster(cls);
  // Pre-populate with existing data
  const st = loadCls(cls);
  names.forEach((_,idx)=>{
    const n=idx+1;
    const rec=getStudentRecord(st,n,names[idx]);
    if(absHasDate(rec,_rcDate)){
      _rcState[n] = absIsJust(rec,_rcDate)?'absent-j':'absent-u';
    } else {
      _rcState[n]='present';
    }
  });
  document.getElementById('rcTitle').textContent=`${cls} â€” Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…`;
  document.getElementById('rcMeta').textContent=_rcDate;
  renderRollCall();
  document.getElementById('rollCallOverlay').classList.add('show');
  addSwipeToClose(document.getElementById('rollCallSheet'), closeRollCall);
}

function renderRollCall(){
  const cls=_rcCls; const names=getRoster(cls);
  const list=document.getElementById('rcStudentList'); list.innerHTML='';
  let presentCount=0, absentUCount=0, absentJCount=0;
  names.forEach((defaultName,idx)=>{
    const n=idx+1;
    const state=_rcState[n]||'present';
    if(state==='present') presentCount++;
    else if(state==='absent-u') absentUCount++;
    else absentJCount++;
    const row=document.createElement('div');
    row.className=`roll-call-student ${state}`;
    row.innerHTML='<span class="roll-call-num">'+n+'</span>'
      +'<span class="roll-call-name">'+defaultName+'</span>'
      +'<div class="roll-call-btns">'
      +'<button class="rc-btn present '+(state==='present'?'active':'')+'" onclick="setRcState('+n+',\'present\',this)">âœ“ Ø­Ø§Ø¶Ø±</button>'
      +'<button class="rc-btn absent-u '+(state==='absent-u'?'active':'')+'" onclick="setRcState('+n+',\'absent-u\',this)">âœ— ØºØ§Ø¦Ø¨</button>'
      +'<button class="rc-btn absent-j '+(state==='absent-j'?'active':'')+'" onclick="setRcState('+n+',\'absent-j\',this)">ğŸ“„ Ù…Ø¨Ø±Ø±</button>'
      +'</div>';
    list.appendChild(row);
  });
  const total=names.length;
  const done=Object.values(_rcState).filter(s=>s!=='present'||true).length;
  document.getElementById('rcProgress').style.width=(done/total*100)+'%';
  document.getElementById('rcSummary').innerHTML=`
    <div class="rc-sum-chip"><div class="v" style="color:var(--green)">${presentCount}</div><div class="l">Ø­Ø§Ø¶Ø±</div></div>
    <div class="rc-sum-chip"><div class="v" style="color:var(--red)">${absentUCount}</div><div class="l">ØºØ§Ø¦Ø¨</div></div>
    <div class="rc-sum-chip"><div class="v" style="color:var(--amber)">${absentJCount}</div><div class="l">Ù…Ø¨Ø±Ø±</div></div>
    <div class="rc-sum-chip"><div class="v" style="color:var(--muted)">${total}</div><div class="l">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div></div>`;
}

function setRcState(n, state, btn){
  _rcState[n]=state;
  // Update row highlight
  const row=btn.closest('.roll-call-student');
  row.className=`roll-call-student ${state}`;
  row.querySelectorAll('.rc-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  // Update summary
  renderRollCallSummary();
}

function renderRollCallSummary(){
  const names=getRoster(_rcCls);
  let p=0,u=0,j=0;
  names.forEach((_,idx)=>{ const s=_rcState[idx+1]||'present'; if(s==='present')p++;else if(s==='absent-u')u++;else j++; });
  document.getElementById('rcSummary').innerHTML=`
    <div class="rc-sum-chip"><div class="v" style="color:var(--green)">${p}</div><div class="l">Ø­Ø§Ø¶Ø±</div></div>
    <div class="rc-sum-chip"><div class="v" style="color:var(--red)">${u}</div><div class="l">ØºØ§Ø¦Ø¨</div></div>
    <div class="rc-sum-chip"><div class="v" style="color:var(--amber)">${j}</div><div class="l">Ù…Ø¨Ø±Ø±</div></div>
    <div class="rc-sum-chip"><div class="v" style="color:var(--muted)">${names.length}</div><div class="l">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div></div>`;
}

function saveRollCall(){
  const cls=_rcCls; const date=_rcDate;
  const st=loadCls(cls); const names=getRoster(cls);
  names.forEach((_,idx)=>{
    const n=idx+1; const state=_rcState[n]||'present';
    const rec=getStudentRecord(st,n,names[idx]);
    // Remove existing entry for this date first
    absRemoveDate(rec,date);
    if(state==='absent-u') absAddDate(rec,date,false);
    else if(state==='absent-j') absAddDate(rec,date,true);
    // sync row if class is open
    var row=_rows[cls]?_rows[cls].find(function(r){return r.n===n;}):null;
    if(row){ row.rowObj.absRec=rec; row.rowObj.absDates=absGetDates(rec); }
  });
  saveCls(cls,st);
  // Sync all changed rows
  names.forEach((_,idx)=>{ const n=idx+1; if(_rcState[n]!=='present') queueSync(cls,n); });
  if(currentClass===cls) renderClassPage(cls);
  updateTodayAbsBadge();
  renderWeekStrip();
  closeRollCall();
  const absentCount=Object.values(_rcState).filter(s=>s!=='present').length;
  showToast(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ â€” ${absentCount} ØºØ§Ø¦Ø¨`);
}

function closeRollCall(){ document.getElementById('rollCallOverlay').classList.remove('show'); _rcCls=null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  loadSettingsUI();
  loadGsUrlUI();
  updateWeights();
  buildSidebarNav();
  buildClassPageContainers();
  renderOverview();
  renderWeekStrip();
  updateTodayAbsBadge();
  updateRiskCount();
  loadTheme();
  loadCompactMode();
  checkPinOnLoad();
  initKeyboardNav();
  // Populate danger zone class selector
  var dsel = document.getElementById('dangerClassSel');
  if(dsel){ classNames.forEach(function(cls){ var o=document.createElement('option'); o.value=cls; o.textContent=cls; dsel.appendChild(o); }); }
  // Skeleton: hide after render
  setTimeout(hideSkeleton, 600);
  // Onboarding: show if first time
  setTimeout(checkOnboarding, 800);
  // Backup reminder
  setTimeout(checkBackupReminder, 2000);
  // Pull latest data from Google Sheets on startup (if URL is set)
  if(getGsUrl()) pullFromSheets();
  // iPhone swipe-down to close all sheets
  const sheets = document.querySelectorAll('.sheet');
  sheets.forEach(s=>{
    const overlay = s.closest('.overlay');
    if(!overlay) return;
    const id = overlay.id;
    const closers = { discOverlay: closeDisc, absOverlay: closeAbs };
    if(closers[id]) addSwipeToClose(s, closers[id]);
  });
});
</script>
</body>
</html>
